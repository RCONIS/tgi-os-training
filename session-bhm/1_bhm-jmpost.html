<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-11-17">

<title>5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-fe572088fed4c8b78605e513f5ffbe45.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-bhm/0_setup.html">Session 5: BHM</a></li><li class="breadcrumb-item"><a href="../session-bhm/1_bhm-jmpost.html">5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      <div class="sidebar-tools-main">
    <a href="https://rconis.github.io/tgi-os-training/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 5: BHM</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-bhm/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-bhm/1_bhm-jmpost.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 4: PTS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-pts/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-pts/1_pts-jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Calculate Bayesian Predictive Power</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 3: TGI-OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/1_jm-jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI-OS joint model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 2: OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/1_os_weibull_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. OS model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/2_os_weibull_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. OS model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/4_tgi_cb_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Claret-Bruno model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#descriptive-analysis-of-the-current-study-data" id="toc-descriptive-analysis-of-the-current-study-data" class="nav-link" data-scroll-target="#descriptive-analysis-of-the-current-study-data">Descriptive analysis of the current study data</a></li>
  <li><a href="#check-compatibility-of-historical-and-current-data" id="toc-check-compatibility-of-historical-and-current-data" class="nav-link" data-scroll-target="#check-compatibility-of-historical-and-current-data">Check compatibility of historical and current data</a></li>
  <li><a href="#fitting-the-joint-model-only-to-the-historical-data" id="toc-fitting-the-joint-model-only-to-the-historical-data" class="nav-link" data-scroll-target="#fitting-the-joint-model-only-to-the-historical-data">Fitting the joint model only to the historical data</a></li>
  <li><a href="#pool-historical-and-current-data" id="toc-pool-historical-and-current-data" class="nav-link" data-scroll-target="#pool-historical-and-current-data">Pool historical and current data</a></li>
  <li><a href="#fit-the-bayesian-hierarchical-joint-model" id="toc-fit-the-bayesian-hierarchical-joint-model" class="nav-link" data-scroll-target="#fit-the-bayesian-hierarchical-joint-model">Fit the Bayesian hierarchical joint model</a></li>
  <li><a href="#investigating-the-parameter-estimates" id="toc-investigating-the-parameter-estimates" class="nav-link" data-scroll-target="#investigating-the-parameter-estimates">Investigating the parameter estimates</a></li>
  <li><a href="#goodness-of-fit" id="toc-goodness-of-fit" class="nav-link" data-scroll-target="#goodness-of-fit">Goodness of fit</a></li>
  <li><a href="#posterior-distribution-of-the-hazard-ratio" id="toc-posterior-distribution-of-the-hazard-ratio" class="nav-link" data-scroll-target="#posterior-distribution-of-the-hazard-ratio">Posterior distribution of the hazard ratio</a></li>
  <li><a href="#probability-of-success" id="toc-probability-of-success" class="nav-link" data-scroll-target="#probability-of-success">Probability of success</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-bhm/1_bhm-jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-bhm/0_setup.html">Session 5: BHM</a></li><li class="breadcrumb-item"><a href="../session-bhm/1_bhm-jmpost.html">5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-11-17</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this document is to show a minimal workflow for Bayesian hierarchical joint modeling for historical data borrowing using the <code>jmpost</code> package.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>Here we execute the R code from the setup and data preparation chapter, see the <a href="../session-bhm/0_setup.html">full code here</a>.</p>
</section>
<section id="descriptive-analysis-of-the-current-study-data" class="level2">
<h2 class="anchored" data-anchor-id="descriptive-analysis-of-the-current-study-data">Descriptive analysis of the current study data</h2>
<p>Let’s have a quick look at the (artificially reduced to maximum 1 year follow-up) current study data, in order to illustrate the typical situation where we have immature OS data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survival'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:brms':

    kidney</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggpubr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survminer'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:survival':

    myeloma</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall Survival KM plot</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fit_os_current <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> current_os_data)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    fit_os_current,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> current_os_data,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pval =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overall Survival in Current Study"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.
ℹ The deprecated feature was likely used in the ggpubr package.
  Please report the issue at &lt;https://github.com/kassambara/ggpubr/issues&gt;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Ignoring unknown labels:
• colour : "Strata"</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_bhm-jmpost_files/figure-html/descriptive_current_data-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So no matter which model we might fit to this data, we will not be able to trust it to estimate the hazard ratio reliably.</p>
</section>
<section id="check-compatibility-of-historical-and-current-data" class="level2">
<h2 class="anchored" data-anchor-id="check-compatibility-of-historical-and-current-data">Check compatibility of historical and current data</h2>
<p>Just to mention that we would need to double check the compatibility of historical and current clinical trial design (including patient populations, endpoints, assessment schedules, etc.) and data distributions before applying any kind of historical data borrowing technique.</p>
<p>In our dummy example here, this is fulfilled by construction.</p>
</section>
<section id="fitting-the-joint-model-only-to-the-historical-data" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-joint-model-only-to-the-historical-data">Fitting the joint model only to the historical data</h2>
<p>The first step is to fit the joint model only to the historical data. In reality, this also includes model selection in order to determine:</p>
<ul>
<li>choice of parametric baseline survival model (log-logistic, Weibull, etc.?)</li>
<li>selection of baseline covariates</li>
<li>choice of the TGI metric to correlate with the survival model, i.e.&nbsp;the link function (SLD, tumor growth rate, time to tumor regrowth, etc.?)</li>
</ul>
<p>We have discussed model comparison and selection in session 3 <a href="https://rconis.github.io/tgi-os-training/session-jm/1_jm-jmpost.html#model-comparison">here</a>, so we will skip this step here and directly fit a joint model to the historical data only.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>historical_subj_df <span class="ot">&lt;-</span> historical_os_data <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>historical_subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_subj_df,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>historical_long_df <span class="ot">&lt;-</span> historical_tumor_data <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>historical_long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_long_df,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>historical_surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_os_data,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>historical_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> historical_subj_data,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> historical_long_data,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> historical_surv_data</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>historical_joint_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="fu">linkGrowth</span>(</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">prior =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.999</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/histmod1.rds"</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    historical_joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    historical_joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        historical_joint_mod,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> historical_joint_data,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(historical_joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s have a look at the results:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"link_growth"</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>mcmc_historical_joint_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(historical_joint_results)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>mcmc_historical_summary <span class="ot">&lt;-</span> mcmc_historical_joint_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mcmc_historical_summary, <span class="at">n =</span> <span class="dv">30</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 10
   variable         mean   median      sd     mad      q5     q95  rhat ess_bulk
   &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 lm_sf_mu_bs…  3.75     3.76    0.0519  0.0510   3.67    3.84   1.01      208.
 2 lm_sf_mu_ks…  0.0560   0.0818  0.257   0.246   -0.399   0.440  1.00      775.
 3 lm_sf_mu_ks… -0.913   -0.865   0.388   0.385   -1.60   -0.353  1.00      683.
 4 lm_sf_mu_kg… -0.496   -0.491   0.126   0.120   -0.699  -0.290  0.999     732.
 5 lm_sf_mu_kg… -0.782   -0.773   0.198   0.189   -1.12   -0.473  1.00      614.
 6 lm_sf_sigma   0.121    0.120   0.00479 0.00459  0.113   0.129  1.00      951.
 7 lm_sf_omega…  0.493    0.490   0.0359  0.0340   0.438   0.557  1.00      590.
 8 lm_sf_omega…  0.913    0.891   0.195   0.181    0.640   1.27   1.00      850.
 9 lm_sf_omega…  1.26     1.21    0.302   0.281    0.837   1.80   1.00      649.
10 lm_sf_omega…  0.458    0.453   0.0903  0.0907   0.324   0.607  1.00      775.
11 lm_sf_omega…  0.990    0.975   0.133   0.131    0.796   1.24   1.00      766.
12 beta_os_cov…  1.17     1.17    0.380   0.364    0.518   1.79   1.00      895.
13 beta_os_cov…  0.00931  0.00952 0.0153  0.0155  -0.0150  0.0342 1.000     987.
14 beta_os_cov…  0.942    0.940   0.653   0.628   -0.153   2.00   1.00     1015.
15 beta_os_cov…  0.165    0.157   0.374   0.379   -0.440   0.778  1.00     1051.
16 beta_os_cov…  0.246    0.239   0.331   0.325   -0.272   0.789  1.00     1049.
17 sm_weibull_…  1.70     1.70    0.212   0.203    1.35    2.06   1.00      980.
18 sm_weibull_…  0.151    0.0983  0.163   0.0881   0.0162  0.460  0.998    1001.
19 link_growth   0.988    0.985   0.375   0.370    0.377   1.59   1.00      796.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Let’s also look at the covariate effect estimates again:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>os_cov_name_mapping <span class="ot">&lt;-</span> <span class="cf">function</span>(surv_data) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    old_coef_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(old_coef_names, os_cov_names)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>os_cov_renaming <span class="ot">&lt;-</span> <span class="fu">os_cov_name_mapping</span>(historical_surv_data)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>draws_historical_joint_results <span class="ot">&lt;-</span> mcmc_historical_joint_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>draws_historical_joint_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_historical_joint_results), os_cov_renaming)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_historical_joint_results) <span class="sc">+</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_bhm-jmpost_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pool-historical-and-current-data" class="level2">
<h2 class="anchored" data-anchor-id="pool-historical-and-current-data">Pool historical and current data</h2>
<p>Now we pool the historical and the current data for the hierarchical joint modeling step:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pooled_os_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    historical_os_data,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    current_os_data</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>pooled_tumor_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    historical_tumor_data,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    current_tumor_data</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>pooled_subj_df <span class="ot">&lt;-</span> pooled_os_data <span class="sc">|&gt;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>pooled_subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_subj_df,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>pooled_long_df <span class="ot">&lt;-</span> pooled_tumor_data <span class="sc">|&gt;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>pooled_long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_long_df,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>pooled_surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_os_data,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>pooled_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> pooled_subj_data,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> pooled_long_data,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> pooled_surv_data</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>So now we have pooled our 101 historical and 102 current patients into a single data set with 203 patients.</p>
</section>
<section id="fit-the-bayesian-hierarchical-joint-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-the-bayesian-hierarchical-joint-model">Fit the Bayesian hierarchical joint model</h2>
<p>Now we can fit the Bayesian hierarchical joint model to the pooled data set, borrowing information from the historical data to inform the current data analysis.</p>
<p>Note that we use the same model specification <code>historical_joint_mod</code> as for the historical data only model fit above. The reason is that the <code>LongitudinalSteinFojo</code> class already accounts for hierarchical modeling, see the statistical specification <a href="https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model">here</a>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/pooledmod1.rds"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    pooled_joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    pooled_joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        historical_joint_mod,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> pooled_joint_data,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(pooled_joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s first check again if the MCMC sampling went fine:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mcmc_pooled_joint_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(pooled_joint_results)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>mcmc_pooled_summary <span class="ot">&lt;-</span> mcmc_pooled_joint_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mcmc_pooled_summary, <span class="at">n =</span> <span class="dv">30</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 10
   variable         mean   median      sd     mad      q5     q95  rhat ess_bulk
   &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1 lm_sf_mu_bs…  3.75     3.75    0.0578  0.0577   3.65    3.84   1.02      247.
 2 lm_sf_mu_bs…  3.76     3.76    0.0490  0.0479   3.67    3.84   1.02      140.
 3 lm_sf_mu_ks… -0.0438  -0.0213  0.228   0.215   -0.454   0.301  1.01      582.
 4 lm_sf_mu_ks… -1.04    -1.01    0.316   0.305   -1.58   -0.581  1.00      618.
 5 lm_sf_mu_kg… -0.587   -0.581   0.129   0.133   -0.807  -0.386  1.01      510.
 6 lm_sf_mu_kg… -0.873   -0.875   0.141   0.144   -1.10   -0.646  1.00      519.
 7 lm_sf_sigma   0.129    0.129   0.00366 0.00361  0.123   0.136  1.00      719.
 8 lm_sf_omega…  0.573    0.569   0.0408  0.0416   0.514   0.644  1.00      393.
 9 lm_sf_omega…  0.492    0.487   0.0370  0.0360   0.436   0.555  1.00      386.
10 lm_sf_omega…  0.956    0.945   0.165   0.163    0.720   1.24   1.01      530.
11 lm_sf_omega…  1.35     1.32    0.248   0.227    1.02    1.79   1.01      512.
12 lm_sf_omega…  0.682    0.675   0.0831  0.0826   0.557   0.827  1.00      884.
13 lm_sf_omega…  0.961    0.950   0.101   0.0995   0.810   1.14   1.00      595.
14 beta_os_cov…  1.16     1.15    0.285   0.285    0.687   1.62   1.00      934.
15 beta_os_cov…  0.00105  0.00131 0.0118  0.0114  -0.0190  0.0202 0.999     965.
16 beta_os_cov…  1.16     1.16    0.508   0.489    0.338   1.97   1.00     1003.
17 beta_os_cov…  0.171    0.167   0.299   0.301   -0.303   0.666  1.00      897.
18 beta_os_cov…  0.263    0.262   0.262   0.268   -0.159   0.708  1.00      834.
19 sm_weibull_…  1.92     1.91    0.201   0.195    1.60    2.25   0.998     930.
20 sm_weibull_…  0.255    0.191   0.212   0.137    0.0551  0.699  1.00     1002.
21 link_growth   1.18     1.18    0.281   0.276    0.708   1.64   0.999     816.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Indeed all <code>rhat</code> values are close to 1 indicating convergence.</p>
</section>
<section id="investigating-the-parameter-estimates" class="level2">
<h2 class="anchored" data-anchor-id="investigating-the-parameter-estimates">Investigating the parameter estimates</h2>
<p>We can see that now we have more model parameters, let’s see which are additional compared to the historical data only model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pooled_param_names <span class="ot">&lt;-</span> mcmc_pooled_summary<span class="sc">$</span>variable</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>historical_param_names <span class="ot">&lt;-</span> mcmc_historical_summary<span class="sc">$</span>variable</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>new_params <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(pooled_param_names, historical_param_names)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>new_params</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "lm_sf_mu_bsld[2]"    "lm_sf_omega_bsld[2]"</code></pre>
</div>
</div>
<p>We see that the additional parameters correspond to the baseline value, which is supposed to differ between studies: both the mean <code>mu</code> parameter and the standard deviation <code>omega</code> parameter gain an additional second dimension here with the addition of the second study.</p>
<p>Let’s look at the estimates of these new parameters and compare them between the studies:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lm_sf_mu_bsld"</span>, <span class="st">"lm_sf_omega_bsld"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>baseline_pooled_joint_results <span class="ot">&lt;-</span> mcmc_pooled_joint_results<span class="sc">$</span><span class="fu">draws</span>(baseline_vars)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(baseline_pooled_joint_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_bhm-jmpost_files/figure-html/summarize_new_params-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert draws to rvars for easier manipulation</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>baseline_rvars <span class="ot">&lt;-</span> <span class="fu">as_draws_rvars</span>(baseline_pooled_joint_results)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>mu_diff <span class="ot">&lt;-</span> baseline_rvars<span class="sc">$</span>lm_sf_mu_bsld[<span class="dv">1</span>] <span class="sc">-</span> baseline_rvars<span class="sc">$</span>lm_sf_mu_bsld[<span class="dv">2</span>]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mu_diff)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable     mean   median     sd    mad     q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 mu_diff  -0.00927 -0.00803 0.0742 0.0752 -0.134 0.112  1.00     228.     356.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>omega_diff <span class="ot">&lt;-</span> baseline_rvars<span class="sc">$</span>lm_sf_omega_bsld[<span class="dv">1</span>] <span class="sc">-</span> baseline_rvars<span class="sc">$</span>lm_sf_omega_bsld[<span class="dv">2</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(omega_diff)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable     mean median     sd    mad       q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 omega_diff 0.0812 0.0803 0.0553 0.0548 -0.00772 0.172  1.00     351.     601.</code></pre>
</div>
</div>
<p>As expected we don’t see a big difference in the baseline SLD between the historical and current study, neither in the mean nor in the standard deviation.</p>
</section>
<section id="goodness-of-fit" class="level2">
<h2 class="anchored" data-anchor-id="goodness-of-fit">Goodness of fit</h2>
<p>Let’s check the goodness of fit to our current study data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>current_subj_df <span class="ot">&lt;-</span> current_os_data <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fu">max</span>(pooled_os_data<span class="sc">$</span>os_time), <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>current_os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        current_subj_df,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>current_os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> pooled_joint_results,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> current_os_surv_group_grid,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(current_os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_bhm-jmpost_files/figure-html/gof_pooled_model-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So the fit looks satisfactory, considering that the current data are quite immature.</p>
</section>
<section id="posterior-distribution-of-the-hazard-ratio" class="level2">
<h2 class="anchored" data-anchor-id="posterior-distribution-of-the-hazard-ratio">Posterior distribution of the hazard ratio</h2>
<p>Now let’s look at the posterior distribution of the hazard ratio between the two treatment arms in the current study. We do this as follows:</p>
<ul>
<li>For a given MCMC sample <span class="math inline">\(i\)</span>:
<ul>
<li>Sample predicted survival times for the current study subjects which are still being followed up</li>
<li>Fit a Cox proportional hazards regression model</li>
<li>Extract the hazard ratio estimate</li>
</ul></li>
<li>Repeat for all MCMC samples to get the posterior distribution of the hazard ratio</li>
</ul>
<p>This is the same algorithm we used in the session 4 <a href="https://rconis.github.io/tgi-os-training/session-pts/1_pts-jmpost.html#individual-samples-based-predictive-power">here</a>.</p>
<p>In this example we assume for simplicity:</p>
<ul>
<li>no additional patients will be enrolled, i.e.&nbsp;we don’t need to add new patients to the data set</li>
<li>all currently censored patients will be followed up until event occurs</li>
</ul>
<p>Therefore we can directly jump into the sampling step as described <a href="https://rconis.github.io/tgi-os-training/session-pts/1_pts-jmpost.html#rcpp-implementation-for-all-patients-and-samples">here</a>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine for which patients we want to sample the individual survival times.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pt_to_sample <span class="ot">&lt;-</span> pooled_os_data <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(study <span class="sc">==</span> <span class="st">"current"</span> <span class="sc">&amp;</span> os_event <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>pt_to_sample_ids <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>id</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the survival function samples (for all patients here).</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>length_time_grid <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>time_grid_end <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(pooled_os_data<span class="sc">$</span>os_time) <span class="sc">+</span> <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, time_grid_end, <span class="at">length =</span> length_time_grid)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/bhm1_surv_samples.rds"</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">object =</span> pooled_joint_results,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_surv_samples, <span class="at">file =</span> save_file)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> os_surv_samples<span class="sc">@</span>quantities</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>include_qs <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups <span class="sc">%in%</span> pt_to_sample_ids</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>qs_samples <span class="ot">&lt;-</span> qs<span class="sc">@</span>quantities[, include_qs]</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>qs_times <span class="ot">&lt;-</span> qs<span class="sc">@</span>times[include_qs]</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>qs_groups <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups[include_qs]</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>surv_values_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    qs_samples,</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER <span class="sc">*</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> length_time_grid</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>surv_values_pt_ids <span class="ot">&lt;-</span> <span class="fu">rep</span>(</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)),</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">each =</span> ITER</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>censoring_times <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>os_time[<span class="fu">match</span>(</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    surv_values_pt_ids,</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Rcpp function for single patient, single sample.</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="fu">here</span>(<span class="st">"session-pts/conditional_sampling.cpp"</span>))</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>cond_surv_time_samples <span class="ot">&lt;-</span> <span class="fu">sample_conditional_survival_times</span>(</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> time_grid,</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> surv_values_samples,</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_times =</span> censoring_times</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>os_cond_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    cond_surv_time_samples<span class="sc">$</span>t_results,</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER,</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">seq_len</span>(ITER), <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)))</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The next step is again to create the complete OS data sets. Here we just use the current data set and replace the censored times with the sampled times above:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>os_rows_to_replace <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    current_os_data<span class="sc">$</span>id</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>os_cond_samples_cols <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(os_cond_samples)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>os_data_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="cf">function</span>(i) {</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the original OS data</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    os_data_sample <span class="ot">&lt;-</span> current_os_data[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"arm"</span>, <span class="st">"os_time"</span>, <span class="st">"os_event"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"ecog"</span>, <span class="st">"age"</span>)]</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the sampled OS times for the patients who are still being followed up.</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_time[os_rows_to_replace] <span class="ot">&lt;-</span> os_cond_samples[</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        os_cond_samples_cols</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the OS event to TRUE for those patients, because we assume they have an event now.</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_event[os_rows_to_replace] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    os_data_sample</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we can fit a Cox proportional hazards regression model to each of the completed data sets and extract the hazard ratio estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>hr_est_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    cox_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>(<span class="fu">unname</span>(<span class="fu">coef</span>(cox_mod)))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We can try on one data set first:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hr_est_fun</span>(os_data_samples[[<span class="dv">1</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8503437</code></pre>
</div>
</div>
<p>Now we can apply this to all data sets:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>hr_estimates <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, hr_est_fun)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We can visualize this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>hr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hr =</span> hr_estimates)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hr_df, <span class="fu">aes</span>(<span class="at">x =</span> hr)) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Hazard Ratio (treatment vs. control)"</span>) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior Distribution of Hazard Ratio in Current Study"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_bhm-jmpost_files/figure-html/plot_hr_posterior-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="probability-of-success" class="level2">
<h2 class="anchored" data-anchor-id="probability-of-success">Probability of success</h2>
<p>Let’s assume the minimal detectable difference, i.e.&nbsp;the hazard ratio that we would consider clinically relevant, is 0.75. Then our probability of success is given by the posterior probability that the hazard ratio is below 0.75:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(hr_estimates <span class="sc">&lt;</span> <span class="fl">0.75</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.326</code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> false</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>The purpose of this document is to show a minimal workflow for Bayesian hierarchical joint modeling for historical data borrowing using the <span class="in">`jmpost`</span> package.</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>Here we execute the R code from the setup and data preparation chapter, see the <span class="co">[</span><span class="ot">full code here</span><span class="co">](0_setup.qmd)</span>.</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup_and_load_data</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.duplicate.label =</span> <span class="st">"allow"</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-bhm/_setup.qmd"</span>),</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-bhm/_setup.R"</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-bhm/_setup.R"</span>))</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-bhm/_load_data.qmd"</span>),</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-bhm/_load_data.R"</span>)</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-bhm/_load_data.R"</span>))</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## Descriptive analysis of the current study data</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>Let's have a quick look at the (artificially reduced to maximum 1 year follow-up) current study data, in order to illustrate the typical situation where we have immature OS data:</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: descriptive_current_data</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall Survival KM plot</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>fit_os_current <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> current_os_data)</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>    fit_os_current,</span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> current_os_data,</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">pval =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overall Survival in Current Study"</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>So no matter which model we might fit to this data, we will not be able to trust it to estimate the hazard ratio reliably.</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check compatibility of historical and current data</span></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>Just to mention that we would need to double check the compatibility of historical and current clinical trial design (including patient populations, endpoints, assessment schedules, etc.) and data distributions before applying any kind of historical data borrowing technique.</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>In our dummy example here, this is fulfilled by construction.</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting the joint model only to the historical data</span></span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>The first step is to fit the joint model only to the historical data. In reality, this also includes model selection in order to determine:</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>choice of parametric baseline survival model (log-logistic, Weibull, etc.?)</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>selection of baseline covariates</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>choice of the TGI metric to correlate with the survival model, i.e. the link function (SLD, tumor growth rate, time to tumor regrowth, etc.?)</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>We have discussed model comparison and selection in session 3 <span class="co">[</span><span class="ot">here</span><span class="co">](https://rconis.github.io/tgi-os-training/session-jm/1_jm-jmpost.html#model-comparison)</span>, so we will skip this step here and directly fit a joint model to the historical data only.</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_joint_model_historical</span></span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>historical_subj_df <span class="ot">&lt;-</span> historical_os_data <span class="sc">|&gt;</span></span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a>historical_subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_subj_df,</span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>historical_long_df <span class="ot">&lt;-</span> historical_tumor_data <span class="sc">|&gt;</span></span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a>historical_long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_long_df,</span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a>historical_surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_os_data,</span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a>historical_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> historical_subj_data,</span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> historical_long_data,</span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> historical_surv_data</span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a>historical_joint_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="fu">linkGrowth</span>(</span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">prior =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.999</span>)</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/histmod1.rds"</span>)</span>
<span id="cb36-143"><a href="#cb36-143" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb36-144"><a href="#cb36-144" aria-hidden="true" tabindex="-1"></a>    historical_joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>    historical_joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a>        historical_joint_mod,</span>
<span id="cb36-148"><a href="#cb36-148" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> historical_joint_data,</span>
<span id="cb36-149"><a href="#cb36-149" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb36-150"><a href="#cb36-150" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb36-151"><a href="#cb36-151" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb36-152"><a href="#cb36-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb36-153"><a href="#cb36-153" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb36-154"><a href="#cb36-154" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb36-155"><a href="#cb36-155" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb36-156"><a href="#cb36-156" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-157"><a href="#cb36-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(historical_joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb36-158"><a href="#cb36-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-159"><a href="#cb36-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-160"><a href="#cb36-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-161"><a href="#cb36-161" aria-hidden="true" tabindex="-1"></a>Let's have a look at the results:</span>
<span id="cb36-162"><a href="#cb36-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-165"><a href="#cb36-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-166"><a href="#cb36-166" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: summarize_historical_model</span></span>
<span id="cb36-167"><a href="#cb36-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-168"><a href="#cb36-168" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb36-169"><a href="#cb36-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb36-170"><a href="#cb36-170" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb36-171"><a href="#cb36-171" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb36-172"><a href="#cb36-172" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb36-173"><a href="#cb36-173" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb36-174"><a href="#cb36-174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb36-175"><a href="#cb36-175" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span>,</span>
<span id="cb36-176"><a href="#cb36-176" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb36-177"><a href="#cb36-177" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb36-178"><a href="#cb36-178" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span>,</span>
<span id="cb36-179"><a href="#cb36-179" aria-hidden="true" tabindex="-1"></a>    <span class="st">"link_growth"</span></span>
<span id="cb36-180"><a href="#cb36-180" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-181"><a href="#cb36-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-182"><a href="#cb36-182" aria-hidden="true" tabindex="-1"></a>mcmc_historical_joint_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(historical_joint_results)</span>
<span id="cb36-183"><a href="#cb36-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-184"><a href="#cb36-184" aria-hidden="true" tabindex="-1"></a>mcmc_historical_summary <span class="ot">&lt;-</span> mcmc_historical_joint_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb36-185"><a href="#cb36-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-186"><a href="#cb36-186" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mcmc_historical_summary, <span class="at">n =</span> <span class="dv">30</span>)</span>
<span id="cb36-187"><a href="#cb36-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-188"><a href="#cb36-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-189"><a href="#cb36-189" aria-hidden="true" tabindex="-1"></a>Let's also look at the covariate effect estimates again:</span>
<span id="cb36-190"><a href="#cb36-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-193"><a href="#cb36-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-194"><a href="#cb36-194" aria-hidden="true" tabindex="-1"></a>os_cov_name_mapping <span class="ot">&lt;-</span> <span class="cf">function</span>(surv_data) {</span>
<span id="cb36-195"><a href="#cb36-195" aria-hidden="true" tabindex="-1"></a>    surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb36-196"><a href="#cb36-196" aria-hidden="true" tabindex="-1"></a>    os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb36-197"><a href="#cb36-197" aria-hidden="true" tabindex="-1"></a>    old_coef_names <span class="ot">&lt;-</span> <span class="fu">as.character</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>))</span>
<span id="cb36-198"><a href="#cb36-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(old_coef_names, os_cov_names)</span>
<span id="cb36-199"><a href="#cb36-199" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-200"><a href="#cb36-200" aria-hidden="true" tabindex="-1"></a>os_cov_renaming <span class="ot">&lt;-</span> <span class="fu">os_cov_name_mapping</span>(historical_surv_data)</span>
<span id="cb36-201"><a href="#cb36-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-202"><a href="#cb36-202" aria-hidden="true" tabindex="-1"></a>draws_historical_joint_results <span class="ot">&lt;-</span> mcmc_historical_joint_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb36-203"><a href="#cb36-203" aria-hidden="true" tabindex="-1"></a>draws_historical_joint_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb36-204"><a href="#cb36-204" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb36-205"><a href="#cb36-205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_historical_joint_results), os_cov_renaming)</span>
<span id="cb36-206"><a href="#cb36-206" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-207"><a href="#cb36-207" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_historical_joint_results) <span class="sc">+</span></span>
<span id="cb36-208"><a href="#cb36-208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb36-209"><a href="#cb36-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-210"><a href="#cb36-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-211"><a href="#cb36-211" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pool historical and current data</span></span>
<span id="cb36-212"><a href="#cb36-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-213"><a href="#cb36-213" aria-hidden="true" tabindex="-1"></a>Now we pool the historical and the current data for the hierarchical joint modeling step:</span>
<span id="cb36-214"><a href="#cb36-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-217"><a href="#cb36-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-218"><a href="#cb36-218" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pool_data</span></span>
<span id="cb36-219"><a href="#cb36-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-220"><a href="#cb36-220" aria-hidden="true" tabindex="-1"></a>pooled_os_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb36-221"><a href="#cb36-221" aria-hidden="true" tabindex="-1"></a>    historical_os_data,</span>
<span id="cb36-222"><a href="#cb36-222" aria-hidden="true" tabindex="-1"></a>    current_os_data</span>
<span id="cb36-223"><a href="#cb36-223" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-224"><a href="#cb36-224" aria-hidden="true" tabindex="-1"></a>pooled_tumor_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb36-225"><a href="#cb36-225" aria-hidden="true" tabindex="-1"></a>    historical_tumor_data,</span>
<span id="cb36-226"><a href="#cb36-226" aria-hidden="true" tabindex="-1"></a>    current_tumor_data</span>
<span id="cb36-227"><a href="#cb36-227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-228"><a href="#cb36-228" aria-hidden="true" tabindex="-1"></a>pooled_subj_df <span class="ot">&lt;-</span> pooled_os_data <span class="sc">|&gt;</span></span>
<span id="cb36-229"><a href="#cb36-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb36-230"><a href="#cb36-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-231"><a href="#cb36-231" aria-hidden="true" tabindex="-1"></a>pooled_subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb36-232"><a href="#cb36-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_subj_df,</span>
<span id="cb36-233"><a href="#cb36-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb36-234"><a href="#cb36-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb36-235"><a href="#cb36-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb36-236"><a href="#cb36-236" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-237"><a href="#cb36-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-238"><a href="#cb36-238" aria-hidden="true" tabindex="-1"></a>pooled_long_df <span class="ot">&lt;-</span> pooled_tumor_data <span class="sc">|&gt;</span></span>
<span id="cb36-239"><a href="#cb36-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb36-240"><a href="#cb36-240" aria-hidden="true" tabindex="-1"></a>pooled_long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb36-241"><a href="#cb36-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_long_df,</span>
<span id="cb36-242"><a href="#cb36-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb36-243"><a href="#cb36-243" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-244"><a href="#cb36-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-245"><a href="#cb36-245" aria-hidden="true" tabindex="-1"></a>pooled_surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb36-246"><a href="#cb36-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pooled_os_data,</span>
<span id="cb36-247"><a href="#cb36-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb36-248"><a href="#cb36-248" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-249"><a href="#cb36-249" aria-hidden="true" tabindex="-1"></a>pooled_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb36-250"><a href="#cb36-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> pooled_subj_data,</span>
<span id="cb36-251"><a href="#cb36-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> pooled_long_data,</span>
<span id="cb36-252"><a href="#cb36-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> pooled_surv_data</span>
<span id="cb36-253"><a href="#cb36-253" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-254"><a href="#cb36-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-255"><a href="#cb36-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-256"><a href="#cb36-256" aria-hidden="true" tabindex="-1"></a>So now we have pooled our <span class="in">`r nrow(historical_os_data)`</span> historical and <span class="in">`r nrow(current_os_data)`</span> current patients into a single data set with <span class="in">`r nrow(pooled_os_data)`</span> patients.</span>
<span id="cb36-257"><a href="#cb36-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-258"><a href="#cb36-258" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit the Bayesian hierarchical joint model</span></span>
<span id="cb36-259"><a href="#cb36-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-260"><a href="#cb36-260" aria-hidden="true" tabindex="-1"></a>Now we can fit the Bayesian hierarchical joint model to the pooled data set, borrowing information from the historical data to inform the current data analysis.</span>
<span id="cb36-261"><a href="#cb36-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-262"><a href="#cb36-262" aria-hidden="true" tabindex="-1"></a>Note that we use the same model specification <span class="in">`historical_joint_mod`</span> as for the historical data only model fit above. </span>
<span id="cb36-263"><a href="#cb36-263" aria-hidden="true" tabindex="-1"></a>The reason is that the <span class="in">`LongitudinalSteinFojo`</span> class already accounts for hierarchical modeling, see the statistical specification <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model)</span>.</span>
<span id="cb36-264"><a href="#cb36-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-267"><a href="#cb36-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-268"><a href="#cb36-268" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_pooled_joint_model</span></span>
<span id="cb36-269"><a href="#cb36-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-270"><a href="#cb36-270" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/pooledmod1.rds"</span>)</span>
<span id="cb36-271"><a href="#cb36-271" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb36-272"><a href="#cb36-272" aria-hidden="true" tabindex="-1"></a>    pooled_joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb36-273"><a href="#cb36-273" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-274"><a href="#cb36-274" aria-hidden="true" tabindex="-1"></a>    pooled_joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb36-275"><a href="#cb36-275" aria-hidden="true" tabindex="-1"></a>        historical_joint_mod,</span>
<span id="cb36-276"><a href="#cb36-276" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> pooled_joint_data,</span>
<span id="cb36-277"><a href="#cb36-277" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb36-278"><a href="#cb36-278" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb36-279"><a href="#cb36-279" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb36-280"><a href="#cb36-280" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb36-281"><a href="#cb36-281" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb36-282"><a href="#cb36-282" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb36-283"><a href="#cb36-283" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb36-284"><a href="#cb36-284" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-285"><a href="#cb36-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(pooled_joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb36-286"><a href="#cb36-286" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-287"><a href="#cb36-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-288"><a href="#cb36-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-289"><a href="#cb36-289" aria-hidden="true" tabindex="-1"></a>Let's first check again if the MCMC sampling went fine:</span>
<span id="cb36-290"><a href="#cb36-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-293"><a href="#cb36-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-294"><a href="#cb36-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_pooled_model</span></span>
<span id="cb36-295"><a href="#cb36-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-296"><a href="#cb36-296" aria-hidden="true" tabindex="-1"></a>mcmc_pooled_joint_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(pooled_joint_results)</span>
<span id="cb36-297"><a href="#cb36-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-298"><a href="#cb36-298" aria-hidden="true" tabindex="-1"></a>mcmc_pooled_summary <span class="ot">&lt;-</span> mcmc_pooled_joint_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb36-299"><a href="#cb36-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-300"><a href="#cb36-300" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mcmc_pooled_summary, <span class="at">n =</span> <span class="dv">30</span>)</span>
<span id="cb36-301"><a href="#cb36-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-302"><a href="#cb36-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-303"><a href="#cb36-303" aria-hidden="true" tabindex="-1"></a>Indeed all <span class="in">`rhat`</span> values are close to 1 indicating convergence.</span>
<span id="cb36-304"><a href="#cb36-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-305"><a href="#cb36-305" aria-hidden="true" tabindex="-1"></a><span class="fu">## Investigating the parameter estimates</span></span>
<span id="cb36-306"><a href="#cb36-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-307"><a href="#cb36-307" aria-hidden="true" tabindex="-1"></a>We can see that now we have more model parameters, let's see which are additional compared to the historical data only model:</span>
<span id="cb36-308"><a href="#cb36-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-311"><a href="#cb36-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-312"><a href="#cb36-312" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compare_pooled_historical</span></span>
<span id="cb36-313"><a href="#cb36-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-314"><a href="#cb36-314" aria-hidden="true" tabindex="-1"></a>pooled_param_names <span class="ot">&lt;-</span> mcmc_pooled_summary<span class="sc">$</span>variable</span>
<span id="cb36-315"><a href="#cb36-315" aria-hidden="true" tabindex="-1"></a>historical_param_names <span class="ot">&lt;-</span> mcmc_historical_summary<span class="sc">$</span>variable</span>
<span id="cb36-316"><a href="#cb36-316" aria-hidden="true" tabindex="-1"></a>new_params <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(pooled_param_names, historical_param_names)</span>
<span id="cb36-317"><a href="#cb36-317" aria-hidden="true" tabindex="-1"></a>new_params</span>
<span id="cb36-318"><a href="#cb36-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-319"><a href="#cb36-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-320"><a href="#cb36-320" aria-hidden="true" tabindex="-1"></a>We see that the additional parameters correspond to the baseline value, which is supposed to differ between studies: both the mean <span class="in">`mu`</span> parameter and the standard deviation <span class="in">`omega`</span> parameter gain an additional second dimension here with the addition of the second study.</span>
<span id="cb36-321"><a href="#cb36-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-322"><a href="#cb36-322" aria-hidden="true" tabindex="-1"></a>Let's look at the estimates of these new parameters and compare them between the studies:</span>
<span id="cb36-323"><a href="#cb36-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-326"><a href="#cb36-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-327"><a href="#cb36-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: summarize_new_params</span></span>
<span id="cb36-328"><a href="#cb36-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-329"><a href="#cb36-329" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lm_sf_mu_bsld"</span>, <span class="st">"lm_sf_omega_bsld"</span>)</span>
<span id="cb36-330"><a href="#cb36-330" aria-hidden="true" tabindex="-1"></a>baseline_pooled_joint_results <span class="ot">&lt;-</span> mcmc_pooled_joint_results<span class="sc">$</span><span class="fu">draws</span>(baseline_vars)</span>
<span id="cb36-331"><a href="#cb36-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-332"><a href="#cb36-332" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(baseline_pooled_joint_results)</span>
<span id="cb36-333"><a href="#cb36-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-334"><a href="#cb36-334" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb36-335"><a href="#cb36-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-336"><a href="#cb36-336" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert draws to rvars for easier manipulation</span></span>
<span id="cb36-337"><a href="#cb36-337" aria-hidden="true" tabindex="-1"></a>baseline_rvars <span class="ot">&lt;-</span> <span class="fu">as_draws_rvars</span>(baseline_pooled_joint_results)</span>
<span id="cb36-338"><a href="#cb36-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-339"><a href="#cb36-339" aria-hidden="true" tabindex="-1"></a>mu_diff <span class="ot">&lt;-</span> baseline_rvars<span class="sc">$</span>lm_sf_mu_bsld[<span class="dv">1</span>] <span class="sc">-</span> baseline_rvars<span class="sc">$</span>lm_sf_mu_bsld[<span class="dv">2</span>]</span>
<span id="cb36-340"><a href="#cb36-340" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mu_diff)</span>
<span id="cb36-341"><a href="#cb36-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-342"><a href="#cb36-342" aria-hidden="true" tabindex="-1"></a>omega_diff <span class="ot">&lt;-</span> baseline_rvars<span class="sc">$</span>lm_sf_omega_bsld[<span class="dv">1</span>] <span class="sc">-</span> baseline_rvars<span class="sc">$</span>lm_sf_omega_bsld[<span class="dv">2</span>]</span>
<span id="cb36-343"><a href="#cb36-343" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(omega_diff)</span>
<span id="cb36-344"><a href="#cb36-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-345"><a href="#cb36-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-346"><a href="#cb36-346" aria-hidden="true" tabindex="-1"></a>As expected we don't see a big difference in the baseline SLD between the historical and current study, neither in the mean nor in the standard deviation.</span>
<span id="cb36-347"><a href="#cb36-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-348"><a href="#cb36-348" aria-hidden="true" tabindex="-1"></a><span class="fu">## Goodness of fit</span></span>
<span id="cb36-349"><a href="#cb36-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-350"><a href="#cb36-350" aria-hidden="true" tabindex="-1"></a>Let's check the goodness of fit to our current study data:</span>
<span id="cb36-351"><a href="#cb36-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-354"><a href="#cb36-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-355"><a href="#cb36-355" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gof_pooled_model</span></span>
<span id="cb36-356"><a href="#cb36-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-357"><a href="#cb36-357" aria-hidden="true" tabindex="-1"></a>current_subj_df <span class="ot">&lt;-</span> current_os_data <span class="sc">|&gt;</span></span>
<span id="cb36-358"><a href="#cb36-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb36-359"><a href="#cb36-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-360"><a href="#cb36-360" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fu">max</span>(pooled_os_data<span class="sc">$</span>os_time), <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb36-361"><a href="#cb36-361" aria-hidden="true" tabindex="-1"></a>current_os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb36-362"><a href="#cb36-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb36-363"><a href="#cb36-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb36-364"><a href="#cb36-364" aria-hidden="true" tabindex="-1"></a>        current_subj_df,</span>
<span id="cb36-365"><a href="#cb36-365" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb36-366"><a href="#cb36-366" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-367"><a href="#cb36-367" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-368"><a href="#cb36-368" aria-hidden="true" tabindex="-1"></a>current_os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb36-369"><a href="#cb36-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> pooled_joint_results,</span>
<span id="cb36-370"><a href="#cb36-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> current_os_surv_group_grid,</span>
<span id="cb36-371"><a href="#cb36-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb36-372"><a href="#cb36-372" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-373"><a href="#cb36-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-374"><a href="#cb36-374" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(current_os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb36-375"><a href="#cb36-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-376"><a href="#cb36-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-377"><a href="#cb36-377" aria-hidden="true" tabindex="-1"></a>So the fit looks satisfactory, considering that the current data are quite immature.</span>
<span id="cb36-378"><a href="#cb36-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-379"><a href="#cb36-379" aria-hidden="true" tabindex="-1"></a><span class="fu">## Posterior distribution of the hazard ratio</span></span>
<span id="cb36-380"><a href="#cb36-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-381"><a href="#cb36-381" aria-hidden="true" tabindex="-1"></a>Now let's look at the posterior distribution of the hazard ratio between the two treatment arms in the current study.</span>
<span id="cb36-382"><a href="#cb36-382" aria-hidden="true" tabindex="-1"></a>We do this as follows:</span>
<span id="cb36-383"><a href="#cb36-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-384"><a href="#cb36-384" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For a given MCMC sample $i$:</span>
<span id="cb36-385"><a href="#cb36-385" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Sample predicted survival times for the current study subjects which are still being followed up</span>
<span id="cb36-386"><a href="#cb36-386" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Fit a Cox proportional hazards regression model</span>
<span id="cb36-387"><a href="#cb36-387" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extract the hazard ratio estimate</span>
<span id="cb36-388"><a href="#cb36-388" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Repeat for all MCMC samples to get the posterior distribution of the hazard ratio</span>
<span id="cb36-389"><a href="#cb36-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-390"><a href="#cb36-390" aria-hidden="true" tabindex="-1"></a>This is the same algorithm we used in the session 4 <span class="co">[</span><span class="ot">here</span><span class="co">](https://rconis.github.io/tgi-os-training/session-pts/1_pts-jmpost.html#individual-samples-based-predictive-power)</span>.</span>
<span id="cb36-391"><a href="#cb36-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-392"><a href="#cb36-392" aria-hidden="true" tabindex="-1"></a>In this example we assume for simplicity:</span>
<span id="cb36-393"><a href="#cb36-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-394"><a href="#cb36-394" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>no additional patients will be enrolled, i.e. we don't need to add new patients to the data set</span>
<span id="cb36-395"><a href="#cb36-395" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>all currently censored patients will be followed up until event occurs</span>
<span id="cb36-396"><a href="#cb36-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-397"><a href="#cb36-397" aria-hidden="true" tabindex="-1"></a>Therefore we can directly jump into the sampling step as described <span class="co">[</span><span class="ot">here</span><span class="co">](https://rconis.github.io/tgi-os-training/session-pts/1_pts-jmpost.html#rcpp-implementation-for-all-patients-and-samples)</span>:</span>
<span id="cb36-398"><a href="#cb36-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-401"><a href="#cb36-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-402"><a href="#cb36-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sample_current_censored_os_times</span></span>
<span id="cb36-403"><a href="#cb36-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-404"><a href="#cb36-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine for which patients we want to sample the individual survival times.</span></span>
<span id="cb36-405"><a href="#cb36-405" aria-hidden="true" tabindex="-1"></a>pt_to_sample <span class="ot">&lt;-</span> pooled_os_data <span class="sc">|&gt;</span></span>
<span id="cb36-406"><a href="#cb36-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(study <span class="sc">==</span> <span class="st">"current"</span> <span class="sc">&amp;</span> os_event <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb36-407"><a href="#cb36-407" aria-hidden="true" tabindex="-1"></a>pt_to_sample_ids <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>id</span>
<span id="cb36-408"><a href="#cb36-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-409"><a href="#cb36-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the survival function samples (for all patients here).</span></span>
<span id="cb36-410"><a href="#cb36-410" aria-hidden="true" tabindex="-1"></a>length_time_grid <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb36-411"><a href="#cb36-411" aria-hidden="true" tabindex="-1"></a>time_grid_end <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(pooled_os_data<span class="sc">$</span>os_time) <span class="sc">+</span> <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb36-412"><a href="#cb36-412" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, time_grid_end, <span class="at">length =</span> length_time_grid)</span>
<span id="cb36-413"><a href="#cb36-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-414"><a href="#cb36-414" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-bhm/bhm1_surv_samples.rds"</span>)</span>
<span id="cb36-415"><a href="#cb36-415" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb36-416"><a href="#cb36-416" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb36-417"><a href="#cb36-417" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-418"><a href="#cb36-418" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb36-419"><a href="#cb36-419" aria-hidden="true" tabindex="-1"></a>        <span class="at">object =</span> pooled_joint_results,</span>
<span id="cb36-420"><a href="#cb36-420" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb36-421"><a href="#cb36-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb36-422"><a href="#cb36-422" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-423"><a href="#cb36-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_surv_samples, <span class="at">file =</span> save_file)</span>
<span id="cb36-424"><a href="#cb36-424" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-425"><a href="#cb36-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-426"><a href="#cb36-426" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> os_surv_samples<span class="sc">@</span>quantities</span>
<span id="cb36-427"><a href="#cb36-427" aria-hidden="true" tabindex="-1"></a>include_qs <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups <span class="sc">%in%</span> pt_to_sample_ids</span>
<span id="cb36-428"><a href="#cb36-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-429"><a href="#cb36-429" aria-hidden="true" tabindex="-1"></a>qs_samples <span class="ot">&lt;-</span> qs<span class="sc">@</span>quantities[, include_qs]</span>
<span id="cb36-430"><a href="#cb36-430" aria-hidden="true" tabindex="-1"></a>qs_times <span class="ot">&lt;-</span> qs<span class="sc">@</span>times[include_qs]</span>
<span id="cb36-431"><a href="#cb36-431" aria-hidden="true" tabindex="-1"></a>qs_groups <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups[include_qs]</span>
<span id="cb36-432"><a href="#cb36-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-433"><a href="#cb36-433" aria-hidden="true" tabindex="-1"></a>surv_values_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb36-434"><a href="#cb36-434" aria-hidden="true" tabindex="-1"></a>    qs_samples,</span>
<span id="cb36-435"><a href="#cb36-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER <span class="sc">*</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb36-436"><a href="#cb36-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> length_time_grid</span>
<span id="cb36-437"><a href="#cb36-437" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-438"><a href="#cb36-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-439"><a href="#cb36-439" aria-hidden="true" tabindex="-1"></a>surv_values_pt_ids <span class="ot">&lt;-</span> <span class="fu">rep</span>(</span>
<span id="cb36-440"><a href="#cb36-440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)),</span>
<span id="cb36-441"><a href="#cb36-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">each =</span> ITER</span>
<span id="cb36-442"><a href="#cb36-442" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-443"><a href="#cb36-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-444"><a href="#cb36-444" aria-hidden="true" tabindex="-1"></a>censoring_times <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>os_time[<span class="fu">match</span>(</span>
<span id="cb36-445"><a href="#cb36-445" aria-hidden="true" tabindex="-1"></a>    surv_values_pt_ids,</span>
<span id="cb36-446"><a href="#cb36-446" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids</span>
<span id="cb36-447"><a href="#cb36-447" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb36-448"><a href="#cb36-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-449"><a href="#cb36-449" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb36-450"><a href="#cb36-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-451"><a href="#cb36-451" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Rcpp function for single patient, single sample.</span></span>
<span id="cb36-452"><a href="#cb36-452" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="fu">here</span>(<span class="st">"session-pts/conditional_sampling.cpp"</span>))</span>
<span id="cb36-453"><a href="#cb36-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-454"><a href="#cb36-454" aria-hidden="true" tabindex="-1"></a>cond_surv_time_samples <span class="ot">&lt;-</span> <span class="fu">sample_conditional_survival_times</span>(</span>
<span id="cb36-455"><a href="#cb36-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> time_grid,</span>
<span id="cb36-456"><a href="#cb36-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> surv_values_samples,</span>
<span id="cb36-457"><a href="#cb36-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_times =</span> censoring_times</span>
<span id="cb36-458"><a href="#cb36-458" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-459"><a href="#cb36-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-460"><a href="#cb36-460" aria-hidden="true" tabindex="-1"></a>os_cond_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb36-461"><a href="#cb36-461" aria-hidden="true" tabindex="-1"></a>    cond_surv_time_samples<span class="sc">$</span>t_results,</span>
<span id="cb36-462"><a href="#cb36-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER,</span>
<span id="cb36-463"><a href="#cb36-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb36-464"><a href="#cb36-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">seq_len</span>(ITER), <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)))</span>
<span id="cb36-465"><a href="#cb36-465" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-466"><a href="#cb36-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-467"><a href="#cb36-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-468"><a href="#cb36-468" aria-hidden="true" tabindex="-1"></a>The next step is again to create the complete OS data sets. Here we just use the current data set and replace the censored times with the sampled times above:</span>
<span id="cb36-469"><a href="#cb36-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-472"><a href="#cb36-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-473"><a href="#cb36-473" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create_complete_os_datasets</span></span>
<span id="cb36-474"><a href="#cb36-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-475"><a href="#cb36-475" aria-hidden="true" tabindex="-1"></a>os_rows_to_replace <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb36-476"><a href="#cb36-476" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb36-477"><a href="#cb36-477" aria-hidden="true" tabindex="-1"></a>    current_os_data<span class="sc">$</span>id</span>
<span id="cb36-478"><a href="#cb36-478" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-479"><a href="#cb36-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-480"><a href="#cb36-480" aria-hidden="true" tabindex="-1"></a>os_cond_samples_cols <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb36-481"><a href="#cb36-481" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb36-482"><a href="#cb36-482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(os_cond_samples)</span>
<span id="cb36-483"><a href="#cb36-483" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-484"><a href="#cb36-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-485"><a href="#cb36-485" aria-hidden="true" tabindex="-1"></a>os_data_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="cf">function</span>(i) {</span>
<span id="cb36-486"><a href="#cb36-486" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the original OS data</span></span>
<span id="cb36-487"><a href="#cb36-487" aria-hidden="true" tabindex="-1"></a>    os_data_sample <span class="ot">&lt;-</span> current_os_data[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"arm"</span>, <span class="st">"os_time"</span>, <span class="st">"os_event"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"ecog"</span>, <span class="st">"age"</span>)]</span>
<span id="cb36-488"><a href="#cb36-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-489"><a href="#cb36-489" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the sampled OS times for the patients who are still being followed up.</span></span>
<span id="cb36-490"><a href="#cb36-490" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_time[os_rows_to_replace] <span class="ot">&lt;-</span> os_cond_samples[</span>
<span id="cb36-491"><a href="#cb36-491" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb36-492"><a href="#cb36-492" aria-hidden="true" tabindex="-1"></a>        os_cond_samples_cols</span>
<span id="cb36-493"><a href="#cb36-493" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb36-494"><a href="#cb36-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-495"><a href="#cb36-495" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the OS event to TRUE for those patients, because we assume they have an event now.</span></span>
<span id="cb36-496"><a href="#cb36-496" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_event[os_rows_to_replace] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb36-497"><a href="#cb36-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-498"><a href="#cb36-498" aria-hidden="true" tabindex="-1"></a>    os_data_sample</span>
<span id="cb36-499"><a href="#cb36-499" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-500"><a href="#cb36-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-501"><a href="#cb36-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-502"><a href="#cb36-502" aria-hidden="true" tabindex="-1"></a>Now we can fit a Cox proportional hazards regression model to each of the completed data sets and extract the hazard ratio estimates:</span>
<span id="cb36-503"><a href="#cb36-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-506"><a href="#cb36-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-507"><a href="#cb36-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_cox_models</span></span>
<span id="cb36-508"><a href="#cb36-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-509"><a href="#cb36-509" aria-hidden="true" tabindex="-1"></a>hr_est_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb36-510"><a href="#cb36-510" aria-hidden="true" tabindex="-1"></a>    cox_mod <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm,</span>
<span id="cb36-511"><a href="#cb36-511" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb36-512"><a href="#cb36-512" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-513"><a href="#cb36-513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>(<span class="fu">unname</span>(<span class="fu">coef</span>(cox_mod)))</span>
<span id="cb36-514"><a href="#cb36-514" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-515"><a href="#cb36-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-516"><a href="#cb36-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-517"><a href="#cb36-517" aria-hidden="true" tabindex="-1"></a>We can try on one data set first:</span>
<span id="cb36-518"><a href="#cb36-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-521"><a href="#cb36-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-522"><a href="#cb36-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test_hr_estimation</span></span>
<span id="cb36-523"><a href="#cb36-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-524"><a href="#cb36-524" aria-hidden="true" tabindex="-1"></a><span class="fu">hr_est_fun</span>(os_data_samples[[<span class="dv">1</span>]])</span>
<span id="cb36-525"><a href="#cb36-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-526"><a href="#cb36-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-527"><a href="#cb36-527" aria-hidden="true" tabindex="-1"></a>Now we can apply this to all data sets:</span>
<span id="cb36-528"><a href="#cb36-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-531"><a href="#cb36-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-532"><a href="#cb36-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: estimate_hr_posterior</span></span>
<span id="cb36-533"><a href="#cb36-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-534"><a href="#cb36-534" aria-hidden="true" tabindex="-1"></a>hr_estimates <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, hr_est_fun)</span>
<span id="cb36-535"><a href="#cb36-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-536"><a href="#cb36-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-537"><a href="#cb36-537" aria-hidden="true" tabindex="-1"></a>We can visualize this:</span>
<span id="cb36-538"><a href="#cb36-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-541"><a href="#cb36-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-542"><a href="#cb36-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_hr_posterior</span></span>
<span id="cb36-543"><a href="#cb36-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-544"><a href="#cb36-544" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb36-545"><a href="#cb36-545" aria-hidden="true" tabindex="-1"></a>hr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hr =</span> hr_estimates)</span>
<span id="cb36-546"><a href="#cb36-546" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hr_df, <span class="fu">aes</span>(<span class="at">x =</span> hr)) <span class="sc">+</span></span>
<span id="cb36-547"><a href="#cb36-547" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb36-548"><a href="#cb36-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb36-549"><a href="#cb36-549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Hazard Ratio (treatment vs. control)"</span>) <span class="sc">+</span></span>
<span id="cb36-550"><a href="#cb36-550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb36-551"><a href="#cb36-551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior Distribution of Hazard Ratio in Current Study"</span>)</span>
<span id="cb36-552"><a href="#cb36-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-553"><a href="#cb36-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-554"><a href="#cb36-554" aria-hidden="true" tabindex="-1"></a><span class="fu">## Probability of success</span></span>
<span id="cb36-555"><a href="#cb36-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-556"><a href="#cb36-556" aria-hidden="true" tabindex="-1"></a>Let's assume the minimal detectable difference, i.e. the hazard ratio that we would consider clinically relevant, is 0.75.</span>
<span id="cb36-557"><a href="#cb36-557" aria-hidden="true" tabindex="-1"></a>Then our probability of success is given by the posterior probability that the hazard ratio is below 0.75:</span>
<span id="cb36-558"><a href="#cb36-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-561"><a href="#cb36-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-562"><a href="#cb36-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_pts</span></span>
<span id="cb36-563"><a href="#cb36-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-564"><a href="#cb36-564" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(hr_estimates <span class="sc">&lt;</span> <span class="fl">0.75</span>)</span>
<span id="cb36-565"><a href="#cb36-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-bhm/1_bhm-jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>