<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-01-31">

<title>1. TGI model minimal workflow with brms – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-tgi/0_setup.html">Session 1: TGI</a></li><li class="breadcrumb-item"><a href="../session-tgi/1_tgi_sf_brms.html">1. TGI model minimal workflow with <code>brms</code></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">TGI-OS Training</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.io/RCONIS/tgi-os-training" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Index</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#stein-fojo-model" id="toc-stein-fojo-model" class="nav-link" data-scroll-target="#stein-fojo-model">Stein-Fojo model</a>
  <ul class="collapse">
  <li><a href="#mean" id="toc-mean" class="nav-link" data-scroll-target="#mean">Mean</a></li>
  <li><a href="#likelihood" id="toc-likelihood" class="nav-link" data-scroll-target="#likelihood">Likelihood</a></li>
  <li><a href="#random-effects" id="toc-random-effects" class="nav-link" data-scroll-target="#random-effects">Random effects</a></li>
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a></li>
  </ul></li>
  <li><a href="#fit-model" id="toc-fit-model" class="nav-link" data-scroll-target="#fit-model">Fit model</a></li>
  <li><a href="#parameter-estimates" id="toc-parameter-estimates" class="nav-link" data-scroll-target="#parameter-estimates">Parameter estimates</a></li>
  <li><a href="#observation-vs-model-fit" id="toc-observation-vs-model-fit" class="nav-link" data-scroll-target="#observation-vs-model-fit">Observation vs model fit</a></li>
  <li><a href="#adding-covariates" id="toc-adding-covariates" class="nav-link" data-scroll-target="#adding-covariates">Adding covariates</a></li>
  <li><a href="#model-comparison-with-loo" id="toc-model-comparison-with-loo" class="nav-link" data-scroll-target="#model-comparison-with-loo">Model comparison with LOO</a></li>
  <li><a href="#tips-and-tricks" id="toc-tips-and-tricks" class="nav-link" data-scroll-target="#tips-and-tricks">Tips and tricks</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-tgi/1_tgi_sf_brms.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-tgi/0_setup.html">Session 1: TGI</a></li><li class="breadcrumb-item"><a href="../session-tgi/1_tgi_sf_brms.html">1. TGI model minimal workflow with <code>brms</code></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">1. TGI model minimal workflow with <code>brms</code></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-01-31</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this document is to show a minimal workflow for fitting a TGI model using the <code>brms</code> package.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>First we need to load the necessary packages and set some default options for the MCMC sampling. We also set the theme for the plots to <code>theme_bw</code> with a base size of 12.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jmpost)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(truncnorm)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">require</span>(cmdstanr)) {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If cmdstanr is available, instruct brms to use cmdstanr as backend </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and cache all Stan binaries</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir =</span> <span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>) <span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  rstan<span class="sc">::</span><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC options</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">4</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># number of sampling iterations after warm up</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>WARMUP <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># number of warm up iterations</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>CHAINS <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>BAYES.SEED <span class="ot">&lt;-</span> <span class="dv">878</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>REFRESH <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also need a small function definition, which is still missing in <code>brms</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>int_step <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(x))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(x, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will use the publicly published tumor size data from the OAK study, see <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009822">here</a>. In particular we are using the <a href="https://doi.org/10.1371/journal.pcbi.1009822.s006">S1 data set</a>, which is the fully anonymized data set used in the publication. For simplicity, we have copied the data set in this GitHub repository.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/journal.pcbi.1009822.s006.xlsx"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>read_one_sheet <span class="ot">&lt;-</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_excel</span>(file_path, <span class="at">sheet =</span> sheet) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(patient_anonmyized)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">day =</span> <span class="fu">as.integer</span>(treatment_day),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> day <span class="sc">/</span> <span class="fl">365.25</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">target_lesion_long_diam_mm =</span> <span class="fu">case_match</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            target_lesion_long_diam_mm,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"TOO SMALL TO MEASURE"</span> <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NOT EVALUABLE"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">.default =</span> target_lesion_long_diam_mm</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">as.numeric</span>(target_lesion_long_diam_mm),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">ifelse</span>(sld <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">2</span>, sld),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">study =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_(</span><span class="sc">\\</span><span class="st">d+)_Arm_</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm)),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_</span><span class="sc">\\</span><span class="st">d+_Arm_(</span><span class="sc">\\</span><span class="st">d+)$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm))</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld, study, arm)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>tumor_data <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(file_path) <span class="sc">|&gt;</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(read_one_sheet) <span class="sc">|&gt;</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  id                      year   sld study arm  
  &lt;fct&gt;                  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;
1 3657015667902160896 -0.00548    33 1     1    
2 3657015667902160896  0.101      33 1     1    
3 3657015667902160896  0.230      32 1     1    
4 3657015667902160896  0.342      37 1     1    
5 3657015667902160896  0.446      49 1     1    
6 2080619628198763008 -0.00548    12 1     1    </code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    id            year              sld        study   
 4308512445673410048 :  18   Min.   :-0.1314   Min.   :  2.0   1: 456  
 -4902532987801034752:  17   1st Qu.: 0.1123   1st Qu.: 17.0   2: 966  
 5394902984416364544 :  16   Median : 0.2847   Median : 30.0   3:2177  
 7160320731596789760 :  16   Mean   : 0.3822   Mean   : 36.1   4:4126  
 -4159496062492130816:  15   3rd Qu.: 0.5722   3rd Qu.: 49.0   5: 835  
 -7900338178541499392:  15   Max.   : 2.0753   Max.   :228.0           
 (Other)             :8463   NA's   :1         NA's   :69              
 arm     
 1:3108  
 2:3715  
 3: 291  
 4: 608  
 5: 227  
 6: 611  
         </code></pre>
</div>
</div>
<p>For simplicity, we will for now just use study 4 (this is the OAK study), and we rename the patient IDs:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(study <span class="sc">==</span> <span class="st">"4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.numeric</span>(id)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here we have 701 patients. It is always a good idea to make a plot of the data. Let’s look at the first 20 patients e.g.:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(id) <span class="sc">&lt;=</span> <span class="dv">20</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> sld, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_tgi_sf_brms_files/figure-html/plot_data-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="stein-fojo-model" class="level2">
<h2 class="anchored" data-anchor-id="stein-fojo-model">Stein-Fojo model</h2>
<p>We start from the Stein-Fojo model as shown in the slides:</p>
<p><span class="math display">\[
y^{*}(t_{ij}) = \psi_{b_{0}i} \{\exp(- \psi_{k_{s}i} \cdot t_{ij}) + \exp(\psi_{k_{g}i} \cdot t_{ij}) - 1\}
\]</span></p>
<section id="mean" class="level3">
<h3 class="anchored" data-anchor-id="mean">Mean</h3>
<p>We will make one more tweak here. If the time <span class="math inline">\(t\)</span> is negative, i.e.&nbsp;the treatment has not started yet, then it is reasonable to assume that the tumor cannot shrink yet. Therefore, the final model for the mean SLD is:</p>
<p><span class="math display">\[
y^{*}(t_{ij}) =
\begin{cases}
\psi_{b_{0}i} \exp(\psi_{k_{g}i} \cdot t_{ij}) &amp; \text{if } t_{ij} &lt; 0 \\
\psi_{b_{0}i} \{\exp(-\psi_{k_{s}i} \cdot t_{ij}) + \exp(\psi_{k_{g}i} \cdot t_{ij}) - 1\} &amp; \text{if } t_{ij} \geq 0
\end{cases}
\]</span></p>
</section>
<section id="likelihood" class="level3">
<h3 class="anchored" data-anchor-id="likelihood">Likelihood</h3>
<p>For the likelihood given the mean SLD <span class="math inline">\(y^{*}\)</span>, we will assume a normal distribution with a constant coefficient of variation <span class="math inline">\(\tau\)</span>:</p>
<p><span class="math display">\[
y(t_{ij}) \sim \text{N}(y^{*}(t_{ij}), y^{*}(t_{ij})\tau)
\]</span></p>
<p>Note that for consistency with the <code>brms</code> and <code>Stan</code> convention, here we denote the standard deviation as the second parameter of the normal distribution. So in this case, the variance would be <span class="math inline">\((y^{*}(t_{ij})\tau)^2\)</span>.</p>
<p>This can also be written as:</p>
<p><span class="math display">\[
y(t_{ij}) = (1 + \epsilon_{ij}) \cdot y^{*}(t_{ij})
\]</span></p>
<p>where <span class="math inline">\(\epsilon_{ij} \sim \text{N}(0, \tau)\)</span>.</p>
<p>Note that also the additive model is a possible choice, where</p>
<p><span class="math display">\[
y(t_{ij}) = y^{*}(t_{ij}) + \epsilon_{ij}
\]</span></p>
<p>such that the error does not depend on the scale of the SLD any longer.</p>
</section>
<section id="random-effects" class="level3">
<h3 class="anchored" data-anchor-id="random-effects">Random effects</h3>
<p>Next, we define the distributions of the random effects <span class="math inline">\(\psi_{b_{0}i}\)</span>, <span class="math inline">\(\psi_{k_{s}i}\)</span>, <span class="math inline">\(\psi_{k_{g}i}\)</span>, for <span class="math inline">\(i = 1, \dotsc, n\)</span>:</p>
<p><span class="math display">\[
\begin{align*}
\psi_{b_{0}i} &amp;\sim \text{LogNormal}(\mu_{b_{0}}, \omega_{0}) \\
\psi_{k_{s}i} &amp;\sim \text{LogNormal}(\mu_{k_{s}}, \omega_{s}) \\
\psi_{k_{g}i} &amp;\sim \text{LogNormal}(\mu_{k_{g}}, \omega_{g})
\end{align*}
\]</span></p>
<p>This can be rewritten as:</p>
<p><span class="math display">\[
\begin{align*}
\psi_{b_{0}i} &amp;= \exp(\mu_{b_{0}} + \omega_{0} \cdot \eta_{b_{0}i}) \\
\psi_{k_{s}i} &amp;= \exp(\mu_{k_{s}} + \omega_{s} \cdot \eta_{k_{s}i}) \\
\psi_{k_{g}i} &amp;= \exp(\mu_{k_{g}} + \omega_{g} \cdot \eta_{k_{g}i})
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(\eta_{b_{0}i}\)</span>, <span class="math inline">\(\eta_{k_{s}i}\)</span>, <span class="math inline">\(\eta_{k_{g}i}\)</span> are the standard normal distributed random effects.</p>
<p>This is important for two reasons:</p>
<ol type="1">
<li>This parametrization can help the sampler to converge faster. See <a href="https://mc-stan.org/docs/stan-users-guide/efficiency-tuning.html#non-centered-parameterization">here</a> for more information.</li>
<li>This shows a bit more explicitly that the population mean of the random effects is not equal to the <span class="math inline">\(\mu\)</span> parameter, but to <span class="math inline">\(\exp(\mu + \omega^2 / 2)\)</span>, because they are log-normally distributed (see e.g.&nbsp;<a href="https://en.wikipedia.org/wiki/Log-normal_distribution#Arithmetic_moments">Wikipedia</a> for the formulas). This is important for the interpretation of the parameter estimates.</li>
</ol>
</section>
<section id="priors" class="level3">
<h3 class="anchored" data-anchor-id="priors">Priors</h3>
<p>Finally, we need to define the priors for the hyperparameters.</p>
<p>There are different principles we could use to define these priors:</p>
<ol type="1">
<li><strong>Non-informative priors</strong>: We could use priors that are as non-informative as possible. This is especially useful if we do not have any prior knowledge about the parameters. For example, we could use normal priors with a large standard deviation for the population means of the random effects.</li>
<li><strong>Informative priors</strong>: If we have some prior knowledge about the parameters, we can use this to define the priors. For example, if we have literature data about the <span class="math inline">\(k_g\)</span> parameter estimate, we could use this to define the prior for the population mean of the growth rate. (Here we just need to be careful to consider the time scale and the log-normal distribution, as mentioned above)</li>
</ol>
<p>Here we use relatively informative priors for the log-normal location parameters, motivated by prior analyses of the same study:</p>
<p><span class="math display">\[
\begin{align*}
\mu_{b_{0}} &amp;\sim \text{LogNormal}(\log(65), 1) \\
\mu_{k_{s}} &amp;\sim \text{LogNormal}(\log(0.52), 0.1) \\
\mu_{k_{g}} &amp;\sim \text{LogNormal}(\log(1.04), 1)
\end{align*}
\]</span></p>
<p>For all standard deviations we use truncated normal priors:</p>
<p><span class="math display">\[
\begin{align*}
\omega_{0} &amp;\sim \text{PositiveNormal}(0, 3) \\
\omega_{s} &amp;\sim \text{PositiveNormal}(0, 3) \\
\omega_{g} &amp;\sim \text{PositiveNormal}(0, 3) \\
\tau &amp;\sim \text{PositiveNormal}(0, 3)
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(\text{PositiveNormal}(0, 3)\)</span> denotes a truncated normal distribution with mean <span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(3\)</span>, truncated to the positive real numbers.</p>
</section>
</section>
<section id="fit-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-model">Fit model</h2>
<p>We can now fit the model using <code>brms</code>. The structure is determined by the model formula:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(sld <span class="sc">~</span> eta, <span class="at">nl =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the mean for the likelihood</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    eta <span class="sc">~</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> (<span class="fu">exp</span>(<span class="sc">-</span>ks <span class="sc">*</span> year) <span class="sc">+</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year) <span class="sc">-</span>  <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the standard deviation (called sigma in brms) as a </span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficient tau times the mean.</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sigma is modelled on the log scale though, therefore:</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(sigma <span class="sc">~</span> <span class="fu">log</span>(tau) <span class="sc">+</span> <span class="fu">log</span>(eta)) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(tau <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define nonlinear parameter transformations</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(b0 <span class="sc">~</span> <span class="fu">exp</span>(lb0)) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(ks <span class="sc">~</span> <span class="fu">exp</span>(lks)) <span class="sc">+</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(kg <span class="sc">~</span> <span class="fu">exp</span>(lkg)) <span class="sc">+</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define random effect structure</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lb0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span> </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lks <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lkg <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the priors</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lb0"</span>),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="fl">0.1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>),</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lb0"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"tau"</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial values to avoid problems at the beginning</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>n_patients <span class="ot">&lt;-</span> <span class="fu">nlevels</span>(df<span class="sc">$</span>id)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lb0 =</span> <span class="fu">array</span>(<span class="fl">3.61</span>),</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lks =</span> <span class="fu">array</span>(<span class="sc">-</span><span class="fl">1.25</span>),</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lkg =</span> <span class="fu">array</span>(<span class="sc">-</span><span class="fl">1.33</span>),</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_1 =</span> <span class="fu">array</span>(<span class="fl">0.58</span>),</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_2 =</span> <span class="fu">array</span>(<span class="fl">1.6</span>),</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_3 =</span> <span class="fu">array</span>(<span class="fl">0.994</span>),</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_tau =</span> <span class="fu">array</span>(<span class="fl">0.161</span>),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_1 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_2 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_3 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/fit9.RData"</span>)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> priors,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> <span class="fu">rep</span>(<span class="fu">list</span>(inits), CHAINS),</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> CHAINS, </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> ITER <span class="sc">+</span> WARMUP, </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> WARMUP, </span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> REFRESH</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit, <span class="at">file =</span> save_file)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fit</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = log 
Formula: sld ~ eta 
         eta ~ int_step(year &gt; 0) * (b0 * (exp(-ks * year) + exp(kg * year) - 1)) + int_step(year &lt;= 0) * (b0 * exp(kg * year))
         sigma ~ log(tau) + log(eta)
         tau ~ 1
         b0 ~ exp(lb0)
         ks ~ exp(lks)
         kg ~ exp(lkg)
         lb0 ~ 1 + (1 | id)
         lks ~ 1 + (1 | id)
         lkg ~ 1 + (1 | id)
   Data: df (Number of observations: 4099) 
  Draws: 4 chains, each with iter = 3000; warmup = 2000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 701) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(lb0_Intercept)     0.58      0.02     0.55     0.61 1.00      689     1248
sd(lks_Intercept)     1.40      0.08     1.25     1.55 1.00      702     1586
sd(lkg_Intercept)     0.96      0.04     0.88     1.05 1.01      902     1750

Regression Coefficients:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
tau_Intercept     0.16      0.00     0.16     0.17 1.00     2250     2892
lb0_Intercept     3.62      0.02     3.57     3.66 1.01      420      723
lks_Intercept    -0.86      0.08    -1.01    -0.72 1.00     1661     2415
lkg_Intercept    -1.20      0.07    -1.34    -1.08 1.01      676     1419

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Note that it is crucial to use here <code>int_step()</code> to properly define the two pieces of the linear predictor for negative and non-negative time values: If you used <code>step()</code> like I did for a few days, then you will have the wrong model! This is because in Stan, <code>step(false) = step(0) = 1</code> and not 0 as you would expect. Only <code>int_step(0) = 0</code> as we need it here.</p>
</section>
<section id="parameter-estimates" class="level2">
<h2 class="anchored" data-anchor-id="parameter-estimates">Parameter estimates</h2>
<p>Here we extract all parameter estimates using the <code>as_draws_df</code> method for <code>brmsfit</code> objects. Note that we could also just extract a subset of parameters, see <code>?as_draws.brmsfit</code> for more information.</p>
<p>As mentioned above, we use the expectation of the log-normal distribution to get the population level estimates for the <span class="math inline">\(b_0\)</span>, <span class="math inline">\(k_s\)</span>, and <span class="math inline">\(k_g\)</span> parameters. We also calculate the coefficient of variation for each parameter.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>post_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">names</span>(post_df), <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_tau_Intercept"        "b_lb0_Intercept"        "b_lks_Intercept"       
 [4] "b_lkg_Intercept"        "sd_id__lb0_Intercept"   "sd_id__lks_Intercept"  
 [7] "sd_id__lkg_Intercept"   "r_id__lb0[1,Intercept]" "r_id__lb0[2,Intercept]"
[10] "r_id__lb0[3,Intercept]"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>post_df <span class="ot">&lt;-</span> post_df <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_0 =</span> sd_id__lb0_Intercept,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_s =</span> sd_id__lks_Intercept,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_g =</span> sd_id__lkg_Intercept,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> b_tau_Intercept</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For a graphical check of the convergence, we can use the <code>mcmc_trace</code> and <code>mcmc_pairs</code> functions from the <code>bayesplot</code> package:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(post_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"ks"</span>, <span class="st">"kg"</span>, <span class="st">"omega_0"</span>, <span class="st">"omega_s"</span>, <span class="st">"omega_g"</span>, <span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_tgi_sf_brms_files/figure-html/plot_convergence-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(post_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"ks"</span>, <span class="st">"kg"</span>, <span class="st">"omega_0"</span>, <span class="st">"omega_s"</span>, <span class="st">"omega_g"</span>, <span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_tgi_sf_brms_files/figure-html/plot_convergence-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next, we can create a nice summary table of the parameter estimates, using <code>summarize_draws</code> from the <code>posterior</code> package in combination with functions from the <code>gt</code> package:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>post_sum <span class="ot">&lt;-</span> post_df <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b0, ks, kg, omega_0, omega_s, omega_g, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>post_sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="llnyvnllow" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#llnyvnllow table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#llnyvnllow thead, #llnyvnllow tbody, #llnyvnllow tfoot, #llnyvnllow tr, #llnyvnllow td, #llnyvnllow th {
  border-style: none;
}

#llnyvnllow p {
  margin: 0;
  padding: 0;
}

#llnyvnllow .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#llnyvnllow .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#llnyvnllow .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#llnyvnllow .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#llnyvnllow .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#llnyvnllow .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#llnyvnllow .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#llnyvnllow .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#llnyvnllow .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#llnyvnllow .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#llnyvnllow .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#llnyvnllow .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#llnyvnllow .gt_spanner_row {
  border-bottom-style: hidden;
}

#llnyvnllow .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#llnyvnllow .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#llnyvnllow .gt_from_md > :first-child {
  margin-top: 0;
}

#llnyvnllow .gt_from_md > :last-child {
  margin-bottom: 0;
}

#llnyvnllow .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#llnyvnllow .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#llnyvnllow .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#llnyvnllow .gt_row_group_first td {
  border-top-width: 2px;
}

#llnyvnllow .gt_row_group_first th {
  border-top-width: 2px;
}

#llnyvnllow .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#llnyvnllow .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#llnyvnllow .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#llnyvnllow .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#llnyvnllow .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#llnyvnllow .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#llnyvnllow .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#llnyvnllow .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#llnyvnllow .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#llnyvnllow .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#llnyvnllow .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#llnyvnllow .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#llnyvnllow .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#llnyvnllow .gt_left {
  text-align: left;
}

#llnyvnllow .gt_center {
  text-align: center;
}

#llnyvnllow .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#llnyvnllow .gt_font_normal {
  font-weight: normal;
}

#llnyvnllow .gt_font_bold {
  font-weight: bold;
}

#llnyvnllow .gt_font_italic {
  font-style: italic;
}

#llnyvnllow .gt_super {
  font-size: 65%;
}

#llnyvnllow .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#llnyvnllow .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#llnyvnllow .gt_indent_1 {
  text-indent: 5px;
}

#llnyvnllow .gt_indent_2 {
  text-indent: 10px;
}

#llnyvnllow .gt_indent_3 {
  text-indent: 15px;
}

#llnyvnllow .gt_indent_4 {
  text-indent: 20px;
}

#llnyvnllow .gt_indent_5 {
  text-indent: 25px;
}

#llnyvnllow .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#llnyvnllow div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="variable">b0</td>
<td class="gt_row gt_right" headers="mean">44.0</td>
<td class="gt_row gt_right" headers="median">44.0</td>
<td class="gt_row gt_right" headers="sd">1.03</td>
<td class="gt_row gt_right" headers="mad">1.01</td>
<td class="gt_row gt_right" headers="q5">42.3</td>
<td class="gt_row gt_right" headers="q95">45.7</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">423</td>
<td class="gt_row gt_right" headers="ess_tail">726</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">ks</td>
<td class="gt_row gt_right" headers="mean">1.13</td>
<td class="gt_row gt_right" headers="median">1.12</td>
<td class="gt_row gt_right" headers="sd">0.104</td>
<td class="gt_row gt_right" headers="mad">0.101</td>
<td class="gt_row gt_right" headers="q5">0.972</td>
<td class="gt_row gt_right" headers="q95">1.32</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">445</td>
<td class="gt_row gt_right" headers="ess_tail">915</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">kg</td>
<td class="gt_row gt_right" headers="mean">0.476</td>
<td class="gt_row gt_right" headers="median">0.475</td>
<td class="gt_row gt_right" headers="sd">0.0311</td>
<td class="gt_row gt_right" headers="mad">0.0318</td>
<td class="gt_row gt_right" headers="q5">0.426</td>
<td class="gt_row gt_right" headers="q95">0.528</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">941</td>
<td class="gt_row gt_right" headers="ess_tail">1,320</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_0</td>
<td class="gt_row gt_right" headers="mean">0.579</td>
<td class="gt_row gt_right" headers="median">0.579</td>
<td class="gt_row gt_right" headers="sd">0.0162</td>
<td class="gt_row gt_right" headers="mad">0.0166</td>
<td class="gt_row gt_right" headers="q5">0.552</td>
<td class="gt_row gt_right" headers="q95">0.605</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">676</td>
<td class="gt_row gt_right" headers="ess_tail">1,220</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">omega_s</td>
<td class="gt_row gt_right" headers="mean">1.40</td>
<td class="gt_row gt_right" headers="median">1.40</td>
<td class="gt_row gt_right" headers="sd">0.0753</td>
<td class="gt_row gt_right" headers="mad">0.0745</td>
<td class="gt_row gt_right" headers="q5">1.28</td>
<td class="gt_row gt_right" headers="q95">1.52</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">699</td>
<td class="gt_row gt_right" headers="ess_tail">1,560</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_g</td>
<td class="gt_row gt_right" headers="mean">0.958</td>
<td class="gt_row gt_right" headers="median">0.956</td>
<td class="gt_row gt_right" headers="sd">0.0446</td>
<td class="gt_row gt_right" headers="mad">0.0446</td>
<td class="gt_row gt_right" headers="q5">0.888</td>
<td class="gt_row gt_right" headers="q95">1.04</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">882</td>
<td class="gt_row gt_right" headers="ess_tail">1,720</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_0</td>
<td class="gt_row gt_right" headers="mean">0.631</td>
<td class="gt_row gt_right" headers="median">0.631</td>
<td class="gt_row gt_right" headers="sd">0.0208</td>
<td class="gt_row gt_right" headers="mad">0.0212</td>
<td class="gt_row gt_right" headers="q5">0.597</td>
<td class="gt_row gt_right" headers="q95">0.665</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">676</td>
<td class="gt_row gt_right" headers="ess_tail">1,220</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">cv_s</td>
<td class="gt_row gt_right" headers="mean">2.49</td>
<td class="gt_row gt_right" headers="median">2.46</td>
<td class="gt_row gt_right" headers="sd">0.311</td>
<td class="gt_row gt_right" headers="mad">0.295</td>
<td class="gt_row gt_right" headers="q5">2.02</td>
<td class="gt_row gt_right" headers="q95">3.04</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">699</td>
<td class="gt_row gt_right" headers="ess_tail">1,560</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_g</td>
<td class="gt_row gt_right" headers="mean">1.23</td>
<td class="gt_row gt_right" headers="median">1.22</td>
<td class="gt_row gt_right" headers="sd">0.0883</td>
<td class="gt_row gt_right" headers="mad">0.0869</td>
<td class="gt_row gt_right" headers="q5">1.10</td>
<td class="gt_row gt_right" headers="q95">1.39</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">882</td>
<td class="gt_row gt_right" headers="ess_tail">1,720</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">sigma</td>
<td class="gt_row gt_right" headers="mean">0.161</td>
<td class="gt_row gt_right" headers="median">0.161</td>
<td class="gt_row gt_right" headers="sd">0.00230</td>
<td class="gt_row gt_right" headers="mad">0.00229</td>
<td class="gt_row gt_right" headers="q5">0.157</td>
<td class="gt_row gt_right" headers="q95">0.165</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">2,190</td>
<td class="gt_row gt_right" headers="ess_tail">2,860</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can also look at parameters for individual patients. This is simplified by using the <code>spread_draws()</code> function:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Understand the names of the random effects:</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">get_variables</span>(fit), <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_tau_Intercept"        "b_lb0_Intercept"        "b_lks_Intercept"       
 [4] "b_lkg_Intercept"        "sd_id__lb0_Intercept"   "sd_id__lks_Intercept"  
 [7] "sd_id__lkg_Intercept"   "r_id__lb0[1,Intercept]" "r_id__lb0[2,Intercept]"
[10] "r_id__lb0[3,Intercept]"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>post_ind <span class="ot">&lt;-</span> fit <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    b_lb0_Intercept,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    r_id__lb0[id, ],</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    b_lks_Intercept,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    r_id__lks[id, ],</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    b_lkg_Intercept,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    r_id__lkg[id, ]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> r_id__lb0),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> r_id__lks),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> r_id__lkg)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    .chain, .iteration, .draw,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    id, b0, ks, kg    </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With this we can e.g.&nbsp;report the estimates for the first patient:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>post_sum_id1 <span class="ot">&lt;-</span> post_ind <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>post_sum_id1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="blvpvkzypi" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#blvpvkzypi table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#blvpvkzypi thead, #blvpvkzypi tbody, #blvpvkzypi tfoot, #blvpvkzypi tr, #blvpvkzypi td, #blvpvkzypi th {
  border-style: none;
}

#blvpvkzypi p {
  margin: 0;
  padding: 0;
}

#blvpvkzypi .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#blvpvkzypi .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#blvpvkzypi .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#blvpvkzypi .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#blvpvkzypi .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#blvpvkzypi .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#blvpvkzypi .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#blvpvkzypi .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#blvpvkzypi .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#blvpvkzypi .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#blvpvkzypi .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#blvpvkzypi .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#blvpvkzypi .gt_spanner_row {
  border-bottom-style: hidden;
}

#blvpvkzypi .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#blvpvkzypi .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#blvpvkzypi .gt_from_md > :first-child {
  margin-top: 0;
}

#blvpvkzypi .gt_from_md > :last-child {
  margin-bottom: 0;
}

#blvpvkzypi .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#blvpvkzypi .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#blvpvkzypi .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#blvpvkzypi .gt_row_group_first td {
  border-top-width: 2px;
}

#blvpvkzypi .gt_row_group_first th {
  border-top-width: 2px;
}

#blvpvkzypi .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#blvpvkzypi .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#blvpvkzypi .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#blvpvkzypi .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#blvpvkzypi .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#blvpvkzypi .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#blvpvkzypi .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#blvpvkzypi .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#blvpvkzypi .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#blvpvkzypi .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#blvpvkzypi .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#blvpvkzypi .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#blvpvkzypi .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#blvpvkzypi .gt_left {
  text-align: left;
}

#blvpvkzypi .gt_center {
  text-align: center;
}

#blvpvkzypi .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#blvpvkzypi .gt_font_normal {
  font-weight: normal;
}

#blvpvkzypi .gt_font_bold {
  font-weight: bold;
}

#blvpvkzypi .gt_font_italic {
  font-style: italic;
}

#blvpvkzypi .gt_super {
  font-size: 65%;
}

#blvpvkzypi .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#blvpvkzypi .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#blvpvkzypi .gt_indent_1 {
  text-indent: 5px;
}

#blvpvkzypi .gt_indent_2 {
  text-indent: 10px;
}

#blvpvkzypi .gt_indent_3 {
  text-indent: 15px;
}

#blvpvkzypi .gt_indent_4 {
  text-indent: 20px;
}

#blvpvkzypi .gt_indent_5 {
  text-indent: 25px;
}

#blvpvkzypi .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#blvpvkzypi div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd gt_group_heading_row">
<td colspan="10" id="1" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">1</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_left" headers="1  variable">b0</td>
<td class="gt_row gt_right" headers="1  mean">43.3</td>
<td class="gt_row gt_right" headers="1  median">42.8</td>
<td class="gt_row gt_right" headers="1  sd">4.80</td>
<td class="gt_row gt_right" headers="1  mad">4.35</td>
<td class="gt_row gt_right" headers="1  q5">36.5</td>
<td class="gt_row gt_right" headers="1  q95">52.2</td>
<td class="gt_row gt_right" headers="1  rhat">1.00</td>
<td class="gt_row gt_right" headers="1  ess_bulk">9,080</td>
<td class="gt_row gt_right" headers="1  ess_tail">2,890</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="1  variable">ks</td>
<td class="gt_row gt_right" headers="1  mean">0.486</td>
<td class="gt_row gt_right" headers="1  median">0.313</td>
<td class="gt_row gt_right" headers="1  sd">0.529</td>
<td class="gt_row gt_right" headers="1  mad">0.309</td>
<td class="gt_row gt_right" headers="1  q5">0.0392</td>
<td class="gt_row gt_right" headers="1  q95">1.50</td>
<td class="gt_row gt_right" headers="1  rhat">1.00</td>
<td class="gt_row gt_right" headers="1  ess_bulk">6,300</td>
<td class="gt_row gt_right" headers="1  ess_tail">3,140</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="1  variable">kg</td>
<td class="gt_row gt_right" headers="1  mean">0.395</td>
<td class="gt_row gt_right" headers="1  median">0.294</td>
<td class="gt_row gt_right" headers="1  sd">0.338</td>
<td class="gt_row gt_right" headers="1  mad">0.241</td>
<td class="gt_row gt_right" headers="1  q5">0.0620</td>
<td class="gt_row gt_right" headers="1  q95">1.04</td>
<td class="gt_row gt_right" headers="1  rhat">1.00</td>
<td class="gt_row gt_right" headers="1  ess_bulk">7,690</td>
<td class="gt_row gt_right" headers="1  ess_tail">3,080</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="observation-vs-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="observation-vs-model-fit">Observation vs model fit</h2>
<p>We can now compare the model fit to the observations. Let’s do this for the first 20 patients again.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pt_subset <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df_subset <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> pt_subset)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> df_subset <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> pt_subset, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">seq_range</span>(year, <span class="dv">101</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_linpred_draws</span>(fit) <span class="sc">|&gt;</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sld_pred =</span> .linpred)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">|&gt;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> sld)) <span class="sc">+</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id) <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> sld_pred, <span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper),</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.3</span>, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"deepskyblue"</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sld_pred), <span class="at">color =</span> <span class="st">"deepskyblue"</span>) <span class="sc">+</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> df_subset, <span class="at">color =</span> <span class="st">"tomato"</span>) <span class="sc">+</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">range</span>(df_subset<span class="sc">$</span>sld)) <span class="sc">+</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Greys"</span>) <span class="sc">+</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"SF model fit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_tgi_sf_brms_files/figure-html/obs_vs_fit_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-covariates" class="level2">
<h2 class="anchored" data-anchor-id="adding-covariates">Adding covariates</h2>
<p>With <code>brms</code> it is straightforward to add covariates to the model. In this example, an obvious choice for a covariate is the treatment the patients received in the study:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, arm) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(arm) <span class="sc">|&gt;</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  1   2 
325 376 </code></pre>
</div>
</div>
<p>Here it makes sense to assume that only the shrinkage and growth parameters differ systematically between the two arms. For example, the baseline SLD should be the same in expectation, because of the randomization between the treatment arms.</p>
<p>Therefore we can add this as follows as a fixed effect for the two parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>formula_by_arm <span class="ot">&lt;-</span> <span class="fu">bf</span>(sld <span class="sc">~</span> eta, <span class="at">nl =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the mean for the likelihood</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    eta <span class="sc">~</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> (<span class="fu">exp</span>(<span class="sc">-</span>ks <span class="sc">*</span> year) <span class="sc">+</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year) <span class="sc">-</span>  <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the standard deviation (called sigma in brms) as a </span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficient tau times the mean.</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sigma is modelled on the log scale though, therefore:</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(sigma <span class="sc">~</span> <span class="fu">log</span>(tau) <span class="sc">+</span> <span class="fu">log</span>(eta)) <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(tau <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define nonlinear parameter transformations</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(b0 <span class="sc">~</span> <span class="fu">exp</span>(lb0)) <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(ks <span class="sc">~</span> <span class="fu">exp</span>(lks)) <span class="sc">+</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(kg <span class="sc">~</span> <span class="fu">exp</span>(lkg)) <span class="sc">+</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define random effect structure</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lb0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span> </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lks <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> arm <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lkg <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> arm <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It is instructive to see that the Stan code that is generated in the background is actually identical to the previous model, except for the prior specification. This is because <code>brms</code> uses a design matrix to model the fixed effects, and the <code>arm</code> variable is just added to this design matrix, which before only contained the intercept column with <code>1</code>s.</p>
<p>However, now the coefficient vector is no longer of length 1 but of length 2, with the first element corresponding to the intercept and the second element to the effect of the <code>arm</code> variable (for the level “2”). For the latter, we want to assume a standard normal prior on the log scale.</p>
<p>So we need to adjust the prior and initial values accordingly:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>priors_by_arm <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lb0"</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the changes here:</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="fl">0.1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">coef =</span> <span class="st">"arm2"</span>), </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">coef =</span> <span class="st">"arm2"</span>),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same as before:</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lb0"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"tau"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>inits_by_arm <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lb0 =</span> <span class="fu">array</span>(<span class="fl">3.61</span>),</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the changes here:</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lks =</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="dv">0</span>)),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lkg =</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.33</span>, <span class="dv">0</span>)),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same as before:</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_1 =</span> <span class="fu">array</span>(<span class="fl">0.58</span>),</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_2 =</span> <span class="fu">array</span>(<span class="fl">1.6</span>),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_3 =</span> <span class="fu">array</span>(<span class="fl">0.994</span>),</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_tau =</span> <span class="fu">array</span>(<span class="fl">0.161</span>),</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_1 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_2 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_3 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can fit the model as before:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/fit10.RData"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  fit_by_arm <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> formula_by_arm,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> priors_by_arm,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> <span class="fu">rep</span>(<span class="fu">list</span>(inits_by_arm), CHAINS),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> CHAINS, </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> ITER <span class="sc">+</span> WARMUP, </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> WARMUP, </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> REFRESH</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit_by_arm, <span class="at">file =</span> save_file)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_by_arm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = log 
Formula: sld ~ eta 
         eta ~ int_step(year &gt; 0) * (b0 * (exp(-ks * year) + exp(kg * year) - 1)) + int_step(year &lt;= 0) * (b0 * exp(kg * year))
         sigma ~ log(tau) + log(eta)
         tau ~ 1
         b0 ~ exp(lb0)
         ks ~ exp(lks)
         kg ~ exp(lkg)
         lb0 ~ 1 + (1 | id)
         lks ~ 1 + arm + (1 | id)
         lkg ~ 1 + arm + (1 | id)
   Data: df (Number of observations: 4099) 
  Draws: 4 chains, each with iter = 3000; warmup = 2000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 701) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(lb0_Intercept)     0.58      0.02     0.55     0.61 1.01      356      987
sd(lks_Intercept)     1.48      0.09     1.31     1.66 1.01      402      917
sd(lkg_Intercept)     0.97      0.05     0.88     1.07 1.01      323      789

Regression Coefficients:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
tau_Intercept     0.16      0.00     0.16     0.17 1.00     1725     2755
lb0_Intercept     3.61      0.02     3.57     3.66 1.00      199      519
lks_Intercept    -0.78      0.09    -0.95    -0.61 1.00     1204     2303
lks_arm2         -0.40      0.16    -0.73    -0.09 1.01      383      823
lkg_Intercept    -1.26      0.11    -1.48    -1.05 1.01      494      853
lkg_arm2          0.03      0.13    -0.22     0.28 1.01      460      975

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Let’s have a look at the parameter estimates then:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit_by_arm)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">names</span>(post_df_by_arm), <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_tau_Intercept"        "b_lb0_Intercept"        "b_lks_Intercept"       
 [4] "b_lks_arm2"             "b_lkg_Intercept"        "b_lkg_arm2"            
 [7] "sd_id__lb0_Intercept"   "sd_id__lks_Intercept"   "sd_id__lkg_Intercept"  
[10] "r_id__lb0[1,Intercept]"</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="ot">&lt;-</span> post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks_arm1 =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks_arm2 =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> b_lks_arm2 <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg_arm1 =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg_arm2 =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> b_lkg_arm2 <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_0 =</span> sd_id__lb0_Intercept,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_s =</span> sd_id__lks_Intercept,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_g =</span> sd_id__lkg_Intercept,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> b_tau_Intercept</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm <span class="ot">&lt;-</span> post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b0, ks_arm1, ks_arm2, kg_arm1, kg_arm2, omega_0, omega_s, omega_g, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="pjbjjsrmyr" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#pjbjjsrmyr table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#pjbjjsrmyr thead, #pjbjjsrmyr tbody, #pjbjjsrmyr tfoot, #pjbjjsrmyr tr, #pjbjjsrmyr td, #pjbjjsrmyr th {
  border-style: none;
}

#pjbjjsrmyr p {
  margin: 0;
  padding: 0;
}

#pjbjjsrmyr .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pjbjjsrmyr .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#pjbjjsrmyr .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pjbjjsrmyr .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pjbjjsrmyr .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pjbjjsrmyr .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pjbjjsrmyr .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pjbjjsrmyr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#pjbjjsrmyr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pjbjjsrmyr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pjbjjsrmyr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pjbjjsrmyr .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pjbjjsrmyr .gt_spanner_row {
  border-bottom-style: hidden;
}

#pjbjjsrmyr .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#pjbjjsrmyr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pjbjjsrmyr .gt_from_md > :first-child {
  margin-top: 0;
}

#pjbjjsrmyr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pjbjjsrmyr .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pjbjjsrmyr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#pjbjjsrmyr .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#pjbjjsrmyr .gt_row_group_first td {
  border-top-width: 2px;
}

#pjbjjsrmyr .gt_row_group_first th {
  border-top-width: 2px;
}

#pjbjjsrmyr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pjbjjsrmyr .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#pjbjjsrmyr .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#pjbjjsrmyr .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pjbjjsrmyr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pjbjjsrmyr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pjbjjsrmyr .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#pjbjjsrmyr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pjbjjsrmyr .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pjbjjsrmyr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pjbjjsrmyr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pjbjjsrmyr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pjbjjsrmyr .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#pjbjjsrmyr .gt_left {
  text-align: left;
}

#pjbjjsrmyr .gt_center {
  text-align: center;
}

#pjbjjsrmyr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pjbjjsrmyr .gt_font_normal {
  font-weight: normal;
}

#pjbjjsrmyr .gt_font_bold {
  font-weight: bold;
}

#pjbjjsrmyr .gt_font_italic {
  font-style: italic;
}

#pjbjjsrmyr .gt_super {
  font-size: 65%;
}

#pjbjjsrmyr .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#pjbjjsrmyr .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#pjbjjsrmyr .gt_indent_1 {
  text-indent: 5px;
}

#pjbjjsrmyr .gt_indent_2 {
  text-indent: 10px;
}

#pjbjjsrmyr .gt_indent_3 {
  text-indent: 15px;
}

#pjbjjsrmyr .gt_indent_4 {
  text-indent: 20px;
}

#pjbjjsrmyr .gt_indent_5 {
  text-indent: 25px;
}

#pjbjjsrmyr .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#pjbjjsrmyr div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="variable">b0</td>
<td class="gt_row gt_right" headers="mean">43.9</td>
<td class="gt_row gt_right" headers="median">43.9</td>
<td class="gt_row gt_right" headers="sd">1.10</td>
<td class="gt_row gt_right" headers="mad">1.11</td>
<td class="gt_row gt_right" headers="q5">42.1</td>
<td class="gt_row gt_right" headers="q95">45.8</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">195</td>
<td class="gt_row gt_right" headers="ess_tail">515</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">ks_arm1</td>
<td class="gt_row gt_right" headers="mean">1.39</td>
<td class="gt_row gt_right" headers="median">1.36</td>
<td class="gt_row gt_right" headers="sd">0.193</td>
<td class="gt_row gt_right" headers="mad">0.178</td>
<td class="gt_row gt_right" headers="q5">1.11</td>
<td class="gt_row gt_right" headers="q95">1.74</td>
<td class="gt_row gt_right" headers="rhat">1.01</td>
<td class="gt_row gt_right" headers="ess_bulk">396</td>
<td class="gt_row gt_right" headers="ess_tail">841</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">ks_arm2</td>
<td class="gt_row gt_right" headers="mean">0.925</td>
<td class="gt_row gt_right" headers="median">0.918</td>
<td class="gt_row gt_right" headers="sd">0.112</td>
<td class="gt_row gt_right" headers="mad">0.108</td>
<td class="gt_row gt_right" headers="q5">0.755</td>
<td class="gt_row gt_right" headers="q95">1.12</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">306</td>
<td class="gt_row gt_right" headers="ess_tail">814</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">kg_arm1</td>
<td class="gt_row gt_right" headers="mean">0.456</td>
<td class="gt_row gt_right" headers="median">0.454</td>
<td class="gt_row gt_right" headers="sd">0.0461</td>
<td class="gt_row gt_right" headers="mad">0.0456</td>
<td class="gt_row gt_right" headers="q5">0.382</td>
<td class="gt_row gt_right" headers="q95">0.535</td>
<td class="gt_row gt_right" headers="rhat">1.01</td>
<td class="gt_row gt_right" headers="ess_bulk">575</td>
<td class="gt_row gt_right" headers="ess_tail">1,000</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">kg_arm2</td>
<td class="gt_row gt_right" headers="mean">0.469</td>
<td class="gt_row gt_right" headers="median">0.468</td>
<td class="gt_row gt_right" headers="sd">0.0425</td>
<td class="gt_row gt_right" headers="mad">0.0423</td>
<td class="gt_row gt_right" headers="q5">0.402</td>
<td class="gt_row gt_right" headers="q95">0.544</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">496</td>
<td class="gt_row gt_right" headers="ess_tail">923</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_0</td>
<td class="gt_row gt_right" headers="mean">0.578</td>
<td class="gt_row gt_right" headers="median">0.578</td>
<td class="gt_row gt_right" headers="sd">0.0161</td>
<td class="gt_row gt_right" headers="mad">0.0160</td>
<td class="gt_row gt_right" headers="q5">0.552</td>
<td class="gt_row gt_right" headers="q95">0.605</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">345</td>
<td class="gt_row gt_right" headers="ess_tail">979</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">omega_s</td>
<td class="gt_row gt_right" headers="mean">1.48</td>
<td class="gt_row gt_right" headers="median">1.48</td>
<td class="gt_row gt_right" headers="sd">0.0909</td>
<td class="gt_row gt_right" headers="mad">0.0899</td>
<td class="gt_row gt_right" headers="q5">1.33</td>
<td class="gt_row gt_right" headers="q95">1.63</td>
<td class="gt_row gt_right" headers="rhat">1.01</td>
<td class="gt_row gt_right" headers="ess_bulk">397</td>
<td class="gt_row gt_right" headers="ess_tail">900</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_g</td>
<td class="gt_row gt_right" headers="mean">0.968</td>
<td class="gt_row gt_right" headers="median">0.965</td>
<td class="gt_row gt_right" headers="sd">0.0485</td>
<td class="gt_row gt_right" headers="mad">0.0474</td>
<td class="gt_row gt_right" headers="q5">0.892</td>
<td class="gt_row gt_right" headers="q95">1.05</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">343</td>
<td class="gt_row gt_right" headers="ess_tail">808</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_0</td>
<td class="gt_row gt_right" headers="mean">0.630</td>
<td class="gt_row gt_right" headers="median">0.630</td>
<td class="gt_row gt_right" headers="sd">0.0206</td>
<td class="gt_row gt_right" headers="mad">0.0205</td>
<td class="gt_row gt_right" headers="q5">0.597</td>
<td class="gt_row gt_right" headers="q95">0.665</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">345</td>
<td class="gt_row gt_right" headers="ess_tail">979</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">cv_s</td>
<td class="gt_row gt_right" headers="mean">2.84</td>
<td class="gt_row gt_right" headers="median">2.79</td>
<td class="gt_row gt_right" headers="sd">0.445</td>
<td class="gt_row gt_right" headers="mad">0.416</td>
<td class="gt_row gt_right" headers="q5">2.21</td>
<td class="gt_row gt_right" headers="q95">3.65</td>
<td class="gt_row gt_right" headers="rhat">1.01</td>
<td class="gt_row gt_right" headers="ess_bulk">397</td>
<td class="gt_row gt_right" headers="ess_tail">900</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_g</td>
<td class="gt_row gt_right" headers="mean">1.25</td>
<td class="gt_row gt_right" headers="median">1.24</td>
<td class="gt_row gt_right" headers="sd">0.0976</td>
<td class="gt_row gt_right" headers="mad">0.0929</td>
<td class="gt_row gt_right" headers="q5">1.10</td>
<td class="gt_row gt_right" headers="q95">1.43</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">343</td>
<td class="gt_row gt_right" headers="ess_tail">808</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">sigma</td>
<td class="gt_row gt_right" headers="mean">0.161</td>
<td class="gt_row gt_right" headers="median">0.161</td>
<td class="gt_row gt_right" headers="sd">0.00229</td>
<td class="gt_row gt_right" headers="mad">0.00230</td>
<td class="gt_row gt_right" headers="q5">0.157</td>
<td class="gt_row gt_right" headers="q95">0.165</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">1,700</td>
<td class="gt_row gt_right" headers="ess_tail">2,710</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>So we see that the shrinkage is stronger in arm 1 compared to arm 2, while the growth rates are similar. We could also calculate the posterior probability that the growth rate is different between the two arms, for example:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff_pos =</span> ks_arm1 <span class="sc">-</span> ks_arm2 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">diff_prob =</span> <span class="fu">mean</span>(diff_pos))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  diff_prob
      &lt;dbl&gt;
1     0.996</code></pre>
</div>
</div>
<p>So we see that the posterior probability that the shrinkage rate is higher in arm 1 compared to arm 2 is quite high.</p>
</section>
<section id="model-comparison-with-loo" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison-with-loo">Model comparison with LOO</h2>
<p>The LOO criterion is a widely used method for comparing models. It is based on the idea of leave-one-out cross-validation, but is more efficient to compute.</p>
<p>With <code>brms</code>, it is easy to compute the LOO criterion:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 374 observations with a pareto_k &gt; 0.7 in model 'fit'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 4099 log-likelihood matrix.

         Estimate    SE
elpd_loo -12990.0  97.3
p_loo      1185.2  40.4
looic     25980.0 194.7
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.1, 2.2]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     3725  90.9%   56      
   (0.7, 1]   (bad)       303   7.4%   &lt;NA&gt;    
   (1, Inf)   (very bad)   71   1.7%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>A helpful glossary explaining the LOO statistics can be found <a href="https://mc-stan.org/cmdstanr/reference/loo-glossary.html">here</a>.</p>
<p>Different criteria are available, for example the <code>elpd_loo</code> is the expected log pointwise predictive density, and the <code>looic = -2 * elpd_loo</code> is the LOO information criterion. For comparing models, the <code>looic</code> is often used, where smaller numbers are better. it is kind of an equivalent to the AIC, but based on the LOO criterion.</p>
<p>Let’s e.g.&nbsp;compare the two models we fitted above, one for the whole dataset and one with the treatment arm as a covariate for the shrinkage and growth rates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit, <span class="st">"loo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 374 observations with a pareto_k &gt; 0.7 in model 'fit'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fit_by_arm <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit_by_arm, <span class="st">"loo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 359 observations with a pareto_k &gt; 0.7 in model 'fit_by_arm'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(fit, fit_by_arm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           elpd_diff se_diff
fit         0.0       0.0   
fit_by_arm -0.2       5.9   </code></pre>
</div>
</div>
<p>So the model without treatment arm seems to be very slightly preferred here by the LOO criterion. Nevertheless, the model with treatment arm might answer exactly the question we need to answer, so it is important to consider the context of the analysis.</p>
</section>
<section id="tips-and-tricks" class="level2">
<h2 class="anchored" data-anchor-id="tips-and-tricks">Tips and tricks</h2>
<ul>
<li><p>When the model breaks down completely, that is a sign that likely the model specification is wrong. For example, in above code I first did not understand how to model the <code>sigma</code> parameter correctly, which led to a model where each chain was completely stuck at its initial values.</p></li>
<li><p>In that case and in general if you are not sure whether the <code>brms</code> model specification is correct, you can check the Stan code that is generated by <code>brms</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Good to check the stan code:</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (This also helps to find the names of the parameters</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># for which to define the initial values below)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">stancode</span>(formula, <span class="at">prior =</span> priors, <span class="at">data =</span> df, <span class="at">family =</span> <span class="fu">gaussian</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>// generated with brms 2.22.0
functions {
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  vector[N] Y;  // response variable
  int&lt;lower=1&gt; K_tau;  // number of population-level effects
  matrix[N, K_tau] X_tau;  // population-level design matrix
  int&lt;lower=1&gt; K_lb0;  // number of population-level effects
  matrix[N, K_lb0] X_lb0;  // population-level design matrix
  int&lt;lower=1&gt; K_lks;  // number of population-level effects
  matrix[N, K_lks] X_lks;  // population-level design matrix
  int&lt;lower=1&gt; K_lkg;  // number of population-level effects
  matrix[N, K_lkg] X_lkg;  // population-level design matrix
  // covariates for non-linear functions
  vector[N] C_eta_1;
  // data for group-level effects of ID 1
  int&lt;lower=1&gt; N_1;  // number of grouping levels
  int&lt;lower=1&gt; M_1;  // number of coefficients per level
  array[N] int&lt;lower=1&gt; J_1;  // grouping indicator per observation
  // group-level predictor values
  vector[N] Z_1_lb0_1;
  // data for group-level effects of ID 2
  int&lt;lower=1&gt; N_2;  // number of grouping levels
  int&lt;lower=1&gt; M_2;  // number of coefficients per level
  array[N] int&lt;lower=1&gt; J_2;  // grouping indicator per observation
  // group-level predictor values
  vector[N] Z_2_lks_1;
  // data for group-level effects of ID 3
  int&lt;lower=1&gt; N_3;  // number of grouping levels
  int&lt;lower=1&gt; M_3;  // number of coefficients per level
  array[N] int&lt;lower=1&gt; J_3;  // grouping indicator per observation
  // group-level predictor values
  vector[N] Z_3_lkg_1;
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
}
parameters {
  vector&lt;lower=0&gt;[K_tau] b_tau;  // regression coefficients
  vector[K_lb0] b_lb0;  // regression coefficients
  vector[K_lks] b_lks;  // regression coefficients
  vector[K_lkg] b_lkg;  // regression coefficients
  vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
  array[M_1] vector[N_1] z_1;  // standardized group-level effects
  vector&lt;lower=0&gt;[M_2] sd_2;  // group-level standard deviations
  array[M_2] vector[N_2] z_2;  // standardized group-level effects
  vector&lt;lower=0&gt;[M_3] sd_3;  // group-level standard deviations
  array[M_3] vector[N_3] z_3;  // standardized group-level effects
}
transformed parameters {
  vector[N_1] r_1_lb0_1;  // actual group-level effects
  vector[N_2] r_2_lks_1;  // actual group-level effects
  vector[N_3] r_3_lkg_1;  // actual group-level effects
  real lprior = 0;  // prior contributions to the log posterior
  r_1_lb0_1 = (sd_1[1] * (z_1[1]));
  r_2_lks_1 = (sd_2[1] * (z_2[1]));
  r_3_lkg_1 = (sd_3[1] * (z_3[1]));
  lprior += normal_lpdf(b_tau | 0, 3)
    - 1 * normal_lccdf(0 | 0, 3);
  lprior += normal_lpdf(b_lb0 | log(65), 1);
  lprior += normal_lpdf(b_lks | log(0.52), 0.1);
  lprior += normal_lpdf(b_lkg | log(1.04), 1);
  lprior += normal_lpdf(sd_1 | 0, 3)
    - 1 * normal_lccdf(0 | 0, 3);
  lprior += normal_lpdf(sd_2 | 0, 3)
    - 1 * normal_lccdf(0 | 0, 3);
  lprior += normal_lpdf(sd_3 | 0, 3)
    - 1 * normal_lccdf(0 | 0, 3);
}
model {
  // likelihood including constants
  if (!prior_only) {
    // initialize linear predictor term
    vector[N] nlp_tau = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] nlp_lb0 = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] nlp_lks = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] nlp_lkg = rep_vector(0.0, N);
    // initialize non-linear predictor term
    vector[N] nlp_b0;
    // initialize non-linear predictor term
    vector[N] nlp_ks;
    // initialize non-linear predictor term
    vector[N] nlp_kg;
    // initialize non-linear predictor term
    vector[N] nlp_eta;
    // initialize non-linear predictor term
    vector[N] mu;
    // initialize non-linear predictor term
    vector[N] sigma;
    nlp_tau += X_tau * b_tau;
    nlp_lb0 += X_lb0 * b_lb0;
    nlp_lks += X_lks * b_lks;
    nlp_lkg += X_lkg * b_lkg;
    for (n in 1:N) {
      // add more terms to the linear predictor
      nlp_lb0[n] += r_1_lb0_1[J_1[n]] * Z_1_lb0_1[n];
    }
    for (n in 1:N) {
      // add more terms to the linear predictor
      nlp_lks[n] += r_2_lks_1[J_2[n]] * Z_2_lks_1[n];
    }
    for (n in 1:N) {
      // add more terms to the linear predictor
      nlp_lkg[n] += r_3_lkg_1[J_3[n]] * Z_3_lkg_1[n];
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      nlp_b0[n] = (exp(nlp_lb0[n]));
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      nlp_ks[n] = (exp(nlp_lks[n]));
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      nlp_kg[n] = (exp(nlp_lkg[n]));
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      nlp_eta[n] = (int_step(C_eta_1[n] &gt; 0) * (nlp_b0[n] * (exp( - nlp_ks[n] * C_eta_1[n]) + exp(nlp_kg[n] * C_eta_1[n]) - 1)) + int_step(C_eta_1[n] &lt;= 0) * (nlp_b0[n] * exp(nlp_kg[n] * C_eta_1[n])));
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      mu[n] = (nlp_eta[n]);
    }
    for (n in 1:N) {
      // compute non-linear predictor values
      sigma[n] = exp(log(nlp_tau[n]) + log(nlp_eta[n]));
    }
    target += normal_lpdf(Y | mu, sigma);
  }
  // priors including constants
  target += lprior;
  target += std_normal_lpdf(z_1[1]);
  target += std_normal_lpdf(z_2[1]);
  target += std_normal_lpdf(z_3[1]);
}
generated quantities {
}</code></pre>
</div>
</div>
<p>Here e.g.&nbsp;it is important to see that the <code>sigma</code> parameter is modelled on the log scale.</p></li>
<li><p>We can also extract the actual data that is passed to the Stan program:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the data that is passed to the Stan program</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">standata</span>(formula, <span class="at">prior =</span> priors, <span class="at">data =</span> df, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that the time variable is correct</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(stan_data<span class="sc">$</span>C_eta_1 <span class="sc">==</span> df<span class="sc">$</span>year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>This can be useful to check if the data is passed correctly to the Stan program.</p></li>
<li><p>It is important to take divergence warnings seriously. For the model parameters where <code>Rhat</code> is larger than 1.05 or so, you can just have a look at the traceplot. For example, in an earlier model fit the <span class="math inline">\(\log(\mu_{\phi})\)</span> population parameter had this traceplot:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fit_save <span class="ot">&lt;-</span> fit</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">here</span>(<span class="st">"session-tgi/fit.RData"</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">pars =</span> <span class="st">"b_tphi"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Argument 'pars' is deprecated. Please use 'variable' instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_tgi_sf_brms_files/figure-html/traceplot_example-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> fit_save</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We see that two chains led to a <span class="math inline">\(\log(\mu_{\phi})\)</span> value below 0, while two chains hovered around much larger values between 5 and 15, which corresponds to <span class="math inline">\(\mu_{\phi} = 1\)</span>. This shows that the model is rather overparametrized. By restricting the range of the prior for <span class="math inline">\(\log(\mu_{\phi})\)</span> to be below 0, we could avoid this problem.</p></li>
<li><p>Providing manually realistic initial values for the model parameters can help to speed up the convergence of the Markov chains. This is especially important for the nonlinear parameters. You can get the names of the parameters from the Stan code above - note that you cannot use the names of the <code>brms</code> R code.</p></li>
<li><p>Sometimes it is not easy to get the dimensions of the inital values right. Here it can be helpful to change the backend to <code>rstan</code>, which provides more detailed error messages. You can do this by setting <code>backend = "rstan"</code> in the <code>brm</code> call.</p></li>
<li><p>When the Stan compiler gives you an error, that can be very informative: Just open the Stan code file that is mentioned in the error message and look at the line number that is mentioned. This can give you a good idea of what went wrong: Maybe a typo in the prior definition, or a missing semicolon, or a wrong dimension in the data block. With VScode e.g.&nbsp;this is very easy: Just hold <code>Ctrl</code> and click on the file name and number, and you will be taken to the right line in the Stan code.</p></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "1. TGI model minimal workflow with `brms`"</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> true</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>The purpose of this document is to show a minimal workflow for fitting a TGI model using the <span class="in">`brms`</span> package.</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup_and_load.qmd &gt;}}</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>{{&lt; include _load_data.qmd &gt;}}</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stein-Fojo model</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>We start from the Stein-Fojo model as shown in the slides:</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>y^{*}(t_{ij}) = \psi_{b_{0}i} <span class="sc">\{</span>\exp(- \psi_{k_{s}i} \cdot t_{ij}) + \exp(\psi_{k_{g}i} \cdot t_{ij}) - 1<span class="sc">\}</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mean</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>We will make one more tweak here. If the time $t$ is negative, i.e. the treatment has not started yet, then it is reasonable to assume that the tumor cannot shrink yet. Therefore, the final model for the mean SLD is:</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>y^{*}(t_{ij}) = </span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>\begin{cases} </span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>\psi_{b_{0}i} \exp(\psi_{k_{g}i} \cdot t_{ij}) &amp; \text{if } t_{ij} &lt; 0 <span class="sc">\\</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>\psi_{b_{0}i} <span class="sc">\{</span>\exp(-\psi_{k_{s}i} \cdot t_{ij}) + \exp(\psi_{k_{g}i} \cdot t_{ij}) - 1<span class="sc">\}</span> &amp; \text{if } t_{ij} \geq 0 </span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### Likelihood</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>For the likelihood given the mean SLD $y^{*}$, we will assume a normal distribution with a constant coefficient of variation $\tau$:</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>y(t_{ij}) \sim \text{N}(y^{*}(t_{ij}), y^{*}(t_{ij})\tau)</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>Note that for consistency with the <span class="in">`brms`</span> and <span class="in">`Stan`</span> convention, here we denote the standard deviation as the second parameter of the normal distribution. So in this case, the variance would be $(y^{*}(t_{ij})\tau)^2$.</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>This can also be written as:</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>y(t_{ij}) = (1 + \epsilon_{ij}) \cdot y^{*}(t_{ij})</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>where $\epsilon_{ij} \sim \text{N}(0, \tau)$.</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>Note that also the additive model is a possible choice, where</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>y(t_{ij}) = y^{*}(t_{ij}) + \epsilon_{ij}</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>such that the error does not depend on the scale of the SLD any longer.</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random effects</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>Next, we define the distributions of the random effects $\psi_{b_{0}i}$, $\psi_{k_{s}i}$, $\psi_{k_{g}i}$, for $i = 1, \dotsc, n$:</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>\psi_{b_{0}i} &amp;\sim \text{LogNormal}(\mu_{b_{0}}, \omega_{0}) <span class="sc">\\</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>\psi_{k_{s}i} &amp;\sim \text{LogNormal}(\mu_{k_{s}}, \omega_{s}) <span class="sc">\\</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>\psi_{k_{g}i} &amp;\sim \text{LogNormal}(\mu_{k_{g}}, \omega_{g})</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>This can be rewritten as:</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>\psi_{b_{0}i} &amp;= \exp(\mu_{b_{0}} + \omega_{0} \cdot \eta_{b_{0}i}) <span class="sc">\\</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>\psi_{k_{s}i} &amp;= \exp(\mu_{k_{s}} + \omega_{s} \cdot \eta_{k_{s}i}) <span class="sc">\\</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>\psi_{k_{g}i} &amp;= \exp(\mu_{k_{g}} + \omega_{g} \cdot \eta_{k_{g}i})</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>where $\eta_{b_{0}i}$, $\eta_{k_{s}i}$, $\eta_{k_{g}i}$ are the standard normal distributed random effects.</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>This is important for two reasons:</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>This parametrization can help the sampler to converge faster. See <span class="co">[</span><span class="ot">here</span><span class="co">](https://mc-stan.org/docs/stan-users-guide/efficiency-tuning.html#non-centered-parameterization)</span> for more information.</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>This shows a bit more explicitly that the population mean of the random effects is not equal to the $\mu$ parameter, but to $\exp(\mu + \omega^2 / 2)$, because they are log-normally distributed (see e.g. <span class="co">[</span><span class="ot">Wikipedia</span><span class="co">](https://en.wikipedia.org/wiki/Log-normal_distribution#Arithmetic_moments)</span> for the formulas). This is important for the interpretation of the parameter estimates.</span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a><span class="fu">### Priors</span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a>Finally, we need to define the priors for the hyperparameters. </span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a>There are different principles we could use to define these priors:</span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Non-informative priors**: We could use priors that are as non-informative as possible. This is especially useful if we do not have any prior knowledge about the parameters. For example, we could use normal priors with a large standard deviation for the population means of the random effects.</span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Informative priors**: If we have some prior knowledge about the parameters, we can use this to define the priors. For example, if we have literature data about the $k_g$ parameter estimate, we could use this to define the prior for the population mean of the growth rate. (Here we just need to be careful to consider the time scale and the log-normal distribution, as mentioned above)</span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>Here we use relatively informative priors for the log-normal location parameters, motivated by prior analyses of the same study:</span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a>\mu_{b_{0}} &amp;\sim \text{LogNormal}(\log(65), 1) <span class="sc">\\</span></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>\mu_{k_{s}} &amp;\sim \text{LogNormal}(\log(0.52), 0.1) <span class="sc">\\</span></span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a>\mu_{k_{g}} &amp;\sim \text{LogNormal}(\log(1.04), 1)</span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a>For all standard deviations we use truncated normal priors:</span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a>\omega_{0} &amp;\sim \text{PositiveNormal}(0, 3) <span class="sc">\\</span></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a>\omega_{s} &amp;\sim \text{PositiveNormal}(0, 3) <span class="sc">\\</span></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a>\omega_{g} &amp;\sim \text{PositiveNormal}(0, 3) <span class="sc">\\</span></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a>\tau &amp;\sim \text{PositiveNormal}(0, 3)</span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a>where $\text{PositiveNormal}(0, 3)$ denotes a truncated normal distribution with mean $0$ and standard deviation $3$, truncated to the positive real numbers.</span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit model</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a>We can now fit the model using <span class="in">`brms`</span>. The structure is determined by the model formula:</span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_brms</span></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(sld <span class="sc">~</span> eta, <span class="at">nl =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the mean for the likelihood</span></span>
<span id="cb53-141"><a href="#cb53-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(</span>
<span id="cb53-142"><a href="#cb53-142" aria-hidden="true" tabindex="-1"></a>    eta <span class="sc">~</span> </span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> (<span class="fu">exp</span>(<span class="sc">-</span>ks <span class="sc">*</span> year) <span class="sc">+</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year) <span class="sc">-</span>  <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year))</span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the standard deviation (called sigma in brms) as a </span></span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficient tau times the mean.</span></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sigma is modelled on the log scale though, therefore:</span></span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(sigma <span class="sc">~</span> <span class="fu">log</span>(tau) <span class="sc">+</span> <span class="fu">log</span>(eta)) <span class="sc">+</span></span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(tau <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define nonlinear parameter transformations</span></span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(b0 <span class="sc">~</span> <span class="fu">exp</span>(lb0)) <span class="sc">+</span></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(ks <span class="sc">~</span> <span class="fu">exp</span>(lks)) <span class="sc">+</span></span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(kg <span class="sc">~</span> <span class="fu">exp</span>(lkg)) <span class="sc">+</span></span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define random effect structure</span></span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lb0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span> </span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lks <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span></span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lkg <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the priors</span></span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lb0"</span>),</span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="fl">0.1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>),</span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>),</span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lb0"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-168"><a href="#cb53-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-169"><a href="#cb53-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"tau"</span>)</span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial values to avoid problems at the beginning</span></span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>n_patients <span class="ot">&lt;-</span> <span class="fu">nlevels</span>(df<span class="sc">$</span>id)</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lb0 =</span> <span class="fu">array</span>(<span class="fl">3.61</span>),</span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lks =</span> <span class="fu">array</span>(<span class="sc">-</span><span class="fl">1.25</span>),</span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lkg =</span> <span class="fu">array</span>(<span class="sc">-</span><span class="fl">1.33</span>),</span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_1 =</span> <span class="fu">array</span>(<span class="fl">0.58</span>),</span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_2 =</span> <span class="fu">array</span>(<span class="fl">1.6</span>),</span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_3 =</span> <span class="fu">array</span>(<span class="fl">0.994</span>),</span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_tau =</span> <span class="fu">array</span>(<span class="fl">0.161</span>),</span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_1 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_2 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_3 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients)</span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/fit9.RData"</span>)</span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> priors,</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> <span class="fu">rep</span>(<span class="fu">list</span>(inits), CHAINS),</span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> CHAINS, </span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> ITER <span class="sc">+</span> WARMUP, </span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> WARMUP, </span>
<span id="cb53-202"><a href="#cb53-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb53-203"><a href="#cb53-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> REFRESH</span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit, <span class="at">file =</span> save_file)</span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fit</span></span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>Note that it is crucial to use here <span class="in">`int_step()`</span> to properly define the two pieces of the linear predictor for negative and non-negative time values: If you used <span class="in">`step()`</span> like I did for a few days, then you will have the wrong model! This is because in Stan, <span class="in">`step(false) = step(0) = 1`</span> and not 0 as you would expect. Only <span class="in">`int_step(0) = 0`</span> as we need it here. </span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter estimates</span></span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a>Here we extract all parameter estimates using the <span class="in">`as_draws_df`</span> method for <span class="in">`brmsfit`</span> objects. Note that we could also just extract a subset of parameters, see <span class="in">`?as_draws.brmsfit`</span> for more information.</span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a>As mentioned above, we use the expectation of the log-normal distribution to get the population level estimates for the $b_0$, $k_s$, and $k_g$ parameters. We also calculate the coefficient of variation for each parameter.</span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_parameters</span></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a>post_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit)</span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">names</span>(post_df), <span class="dv">10</span>)</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a>post_df <span class="ot">&lt;-</span> post_df <span class="sc">|&gt;</span></span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_0 =</span> sd_id__lb0_Intercept,</span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_s =</span> sd_id__lks_Intercept,</span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_g =</span> sd_id__lkg_Intercept,</span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> b_tau_Intercept</span>
<span id="cb53-239"><a href="#cb53-239" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>For a graphical check of the convergence, we can use the <span class="in">`mcmc_trace`</span> and <span class="in">`mcmc_pairs`</span> functions from the <span class="in">`bayesplot`</span> package:</span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_convergence</span></span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-249"><a href="#cb53-249" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(post_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"ks"</span>, <span class="st">"kg"</span>, <span class="st">"omega_0"</span>, <span class="st">"omega_s"</span>, <span class="st">"omega_g"</span>, <span class="st">"sigma"</span>))</span>
<span id="cb53-250"><a href="#cb53-250" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(post_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"b0"</span>, <span class="st">"ks"</span>, <span class="st">"kg"</span>, <span class="st">"omega_0"</span>, <span class="st">"omega_s"</span>, <span class="st">"omega_g"</span>, <span class="st">"sigma"</span>))</span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>Next, we can create a nice summary table of the parameter estimates, using <span class="in">`summarize_draws`</span> from the <span class="in">`posterior`</span> package in combination with functions from the <span class="in">`gt`</span> package:</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: summarize_parameters</span></span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a>post_sum <span class="ot">&lt;-</span> post_df <span class="sc">|&gt;</span></span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b0, ks, kg, omega_0, omega_s, omega_g, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a>post_sum</span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a>We can also look at parameters for individual patients. This is simplified by using the <span class="in">`spread_draws()`</span> function:</span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-272"><a href="#cb53-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_individual_parameters</span></span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Understand the names of the random effects:</span></span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">get_variables</span>(fit), <span class="dv">10</span>)</span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>post_ind <span class="ot">&lt;-</span> fit <span class="sc">|&gt;</span> </span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(</span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>    b_lb0_Intercept,</span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a>    r_id__lb0[id, ],</span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a>    b_lks_Intercept,</span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a>    r_id__lks[id, ],</span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a>    b_lkg_Intercept,</span>
<span id="cb53-285"><a href="#cb53-285" aria-hidden="true" tabindex="-1"></a>    r_id__lkg[id, ]</span>
<span id="cb53-286"><a href="#cb53-286" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> r_id__lb0),</span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> r_id__lks),</span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> r_id__lkg)</span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb53-292"><a href="#cb53-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb53-293"><a href="#cb53-293" aria-hidden="true" tabindex="-1"></a>    .chain, .iteration, .draw,</span>
<span id="cb53-294"><a href="#cb53-294" aria-hidden="true" tabindex="-1"></a>    id, b0, ks, kg    </span>
<span id="cb53-295"><a href="#cb53-295" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-296"><a href="#cb53-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-297"><a href="#cb53-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-298"><a href="#cb53-298" aria-hidden="true" tabindex="-1"></a>With this we can e.g. report the estimates for the first patient:</span>
<span id="cb53-299"><a href="#cb53-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-302"><a href="#cb53-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-303"><a href="#cb53-303" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: first_patient_estimates</span></span>
<span id="cb53-304"><a href="#cb53-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-305"><a href="#cb53-305" aria-hidden="true" tabindex="-1"></a>post_sum_id1 <span class="ot">&lt;-</span> post_ind <span class="sc">|&gt;</span></span>
<span id="cb53-306"><a href="#cb53-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb53-307"><a href="#cb53-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-308"><a href="#cb53-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-309"><a href="#cb53-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb53-310"><a href="#cb53-310" aria-hidden="true" tabindex="-1"></a>post_sum_id1</span>
<span id="cb53-311"><a href="#cb53-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-312"><a href="#cb53-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-313"><a href="#cb53-313" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observation vs model fit</span></span>
<span id="cb53-314"><a href="#cb53-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-315"><a href="#cb53-315" aria-hidden="true" tabindex="-1"></a>We can now compare the model fit to the observations. Let's do this for the first 20 patients again.</span>
<span id="cb53-316"><a href="#cb53-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-319"><a href="#cb53-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-320"><a href="#cb53-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: obs_vs_fit_plots</span></span>
<span id="cb53-321"><a href="#cb53-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-322"><a href="#cb53-322" aria-hidden="true" tabindex="-1"></a>pt_subset <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb53-323"><a href="#cb53-323" aria-hidden="true" tabindex="-1"></a>df_subset <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb53-324"><a href="#cb53-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> pt_subset)</span>
<span id="cb53-325"><a href="#cb53-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-326"><a href="#cb53-326" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> df_subset <span class="sc">|&gt;</span> </span>
<span id="cb53-327"><a href="#cb53-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_grid</span>(</span>
<span id="cb53-328"><a href="#cb53-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> pt_subset, </span>
<span id="cb53-329"><a href="#cb53-329" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">seq_range</span>(year, <span class="dv">101</span>)</span>
<span id="cb53-330"><a href="#cb53-330" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb53-331"><a href="#cb53-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_linpred_draws</span>(fit) <span class="sc">|&gt;</span> </span>
<span id="cb53-332"><a href="#cb53-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-333"><a href="#cb53-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sld_pred =</span> .linpred)</span>
<span id="cb53-334"><a href="#cb53-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-335"><a href="#cb53-335" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">|&gt;</span></span>
<span id="cb53-336"><a href="#cb53-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> sld)) <span class="sc">+</span></span>
<span id="cb53-337"><a href="#cb53-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id) <span class="sc">+</span></span>
<span id="cb53-338"><a href="#cb53-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb53-339"><a href="#cb53-339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> sld_pred, <span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper),</span>
<span id="cb53-340"><a href="#cb53-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.3</span>, </span>
<span id="cb53-341"><a href="#cb53-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"deepskyblue"</span></span>
<span id="cb53-342"><a href="#cb53-342" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-343"><a href="#cb53-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sld_pred), <span class="at">color =</span> <span class="st">"deepskyblue"</span>) <span class="sc">+</span></span>
<span id="cb53-344"><a href="#cb53-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> df_subset, <span class="at">color =</span> <span class="st">"tomato"</span>) <span class="sc">+</span></span>
<span id="cb53-345"><a href="#cb53-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">range</span>(df_subset<span class="sc">$</span>sld)) <span class="sc">+</span></span>
<span id="cb53-346"><a href="#cb53-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Greys"</span>) <span class="sc">+</span></span>
<span id="cb53-347"><a href="#cb53-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"SF model fit"</span>)</span>
<span id="cb53-348"><a href="#cb53-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-349"><a href="#cb53-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-350"><a href="#cb53-350" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding covariates</span></span>
<span id="cb53-351"><a href="#cb53-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-352"><a href="#cb53-352" aria-hidden="true" tabindex="-1"></a>With <span class="in">`brms`</span> it is straightforward to add covariates to the model. In this example, an obvious choice for a covariate is the treatment the patients received in the study:</span>
<span id="cb53-353"><a href="#cb53-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-356"><a href="#cb53-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-357"><a href="#cb53-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: arms_distribution</span></span>
<span id="cb53-358"><a href="#cb53-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-359"><a href="#cb53-359" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb53-360"><a href="#cb53-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, arm) <span class="sc">|&gt;</span> </span>
<span id="cb53-361"><a href="#cb53-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-362"><a href="#cb53-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(arm) <span class="sc">|&gt;</span> </span>
<span id="cb53-363"><a href="#cb53-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span>
<span id="cb53-364"><a href="#cb53-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-365"><a href="#cb53-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-366"><a href="#cb53-366" aria-hidden="true" tabindex="-1"></a>Here it makes sense to assume that only the shrinkage and growth parameters differ systematically between the two arms. For example, the baseline SLD should be the same in expectation, because of the randomization between the treatment arms.</span>
<span id="cb53-367"><a href="#cb53-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-368"><a href="#cb53-368" aria-hidden="true" tabindex="-1"></a>Therefore we can add this as follows as a fixed effect for the two parameters:</span>
<span id="cb53-369"><a href="#cb53-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-372"><a href="#cb53-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-373"><a href="#cb53-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: formula_covariates</span></span>
<span id="cb53-374"><a href="#cb53-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-375"><a href="#cb53-375" aria-hidden="true" tabindex="-1"></a>formula_by_arm <span class="ot">&lt;-</span> <span class="fu">bf</span>(sld <span class="sc">~</span> eta, <span class="at">nl =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-376"><a href="#cb53-376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the mean for the likelihood</span></span>
<span id="cb53-377"><a href="#cb53-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(</span>
<span id="cb53-378"><a href="#cb53-378" aria-hidden="true" tabindex="-1"></a>    eta <span class="sc">~</span> </span>
<span id="cb53-379"><a href="#cb53-379" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb53-380"><a href="#cb53-380" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> (<span class="fu">exp</span>(<span class="sc">-</span>ks <span class="sc">*</span> year) <span class="sc">+</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year) <span class="sc">-</span>  <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb53-381"><a href="#cb53-381" aria-hidden="true" tabindex="-1"></a>      <span class="fu">int_step</span>(year <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="sc">*</span> </span>
<span id="cb53-382"><a href="#cb53-382" aria-hidden="true" tabindex="-1"></a>        (b0 <span class="sc">*</span> <span class="fu">exp</span>(kg <span class="sc">*</span> year))</span>
<span id="cb53-383"><a href="#cb53-383" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-384"><a href="#cb53-384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the standard deviation (called sigma in brms) as a </span></span>
<span id="cb53-385"><a href="#cb53-385" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficient tau times the mean.</span></span>
<span id="cb53-386"><a href="#cb53-386" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sigma is modelled on the log scale though, therefore:</span></span>
<span id="cb53-387"><a href="#cb53-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(sigma <span class="sc">~</span> <span class="fu">log</span>(tau) <span class="sc">+</span> <span class="fu">log</span>(eta)) <span class="sc">+</span></span>
<span id="cb53-388"><a href="#cb53-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(tau <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-389"><a href="#cb53-389" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define nonlinear parameter transformations</span></span>
<span id="cb53-390"><a href="#cb53-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(b0 <span class="sc">~</span> <span class="fu">exp</span>(lb0)) <span class="sc">+</span></span>
<span id="cb53-391"><a href="#cb53-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(ks <span class="sc">~</span> <span class="fu">exp</span>(lks)) <span class="sc">+</span></span>
<span id="cb53-392"><a href="#cb53-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nlf</span>(kg <span class="sc">~</span> <span class="fu">exp</span>(lkg)) <span class="sc">+</span></span>
<span id="cb53-393"><a href="#cb53-393" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define random effect structure</span></span>
<span id="cb53-394"><a href="#cb53-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lb0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span> </span>
<span id="cb53-395"><a href="#cb53-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lks <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> arm <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)) <span class="sc">+</span></span>
<span id="cb53-396"><a href="#cb53-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lf</span>(lkg <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> arm <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id))</span>
<span id="cb53-397"><a href="#cb53-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-398"><a href="#cb53-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-399"><a href="#cb53-399" aria-hidden="true" tabindex="-1"></a>It is instructive to see that the Stan code that is generated in the background is actually identical to the previous model, except for the prior specification. This is because <span class="in">`brms`</span> uses a design matrix to model the fixed effects, and the <span class="in">`arm`</span> variable is just added to this design matrix, which before only contained the intercept column with <span class="in">`1`</span>s. </span>
<span id="cb53-400"><a href="#cb53-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-401"><a href="#cb53-401" aria-hidden="true" tabindex="-1"></a>However, now the coefficient vector is no longer of length 1 but of length 2, with the first element corresponding to the intercept and the second element to the effect of the <span class="in">`arm`</span> variable (for the level "2"). For the latter, we want to assume a standard normal prior on the log scale. </span>
<span id="cb53-402"><a href="#cb53-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-403"><a href="#cb53-403" aria-hidden="true" tabindex="-1"></a>So we need to adjust the prior and initial values accordingly:</span>
<span id="cb53-404"><a href="#cb53-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-407"><a href="#cb53-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-408"><a href="#cb53-408" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: priors_covariates</span></span>
<span id="cb53-409"><a href="#cb53-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-410"><a href="#cb53-410" aria-hidden="true" tabindex="-1"></a>priors_by_arm <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb53-411"><a href="#cb53-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lb0"</span>),</span>
<span id="cb53-412"><a href="#cb53-412" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the changes here:</span></span>
<span id="cb53-413"><a href="#cb53-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="fl">0.1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb53-414"><a href="#cb53-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">coef =</span> <span class="st">"arm2"</span>), </span>
<span id="cb53-415"><a href="#cb53-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">coef =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb53-416"><a href="#cb53-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">coef =</span> <span class="st">"arm2"</span>),</span>
<span id="cb53-417"><a href="#cb53-417" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same as before:</span></span>
<span id="cb53-418"><a href="#cb53-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lb0"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-419"><a href="#cb53-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lks"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-420"><a href="#cb53-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"lkg"</span>, <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb53-421"><a href="#cb53-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">lb =</span> <span class="dv">0</span>, <span class="at">nlpar =</span> <span class="st">"tau"</span>)</span>
<span id="cb53-422"><a href="#cb53-422" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-423"><a href="#cb53-423" aria-hidden="true" tabindex="-1"></a>inits_by_arm <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb53-424"><a href="#cb53-424" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lb0 =</span> <span class="fu">array</span>(<span class="fl">3.61</span>),</span>
<span id="cb53-425"><a href="#cb53-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note the changes here:</span></span>
<span id="cb53-426"><a href="#cb53-426" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lks =</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.25</span>, <span class="dv">0</span>)),</span>
<span id="cb53-427"><a href="#cb53-427" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_lkg =</span> <span class="fu">array</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.33</span>, <span class="dv">0</span>)),</span>
<span id="cb53-428"><a href="#cb53-428" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same as before:</span></span>
<span id="cb53-429"><a href="#cb53-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_1 =</span> <span class="fu">array</span>(<span class="fl">0.58</span>),</span>
<span id="cb53-430"><a href="#cb53-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_2 =</span> <span class="fu">array</span>(<span class="fl">1.6</span>),</span>
<span id="cb53-431"><a href="#cb53-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_3 =</span> <span class="fu">array</span>(<span class="fl">0.994</span>),</span>
<span id="cb53-432"><a href="#cb53-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_tau =</span> <span class="fu">array</span>(<span class="fl">0.161</span>),</span>
<span id="cb53-433"><a href="#cb53-433" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_1 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb53-434"><a href="#cb53-434" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_2 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients),</span>
<span id="cb53-435"><a href="#cb53-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">z_3 =</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol =</span> n_patients)</span>
<span id="cb53-436"><a href="#cb53-436" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-437"><a href="#cb53-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-438"><a href="#cb53-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-439"><a href="#cb53-439" aria-hidden="true" tabindex="-1"></a>Now we can fit the model as before:</span>
<span id="cb53-440"><a href="#cb53-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-443"><a href="#cb53-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-444"><a href="#cb53-444" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_brms_by_arm</span></span>
<span id="cb53-445"><a href="#cb53-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-446"><a href="#cb53-446" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/fit10.RData"</span>)</span>
<span id="cb53-447"><a href="#cb53-447" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb53-448"><a href="#cb53-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb53-449"><a href="#cb53-449" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-450"><a href="#cb53-450" aria-hidden="true" tabindex="-1"></a>  fit_by_arm <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb53-451"><a href="#cb53-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> formula_by_arm,</span>
<span id="cb53-452"><a href="#cb53-452" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb53-453"><a href="#cb53-453" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> priors_by_arm,</span>
<span id="cb53-454"><a href="#cb53-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb53-455"><a href="#cb53-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> <span class="fu">rep</span>(<span class="fu">list</span>(inits_by_arm), CHAINS),</span>
<span id="cb53-456"><a href="#cb53-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> CHAINS, </span>
<span id="cb53-457"><a href="#cb53-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> ITER <span class="sc">+</span> WARMUP, </span>
<span id="cb53-458"><a href="#cb53-458" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> WARMUP, </span>
<span id="cb53-459"><a href="#cb53-459" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb53-460"><a href="#cb53-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> REFRESH</span>
<span id="cb53-461"><a href="#cb53-461" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-462"><a href="#cb53-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit_by_arm, <span class="at">file =</span> save_file)</span>
<span id="cb53-463"><a href="#cb53-463" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-464"><a href="#cb53-464" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_by_arm)</span>
<span id="cb53-465"><a href="#cb53-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-466"><a href="#cb53-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-467"><a href="#cb53-467" aria-hidden="true" tabindex="-1"></a>Let's have a look at the parameter estimates then:</span>
<span id="cb53-468"><a href="#cb53-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-471"><a href="#cb53-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-472"><a href="#cb53-472" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_parameters_by_arm</span></span>
<span id="cb53-473"><a href="#cb53-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-474"><a href="#cb53-474" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit_by_arm)</span>
<span id="cb53-475"><a href="#cb53-475" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">names</span>(post_df_by_arm), <span class="dv">10</span>)</span>
<span id="cb53-476"><a href="#cb53-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-477"><a href="#cb53-477" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="ot">&lt;-</span> post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb53-478"><a href="#cb53-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-479"><a href="#cb53-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0 =</span> <span class="fu">exp</span>(b_lb0_Intercept <span class="sc">+</span> sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-480"><a href="#cb53-480" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks_arm1 =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-481"><a href="#cb53-481" aria-hidden="true" tabindex="-1"></a>    <span class="at">ks_arm2 =</span> <span class="fu">exp</span>(b_lks_Intercept <span class="sc">+</span> b_lks_arm2 <span class="sc">+</span> sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-482"><a href="#cb53-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg_arm1 =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-483"><a href="#cb53-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">kg_arm2 =</span> <span class="fu">exp</span>(b_lkg_Intercept <span class="sc">+</span> b_lkg_arm2 <span class="sc">+</span> sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb53-484"><a href="#cb53-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_0 =</span> sd_id__lb0_Intercept,</span>
<span id="cb53-485"><a href="#cb53-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_s =</span> sd_id__lks_Intercept,</span>
<span id="cb53-486"><a href="#cb53-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_g =</span> sd_id__lkg_Intercept,</span>
<span id="cb53-487"><a href="#cb53-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lb0_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-488"><a href="#cb53-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lks_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-489"><a href="#cb53-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(sd_id__lkg_Intercept<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb53-490"><a href="#cb53-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> b_tau_Intercept</span>
<span id="cb53-491"><a href="#cb53-491" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-492"><a href="#cb53-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-493"><a href="#cb53-493" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm <span class="ot">&lt;-</span> post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb53-494"><a href="#cb53-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(b0, ks_arm1, ks_arm2, kg_arm1, kg_arm2, omega_0, omega_s, omega_g, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb53-495"><a href="#cb53-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-496"><a href="#cb53-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-497"><a href="#cb53-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb53-498"><a href="#cb53-498" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm</span>
<span id="cb53-499"><a href="#cb53-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-500"><a href="#cb53-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-501"><a href="#cb53-501" aria-hidden="true" tabindex="-1"></a>So we see that the shrinkage is stronger in arm 1 compared to arm 2, while the growth rates are similar. We could also calculate the posterior probability that the growth rate is different between the two arms, for example:</span>
<span id="cb53-502"><a href="#cb53-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-505"><a href="#cb53-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-506"><a href="#cb53-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: posterior_prob_diff</span></span>
<span id="cb53-507"><a href="#cb53-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-508"><a href="#cb53-508" aria-hidden="true" tabindex="-1"></a>post_df_by_arm <span class="sc">|&gt;</span></span>
<span id="cb53-509"><a href="#cb53-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff_pos =</span> ks_arm1 <span class="sc">-</span> ks_arm2 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb53-510"><a href="#cb53-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">diff_prob =</span> <span class="fu">mean</span>(diff_pos))</span>
<span id="cb53-511"><a href="#cb53-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-512"><a href="#cb53-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-513"><a href="#cb53-513" aria-hidden="true" tabindex="-1"></a>So we see that the posterior probability that the shrinkage rate is higher in arm 1 compared to arm 2 is quite high.</span>
<span id="cb53-514"><a href="#cb53-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-515"><a href="#cb53-515" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model comparison with LOO</span></span>
<span id="cb53-516"><a href="#cb53-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-517"><a href="#cb53-517" aria-hidden="true" tabindex="-1"></a>The LOO criterion is a widely used method for comparing models. It is based on the idea of leave-one-out cross-validation, but is more efficient to compute. </span>
<span id="cb53-518"><a href="#cb53-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-519"><a href="#cb53-519" aria-hidden="true" tabindex="-1"></a>With <span class="in">`brms`</span>, it is easy to compute the LOO criterion:</span>
<span id="cb53-520"><a href="#cb53-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-523"><a href="#cb53-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-524"><a href="#cb53-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loo</span></span>
<span id="cb53-525"><a href="#cb53-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-526"><a href="#cb53-526" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(fit)</span>
<span id="cb53-527"><a href="#cb53-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-528"><a href="#cb53-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-529"><a href="#cb53-529" aria-hidden="true" tabindex="-1"></a>A helpful glossary explaining the LOO statistics can be found <span class="co">[</span><span class="ot">here</span><span class="co">](https://mc-stan.org/cmdstanr/reference/loo-glossary.html)</span>.</span>
<span id="cb53-530"><a href="#cb53-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-531"><a href="#cb53-531" aria-hidden="true" tabindex="-1"></a>Different criteria are available, for example the <span class="in">`elpd_loo`</span> is the expected log pointwise predictive density, and the <span class="in">`looic = -2 * elpd_loo`</span> is the LOO information criterion. For comparing models, the <span class="in">`looic`</span> is often used, where smaller numbers are better. it is kind of an equivalent to the AIC, but based on the LOO criterion.</span>
<span id="cb53-532"><a href="#cb53-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-533"><a href="#cb53-533" aria-hidden="true" tabindex="-1"></a>Let's e.g. compare the two models we fitted above, one for the whole dataset and one with the treatment arm as a covariate for the shrinkage and growth rates:</span>
<span id="cb53-534"><a href="#cb53-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-537"><a href="#cb53-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-538"><a href="#cb53-538" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loo_compare</span></span>
<span id="cb53-539"><a href="#cb53-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-540"><a href="#cb53-540" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit, <span class="st">"loo"</span>)</span>
<span id="cb53-541"><a href="#cb53-541" aria-hidden="true" tabindex="-1"></a>fit_by_arm <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(fit_by_arm, <span class="st">"loo"</span>)</span>
<span id="cb53-542"><a href="#cb53-542" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(fit, fit_by_arm)</span>
<span id="cb53-543"><a href="#cb53-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-544"><a href="#cb53-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-545"><a href="#cb53-545" aria-hidden="true" tabindex="-1"></a>So the model without treatment arm seems to be very slightly preferred here by the LOO criterion. Nevertheless, the model with treatment arm might answer exactly the question we need to answer, so it is important to consider the context of the analysis.</span>
<span id="cb53-546"><a href="#cb53-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-547"><a href="#cb53-547" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tips and tricks</span></span>
<span id="cb53-548"><a href="#cb53-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-549"><a href="#cb53-549" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>When the model breaks down completely, that is a sign that likely the model specification is wrong. For example, in above code I first did not understand how to model the <span class="in">`sigma`</span> parameter correctly, which led to a model where each chain was completely stuck at its initial values.</span>
<span id="cb53-550"><a href="#cb53-550" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In that case and in general if you are not sure whether the <span class="in">`brms`</span> model specification is correct, you can check the Stan code that is generated by <span class="in">`brms`</span>:</span>
<span id="cb53-551"><a href="#cb53-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-552"><a href="#cb53-552" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb53-553"><a href="#cb53-553" aria-hidden="true" tabindex="-1"></a><span class="in">  #| label: check_stan_code</span></span>
<span id="cb53-554"><a href="#cb53-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-555"><a href="#cb53-555" aria-hidden="true" tabindex="-1"></a><span class="in">  # Good to check the stan code:</span></span>
<span id="cb53-556"><a href="#cb53-556" aria-hidden="true" tabindex="-1"></a><span class="in">  # (This also helps to find the names of the parameters</span></span>
<span id="cb53-557"><a href="#cb53-557" aria-hidden="true" tabindex="-1"></a><span class="in">  # for which to define the initial values below)</span></span>
<span id="cb53-558"><a href="#cb53-558" aria-hidden="true" tabindex="-1"></a><span class="in">  stancode(formula, prior = priors, data = df, family = gaussian())</span></span>
<span id="cb53-559"><a href="#cb53-559" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb53-560"><a href="#cb53-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-561"><a href="#cb53-561" aria-hidden="true" tabindex="-1"></a>  Here e.g. it is important to see that the <span class="in">`sigma`</span> parameter is modelled on the log scale.</span>
<span id="cb53-562"><a href="#cb53-562" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We can also extract the actual data that is passed to the Stan program:</span>
<span id="cb53-563"><a href="#cb53-563" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-564"><a href="#cb53-564" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb53-565"><a href="#cb53-565" aria-hidden="true" tabindex="-1"></a><span class="in">  #| label: extract_data</span></span>
<span id="cb53-566"><a href="#cb53-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-567"><a href="#cb53-567" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract the data that is passed to the Stan program</span></span>
<span id="cb53-568"><a href="#cb53-568" aria-hidden="true" tabindex="-1"></a><span class="in">  stan_data &lt;- standata(formula, prior = priors, data = df, family = gaussian())</span></span>
<span id="cb53-569"><a href="#cb53-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-570"><a href="#cb53-570" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check that the time variable is correct</span></span>
<span id="cb53-571"><a href="#cb53-571" aria-hidden="true" tabindex="-1"></a><span class="in">  all(stan_data$C_eta_1 == df$year)</span></span>
<span id="cb53-572"><a href="#cb53-572" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb53-573"><a href="#cb53-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-574"><a href="#cb53-574" aria-hidden="true" tabindex="-1"></a>  This can be useful to check if the data is passed correctly to the Stan program.</span>
<span id="cb53-575"><a href="#cb53-575" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is important to take divergence warnings seriously. For the model parameters where <span class="in">`Rhat`</span> is larger than 1.05 or so, you can just have a look at the traceplot. For example, in an earlier model fit the $\log(\mu_{\phi})$ population parameter had this traceplot:</span>
<span id="cb53-576"><a href="#cb53-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-577"><a href="#cb53-577" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb53-578"><a href="#cb53-578" aria-hidden="true" tabindex="-1"></a><span class="in">  #| label: traceplot_example</span></span>
<span id="cb53-579"><a href="#cb53-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-580"><a href="#cb53-580" aria-hidden="true" tabindex="-1"></a><span class="in">  fit_save &lt;- fit</span></span>
<span id="cb53-581"><a href="#cb53-581" aria-hidden="true" tabindex="-1"></a><span class="in">  load(here("session-tgi/fit.RData"))</span></span>
<span id="cb53-582"><a href="#cb53-582" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(fit, pars = "b_tphi")</span></span>
<span id="cb53-583"><a href="#cb53-583" aria-hidden="true" tabindex="-1"></a><span class="in">  fit &lt;- fit_save</span></span>
<span id="cb53-584"><a href="#cb53-584" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb53-585"><a href="#cb53-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-586"><a href="#cb53-586" aria-hidden="true" tabindex="-1"></a>  We see that two chains led to a $\log(\mu_{\phi})$ value below 0, while two chains hovered around much larger values between 5 and 15, which corresponds to $\mu_{\phi} = 1$. This shows that the model is rather overparametrized. By restricting the range of the prior for $\log(\mu_{\phi})$ to be below 0, we could avoid this problem.</span>
<span id="cb53-587"><a href="#cb53-587" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Providing manually realistic initial values for the model parameters can help to speed up the convergence of the Markov chains. This is especially important for the nonlinear parameters. You can get the names of the parameters from the Stan code above - note that you cannot use the names of the <span class="in">`brms`</span> R code. </span>
<span id="cb53-588"><a href="#cb53-588" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sometimes it is not easy to get the dimensions of the inital values right. Here it can be helpful to change the backend to <span class="in">`rstan`</span>, which provides more detailed error messages. You can do this by setting <span class="in">`backend = "rstan"`</span> in the <span class="in">`brm`</span> call.</span>
<span id="cb53-589"><a href="#cb53-589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>When the Stan compiler gives you an error, that can be very informative: Just open the Stan code file that is mentioned in the error message and look at the line number that is mentioned. This can give you a good idea of what went wrong: Maybe a typo in the prior definition, or a missing semicolon, or a wrong dimension in the data block. With VScode e.g. this is very easy: Just hold <span class="in">`Ctrl`</span> and click on the file name and number, and you will be taken to the right line in the Stan code.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-tgi/1_tgi_sf_brms.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>