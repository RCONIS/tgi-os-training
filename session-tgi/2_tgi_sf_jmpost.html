<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-04-25">

<title>2. TGI model minimal workflow with jmpost – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-45204b72a2a947c2139097db84dadf54.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-tgi/0_setup.html">Session 1: TGI</a></li><li class="breadcrumb-item"><a href="../session-tgi/2_tgi_sf_jmpost.html">2. TGI model minimal workflow with <code>jmpost</code></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">TGI-OS Training</a> 
        <div class="sidebar-tools-main">
    <a href="https://rconis.github.io/tgi-os-training/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 3: TGI-OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/1_jm-jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI-OS joint model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 2: OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/1_os_weibull_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. OS model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/2_os_weibull_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. OS model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/4_tgi_cb_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Claret-Bruno model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#model-specification" id="toc-model-specification" class="nav-link" data-scroll-target="#model-specification">Model specification</a></li>
  <li><a href="#fit-model" id="toc-fit-model" class="nav-link" data-scroll-target="#fit-model">Fit model</a></li>
  <li><a href="#observation-vs.-model-fit" id="toc-observation-vs.-model-fit" class="nav-link" data-scroll-target="#observation-vs.-model-fit">Observation vs.&nbsp;model fit</a></li>
  <li><a href="#prior-vs.-posterior" id="toc-prior-vs.-posterior" class="nav-link" data-scroll-target="#prior-vs.-posterior">Prior vs.&nbsp;posterior</a></li>
  <li><a href="#parameter-estimates" id="toc-parameter-estimates" class="nav-link" data-scroll-target="#parameter-estimates">Parameter estimates</a></li>
  <li><a href="#separate-arm-estimates" id="toc-separate-arm-estimates" class="nav-link" data-scroll-target="#separate-arm-estimates">Separate arm estimates</a></li>
  <li><a href="#model-comparison-with-loo" id="toc-model-comparison-with-loo" class="nav-link" data-scroll-target="#model-comparison-with-loo">Model comparison with LOO</a></li>
  <li><a href="#tipps-and-tricks" id="toc-tipps-and-tricks" class="nav-link" data-scroll-target="#tipps-and-tricks">Tipps and tricks</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-tgi/2_tgi_sf_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-tgi/0_setup.html">Session 1: TGI</a></li><li class="breadcrumb-item"><a href="../session-tgi/2_tgi_sf_jmpost.html">2. TGI model minimal workflow with <code>jmpost</code></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">2. TGI model minimal workflow with <code>jmpost</code></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-04-25</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Let’s try to fit the same model now with <code>jmpost</code>. We will use the same data as in the previous notebook.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>First we need to load the necessary packages and set some default options for the MCMC sampling. We also set the theme for the plots to <code>theme_bw</code> with a base size of 12.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jmpost)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(truncnorm)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">require</span>(cmdstanr)) {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If cmdstanr is available, instruct brms to use cmdstanr as backend </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and cache all Stan binaries</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir =</span> <span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>) <span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  rstan<span class="sc">::</span><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC options</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">4</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># number of sampling iterations after warm up</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>WARMUP <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># number of warm up iterations</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>CHAINS <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>BAYES.SEED <span class="ot">&lt;-</span> <span class="dv">878</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>REFRESH <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also need a small function definition, which is still missing in <code>brms</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>int_step <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(x))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(x, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will use the publicly published tumor size data from the OAK study, see <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009822">here</a>. In particular we are using the <a href="https://doi.org/10.1371/journal.pcbi.1009822.s006">S1 data set</a>, which is the fully anonymized data set used in the publication. For simplicity, we have copied the data set in this GitHub repository.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/journal.pcbi.1009822.s006.xlsx"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>read_one_sheet <span class="ot">&lt;-</span> <span class="cf">function</span>(sheet) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_excel</span>(file_path, <span class="at">sheet =</span> sheet) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(patient_anonmyized)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">day =</span> <span class="fu">as.integer</span>(treatment_day),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> day <span class="sc">/</span> <span class="fl">365.25</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">target_lesion_long_diam_mm =</span> <span class="fu">case_match</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            target_lesion_long_diam_mm,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"TOO SMALL TO MEASURE"</span> <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NOT EVALUABLE"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">.default =</span> target_lesion_long_diam_mm</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">as.numeric</span>(target_lesion_long_diam_mm),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">ifelse</span>(sld <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">2</span>, sld),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">study =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_(</span><span class="sc">\\</span><span class="st">d+)_Arm_</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm)),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_</span><span class="sc">\\</span><span class="st">d+_Arm_(</span><span class="sc">\\</span><span class="st">d+)$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm))</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld, study, arm)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>tumor_data <span class="ot">&lt;-</span> <span class="fu">excel_sheets</span>(file_path) <span class="sc">|&gt;</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(read_one_sheet) <span class="sc">|&gt;</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  id                      year   sld study arm  
  &lt;fct&gt;                  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;
1 3657015667902160896 -0.00548    33 1     1    
2 3657015667902160896  0.101      33 1     1    
3 3657015667902160896  0.230      32 1     1    
4 3657015667902160896  0.342      37 1     1    
5 3657015667902160896  0.446      49 1     1    
6 2080619628198763008 -0.00548    12 1     1    </code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    id            year              sld        study   
 4308512445673410048 :  18   Min.   :-0.1314   Min.   :  2.0   1: 456  
 -4902532987801034752:  17   1st Qu.: 0.1123   1st Qu.: 17.0   2: 966  
 5394902984416364544 :  16   Median : 0.2847   Median : 30.0   3:2177  
 7160320731596789760 :  16   Mean   : 0.3822   Mean   : 36.1   4:4126  
 -4159496062492130816:  15   3rd Qu.: 0.5722   3rd Qu.: 49.0   5: 835  
 -7900338178541499392:  15   Max.   : 2.0753   Max.   :228.0           
 (Other)             :8463   NA's   :1         NA's   :69              
 arm     
 1:3108  
 2:3715  
 3: 291  
 4: 608  
 5: 227  
 6: 611  
         </code></pre>
</div>
</div>
<p>For simplicity, we will for now just use study 4 (this is the OAK study), and we rename the patient IDs:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(study <span class="sc">==</span> <span class="st">"4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.numeric</span>(id)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here we have 701 patients. It is always a good idea to make a plot of the data. Let’s look at the first 20 patients e.g.:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.integer</span>(id) <span class="sc">&lt;=</span> <span class="dv">20</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> sld, <span class="at">group =</span> id)) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> id) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_tgi_sf_jmpost_files/figure-html/plot_data-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data preparation</h2>
<p>We start with the subject level data set. For the beginning, we want to treat all observations as if they come from a single arm and single study for now. Therefore we insert constant study and arm values here.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">unique</span>(df<span class="sc">$</span>id),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> subj_df,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next we prepare the longitudinal data object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, year, sld)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> long_df,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can create the <code>JointData</code> object:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-specification" class="level2">
<h2 class="anchored" data-anchor-id="model-specification">Model specification</h2>
<p>The statistical model is specified in the <code>jmpost</code> vignette <a href="https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model">here</a>.</p>
<p>Here we just want to fit the longitudinal data, therefore:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that the priors on the standard deviations, <code>omega_*</code> and <code>sigma</code>, are truncated to the positive domain. So we used here truncated normal priors.</p>
</section>
<section id="fit-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-model">Fit model</h2>
<p>We can now fit the model using <code>jmpost</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5.RData"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  mcmc_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      tgi_mod,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> joint_data,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">chains =</span> CHAINS,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> CHAINS,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">refresh =</span> REFRESH</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_results, <span class="at">file =</span> save_file)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s check the convergence of the population parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>save_overall_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5_more.RData"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_overall_file)) {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_overall_file)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  mcmc_res_cmdstan <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(mcmc_results)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  mcmc_res_sum <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  vars_draws <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  loo_res <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_res_sum, vars_draws, loo_res, <span class="at">file =</span> save_overall_file)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>mcmc_res_sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 10
  variable     mean median      sd     mad     q5    q95  rhat ess_bulk ess_tail
  &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 lm_sf_mu_…  3.61   3.61  0.0236  0.0232   3.57   3.65   1.02     142.     188.
2 lm_sf_mu_… -1.27  -1.27  0.160   0.152   -1.54  -1.03   1.01     352.     500.
3 lm_sf_mu_… -1.35  -1.35  0.0828  0.0789  -1.49  -1.22   1.00     230.     456.
4 lm_sf_sig…  0.161  0.161 0.00233 0.00244  0.158  0.165  1.00     513.     875.
5 lm_sf_ome…  0.579  0.578 0.0156  0.0153   0.555  0.608  1.00     341.     576.
6 lm_sf_ome…  1.62   1.62  0.117   0.112    1.45   1.82   1.01     321.     509.
7 lm_sf_ome…  0.997  0.993 0.0505  0.0503   0.920  1.08   1.00     390.     595.</code></pre>
</div>
</div>
<p>This looks good, let’s check the traceplots:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># vars_draws &lt;- mcmc_res_cmdstan$draws(vars)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(vars_draws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_tgi_sf_jmpost_files/figure-html/plot_trace-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>They also look ok, all chains are mixing well in the same range of parameter values.</p>
<p>Also here we could look at the pairs plot:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  vars_draws,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_tgi_sf_jmpost_files/figure-html/plot_pairs-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="observation-vs.-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="observation-vs.-model-fit">Observation vs.&nbsp;model fit</h2>
<p>Let’s check the fit of the model to the data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pt_subset <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>save_fit_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5_fit.RData"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_fit_file)) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_fit_file)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  fit_subset <span class="ot">&lt;-</span> <span class="fu">LongitudinalQuantities</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    mcmc_results, </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridObserved</span>(<span class="at">subjects =</span> pt_subset)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit_subset, <span class="at">file =</span> save_fit_file)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(fit_subset)<span class="sc">+</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time (years)"</span>, <span class="at">y =</span> <span class="st">"SLD (mm)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_tgi_sf_jmpost_files/figure-html/plot_fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So this works very nicely.</p>
</section>
<section id="prior-vs.-posterior" class="level2">
<h2 class="anchored" data-anchor-id="prior-vs.-posterior">Prior vs.&nbsp;posterior</h2>
<p>Let’s check the prior vs.&nbsp;posterior for the parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(vars_draws) <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="st">"lm_sf_mu_bsld[1]"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks =</span> <span class="st">"lm_sf_mu_ks[1]"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg =</span> <span class="st">"lm_sf_mu_kg[1]"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="st">"lm_sf_omega_bsld[1]"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks =</span> <span class="st">"lm_sf_omega_ks[1]"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg =</span> <span class="st">"lm_sf_omega_kg[1]"</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> lm_sf_sigma</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"posterior"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu_bsld, mu_ks, mu_kg, omega_bsld, omega_ks, omega_kg, sigma, type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>n_prior_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(post_samples)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>prior_samples <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"prior"</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the two</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>combined_samples <span class="ot">&lt;-</span> <span class="fu">rbind</span>(post_samples, prior_samples) <span class="sc">|&gt;</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>type, <span class="at">names_to =</span> <span class="st">"parameter"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_samples, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>parameter, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2_tgi_sf_jmpost_files/figure-html/plot_prior_post-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks good, because the priors are covering the range of the posterior samples and are not too informative.</p>
</section>
<section id="parameter-estimates" class="level2">
<h2 class="anchored" data-anchor-id="parameter-estimates">Parameter estimates</h2>
<p>Here we need again to be careful: We are interested in the posterior mean estimates of the baseline, shrinkage and growth population rates on the original scale. Because we model them on the log scale as normal distributed, we need to use the mean of the log-normal distribution to get the mean on the original scale.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>post_sum <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_b0 =</span> <span class="fu">exp</span>(mu_bsld <span class="sc">+</span> omega_bsld<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks =</span> <span class="fu">exp</span>(mu_ks <span class="sc">+</span> omega_ks<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg =</span> <span class="fu">exp</span>(mu_kg <span class="sc">+</span> omega_kg<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_bsld<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(theta_b0, theta_ks, theta_kg, omega_bsld, omega_ks, omega_kg, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>post_sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="lqoidrymlj" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#lqoidrymlj table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#lqoidrymlj thead, #lqoidrymlj tbody, #lqoidrymlj tfoot, #lqoidrymlj tr, #lqoidrymlj td, #lqoidrymlj th {
  border-style: none;
}

#lqoidrymlj p {
  margin: 0;
  padding: 0;
}

#lqoidrymlj .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#lqoidrymlj .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#lqoidrymlj .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#lqoidrymlj .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#lqoidrymlj .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#lqoidrymlj .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lqoidrymlj .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#lqoidrymlj .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#lqoidrymlj .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#lqoidrymlj .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#lqoidrymlj .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#lqoidrymlj .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#lqoidrymlj .gt_spanner_row {
  border-bottom-style: hidden;
}

#lqoidrymlj .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#lqoidrymlj .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#lqoidrymlj .gt_from_md > :first-child {
  margin-top: 0;
}

#lqoidrymlj .gt_from_md > :last-child {
  margin-bottom: 0;
}

#lqoidrymlj .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#lqoidrymlj .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#lqoidrymlj .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#lqoidrymlj .gt_row_group_first td {
  border-top-width: 2px;
}

#lqoidrymlj .gt_row_group_first th {
  border-top-width: 2px;
}

#lqoidrymlj .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#lqoidrymlj .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#lqoidrymlj .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#lqoidrymlj .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lqoidrymlj .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#lqoidrymlj .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#lqoidrymlj .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#lqoidrymlj .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#lqoidrymlj .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#lqoidrymlj .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#lqoidrymlj .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#lqoidrymlj .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#lqoidrymlj .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#lqoidrymlj .gt_left {
  text-align: left;
}

#lqoidrymlj .gt_center {
  text-align: center;
}

#lqoidrymlj .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#lqoidrymlj .gt_font_normal {
  font-weight: normal;
}

#lqoidrymlj .gt_font_bold {
  font-weight: bold;
}

#lqoidrymlj .gt_font_italic {
  font-style: italic;
}

#lqoidrymlj .gt_super {
  font-size: 65%;
}

#lqoidrymlj .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#lqoidrymlj .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#lqoidrymlj .gt_indent_1 {
  text-indent: 5px;
}

#lqoidrymlj .gt_indent_2 {
  text-indent: 10px;
}

#lqoidrymlj .gt_indent_3 {
  text-indent: 15px;
}

#lqoidrymlj .gt_indent_4 {
  text-indent: 20px;
}

#lqoidrymlj .gt_indent_5 {
  text-indent: 25px;
}

#lqoidrymlj .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#lqoidrymlj div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="variable">theta_b0</td>
<td class="gt_row gt_right" headers="mean">43.7</td>
<td class="gt_row gt_right" headers="median">43.8</td>
<td class="gt_row gt_right" headers="sd">1.10</td>
<td class="gt_row gt_right" headers="mad">1.12</td>
<td class="gt_row gt_right" headers="q5">42.0</td>
<td class="gt_row gt_right" headers="q95">45.5</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">151</td>
<td class="gt_row gt_right" headers="ess_tail">201</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">theta_ks</td>
<td class="gt_row gt_right" headers="mean">1.06</td>
<td class="gt_row gt_right" headers="median">1.05</td>
<td class="gt_row gt_right" headers="sd">0.129</td>
<td class="gt_row gt_right" headers="mad">0.120</td>
<td class="gt_row gt_right" headers="q5">0.871</td>
<td class="gt_row gt_right" headers="q95">1.30</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">226</td>
<td class="gt_row gt_right" headers="ess_tail">408</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">theta_kg</td>
<td class="gt_row gt_right" headers="mean">0.428</td>
<td class="gt_row gt_right" headers="median">0.427</td>
<td class="gt_row gt_right" headers="sd">0.0311</td>
<td class="gt_row gt_right" headers="mad">0.0306</td>
<td class="gt_row gt_right" headers="q5">0.378</td>
<td class="gt_row gt_right" headers="q95">0.479</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">318</td>
<td class="gt_row gt_right" headers="ess_tail">472</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_bsld</td>
<td class="gt_row gt_right" headers="mean">0.579</td>
<td class="gt_row gt_right" headers="median">0.578</td>
<td class="gt_row gt_right" headers="sd">0.0156</td>
<td class="gt_row gt_right" headers="mad">0.0153</td>
<td class="gt_row gt_right" headers="q5">0.555</td>
<td class="gt_row gt_right" headers="q95">0.608</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">346</td>
<td class="gt_row gt_right" headers="ess_tail">545</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">omega_ks</td>
<td class="gt_row gt_right" headers="mean">1.62</td>
<td class="gt_row gt_right" headers="median">1.62</td>
<td class="gt_row gt_right" headers="sd">0.117</td>
<td class="gt_row gt_right" headers="mad">0.112</td>
<td class="gt_row gt_right" headers="q5">1.45</td>
<td class="gt_row gt_right" headers="q95">1.82</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">318</td>
<td class="gt_row gt_right" headers="ess_tail">494</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_kg</td>
<td class="gt_row gt_right" headers="mean">0.997</td>
<td class="gt_row gt_right" headers="median">0.993</td>
<td class="gt_row gt_right" headers="sd">0.0505</td>
<td class="gt_row gt_right" headers="mad">0.0503</td>
<td class="gt_row gt_right" headers="q5">0.920</td>
<td class="gt_row gt_right" headers="q95">1.08</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">390</td>
<td class="gt_row gt_right" headers="ess_tail">576</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_0</td>
<td class="gt_row gt_right" headers="mean">0.631</td>
<td class="gt_row gt_right" headers="median">0.630</td>
<td class="gt_row gt_right" headers="sd">0.0200</td>
<td class="gt_row gt_right" headers="mad">0.0196</td>
<td class="gt_row gt_right" headers="q5">0.600</td>
<td class="gt_row gt_right" headers="q95">0.668</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">346</td>
<td class="gt_row gt_right" headers="ess_tail">545</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">cv_s</td>
<td class="gt_row gt_right" headers="mean">3.70</td>
<td class="gt_row gt_right" headers="median">3.57</td>
<td class="gt_row gt_right" headers="sd">0.818</td>
<td class="gt_row gt_right" headers="mad">0.685</td>
<td class="gt_row gt_right" headers="q5">2.66</td>
<td class="gt_row gt_right" headers="q95">5.16</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">318</td>
<td class="gt_row gt_right" headers="ess_tail">494</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_g</td>
<td class="gt_row gt_right" headers="mean">1.31</td>
<td class="gt_row gt_right" headers="median">1.30</td>
<td class="gt_row gt_right" headers="sd">0.106</td>
<td class="gt_row gt_right" headers="mad">0.103</td>
<td class="gt_row gt_right" headers="q5">1.15</td>
<td class="gt_row gt_right" headers="q95">1.49</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">390</td>
<td class="gt_row gt_right" headers="ess_tail">576</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">sigma</td>
<td class="gt_row gt_right" headers="mean">0.161</td>
<td class="gt_row gt_right" headers="median">0.161</td>
<td class="gt_row gt_right" headers="sd">0.00233</td>
<td class="gt_row gt_right" headers="mad">0.00244</td>
<td class="gt_row gt_right" headers="q5">0.158</td>
<td class="gt_row gt_right" headers="q95">0.165</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">495</td>
<td class="gt_row gt_right" headers="ess_tail">844</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see that these are consistent with the estimates from the <code>brms</code> model earlier.</p>
</section>
<section id="separate-arm-estimates" class="level2">
<h2 class="anchored" data-anchor-id="separate-arm-estimates">Separate arm estimates</h2>
<p>While there is no general covariates support in <code>jmpost</code> for the longitudinal models as of now, we can obtain separate estimates for the longitudinal model parameters: As detailed in the model specification <a href="https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model">here</a>, as soon as we have the arm defined, then separate estimates for the arm-specific shrinkage and growth parameters will be obtained: Both the population means and standard deviation parameters are here arm-specific. (Note that this is slightly different from <code>brms</code> where we assumed earlier the same standard deviation independent of the treatment arm.)</p>
<p>So we need to define the subject data accordingly now with the arm information:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>subj_df_by_arm <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, arm) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"study"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>subj_data_by_arm <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> subj_df_by_arm,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We redefine the <code>JointData</code> object and can then fit the model, because the prior specification does not need to change: We assume iid priors on the arm-specific parameters here.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>joint_data_by_arm <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data_by_arm,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm6.RData"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  mcmc_results_by_arm <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>      tgi_mod,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> joint_data_by_arm,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">chains =</span> CHAINS,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> CHAINS,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">refresh =</span> REFRESH</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_results_by_arm, <span class="at">file =</span> save_file)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s again check the convergence:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>save_arm_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm6_more.RData"</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_arm_file)) {</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_arm_file)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  mcmc_res_cmdstan_by_arm <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(mcmc_results_by_arm)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  mcmc_res_sum_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  vars_draws_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  loo_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_res_sum_by_arm, vars_draws_by_arm, loo_by_arm, <span class="at">file =</span> save_arm_file)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>mcmc_res_sum_by_arm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 10
   variable    mean median      sd     mad     q5    q95  rhat ess_bulk ess_tail
   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lm_sf_mu…  3.61   3.61  0.0211  0.0217   3.58   3.65  1.00      244.     502.
 2 lm_sf_mu… -0.752 -0.730 0.222   0.216   -1.14  -0.398 1.01      592.     673.
 3 lm_sf_mu… -1.52  -1.51  0.222   0.217   -1.90  -1.17  1.00      706.     850.
 4 lm_sf_mu… -1.11  -1.11  0.138   0.139   -1.35  -0.900 1.00      594.     814.
 5 lm_sf_mu… -1.35  -1.35  0.103   0.104   -1.52  -1.19  1.00      560.     776.
 6 lm_sf_si…  0.161  0.161 0.00224 0.00228  0.157  0.165 1.00      892.     941.
 7 lm_sf_om…  0.577  0.577 0.0159  0.0153   0.551  0.603 1.00      511.     672.
 8 lm_sf_om…  1.34   1.33  0.150   0.152    1.11   1.60  1.00      630.     844.
 9 lm_sf_om…  1.76   1.76  0.161   0.150    1.51   2.05  1.00      662.     990.
10 lm_sf_om…  0.765  0.758 0.0710  0.0685   0.662  0.891 0.999     809.     951.
11 lm_sf_om…  1.10   1.10  0.0705  0.0684   0.991  1.22  0.999     669.     736.</code></pre>
</div>
</div>
<p>Let’s again tabulate the parameter estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>post_samples_by_arm <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(vars_draws_by_arm) <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="st">"lm_sf_mu_bsld[1]"</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks1 =</span> <span class="st">"lm_sf_mu_ks[1]"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks2 =</span> <span class="st">"lm_sf_mu_ks[2]"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg1 =</span> <span class="st">"lm_sf_mu_kg[1]"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg2 =</span> <span class="st">"lm_sf_mu_kg[2]"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="st">"lm_sf_omega_bsld[1]"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks1 =</span> <span class="st">"lm_sf_omega_ks[1]"</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks2 =</span> <span class="st">"lm_sf_omega_ks[2]"</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg1 =</span> <span class="st">"lm_sf_omega_kg[1]"</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg2 =</span> <span class="st">"lm_sf_omega_kg[2]"</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> lm_sf_sigma</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_b0 =</span> <span class="fu">exp</span>(mu_bsld <span class="sc">+</span> omega_bsld<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks1 =</span> <span class="fu">exp</span>(mu_ks1 <span class="sc">+</span> omega_ks1<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks2 =</span> <span class="fu">exp</span>(mu_ks2 <span class="sc">+</span> omega_ks2<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg1 =</span> <span class="fu">exp</span>(mu_kg1 <span class="sc">+</span> omega_kg1<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg2 =</span> <span class="fu">exp</span>(mu_kg2 <span class="sc">+</span> omega_kg2<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_bsld<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s1 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks1<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s2 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks2<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g1 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg1<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g2 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg2<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm <span class="ot">&lt;-</span> post_samples_by_arm <span class="sc">|&gt;</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    theta_b0, theta_ks1, theta_ks2, theta_kg1, theta_kg2, </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    omega_bsld, omega_ks1, omega_ks2, omega_kg1, omega_kg2, </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    cv_0, cv_s1, cv_s2, cv_g1, cv_g2, sigma) <span class="sc">|&gt;</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="uljknpyhog" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#uljknpyhog table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#uljknpyhog thead, #uljknpyhog tbody, #uljknpyhog tfoot, #uljknpyhog tr, #uljknpyhog td, #uljknpyhog th {
  border-style: none;
}

#uljknpyhog p {
  margin: 0;
  padding: 0;
}

#uljknpyhog .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#uljknpyhog .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#uljknpyhog .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#uljknpyhog .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#uljknpyhog .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uljknpyhog .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uljknpyhog .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uljknpyhog .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#uljknpyhog .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#uljknpyhog .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#uljknpyhog .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#uljknpyhog .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#uljknpyhog .gt_spanner_row {
  border-bottom-style: hidden;
}

#uljknpyhog .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#uljknpyhog .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#uljknpyhog .gt_from_md > :first-child {
  margin-top: 0;
}

#uljknpyhog .gt_from_md > :last-child {
  margin-bottom: 0;
}

#uljknpyhog .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#uljknpyhog .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#uljknpyhog .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#uljknpyhog .gt_row_group_first td {
  border-top-width: 2px;
}

#uljknpyhog .gt_row_group_first th {
  border-top-width: 2px;
}

#uljknpyhog .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uljknpyhog .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#uljknpyhog .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#uljknpyhog .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uljknpyhog .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uljknpyhog .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#uljknpyhog .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#uljknpyhog .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#uljknpyhog .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uljknpyhog .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uljknpyhog .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uljknpyhog .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uljknpyhog .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uljknpyhog .gt_left {
  text-align: left;
}

#uljknpyhog .gt_center {
  text-align: center;
}

#uljknpyhog .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#uljknpyhog .gt_font_normal {
  font-weight: normal;
}

#uljknpyhog .gt_font_bold {
  font-weight: bold;
}

#uljknpyhog .gt_font_italic {
  font-style: italic;
}

#uljknpyhog .gt_super {
  font-size: 65%;
}

#uljknpyhog .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#uljknpyhog .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#uljknpyhog .gt_indent_1 {
  text-indent: 5px;
}

#uljknpyhog .gt_indent_2 {
  text-indent: 10px;
}

#uljknpyhog .gt_indent_3 {
  text-indent: 15px;
}

#uljknpyhog .gt_indent_4 {
  text-indent: 20px;
}

#uljknpyhog .gt_indent_5 {
  text-indent: 25px;
}

#uljknpyhog .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#uljknpyhog div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">variable</th>
<th id="mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mean</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">median</th>
<th id="sd" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">sd</th>
<th id="mad" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">mad</th>
<th id="q5" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q5</th>
<th id="q95" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">q95</th>
<th id="rhat" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">rhat</th>
<th id="ess_bulk" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_bulk</th>
<th id="ess_tail" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ess_tail</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="variable">theta_b0</td>
<td class="gt_row gt_right" headers="mean">43.7</td>
<td class="gt_row gt_right" headers="median">43.7</td>
<td class="gt_row gt_right" headers="sd">0.999</td>
<td class="gt_row gt_right" headers="mad">1.05</td>
<td class="gt_row gt_right" headers="q5">42.1</td>
<td class="gt_row gt_right" headers="q95">45.4</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">227</td>
<td class="gt_row gt_right" headers="ess_tail">558</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">theta_ks1</td>
<td class="gt_row gt_right" headers="mean">1.18</td>
<td class="gt_row gt_right" headers="median">1.17</td>
<td class="gt_row gt_right" headers="sd">0.152</td>
<td class="gt_row gt_right" headers="mad">0.146</td>
<td class="gt_row gt_right" headers="q5">0.961</td>
<td class="gt_row gt_right" headers="q95">1.44</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">530</td>
<td class="gt_row gt_right" headers="ess_tail">696</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">theta_ks2</td>
<td class="gt_row gt_right" headers="mean">1.07</td>
<td class="gt_row gt_right" headers="median">1.04</td>
<td class="gt_row gt_right" headers="sd">0.209</td>
<td class="gt_row gt_right" headers="mad">0.183</td>
<td class="gt_row gt_right" headers="q5">0.779</td>
<td class="gt_row gt_right" headers="q95">1.42</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">344</td>
<td class="gt_row gt_right" headers="ess_tail">443</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">theta_kg1</td>
<td class="gt_row gt_right" headers="mean">0.444</td>
<td class="gt_row gt_right" headers="median">0.443</td>
<td class="gt_row gt_right" headers="sd">0.0490</td>
<td class="gt_row gt_right" headers="mad">0.0489</td>
<td class="gt_row gt_right" headers="q5">0.365</td>
<td class="gt_row gt_right" headers="q95">0.527</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">539</td>
<td class="gt_row gt_right" headers="ess_tail">712</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">theta_kg2</td>
<td class="gt_row gt_right" headers="mean">0.479</td>
<td class="gt_row gt_right" headers="median">0.478</td>
<td class="gt_row gt_right" headers="sd">0.0487</td>
<td class="gt_row gt_right" headers="mad">0.0479</td>
<td class="gt_row gt_right" headers="q5">0.399</td>
<td class="gt_row gt_right" headers="q95">0.563</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">735</td>
<td class="gt_row gt_right" headers="ess_tail">908</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_bsld</td>
<td class="gt_row gt_right" headers="mean">0.577</td>
<td class="gt_row gt_right" headers="median">0.577</td>
<td class="gt_row gt_right" headers="sd">0.0159</td>
<td class="gt_row gt_right" headers="mad">0.0153</td>
<td class="gt_row gt_right" headers="q5">0.551</td>
<td class="gt_row gt_right" headers="q95">0.603</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">504</td>
<td class="gt_row gt_right" headers="ess_tail">659</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">omega_ks1</td>
<td class="gt_row gt_right" headers="mean">1.34</td>
<td class="gt_row gt_right" headers="median">1.33</td>
<td class="gt_row gt_right" headers="sd">0.150</td>
<td class="gt_row gt_right" headers="mad">0.152</td>
<td class="gt_row gt_right" headers="q5">1.11</td>
<td class="gt_row gt_right" headers="q95">1.60</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">620</td>
<td class="gt_row gt_right" headers="ess_tail">838</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_ks2</td>
<td class="gt_row gt_right" headers="mean">1.76</td>
<td class="gt_row gt_right" headers="median">1.76</td>
<td class="gt_row gt_right" headers="sd">0.161</td>
<td class="gt_row gt_right" headers="mad">0.150</td>
<td class="gt_row gt_right" headers="q5">1.51</td>
<td class="gt_row gt_right" headers="q95">2.05</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">651</td>
<td class="gt_row gt_right" headers="ess_tail">972</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">omega_kg1</td>
<td class="gt_row gt_right" headers="mean">0.765</td>
<td class="gt_row gt_right" headers="median">0.758</td>
<td class="gt_row gt_right" headers="sd">0.0710</td>
<td class="gt_row gt_right" headers="mad">0.0685</td>
<td class="gt_row gt_right" headers="q5">0.662</td>
<td class="gt_row gt_right" headers="q95">0.891</td>
<td class="gt_row gt_right" headers="rhat">0.999</td>
<td class="gt_row gt_right" headers="ess_bulk">799</td>
<td class="gt_row gt_right" headers="ess_tail">943</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">omega_kg2</td>
<td class="gt_row gt_right" headers="mean">1.10</td>
<td class="gt_row gt_right" headers="median">1.10</td>
<td class="gt_row gt_right" headers="sd">0.0705</td>
<td class="gt_row gt_right" headers="mad">0.0684</td>
<td class="gt_row gt_right" headers="q5">0.991</td>
<td class="gt_row gt_right" headers="q95">1.22</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">649</td>
<td class="gt_row gt_right" headers="ess_tail">693</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_0</td>
<td class="gt_row gt_right" headers="mean">0.629</td>
<td class="gt_row gt_right" headers="median">0.628</td>
<td class="gt_row gt_right" headers="sd">0.0205</td>
<td class="gt_row gt_right" headers="mad">0.0196</td>
<td class="gt_row gt_right" headers="q5">0.596</td>
<td class="gt_row gt_right" headers="q95">0.662</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">504</td>
<td class="gt_row gt_right" headers="ess_tail">659</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">cv_s1</td>
<td class="gt_row gt_right" headers="mean">2.33</td>
<td class="gt_row gt_right" headers="median">2.22</td>
<td class="gt_row gt_right" headers="sd">0.601</td>
<td class="gt_row gt_right" headers="mad">0.547</td>
<td class="gt_row gt_right" headers="q5">1.55</td>
<td class="gt_row gt_right" headers="q95">3.46</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">620</td>
<td class="gt_row gt_right" headers="ess_tail">838</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_s2</td>
<td class="gt_row gt_right" headers="mean">4.90</td>
<td class="gt_row gt_right" headers="median">4.58</td>
<td class="gt_row gt_right" headers="sd">1.64</td>
<td class="gt_row gt_right" headers="mad">1.25</td>
<td class="gt_row gt_right" headers="q5">2.96</td>
<td class="gt_row gt_right" headers="q95">8.11</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">651</td>
<td class="gt_row gt_right" headers="ess_tail">972</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">cv_g1</td>
<td class="gt_row gt_right" headers="mean">0.897</td>
<td class="gt_row gt_right" headers="median">0.880</td>
<td class="gt_row gt_right" headers="sd">0.112</td>
<td class="gt_row gt_right" headers="mad">0.105</td>
<td class="gt_row gt_right" headers="q5">0.742</td>
<td class="gt_row gt_right" headers="q95">1.10</td>
<td class="gt_row gt_right" headers="rhat">0.999</td>
<td class="gt_row gt_right" headers="ess_bulk">799</td>
<td class="gt_row gt_right" headers="ess_tail">943</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="variable">cv_g2</td>
<td class="gt_row gt_right" headers="mean">1.55</td>
<td class="gt_row gt_right" headers="median">1.54</td>
<td class="gt_row gt_right" headers="sd">0.175</td>
<td class="gt_row gt_right" headers="mad">0.163</td>
<td class="gt_row gt_right" headers="q5">1.29</td>
<td class="gt_row gt_right" headers="q95">1.85</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">649</td>
<td class="gt_row gt_right" headers="ess_tail">693</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="variable">sigma</td>
<td class="gt_row gt_right" headers="mean">0.161</td>
<td class="gt_row gt_right" headers="median">0.161</td>
<td class="gt_row gt_right" headers="sd">0.00224</td>
<td class="gt_row gt_right" headers="mad">0.00228</td>
<td class="gt_row gt_right" headers="q5">0.157</td>
<td class="gt_row gt_right" headers="q95">0.165</td>
<td class="gt_row gt_right" headers="rhat">1.00</td>
<td class="gt_row gt_right" headers="ess_bulk">885</td>
<td class="gt_row gt_right" headers="ess_tail">881</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here again the shrinkage rate in the treatment arm 1 seems higher than in the treatment arm 2. However, the difference is not as pronounced as in the <code>brms</code> model before with the same standard deviation for both arms. We can again calculate the posterior probability that the shrinkage rate in arm 1 is higher than in arm 2:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>prob_ks1_greater_ks2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(post_samples_by_arm<span class="sc">$</span>theta_ks1 <span class="sc">&gt;</span> post_samples_by_arm<span class="sc">$</span>theta_ks2)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>prob_ks1_greater_ks2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.706</code></pre>
</div>
</div>
<p>So the posterior probability is now only around 71%.</p>
</section>
<section id="model-comparison-with-loo" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison-with-loo">Model comparison with LOO</h2>
<p>As we have seen for <code>brms</code>, also for <code>jmpost</code> we can easily compute the LOO criterion:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loo_res &lt;- mcmc_res_cmdstan$loo(r_eff = FALSE)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>loo_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 4099 log-likelihood matrix.

         Estimate    SE
elpd_loo -12957.3  95.8
p_loo      1137.1  38.4
looic     25914.5 191.6
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume independent draws (r_eff=1).

Pareto k diagnostic values:
                          Count Pct.    Min. ESS
(-Inf, 0.67]   (good)     3665  89.4%   26      
   (0.67, 1]   (bad)       363   8.9%   &lt;NA&gt;    
    (1, Inf)   (very bad)   71   1.7%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>Underneath this is using the <a href="https://mc-stan.org/cmdstanr/reference/fit-method-loo.html">$loo()</a> method from <code>cmdstanr</code>.</p>
<p>And we can compare this to the LOO of the model with separate arm estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loo_by_arm &lt;- mcmc_res_cmdstan_by_arm$loo(r_eff = FALSE)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>loo_by_arm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 4099 log-likelihood matrix.

         Estimate    SE
elpd_loo -12931.8  95.6
p_loo      1121.5  36.8
looic     25863.5 191.1
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume independent draws (r_eff=1).

Pareto k diagnostic values:
                          Count Pct.    Min. ESS
(-Inf, 0.67]   (good)     3652  89.1%   48      
   (0.67, 1]   (bad)       374   9.1%   &lt;NA&gt;    
    (1, Inf)   (very bad)   73   1.8%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>So the model by treatment arm performs here better than the model without treatment arm specific growth and shrinkage parameters.</p>
</section>
<section id="tipps-and-tricks" class="level2">
<h2 class="anchored" data-anchor-id="tipps-and-tricks">Tipps and tricks</h2>
<ul>
<li><p>Also here it is possible to look at the underlying Stan code:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".stan"</span>) <span class="co"># file extension for syntax highlighting</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan</span>(tgi_mod, <span class="at">destination =</span> tmp)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">file.edit</span>(tmp) <span class="co"># opens the Stan file in the default editor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
<li><p>It is not trivial to transport saved models from one computer to another. This is because <code>cmdstanr</code> only loads the results it currently needs from disk into memory, and thus into the R session. If you want to transport the model to another computer, you need to save the Stan code and the data, and then re-run the model on the other computer. This is because the model object in R is only a reference to the model on disk, not the model itself. Note that there is the <code>$save_object()</code> method, see <a href="https://mc-stan.org/cmdstanr/reference/fit-method-save_object.html">here</a>, however this leads to very large files (here about 300 MB for one fit) and can thus not be uploaded to typical git repositories. Therefore above we saved interim result objects separately as needed.</p></li>
<li><p>It is important to explicitly define the truncation boundaries for the truncated normal priors, because otherwise the MCMC results will not be correct.</p></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb38" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "2. TGI model minimal workflow with `jmpost`"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> true</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>Let's try to fit the same model now with <span class="in">`jmpost`</span>. We will use the same data as in the previous notebook.</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup_and_load.qmd &gt;}}</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>{{&lt; include _load_data.qmd &gt;}}</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data preparation</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>We start with the subject level data set.</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>For the beginning, we want to treat all observations as if they come from a single arm and single study for now. Therefore we insert constant study and arm values here.</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: subj_df_prep</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">unique</span>(df<span class="sc">$</span>id),</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> subj_df,</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>Next we prepare the longitudinal data object.</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: long_df_prep</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, year, sld)</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> long_df,</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>Now we can create the <span class="in">`JointData`</span> object:</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: joint_data_prep</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model specification</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>The statistical model is specified in the <span class="in">`jmpost`</span> vignette <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model)</span>.</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>Here we just want to fit the longitudinal data, therefore:</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_mod_spec</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>Note that the priors on the standard deviations, <span class="in">`omega_*`</span> and <span class="in">`sigma`</span>, are truncated to the positive domain. So we used here truncated normal priors.</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit model</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>We can now fit the model using <span class="in">`jmpost`</span>. </span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_model</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5.RData"</span>)</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>  mcmc_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>      tgi_mod,</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> joint_data,</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">chains =</span> CHAINS,</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> CHAINS,</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">refresh =</span> REFRESH</span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_results, <span class="at">file =</span> save_file)</span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>Let's check the convergence of the population parameters:</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence</span></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: fit_model</span></span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>save_overall_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5_more.RData"</span>)</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_overall_file)) {</span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_overall_file)</span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>  mcmc_res_cmdstan <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(mcmc_results)</span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>  mcmc_res_sum <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>  vars_draws <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>  loo_res <span class="ot">&lt;-</span> mcmc_res_cmdstan<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_res_sum, vars_draws, loo_res, <span class="at">file =</span> save_overall_file)</span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a>mcmc_res_sum</span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a>This looks good, let's check the traceplots:</span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_trace</span></span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: check_convergence</span></span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a><span class="co"># vars_draws &lt;- mcmc_res_cmdstan$draws(vars)</span></span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(vars_draws)</span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a>They also look ok, all chains are mixing well in the same range of parameter values.</span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a>Also here we could look at the pairs plot:</span>
<span id="cb38-175"><a href="#cb38-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_pairs</span></span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(</span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a>  vars_draws,</span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>)</span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observation vs. model fit</span></span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a>Let's check the fit of the model to the data:</span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_fit</span></span>
<span id="cb38-195"><a href="#cb38-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: fit_model</span></span>
<span id="cb38-196"><a href="#cb38-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a>pt_subset <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a>save_fit_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm5_fit.RData"</span>)</span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_fit_file)) {</span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_fit_file)</span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>  fit_subset <span class="ot">&lt;-</span> <span class="fu">LongitudinalQuantities</span>(</span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a>    mcmc_results, </span>
<span id="cb38-205"><a href="#cb38-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridObserved</span>(<span class="at">subjects =</span> pt_subset)</span>
<span id="cb38-206"><a href="#cb38-206" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(fit_subset, <span class="at">file =</span> save_fit_file)</span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(fit_subset)<span class="sc">+</span></span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time (years)"</span>, <span class="at">y =</span> <span class="st">"SLD (mm)"</span>)</span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a>So this works very nicely.</span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior vs. posterior</span></span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a>Let's check the prior vs. posterior for the parameters:</span>
<span id="cb38-219"><a href="#cb38-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_prior_post</span></span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: plot_trace</span></span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-226"><a href="#cb38-226" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(vars_draws) <span class="sc">|&gt;</span> </span>
<span id="cb38-227"><a href="#cb38-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb38-228"><a href="#cb38-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="st">"lm_sf_mu_bsld[1]"</span>,</span>
<span id="cb38-229"><a href="#cb38-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks =</span> <span class="st">"lm_sf_mu_ks[1]"</span>,</span>
<span id="cb38-230"><a href="#cb38-230" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg =</span> <span class="st">"lm_sf_mu_kg[1]"</span>,</span>
<span id="cb38-231"><a href="#cb38-231" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="st">"lm_sf_omega_bsld[1]"</span>,</span>
<span id="cb38-232"><a href="#cb38-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks =</span> <span class="st">"lm_sf_omega_ks[1]"</span>,</span>
<span id="cb38-233"><a href="#cb38-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg =</span> <span class="st">"lm_sf_omega_kg[1]"</span>,</span>
<span id="cb38-234"><a href="#cb38-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> lm_sf_sigma</span>
<span id="cb38-235"><a href="#cb38-235" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb38-236"><a href="#cb38-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"posterior"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-237"><a href="#cb38-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mu_bsld, mu_ks, mu_kg, omega_bsld, omega_ks, omega_kg, sigma, type)</span>
<span id="cb38-238"><a href="#cb38-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-239"><a href="#cb38-239" aria-hidden="true" tabindex="-1"></a>n_prior_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(post_samples)</span>
<span id="cb38-240"><a href="#cb38-240" aria-hidden="true" tabindex="-1"></a>prior_samples <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-241"><a href="#cb38-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb38-242"><a href="#cb38-242" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb38-243"><a href="#cb38-243" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg =</span> <span class="fu">rnorm</span>(n_prior_samples, <span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb38-244"><a href="#cb38-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb38-245"><a href="#cb38-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb38-246"><a href="#cb38-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>),</span>
<span id="cb38-247"><a href="#cb38-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">rtruncnorm</span>(n_prior_samples, <span class="at">a =</span> <span class="dv">0</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">3</span>)</span>
<span id="cb38-248"><a href="#cb38-248" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb38-249"><a href="#cb38-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"prior"</span>)</span>
<span id="cb38-250"><a href="#cb38-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-251"><a href="#cb38-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the two</span></span>
<span id="cb38-252"><a href="#cb38-252" aria-hidden="true" tabindex="-1"></a>combined_samples <span class="ot">&lt;-</span> <span class="fu">rbind</span>(post_samples, prior_samples) <span class="sc">|&gt;</span> </span>
<span id="cb38-253"><a href="#cb38-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>type, <span class="at">names_to =</span> <span class="st">"parameter"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb38-254"><a href="#cb38-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-255"><a href="#cb38-255" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_samples, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb38-256"><a href="#cb38-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb38-257"><a href="#cb38-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>parameter, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb38-258"><a href="#cb38-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb38-259"><a href="#cb38-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-260"><a href="#cb38-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-261"><a href="#cb38-261" aria-hidden="true" tabindex="-1"></a>This looks good, because the priors are covering the range of the posterior samples and are not too informative.</span>
<span id="cb38-262"><a href="#cb38-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-263"><a href="#cb38-263" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter estimates</span></span>
<span id="cb38-264"><a href="#cb38-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-265"><a href="#cb38-265" aria-hidden="true" tabindex="-1"></a>Here we need again to be careful: We are interested in the posterior mean estimates of the baseline, shrinkage and growth population rates on the original scale. Because we model them on the log scale as normal distributed, we need to use the mean of the log-normal distribution to get the mean on the original scale.</span>
<span id="cb38-266"><a href="#cb38-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-269"><a href="#cb38-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-270"><a href="#cb38-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: par_estimates</span></span>
<span id="cb38-271"><a href="#cb38-271" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: plot_prior_post</span></span>
<span id="cb38-272"><a href="#cb38-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-273"><a href="#cb38-273" aria-hidden="true" tabindex="-1"></a>post_sum <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span></span>
<span id="cb38-274"><a href="#cb38-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-275"><a href="#cb38-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_b0 =</span> <span class="fu">exp</span>(mu_bsld <span class="sc">+</span> omega_bsld<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb38-276"><a href="#cb38-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks =</span> <span class="fu">exp</span>(mu_ks <span class="sc">+</span> omega_ks<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb38-277"><a href="#cb38-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg =</span> <span class="fu">exp</span>(mu_kg <span class="sc">+</span> omega_kg<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb38-278"><a href="#cb38-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_bsld<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-279"><a href="#cb38-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-280"><a href="#cb38-280" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb38-281"><a href="#cb38-281" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb38-282"><a href="#cb38-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(theta_b0, theta_ks, theta_kg, omega_bsld, omega_ks, omega_kg, cv_0, cv_s, cv_g, sigma) <span class="sc">|&gt;</span></span>
<span id="cb38-283"><a href="#cb38-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb38-284"><a href="#cb38-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb38-285"><a href="#cb38-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb38-286"><a href="#cb38-286" aria-hidden="true" tabindex="-1"></a>post_sum</span>
<span id="cb38-287"><a href="#cb38-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-288"><a href="#cb38-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-289"><a href="#cb38-289" aria-hidden="true" tabindex="-1"></a>We can see that these are consistent with the estimates from the <span class="in">`brms`</span> model earlier.</span>
<span id="cb38-290"><a href="#cb38-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-291"><a href="#cb38-291" aria-hidden="true" tabindex="-1"></a><span class="fu">## Separate arm estimates</span></span>
<span id="cb38-292"><a href="#cb38-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-293"><a href="#cb38-293" aria-hidden="true" tabindex="-1"></a>While there is no general covariates support in <span class="in">`jmpost`</span> for the longitudinal models as of now, we can obtain separate estimates for the longitudinal model parameters: As detailed in the model specification <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/statistical-specification.html#stein-fojo-model)</span>, as soon as we have the arm defined, then separate estimates for the arm-specific shrinkage and growth parameters will be obtained: Both the population means and standard deviation parameters are here arm-specific. (Note that this is slightly different from <span class="in">`brms`</span> where we assumed earlier the same standard deviation independent of the treatment arm.)</span>
<span id="cb38-294"><a href="#cb38-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-295"><a href="#cb38-295" aria-hidden="true" tabindex="-1"></a>So we need to define the subject data accordingly now with the arm information:</span>
<span id="cb38-296"><a href="#cb38-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-299"><a href="#cb38-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-300"><a href="#cb38-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: subj_df_prep_arm</span></span>
<span id="cb38-301"><a href="#cb38-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-302"><a href="#cb38-302" aria-hidden="true" tabindex="-1"></a>subj_df_by_arm <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb38-303"><a href="#cb38-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, arm) <span class="sc">|&gt;</span></span>
<span id="cb38-304"><a href="#cb38-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb38-305"><a href="#cb38-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"study"</span>)</span>
<span id="cb38-306"><a href="#cb38-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-307"><a href="#cb38-307" aria-hidden="true" tabindex="-1"></a>subj_data_by_arm <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb38-308"><a href="#cb38-308" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> subj_df_by_arm,</span>
<span id="cb38-309"><a href="#cb38-309" aria-hidden="true" tabindex="-1"></a>  <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb38-310"><a href="#cb38-310" aria-hidden="true" tabindex="-1"></a>  <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb38-311"><a href="#cb38-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb38-312"><a href="#cb38-312" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-313"><a href="#cb38-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-314"><a href="#cb38-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-315"><a href="#cb38-315" aria-hidden="true" tabindex="-1"></a>We redefine the <span class="in">`JointData`</span> object and can then fit the model, because the prior specification does not need to change: We assume iid priors on the arm-specific parameters here.</span>
<span id="cb38-316"><a href="#cb38-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-319"><a href="#cb38-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-320"><a href="#cb38-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: joint_data_prep_arm</span></span>
<span id="cb38-321"><a href="#cb38-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-322"><a href="#cb38-322" aria-hidden="true" tabindex="-1"></a>joint_data_by_arm <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb38-323"><a href="#cb38-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data_by_arm,</span>
<span id="cb38-324"><a href="#cb38-324" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb38-325"><a href="#cb38-325" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-326"><a href="#cb38-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-327"><a href="#cb38-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-330"><a href="#cb38-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-331"><a href="#cb38-331" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_model_arm</span></span>
<span id="cb38-332"><a href="#cb38-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-333"><a href="#cb38-333" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm6.RData"</span>)</span>
<span id="cb38-334"><a href="#cb38-334" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb38-335"><a href="#cb38-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_file)</span>
<span id="cb38-336"><a href="#cb38-336" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-337"><a href="#cb38-337" aria-hidden="true" tabindex="-1"></a>  mcmc_results_by_arm <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb38-338"><a href="#cb38-338" aria-hidden="true" tabindex="-1"></a>      tgi_mod,</span>
<span id="cb38-339"><a href="#cb38-339" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> joint_data_by_arm,</span>
<span id="cb38-340"><a href="#cb38-340" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb38-341"><a href="#cb38-341" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb38-342"><a href="#cb38-342" aria-hidden="true" tabindex="-1"></a>      <span class="at">chains =</span> CHAINS,</span>
<span id="cb38-343"><a href="#cb38-343" aria-hidden="true" tabindex="-1"></a>      <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb38-344"><a href="#cb38-344" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> CHAINS,</span>
<span id="cb38-345"><a href="#cb38-345" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb38-346"><a href="#cb38-346" aria-hidden="true" tabindex="-1"></a>      <span class="at">refresh =</span> REFRESH</span>
<span id="cb38-347"><a href="#cb38-347" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-348"><a href="#cb38-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_results_by_arm, <span class="at">file =</span> save_file)</span>
<span id="cb38-349"><a href="#cb38-349" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-350"><a href="#cb38-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-351"><a href="#cb38-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-352"><a href="#cb38-352" aria-hidden="true" tabindex="-1"></a>Let's again check the convergence:</span>
<span id="cb38-353"><a href="#cb38-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-356"><a href="#cb38-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-357"><a href="#cb38-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence_arm</span></span>
<span id="cb38-358"><a href="#cb38-358" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: fit_model_arm</span></span>
<span id="cb38-359"><a href="#cb38-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-360"><a href="#cb38-360" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb38-361"><a href="#cb38-361" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb38-362"><a href="#cb38-362" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb38-363"><a href="#cb38-363" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb38-364"><a href="#cb38-364" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb38-365"><a href="#cb38-365" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb38-366"><a href="#cb38-366" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb38-367"><a href="#cb38-367" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb38-368"><a href="#cb38-368" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-369"><a href="#cb38-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-370"><a href="#cb38-370" aria-hidden="true" tabindex="-1"></a>save_arm_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-tgi/jm6_more.RData"</span>)</span>
<span id="cb38-371"><a href="#cb38-371" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_arm_file)) {</span>
<span id="cb38-372"><a href="#cb38-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(save_arm_file)</span>
<span id="cb38-373"><a href="#cb38-373" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-374"><a href="#cb38-374" aria-hidden="true" tabindex="-1"></a>  mcmc_res_cmdstan_by_arm <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(mcmc_results_by_arm)</span>
<span id="cb38-375"><a href="#cb38-375" aria-hidden="true" tabindex="-1"></a>  mcmc_res_sum_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb38-376"><a href="#cb38-376" aria-hidden="true" tabindex="-1"></a>  vars_draws_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb38-377"><a href="#cb38-377" aria-hidden="true" tabindex="-1"></a>  loo_by_arm <span class="ot">&lt;-</span> mcmc_res_cmdstan_by_arm<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-378"><a href="#cb38-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(mcmc_res_sum_by_arm, vars_draws_by_arm, loo_by_arm, <span class="at">file =</span> save_arm_file)</span>
<span id="cb38-379"><a href="#cb38-379" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-380"><a href="#cb38-380" aria-hidden="true" tabindex="-1"></a>mcmc_res_sum_by_arm</span>
<span id="cb38-381"><a href="#cb38-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-382"><a href="#cb38-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-383"><a href="#cb38-383" aria-hidden="true" tabindex="-1"></a>Let's again tabulate the parameter estimates:</span>
<span id="cb38-384"><a href="#cb38-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-387"><a href="#cb38-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-388"><a href="#cb38-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: par_estimates_arm</span></span>
<span id="cb38-389"><a href="#cb38-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: check_convergence_arm</span></span>
<span id="cb38-390"><a href="#cb38-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-391"><a href="#cb38-391" aria-hidden="true" tabindex="-1"></a>post_samples_by_arm <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(vars_draws_by_arm) <span class="sc">|&gt;</span> </span>
<span id="cb38-392"><a href="#cb38-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb38-393"><a href="#cb38-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_bsld =</span> <span class="st">"lm_sf_mu_bsld[1]"</span>,</span>
<span id="cb38-394"><a href="#cb38-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks1 =</span> <span class="st">"lm_sf_mu_ks[1]"</span>,</span>
<span id="cb38-395"><a href="#cb38-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_ks2 =</span> <span class="st">"lm_sf_mu_ks[2]"</span>,</span>
<span id="cb38-396"><a href="#cb38-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg1 =</span> <span class="st">"lm_sf_mu_kg[1]"</span>,</span>
<span id="cb38-397"><a href="#cb38-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_kg2 =</span> <span class="st">"lm_sf_mu_kg[2]"</span>,</span>
<span id="cb38-398"><a href="#cb38-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_bsld =</span> <span class="st">"lm_sf_omega_bsld[1]"</span>,</span>
<span id="cb38-399"><a href="#cb38-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks1 =</span> <span class="st">"lm_sf_omega_ks[1]"</span>,</span>
<span id="cb38-400"><a href="#cb38-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_ks2 =</span> <span class="st">"lm_sf_omega_ks[2]"</span>,</span>
<span id="cb38-401"><a href="#cb38-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg1 =</span> <span class="st">"lm_sf_omega_kg[1]"</span>,</span>
<span id="cb38-402"><a href="#cb38-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">omega_kg2 =</span> <span class="st">"lm_sf_omega_kg[2]"</span>,</span>
<span id="cb38-403"><a href="#cb38-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> lm_sf_sigma</span>
<span id="cb38-404"><a href="#cb38-404" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb38-405"><a href="#cb38-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-406"><a href="#cb38-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_b0 =</span> <span class="fu">exp</span>(mu_bsld <span class="sc">+</span> omega_bsld<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb38-407"><a href="#cb38-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks1 =</span> <span class="fu">exp</span>(mu_ks1 <span class="sc">+</span> omega_ks1<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>), </span>
<span id="cb38-408"><a href="#cb38-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_ks2 =</span> <span class="fu">exp</span>(mu_ks2 <span class="sc">+</span> omega_ks2<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb38-409"><a href="#cb38-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg1 =</span> <span class="fu">exp</span>(mu_kg1 <span class="sc">+</span> omega_kg1<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb38-410"><a href="#cb38-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta_kg2 =</span> <span class="fu">exp</span>(mu_kg2 <span class="sc">+</span> omega_kg2<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb38-411"><a href="#cb38-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_0 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_bsld<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-412"><a href="#cb38-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s1 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks1<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-413"><a href="#cb38-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_s2 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_ks2<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-414"><a href="#cb38-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g1 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg1<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb38-415"><a href="#cb38-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_g2 =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(omega_kg2<span class="sc">^</span><span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb38-416"><a href="#cb38-416" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb38-417"><a href="#cb38-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-418"><a href="#cb38-418" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm <span class="ot">&lt;-</span> post_samples_by_arm <span class="sc">|&gt;</span></span>
<span id="cb38-419"><a href="#cb38-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb38-420"><a href="#cb38-420" aria-hidden="true" tabindex="-1"></a>    theta_b0, theta_ks1, theta_ks2, theta_kg1, theta_kg2, </span>
<span id="cb38-421"><a href="#cb38-421" aria-hidden="true" tabindex="-1"></a>    omega_bsld, omega_ks1, omega_ks2, omega_kg1, omega_kg2, </span>
<span id="cb38-422"><a href="#cb38-422" aria-hidden="true" tabindex="-1"></a>    cv_0, cv_s1, cv_s2, cv_g1, cv_g2, sigma) <span class="sc">|&gt;</span></span>
<span id="cb38-423"><a href="#cb38-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_draws</span>() <span class="sc">|&gt;</span></span>
<span id="cb38-424"><a href="#cb38-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb38-425"><a href="#cb38-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">n_sigfig =</span> <span class="dv">3</span>)</span>
<span id="cb38-426"><a href="#cb38-426" aria-hidden="true" tabindex="-1"></a>post_sum_by_arm</span>
<span id="cb38-427"><a href="#cb38-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-428"><a href="#cb38-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-429"><a href="#cb38-429" aria-hidden="true" tabindex="-1"></a>Here again the shrinkage rate in the treatment arm 1 seems higher than in the treatment arm 2. However, the difference is not as pronounced as in the <span class="in">`brms`</span> model before with the same standard deviation for both arms. We can again calculate the posterior probability that the shrinkage rate in arm 1 is higher than in arm 2:</span>
<span id="cb38-430"><a href="#cb38-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-433"><a href="#cb38-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-434"><a href="#cb38-434" aria-hidden="true" tabindex="-1"></a>prob_ks1_greater_ks2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(post_samples_by_arm<span class="sc">$</span>theta_ks1 <span class="sc">&gt;</span> post_samples_by_arm<span class="sc">$</span>theta_ks2)</span>
<span id="cb38-435"><a href="#cb38-435" aria-hidden="true" tabindex="-1"></a>prob_ks1_greater_ks2</span>
<span id="cb38-436"><a href="#cb38-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-437"><a href="#cb38-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-438"><a href="#cb38-438" aria-hidden="true" tabindex="-1"></a>So the posterior probability is now only around <span class="in">`r round(prob_ks1_greater_ks2 * 100)`</span>%. </span>
<span id="cb38-439"><a href="#cb38-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-440"><a href="#cb38-440" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model comparison with LOO</span></span>
<span id="cb38-441"><a href="#cb38-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-442"><a href="#cb38-442" aria-hidden="true" tabindex="-1"></a>As we have seen for <span class="in">`brms`</span>, also for <span class="in">`jmpost`</span> we can easily compute the LOO criterion:</span>
<span id="cb38-443"><a href="#cb38-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-446"><a href="#cb38-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-447"><a href="#cb38-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loo</span></span>
<span id="cb38-448"><a href="#cb38-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: check_convergence</span></span>
<span id="cb38-449"><a href="#cb38-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-450"><a href="#cb38-450" aria-hidden="true" tabindex="-1"></a><span class="co"># loo_res &lt;- mcmc_res_cmdstan$loo(r_eff = FALSE)</span></span>
<span id="cb38-451"><a href="#cb38-451" aria-hidden="true" tabindex="-1"></a>loo_res</span>
<span id="cb38-452"><a href="#cb38-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-453"><a href="#cb38-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-454"><a href="#cb38-454" aria-hidden="true" tabindex="-1"></a>Underneath this is using the <span class="co">[</span><span class="ot">$loo()</span><span class="co">](https://mc-stan.org/cmdstanr/reference/fit-method-loo.html)</span> method from <span class="in">`cmdstanr`</span>. </span>
<span id="cb38-455"><a href="#cb38-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-456"><a href="#cb38-456" aria-hidden="true" tabindex="-1"></a>And we can compare this to the LOO of the model with separate arm estimates:</span>
<span id="cb38-457"><a href="#cb38-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-460"><a href="#cb38-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb38-461"><a href="#cb38-461" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loo_arm</span></span>
<span id="cb38-462"><a href="#cb38-462" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: check_convergence_arm</span></span>
<span id="cb38-463"><a href="#cb38-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-464"><a href="#cb38-464" aria-hidden="true" tabindex="-1"></a><span class="co"># loo_by_arm &lt;- mcmc_res_cmdstan_by_arm$loo(r_eff = FALSE)</span></span>
<span id="cb38-465"><a href="#cb38-465" aria-hidden="true" tabindex="-1"></a>loo_by_arm</span>
<span id="cb38-466"><a href="#cb38-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb38-467"><a href="#cb38-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-468"><a href="#cb38-468" aria-hidden="true" tabindex="-1"></a>So the model by treatment arm performs here better than the model without treatment arm specific growth and shrinkage parameters.</span>
<span id="cb38-469"><a href="#cb38-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-470"><a href="#cb38-470" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tipps and tricks</span></span>
<span id="cb38-471"><a href="#cb38-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-472"><a href="#cb38-472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Also here it is possible to look at the underlying Stan code:</span>
<span id="cb38-473"><a href="#cb38-473" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb38-474"><a href="#cb38-474" aria-hidden="true" tabindex="-1"></a><span class="in">  #| eval: false</span></span>
<span id="cb38-475"><a href="#cb38-475" aria-hidden="true" tabindex="-1"></a><span class="in">  #| label: show_stan_code</span></span>
<span id="cb38-476"><a href="#cb38-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-477"><a href="#cb38-477" aria-hidden="true" tabindex="-1"></a><span class="in">  tmp &lt;- tempfile(fileext = ".stan") # file extension for syntax highlighting</span></span>
<span id="cb38-478"><a href="#cb38-478" aria-hidden="true" tabindex="-1"></a><span class="in">  write_stan(tgi_mod, destination = tmp)</span></span>
<span id="cb38-479"><a href="#cb38-479" aria-hidden="true" tabindex="-1"></a><span class="in">  file.edit(tmp) # opens the Stan file in the default editor</span></span>
<span id="cb38-480"><a href="#cb38-480" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb38-481"><a href="#cb38-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is not trivial to transport saved models from one computer to another. This is because <span class="in">`cmdstanr`</span> only loads the results it currently needs from disk into memory, and thus into the R session. If you want to transport the model to another computer, you need to save the Stan code and the data, and then re-run the model on the other computer. This is because the model object in R is only a reference to the model on disk, not the model itself. Note that there is the <span class="in">`$save_object()`</span> method, see <span class="co">[</span><span class="ot">here</span><span class="co">](https://mc-stan.org/cmdstanr/reference/fit-method-save_object.html)</span>, however this leads to very large files (here about 300 MB for one fit) and can thus not be uploaded to typical git repositories. Therefore above we saved interim result objects separately as needed.</span>
<span id="cb38-482"><a href="#cb38-482" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is important to explicitly define the truncation boundaries for the truncated normal priors, because otherwise the MCMC results will not be correct.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-tgi/2_tgi_sf_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>