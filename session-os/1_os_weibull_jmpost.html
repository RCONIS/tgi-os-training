<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-03-10">

<title>1. OS model minimal workflow with jmpost – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f9c7e5d2d3782bd4f414016107dfc2cc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">Session 2: OS</a></li><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">1. OS model minimal workflow with <code>jmpost</code></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">TGI-OS Training</a> 
        <div class="sidebar-tools-main">
    <a href="https://rconis.github.io/tgi-os-training/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/4_tgi_cb_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Claret-Bruno model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 2: OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/1_os_weibull_jmpost.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. OS model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/2_os_weibull_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. OS model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#tgi-model-fitting" id="toc-tgi-model-fitting" class="nav-link" data-scroll-target="#tgi-model-fitting">TGI model fitting</a></li>
  <li><a href="#extract-individual-growth-rate-estimates" id="toc-extract-individual-growth-rate-estimates" class="nav-link" data-scroll-target="#extract-individual-growth-rate-estimates">Extract individual growth rate estimates</a></li>
  <li><a href="#os-model-fitting" id="toc-os-model-fitting" class="nav-link" data-scroll-target="#os-model-fitting">OS model fitting</a></li>
  <li><a href="#interpret-covariate-effects" id="toc-interpret-covariate-effects" class="nav-link" data-scroll-target="#interpret-covariate-effects">Interpret covariate effects</a></li>
  <li><a href="#observation-vs-model-fit" id="toc-observation-vs-model-fit" class="nav-link" data-scroll-target="#observation-vs-model-fit">Observation vs model fit</a></li>
  <li><a href="#hazard-and-hazard-rate-estimation" id="toc-hazard-and-hazard-rate-estimation" class="nav-link" data-scroll-target="#hazard-and-hazard-rate-estimation">Hazard and hazard rate estimation</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model comparison</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-os/1_os_weibull_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">Session 2: OS</a></li><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">1. OS model minimal workflow with <code>jmpost</code></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">1. OS model minimal workflow with <code>jmpost</code></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-03-10</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this document is to show a minimal workflow for fitting a Weibull OS model using the <code>jmpost</code> package.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>First we need to load the necessary packages and set some default options for the MCMC sampling. We also set the theme for the plots to <code>theme_bw</code> with a base size of 12.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jmpost)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(truncnorm)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fuzzyjoin)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sn)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">require</span>(cmdstanr)) {</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If cmdstanr is available, instruct brms to use cmdstanr as backend</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and cache all Stan binaries</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">options</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">brms.backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">cmdstanr_write_stan_file_dir =</span> <span class="fu">here</span>(<span class="st">"_brms-cache"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>) <span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    rstan<span class="sc">::</span><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC options</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">4</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># number of sampling iterations after warm up</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>WARMUP <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># number of warm up iterations</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>CHAINS <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>BAYES.SEED <span class="ot">&lt;-</span> <span class="dv">878</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>REFRESH <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also need a small function definition, which is still missing in <code>brms</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>int_step <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">is.logical</span>(x))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(x, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will again use the OAK study data.</p>
<p>For the tumor growth data, we are using the <a href="https://doi.org/10.1371/journal.pcbi.1009822.s006">S1 data set</a> from <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009822">here</a>. For simplicity, we have copied the data set in this GitHub repository.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tumor_data <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/journal.pcbi.1009822.s006.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"Study4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(patient_anonmyized)),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">day =</span> <span class="fu">as.integer</span>(treatment_day),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> day <span class="sc">/</span> <span class="fl">365.25</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">target_lesion_long_diam_mm =</span> <span class="fu">case_match</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            target_lesion_long_diam_mm,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"TOO SMALL TO MEASURE"</span> <span class="sc">~</span> <span class="st">"2"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"NOT EVALUABLE"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">.default =</span> target_lesion_long_diam_mm</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">as.numeric</span>(target_lesion_long_diam_mm),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">ifelse</span>(sld <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">2</span>, sld),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">study =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_(</span><span class="sc">\\</span><span class="st">d+)_Arm_</span><span class="sc">\\</span><span class="st">d+$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm)),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">factor</span>(<span class="fu">gsub</span>(<span class="st">"^Study_</span><span class="sc">\\</span><span class="st">d+_Arm_(</span><span class="sc">\\</span><span class="st">d+)$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, study_arm)),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">fct_recode</span>(arm, <span class="st">"Docetaxel"</span> <span class="ot">=</span> <span class="st">"1"</span>, <span class="st">"MPDL3280A"</span> <span class="ot">=</span> <span class="st">"2"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld, arm)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  id                       year   sld arm      
  &lt;fct&gt;                   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;    
1 -594245265511412736  -0.00821  42   Docetaxel
2 -594245265511412736   0.0986   44   Docetaxel
3 -594245265511412736   0.222    44   Docetaxel
4 -4078394139718744064 -0.0110   65.8 Docetaxel
5 -4078394139718744064  0.832    66   Docetaxel
6 -4078394139718744064  1.07     68   Docetaxel</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tumor_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    id            year              sld        
 5394902984416364544 :  16   Min.   :-0.1068   Min.   :  2.00  
 7160320731596789760 :  16   1st Qu.: 0.1123   1st Qu.: 19.05  
 -4159496062492130816:  15   Median : 0.2519   Median : 32.00  
 -7900338178541499392:  15   Mean   : 0.3995   Mean   : 38.16  
 4878279915140903936 :  15   3rd Qu.: 0.5749   3rd Qu.: 51.00  
 9202154259772598272 :  15   Max.   : 2.0753   Max.   :228.00  
 (Other)             :4034                     NA's   :27      
        arm      
 Docetaxel:1658  
 MPDL3280A:2468  
                 
                 
                 
                 
                 </code></pre>
</div>
</div>
<p>Here we have 701 patients, and we know from Fig. 1 in the publication that this is the subset of patients with at least 3 tumor size measurements. We have guessed from the second Excel sheet with parameter estimates that arm 1 means docetaxel and arm 2 means MPDL3280A. This also seems reasonable given the larger number of measurements per patient:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a table</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tumor_data <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">arm =</span> arm[<span class="dv">1</span>], <span class="at">n =</span> <span class="fu">n</span>())  <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(arm) <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_n =</span> <span class="fu">mean</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  arm       mean_n
  &lt;fct&gt;      &lt;dbl&gt;
1 Docetaxel   5.10
2 MPDL3280A   6.56</code></pre>
</div>
</div>
<p>For the OS data, we will be using the <a href="https://static-content.springer.com/esm/art%3A10.1038%2Fs41591-018-0134-3/MediaObjects/41591_2018_134_MOESM3_ESM.xlsx">Supplementary Table 8</a> from <a href="https://doi.org/10.1038/s41591-018-0134-3">here</a>. Again, we have copied the data set in this GitHub repository.</p>
<p>From the supplementary material, we know that:</p>
<ul>
<li><code>PFS/OS</code>: time in months</li>
<li><code>PFS.CNSR/OS.CNSR</code>: 1 for censor, 0 for event</li>
</ul>
<p>Therefore we will convert the time to years and the censoring to a logical variable:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>os_data <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/41591_2018_134_MOESM3_ESM.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_excel</span>(<span class="at">sheet =</span> <span class="st">"OAK_Clinical_Data"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">age =</span> bage,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">race =</span> race2,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">ecog =</span> ecoggr,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> trt01p,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">response =</span> bcor</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(pt_id)),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">sld =</span> <span class="fu">as.numeric</span>(<span class="fu">na_if</span>(bl_sld, <span class="st">"."</span>)),</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">pfs_time =</span> <span class="fu">as.numeric</span>(pfs) <span class="sc">/</span> <span class="dv">12</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">pfs_event =</span> <span class="fu">as.numeric</span>(pfs_cnsr) <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">os_time =</span> <span class="fu">as.numeric</span>(os) <span class="sc">/</span> <span class="dv">12</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">os_event =</span> <span class="fu">as.numeric</span>(os_cnsr) <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">race =</span> <span class="fu">factor</span>(race),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">ecog =</span> <span class="fu">factor</span>(ecog),</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">factor</span>(arm),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">response =</span> <span class="fu">factor</span>(</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>          response, </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">sex =</span> <span class="fu">factor</span>(sex)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      id,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>      arm,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      ecog,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      age,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      race,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      sex,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      sld,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      response,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      pfs_time,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      pfs_event,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      os_time,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>      os_event</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  id    arm    ecog    age race  sex     sld response pfs_time pfs_event os_time
  &lt;fct&gt; &lt;fct&gt;  &lt;fct&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;fct&gt;       &lt;dbl&gt; &lt;lgl&gt;       &lt;dbl&gt;
1 318   Docet… 1        64 WHITE M     152   PD          0.107 TRUE        0.433
2 1088  Docet… 0        65 WHITE M      36   PD          0.194 TRUE        0.402
3 345   Docet… 1        75 WHITE M      92   &lt;NA&gt;        0.162 TRUE        0.162
4 588   Docet… 0        61 WHITE F      36   SD          1.02  TRUE        2.05 
5 306   MPDL3… 1        53 WHITE F      86   PD          0.118 TRUE        0.498
6 718   Docet… 1        80 WHITE M      45.7 SD          0.712 TRUE        1.60 
# ℹ 1 more variable: os_event &lt;lgl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(os_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       id             arm      ecog         age           race     sex    
 1000   :  1   Docetaxel:425   0:315   Min.   :33.00   ASIAN:180   F:330  
 1001   :  1   MPDL3280A:425   1:535   1st Qu.:57.00   OTHER: 72   M:520  
 1002   :  1                           Median :64.00   WHITE:598          
 1003   :  1                           Mean   :63.23                      
 1004   :  1                           3rd Qu.:70.00                      
 1005   :  1                           Max.   :85.00                      
 (Other):844                                                              
      sld         response      pfs_time        pfs_event      
 Min.   : 10.00   CR  :  7   Min.   :0.002738   Mode :logical  
 1st Qu.: 41.00   PR  :108   1st Qu.:0.117728   FALSE:95       
 Median : 66.00   SD  :327   Median :0.240931   TRUE :755      
 Mean   : 76.69   PD  :304   Mean   :0.443174                  
 3rd Qu.: 99.00   NE  : 24   3rd Qu.:0.580424                  
 Max.   :316.00   NA's: 80   Max.   :2.242300                  
 NA's   :1                                                     
    os_time          os_event      
 Min.   :0.002738   Mode :logical  
 1st Qu.:0.364134   FALSE:281      
 Median :0.803559   TRUE :569      
 Mean   :0.949841                  
 3rd Qu.:1.620808                  
 Max.   :2.253251                  
                                   </code></pre>
</div>
</div>
<p>Now we would like to join the two data sets, i.e.&nbsp;know which tumor growth data belongs to which baseline covariates and overall survival time and event indicator. Unfortunately we cannot use the <code>id</code> variable as it is not consistent between the two data sets, because both were anonymized. Instead, we will use the <code>sld</code> variable in combination with the treatment arm. We can also double check with the best overall response variable, because that is closely related to the tumor growth.</p>
<p>First, we will summarize the patient information int he tumor data set. We will calculate the baseline SLD, determine the time of the last tumor measurement and approximate the best overall response by looking at the change from baseline:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>get_baseline <span class="ot">&lt;-</span> <span class="cf">function</span>(sld, year) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    which_base <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">which</span>(year <span class="sc">&lt;=</span> <span class="dv">0</span>), <span class="dv">1</span>L)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(which_base) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>      which_base <span class="ot">&lt;-</span> <span class="fu">which.min</span>(year)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    sld[which_base]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>get_contig_below_thresh <span class="ot">&lt;-</span> <span class="cf">function</span>(sld, year, bsld, thresh) {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    rle_res <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rle</span>(((sld[year <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="sc">-</span> bsld) <span class="sc">/</span> bsld) <span class="sc">&lt;</span> <span class="fl">0.2</span>), </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        lengths[values]</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(rle_res) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(rle_res)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>tumor_data_summary <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span> </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">arm =</span> arm[<span class="dv">1</span>L],</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">bsld =</span> <span class="fu">get_baseline</span>(sld, year),</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">last_year =</span> <span class="fu">tail</span>(year, <span class="dv">1</span>L),</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">nadir =</span> <span class="fu">min</span>(sld[year <span class="sc">&gt;=</span> <span class="dv">0</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_cfn =</span> <span class="fu">max</span>((sld[year <span class="sc">&gt;=</span> <span class="dv">0</span>] <span class="sc">-</span> nadir) <span class="sc">/</span> nadir, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_cfb =</span> <span class="fu">min</span>((sld[year <span class="sc">&gt;=</span> <span class="dv">0</span>] <span class="sc">-</span> bsld) <span class="sc">/</span> bsld, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">contig_below_0.2 =</span> <span class="fu">get_contig_below_thresh</span>(sld, year, bsld, <span class="at">thresh =</span> <span class="fl">0.2</span>),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">approx_response =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        min_cfb <span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">~</span> <span class="st">"PR"</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        contig_below_0<span class="fl">.2</span> <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"SD"</span>,</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        max_cfn <span class="sc">&gt;=</span> <span class="fl">0.2</span> <span class="sc">~</span> <span class="st">"PD"</span>,        </span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> <span class="st">"NE"</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>      )   </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tumor_data_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  id                arm    bsld last_year nadir max_cfn min_cfb contig_below_0.2
  &lt;fct&gt;             &lt;fct&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
1 -100096848245159… Doce…    53     0.356    55  0       0.0377                3
2 -102777882269110… MPDL…    11     0.901     2  2      -0.818                 7
3 -105049343897269… MPDL…    20     0.345    21  1.62    0.05                  2
4 -106934201929572… Doce…    15     1.72     11  0.273  -0.267                12
5 -108949367808374… Doce…    33     0.709    31  0.0968 -0.0606                6
6 -110624773747042… MPDL…    24     1.32     16  0.562  -0.333                 9
# ℹ 1 more variable: approx_response &lt;chr&gt;</code></pre>
</div>
</div>
<p>Now let’s try to fuzzy join this with the OS data set, based on the baseline SLD and the treatment arm. In addition, we know that the last time point in the tumor data needs to be before the OS time point. We will also check that the best overall response is the same in both data sets. There will be some errors here: For example, we don’t know whether there were new lesions leading to a progression assessment, or whether the patient had later better results. So we need to expect that the matching will not be perfect.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>os_data_keys <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, arm, sld, pfs_time, os_time, response)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data_keys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  id    arm         sld pfs_time os_time response
  &lt;fct&gt; &lt;fct&gt;     &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;   
1 318   Docetaxel 152      0.107   0.433 PD      
2 1088  Docetaxel  36      0.194   0.402 PD      
3 345   Docetaxel  92      0.162   0.162 &lt;NA&gt;    
4 588   Docetaxel  36      1.02    2.05  SD      
5 306   MPDL3280A  86      0.118   0.498 PD      
6 718   Docetaxel  45.7    0.712   1.60  SD      </code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dist_match <span class="ot">&lt;-</span> <span class="cf">function</span>(v1, v2) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    dist <span class="ot">&lt;-</span> <span class="fu">abs</span>(v1 <span class="sc">-</span> v2)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">include =</span> (dist <span class="sc">&lt;=</span> <span class="fl">0.05</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>less_match <span class="ot">&lt;-</span> <span class="cf">function</span>(lower, upper) {</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">include =</span> lower <span class="sc">&lt;=</span> upper)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>tumor_os_data_joined <span class="ot">&lt;-</span> tumor_data_summary <span class="sc">|&gt;</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fuzzy_left_join</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        os_data_keys,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">"arm"</span> <span class="ot">=</span> <span class="st">"arm"</span>, </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>          <span class="st">"bsld"</span> <span class="ot">=</span> <span class="st">"sld"</span>,          </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>          <span class="st">"last_year"</span> <span class="ot">=</span> <span class="st">"os_time"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>          <span class="st">"approx_response"</span> <span class="ot">=</span> <span class="st">"response"</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">match_fun =</span> <span class="fu">list</span>(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">==</span><span class="st">`</span>, </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>          dist_match, </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>          less_match,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">==</span><span class="st">`</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(tumor_os_data_joined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 954</code></pre>
</div>
</div>
<p>We see that we cannot match the two data sets exactly:</p>
<ul>
<li>We have less patients to start with in the tumor size data set.</li>
<li>We have patients in the tumor size data set which match multiple patients in the OS data set based on the treatment arm and the baseline SLD, and also the last measurement time point cannot disambiguate them.</li>
<li>We have patients in the tumor size data set which do not match any patient in the OS data set.</li>
</ul>
<p>However, for the purpose of this training we don’t need to be able to recover the true full data set. Therefore we will just subset the matched data set to a reasonable combination of the two data sets:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tumor_os_data_joined_subset <span class="ot">&lt;-</span> tumor_os_data_joined <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(id.y)) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(id.x))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(tumor_os_data_joined_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 203</code></pre>
</div>
</div>
<p>Now let’s save the joining information:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tgi_os_join_keys <span class="ot">&lt;-</span> tumor_os_data_joined_subset <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id.x, id.y, arm.x) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_tgi =</span> id.x,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_os =</span> id.y,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> arm.x</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(tgi_os_join_keys<span class="sc">$</span>arm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Docetaxel MPDL3280A 
       96       107 </code></pre>
</div>
</div>
<p>So we have about 100 patients in each arm.</p>
<p>We subset the two data sets accordingly:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tumor_data <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>      tgi_os_join_keys, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id_tgi"</span>, <span class="st">"arm"</span> <span class="ot">=</span> <span class="st">"arm"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">id =</span> id_os)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>os_data <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      tgi_os_join_keys, </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id_os"</span>, <span class="st">"arm"</span> <span class="ot">=</span> <span class="st">"arm"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id_tgi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tgi-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="tgi-model-fitting">TGI model fitting</h2>
<p>Let’s use <code>jmpost</code> to fit the Stein-Fojo model to the TGI dataset. This works analogously to what we showed in the previous session.</p>
<p>First we again prepare the data objects, starting with the subject level data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next we prepare the longitudinal data object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can create the <code>JointData</code> object for the TGI model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tgi_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We specify the Stein-Fojo model together with the priors for the model parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can fit the model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/tgi1.rds"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        tgi_mod,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> tgi_joint_data,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(tgi_results, <span class="at">file =</span> save_file)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function <code>saveObject()</code> was added to the package recently, please update your installation if it is not yet available.</p>
<p>Note that this is considerably faster than fitting the larger dataset of 701 patients. Let’s check the convergence of the population parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(tgi_results)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 10
   variable    mean median      sd     mad     q5    q95  rhat ess_bulk ess_tail
   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lm_sf_mu…  3.75   3.75  0.0375  0.0376   3.69   3.81  1.01      298.     572.
 2 lm_sf_mu… -0.270 -0.255 0.298   0.308   -0.789  0.163 1.00      641.     680.
 3 lm_sf_mu… -1.22  -1.16  0.360   0.343   -1.90  -0.708 0.999     723.     852.
 4 lm_sf_mu… -0.731 -0.723 0.174   0.167   -1.02  -0.462 1.00      604.     762.
 5 lm_sf_mu… -0.973 -0.969 0.157   0.150   -1.25  -0.728 1.00      641.     869.
 6 lm_sf_si…  0.129  0.129 0.00381 0.00373  0.123  0.135 1.00      883.     892.
 7 lm_sf_om…  0.531  0.529 0.0288  0.0294   0.486  0.583 1.00      518.     751.
 8 lm_sf_om…  1.09   1.08  0.212   0.207    0.771  1.44  1.00      704.     861.
 9 lm_sf_om…  1.45   1.42  0.271   0.251    1.07   1.95  0.999     731.     994.
10 lm_sf_om…  0.694  0.684 0.0963  0.0881   0.556  0.860 1.01      930.     904.
11 lm_sf_om…  0.994  0.983 0.103   0.100    0.840  1.17  1.01      762.     869.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>draws_tgi_results <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_tgi_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/check_convergence-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So this looks good.</p>
</section>
<section id="extract-individual-growth-rate-estimates" class="level2">
<h2 class="anchored" data-anchor-id="extract-individual-growth-rate-estimates">Extract individual growth rate estimates</h2>
<p>We can now extract the individual growth rate estimates from the model. Since the relevant random effect parameter samples are already stored in the <code>mcmc_tgi_results</code> object, we can directly extract the posterior means and credible intervals for the growth rates using the <code>summary</code> method. The only tricky part is that we need to match the IDs of the patients manually, because <code>jmpost</code> just numbers the patients in the order they appear in the data, which is then the index for all the random effects and individual growth parameters <span class="math inline">\(\psi_{\text{kg}, i}\)</span>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>subj_kg_est <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lm_sf_psi_kg"</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> subj_df<span class="sc">$</span>id)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(subj_kg_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  variable    mean median    sd   mad     q5   q95  rhat ess_bulk ess_tail id   
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;
1 lm_sf_psi… 0.514  0.446 0.349 0.397 0.0707 1.14  1.00      937.    1037. 588  
2 lm_sf_psi… 0.479  0.354 0.400 0.287 0.0729 1.28  0.999     929.     731. 330  
3 lm_sf_psi… 0.387  0.402 0.115 0.111 0.179  0.554 1.00      888.     717. 791  
4 lm_sf_psi… 0.549  0.482 0.298 0.287 0.168  1.12  1.00      857.     950. 635  
5 lm_sf_psi… 0.473  0.356 0.390 0.304 0.0729 1.24  1.01      976.     852. 365  
6 lm_sf_psi… 0.307  0.251 0.213 0.198 0.0518 0.732 1.00      905.     915. 773  </code></pre>
</div>
</div>
<p>We now add the e.g.&nbsp;posterior mean estimate of the individual growth rates to the OS data set, such that we will be able to use it below as a covariate in the OS model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>os_data_with_kg_est <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, arm, ecog, age, race, sex, os_time, os_event) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(subj_kg_est, mean, id), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">kg_est =</span> mean)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data_with_kg_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  id    arm       ecog    age race  sex   os_time os_event kg_est
  &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt; &lt;lgl&gt;     &lt;dbl&gt;
1 588   Docetaxel 0        61 WHITE F       2.05  FALSE     0.514
2 330   MPDL3280A 1        56 WHITE F       1.68  FALSE     0.479
3 791   Docetaxel 0        72 WHITE F       0.901 TRUE      0.387
4 635   Docetaxel 0        42 OTHER F       1.66  TRUE      0.549
5 365   MPDL3280A 0        64 WHITE F       1.43  TRUE      0.473
6 773   Docetaxel 0        65 WHITE M       1.63  FALSE     0.307</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_data_with_kg.rds"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_data_with_kg_est, <span class="at">file =</span> save_file)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="os-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="os-model-fitting">OS model fitting</h2>
<p>Now we can fit the OS model. We start by preparing the data objects.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_kg_est,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm <span class="sc">+</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex <span class="sc">+</span> kg_est</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that we are both including the treatment arm as well as the growth rate estimate here as covariates in the model, alongside the ECOG score, age, race and sex. The idea is that we want to understand whether there is additional information in the growth rate estimates, adjusting separately for the treatment arm.</p>
<p>Now we can create the <code>JointData</code> object for the OS model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>os_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We specify the Weibull model together with the priors for the model parameters. We take vague priors for the regression coefficients <code>beta</code>. For <code>lambda</code> and <code>gamma</code>, we start from the scale of the survival data at hand: the average survival time is 1.3 years, just taking a crude average of all survival times.</p>
<p>We can quickly write the function that gives the mean of the Weibull distribution with fixed <code>lambda</code> and <code>gamma</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>weibull_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, gamma) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> gamma) <span class="sc">/</span> lambda</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Therefore, playing around with this a bit, we can e.g.&nbsp;center the prior for <code>lambda</code> around 0.7 and the prior for <code>gamma</code> around 1.5, giving a mean survival time of 1.3 years.</p>
<p>If we want to use Gamma distributions e.g.&nbsp;for <code>lambda</code> and <code>gamma</code>, we can use the <code>prior_gamma</code> function. The two parameters of this distribution are the shape and the rate. The mean is shape divided by the rate. So easiest is to keep a rate of 1 and just set the shape to the mean value we need:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>os_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Because we use a large prior variance for <code>beta</code>, we need to adjust the default initial value construction used in <code>jmpost</code>. As explained <a href="https://genentech.github.io/jmpost/main/articles/model_fitting.html#initial-values">here</a>, we can change the shrinkage of the initial values to the mean. We can then check what the initial values will be, to make sure that they are reasonable:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.99</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">initialValues</span>(os_mod, <span class="at">n_chains =</span> CHAINS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$sm_weibull_ph_lambda
[1] 0.697769

[[1]]$sm_weibull_ph_gamma
[1] 1.49011

[[1]]$beta_os_cov
[1] -0.01574033


[[2]]
[[2]]$sm_weibull_ph_lambda
[1] 0.6978782

[[2]]$sm_weibull_ph_gamma
[1] 1.489772

[[2]]$beta_os_cov
[1] 0.0799451


[[3]]
[[3]]$sm_weibull_ph_lambda
[1] 0.6987861

[[3]]$sm_weibull_ph_gamma
[1] 1.493009

[[3]]$beta_os_cov
[1] -0.02421813


[[4]]
[[4]]$sm_weibull_ph_lambda
[1] 0.7038139

[[4]]$sm_weibull_ph_gamma
[1] 1.489617

[[4]]$beta_os_cov
[1] -0.08382688</code></pre>
</div>
</div>
<p>Now we can fit the model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os1.rds"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results, <span class="at">file =</span> save_file)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that here we can get warnings at the beginning of the chains’ sampling process (“The current Metropolis proposal is about to be rejected …”). As long as this only happens in the beginning, and not during the sampling later, then this is not a cause for concern.</p>
<p>Let’s check the convergence of the population parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>mcmc_os_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>mcmc_os_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 10
  variable          mean   median      sd     mad      q5     q95  rhat ess_bulk
  &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 beta_os_cov[… -0.346   -0.342   0.191   0.191   -0.667  -0.0394 1.01      990.
2 beta_os_cov[…  0.616    0.621   0.204   0.211    0.294   0.944  0.998     925.
3 beta_os_cov[…  0.00225  0.00196 0.00978 0.00913 -0.0135  0.0194 1.00      744.
4 beta_os_cov[…  0.508    0.509   0.409   0.402   -0.164   1.17   1.00      935.
5 beta_os_cov[…  0.0790   0.0741  0.231   0.224   -0.301   0.481  1.00      984.
6 beta_os_cov[…  0.282    0.278   0.209   0.212   -0.0738  0.622  0.998     903.
7 beta_os_cov[…  0.302    0.317   0.201   0.202   -0.0435  0.602  1.00      922.
8 sm_weibull_p…  1.66     1.67    0.139   0.143    1.43    1.90   1.00     1089.
9 sm_weibull_p…  0.176    0.145   0.126   0.0889   0.0484  0.419  1.00      740.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_os_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/check_convergence_os-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpret-covariate-effects" class="level2">
<h2 class="anchored" data-anchor-id="interpret-covariate-effects">Interpret covariate effects</h2>
<p>In order to better see which of the coefficients relate to which covariates, we can rename them as follows:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>old_coef_names <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_os_results), <span class="fu">setNames</span>(old_coef_names, os_cov_names))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_os_results) <span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/rename_os_cov_coefs-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(draws_os_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 10
  variable          mean   median      sd     mad      q5     q95  rhat ess_bulk
  &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 armMPDL3280A  -0.346   -0.342   0.191   0.191   -0.667  -0.0394 1.01      990.
2 ecog1          0.616    0.621   0.204   0.211    0.294   0.944  0.998     925.
3 age            0.00225  0.00196 0.00978 0.00913 -0.0135  0.0194 1.00      744.
4 raceOTHER      0.508    0.509   0.409   0.402   -0.164   1.17   1.00      935.
5 raceWHITE      0.0790   0.0741  0.231   0.224   -0.301   0.481  1.00      984.
6 sexM           0.282    0.278   0.209   0.212   -0.0738  0.622  0.998     903.
7 kg_est         0.302    0.317   0.201   0.202   -0.0435  0.602  1.00      922.
8 sm_weibull_p…  1.66     1.67    0.139   0.143    1.43    1.90   1.00     1089.
9 sm_weibull_p…  0.176    0.145   0.126   0.0889   0.0484  0.419  1.00      740.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_draws.rds"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(draws_os_results, <span class="at">file =</span> save_file)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So we can see that the 90% credible interval (CI) for the covariates <code>arm</code> and <code>ecog1</code> excludes 0, so these are “significant” predictors of the hazard rate. On the other hand, the <code>race</code> variable indicator and <code>age</code> variables’ CIs clearly include 0. The situation is less clear for <code>sex</code> and <code>kg_est</code>, the estimated growth rate: here the CIs barely include 0. The posterior probabilities for a hazard ratio above 1 are:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sexM, kg_est) <span class="sc">|&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise_all</span>(<span class="sc">~</span> <span class="fu">mean</span>(. <span class="sc">&gt;</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   sexM kg_est
  &lt;dbl&gt;  &lt;dbl&gt;
1 0.904  0.927</code></pre>
</div>
</div>
<p>So we have a more than 90% posterior probability that male patients have a higher hazard than females, and that patients with a higher estimated growth rate have a higher hazard than those with a lower growth rate - and this holds true even after adjusting for the treatment arm.</p>
</section>
<section id="observation-vs-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="observation-vs-model-fit">Observation vs model fit</h2>
<p>A useful plot displays the model predicted survival function and overlays the non-parametric Kaplan-Meier plot to it. Such a plot is easily obtained using the <code>autoplot()</code> function, as we will see below.</p>
<p>The first step consists in generating the survival predictions at the group level with the <code>SurvivalQuantities()</code> function. It is recommended to specify the sequence of time points at which the predictions should be made (using the argument <code>times</code>):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fu">max</span>(os_data_with_kg_est<span class="sc">$</span>os_time), <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        subj_df,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can use the <code>autoplot()</code> method:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/os_surv_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hazard-and-hazard-rate-estimation" class="level2">
<h2 class="anchored" data-anchor-id="hazard-and-hazard-rate-estimation">Hazard and hazard rate estimation</h2>
<p>Similarly to the survival function estimation, we can also estimate the hazard function by treatment group.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>os_hazard_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"haz"</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Also this can be plotted using the <code>autoplot()</code> method:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_hazard_pred, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/os_hazard_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can also estimate the hazard rate, which is constant over time here - because we use the Weibull proportional hazards model. We still show this more complicated code here because it will also work later for joint TGI-OS models, where the hazard rate is not constant any longer.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>os_hr_est <span class="ot">&lt;-</span> os_hazard_pred <span class="sc">|&gt;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group, time) <span class="sc">|&gt;</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> group, <span class="at">values_from =</span> values) <span class="sc">|&gt;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hr =</span> MPDL3280A <span class="sc">/</span> Docetaxel) <span class="sc">|&gt;</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">mean</span>(hr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">upper =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="co"># Omit the time = 0 which has NA</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(os_hr_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      time              mean            lower            upper       
 Min.   :0.02276   Min.   :0.7251   Min.   :0.5166   Min.   :0.9638  
 1st Qu.:0.58038   1st Qu.:0.7251   1st Qu.:0.5166   1st Qu.:0.9638  
 Median :1.13801   Median :0.7251   Median :0.5166   Median :0.9638  
 Mean   :1.13801   Mean   :0.7251   Mean   :0.5166   Mean   :0.9638  
 3rd Qu.:1.69563   3rd Qu.:0.7251   3rd Qu.:0.5166   3rd Qu.:0.9638  
 Max.   :2.25325   Max.   :0.7251   Max.   :0.5166   Max.   :0.9638  </code></pre>
</div>
</div>
<p>Now we can plot this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(os_hr_est, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)) <span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Similar, but not identical numbers we can obtain here of course directly from the group covariate coefficient:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">hr =</span> <span class="fu">exp</span>(armMPDL3280A)) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">variable =</span> <span class="st">"hr"</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable  mean median    sd   mad    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 hr       0.720  0.710 0.138 0.136 0.513 0.961  1.01     990.     789.</code></pre>
</div>
</div>
<p>The difference is due to the fact that the other covariates are ignored here by this simpler calculation.</p>
</section>
<section id="model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison">Model comparison</h2>
<p>We can use the <a href="https://en.wikipedia.org/wiki/Brier_score">Brier score</a> to compare two different survival models. The Brier score is a measure of the mean squared difference between the predicted survival probability and the actual survival status. The lower the Brier score, the better the model.</p>
<p>To calculate it, we need to use the <code>GridFixed</code> input for <code>SurvivalQuantities()</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>os_fixed_surv <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Current workaround if we have a logical event indicator:</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>os_fixed_surv<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    os_fixed_surv<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>os_mod1_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can also look at the LOOIC. As for the TGI model, we can use the <code>loo()</code> method in the <code>CmdStanMCMC</code> object to calculate it:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>os_mod1_looic <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now suppose we have a second model, where we omit the <code>kg_est</code> covariate. We can fit this model, just by omitting the <code>kg_est</code> covariate in the formula of the <code>DataSurvival</code> construction:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>surv_data2 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_kg_est,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">-</span> kg_est)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>os_joint_data2 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data2</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os2.rds"</span>)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data2,</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results2, <span class="at">file =</span> save_file)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>mcmc_os_results2 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we can calculate the Brier score and LOOIC as well:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Current workaround if we have a logical event indicator:</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    os_fixed_surv2<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>os_mod2_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv2)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>os_mod2_looic <span class="ot">&lt;-</span> mcmc_os_results2<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can compare the two models:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>os_mod1_looic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 203 log-likelihood matrix.

         Estimate   SE
elpd_loo   -192.9  5.7
p_loo         9.6  0.8
looic       385.7 11.5
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.67).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>os_mod2_looic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 203 log-likelihood matrix.

         Estimate   SE
elpd_loo   -193.3  5.6
p_loo         8.6  0.7
looic       386.6 11.2
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.67).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(os_mod1_looic, os_mod2_looic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff
model1  0.0       0.0   
model2 -0.4       1.4   </code></pre>
</div>
</div>
<p>So we see that according to the LOOIC, the model with the <code>kg_est</code> covariate is slightly better than the model without it. However, the difference is small, and considering the difference in the expected log pointwise predictive density (ELPD) is small compared to the standard error, the improvement is not significant.</p>
<p>We can plot the Brier scores:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time_grid,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">brier_score_diff =</span> os_mod1_bs <span class="sc">-</span> os_mod2_bs</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> brier_score_diff)) <span class="sc">+</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Brier score difference (1 - 2)"</span>) <span class="sc">+</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/brier_scores_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Also here we can see that the differences are very small, but for most time points the model with <code>kg_est</code> is slightly better than the one without (because lower numbers are better and we looked at the difference model 1 minus model 2 scores).</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb74" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "1. OS model minimal workflow with `jmpost`"</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> true</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>The purpose of this document is to show a minimal workflow for fitting a Weibull OS model using the <span class="in">`jmpost`</span> package.</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>{{&lt; include _setup_and_load.qmd &gt;}}</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>{{&lt; include _load_data.qmd &gt;}}</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## TGI model fitting</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>Let's use <span class="in">`jmpost`</span> to fit the Stein-Fojo model to the TGI dataset. This works analogously to what we showed in the previous session.</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>First we again prepare the data objects, starting with the subject level data:</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: subj_df_prep</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>Next we prepare the longitudinal data object.</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: long_df_prep</span></span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>Now we can create the <span class="in">`JointData`</span> object for the TGI model:</span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_data_prep</span></span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a>tgi_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>We specify the Stein-Fojo model together with the priors for the model parameters:</span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_mod_spec</span></span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb74-83"><a href="#cb74-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb74-84"><a href="#cb74-84" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb74-85"><a href="#cb74-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb74-86"><a href="#cb74-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb74-87"><a href="#cb74-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb74-88"><a href="#cb74-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb74-89"><a href="#cb74-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb74-90"><a href="#cb74-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb74-91"><a href="#cb74-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-92"><a href="#cb74-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-93"><a href="#cb74-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-94"><a href="#cb74-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-95"><a href="#cb74-95" aria-hidden="true" tabindex="-1"></a>Now we can fit the model:</span>
<span id="cb74-96"><a href="#cb74-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-99"><a href="#cb74-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-100"><a href="#cb74-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_model_fit</span></span>
<span id="cb74-101"><a href="#cb74-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-102"><a href="#cb74-102" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/tgi1.rds"</span>)</span>
<span id="cb74-103"><a href="#cb74-103" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb74-104"><a href="#cb74-104" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb74-105"><a href="#cb74-105" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb74-106"><a href="#cb74-106" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb74-107"><a href="#cb74-107" aria-hidden="true" tabindex="-1"></a>        tgi_mod,</span>
<span id="cb74-108"><a href="#cb74-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> tgi_joint_data,</span>
<span id="cb74-109"><a href="#cb74-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb74-110"><a href="#cb74-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb74-111"><a href="#cb74-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb74-112"><a href="#cb74-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb74-113"><a href="#cb74-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb74-114"><a href="#cb74-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb74-115"><a href="#cb74-115" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb74-116"><a href="#cb74-116" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-117"><a href="#cb74-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(tgi_results, <span class="at">file =</span> save_file)</span>
<span id="cb74-118"><a href="#cb74-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-119"><a href="#cb74-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-120"><a href="#cb74-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-121"><a href="#cb74-121" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`saveObject()`</span> was added to the package recently, please update your installation if it is not yet available.</span>
<span id="cb74-122"><a href="#cb74-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-123"><a href="#cb74-123" aria-hidden="true" tabindex="-1"></a>Note that this is considerably faster than fitting the larger dataset of 701 patients.</span>
<span id="cb74-124"><a href="#cb74-124" aria-hidden="true" tabindex="-1"></a>Let's check the convergence of the population parameters:</span>
<span id="cb74-125"><a href="#cb74-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-128"><a href="#cb74-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-129"><a href="#cb74-129" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence</span></span>
<span id="cb74-130"><a href="#cb74-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: tgi_model_fit</span></span>
<span id="cb74-131"><a href="#cb74-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-132"><a href="#cb74-132" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb74-133"><a href="#cb74-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb74-134"><a href="#cb74-134" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb74-135"><a href="#cb74-135" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb74-136"><a href="#cb74-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb74-137"><a href="#cb74-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb74-138"><a href="#cb74-138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb74-139"><a href="#cb74-139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb74-140"><a href="#cb74-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-141"><a href="#cb74-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-142"><a href="#cb74-142" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(tgi_results)</span>
<span id="cb74-143"><a href="#cb74-143" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb74-144"><a href="#cb74-144" aria-hidden="true" tabindex="-1"></a>draws_tgi_results <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb74-145"><a href="#cb74-145" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_tgi_results)</span>
<span id="cb74-146"><a href="#cb74-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-147"><a href="#cb74-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-148"><a href="#cb74-148" aria-hidden="true" tabindex="-1"></a>So this looks good.</span>
<span id="cb74-149"><a href="#cb74-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-150"><a href="#cb74-150" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extract individual growth rate estimates</span></span>
<span id="cb74-151"><a href="#cb74-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-152"><a href="#cb74-152" aria-hidden="true" tabindex="-1"></a>We can now extract the individual growth rate estimates from the model. </span>
<span id="cb74-153"><a href="#cb74-153" aria-hidden="true" tabindex="-1"></a>Since the relevant random effect parameter samples are already stored in the <span class="in">`mcmc_tgi_results`</span> object, we can directly extract the posterior means and credible intervals for the growth rates using the <span class="in">`summary`</span> method.</span>
<span id="cb74-154"><a href="#cb74-154" aria-hidden="true" tabindex="-1"></a>The only tricky part is that we need to match the IDs of the patients manually, because <span class="in">`jmpost`</span> just numbers the patients in the order they appear in the data, which is then the index for all the random effects and individual growth parameters $\psi_{\text{kg}, i}$.</span>
<span id="cb74-155"><a href="#cb74-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-158"><a href="#cb74-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-159"><a href="#cb74-159" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_growth_rates</span></span>
<span id="cb74-160"><a href="#cb74-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-161"><a href="#cb74-161" aria-hidden="true" tabindex="-1"></a>subj_kg_est <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lm_sf_psi_kg"</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-162"><a href="#cb74-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> subj_df<span class="sc">$</span>id)</span>
<span id="cb74-163"><a href="#cb74-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-164"><a href="#cb74-164" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(subj_kg_est)</span>
<span id="cb74-165"><a href="#cb74-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-166"><a href="#cb74-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-167"><a href="#cb74-167" aria-hidden="true" tabindex="-1"></a>We now add the e.g. posterior mean estimate of the individual growth rates to the OS data set, such that we will be able to use it below as a covariate in the OS model:</span>
<span id="cb74-168"><a href="#cb74-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-171"><a href="#cb74-171" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-172"><a href="#cb74-172" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: add_kg_est_to_os_data</span></span>
<span id="cb74-173"><a href="#cb74-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-174"><a href="#cb74-174" aria-hidden="true" tabindex="-1"></a>os_data_with_kg_est <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb74-175"><a href="#cb74-175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, arm, ecog, age, race, sex, os_time, os_event) <span class="sc">|&gt;</span></span>
<span id="cb74-176"><a href="#cb74-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(subj_kg_est, mean, id), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-177"><a href="#cb74-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">kg_est =</span> mean)</span>
<span id="cb74-178"><a href="#cb74-178" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data_with_kg_est)</span>
<span id="cb74-179"><a href="#cb74-179" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_data_with_kg.rds"</span>)</span>
<span id="cb74-180"><a href="#cb74-180" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb74-181"><a href="#cb74-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_data_with_kg_est, <span class="at">file =</span> save_file)</span>
<span id="cb74-182"><a href="#cb74-182" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-183"><a href="#cb74-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-184"><a href="#cb74-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-185"><a href="#cb74-185" aria-hidden="true" tabindex="-1"></a><span class="fu">## OS model fitting</span></span>
<span id="cb74-186"><a href="#cb74-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-187"><a href="#cb74-187" aria-hidden="true" tabindex="-1"></a>Now we can fit the OS model. We start by preparing the data objects.</span>
<span id="cb74-188"><a href="#cb74-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-191"><a href="#cb74-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-192"><a href="#cb74-192" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_df_prep</span></span>
<span id="cb74-193"><a href="#cb74-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-194"><a href="#cb74-194" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb74-195"><a href="#cb74-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_kg_est,</span>
<span id="cb74-196"><a href="#cb74-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm <span class="sc">+</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex <span class="sc">+</span> kg_est</span>
<span id="cb74-197"><a href="#cb74-197" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-198"><a href="#cb74-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-199"><a href="#cb74-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-200"><a href="#cb74-200" aria-hidden="true" tabindex="-1"></a>Note that we are both including the treatment arm as well as the growth rate estimate here as covariates in the model, alongside the ECOG score, age, race and sex.</span>
<span id="cb74-201"><a href="#cb74-201" aria-hidden="true" tabindex="-1"></a>The idea is that we want to understand whether there is additional information in the growth rate estimates, adjusting separately for the treatment arm.</span>
<span id="cb74-202"><a href="#cb74-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-203"><a href="#cb74-203" aria-hidden="true" tabindex="-1"></a>Now we can create the <span class="in">`JointData`</span> object for the OS model:</span>
<span id="cb74-204"><a href="#cb74-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-207"><a href="#cb74-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-208"><a href="#cb74-208" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_data_prep</span></span>
<span id="cb74-209"><a href="#cb74-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-210"><a href="#cb74-210" aria-hidden="true" tabindex="-1"></a>os_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb74-211"><a href="#cb74-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb74-212"><a href="#cb74-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb74-213"><a href="#cb74-213" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-214"><a href="#cb74-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-215"><a href="#cb74-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-216"><a href="#cb74-216" aria-hidden="true" tabindex="-1"></a>We specify the Weibull model together with the priors for the model parameters. We take vague priors for the regression coefficients <span class="in">`beta`</span>. For <span class="in">`lambda`</span> and <span class="in">`gamma`</span>, we start from the scale of the survival data at hand: </span>
<span id="cb74-217"><a href="#cb74-217" aria-hidden="true" tabindex="-1"></a>the average survival time is <span class="in">`r round(mean(os_data_with_kg_est$os_time), 1)`</span> years, just taking a crude average of all survival times. </span>
<span id="cb74-218"><a href="#cb74-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-219"><a href="#cb74-219" aria-hidden="true" tabindex="-1"></a>We can quickly write the function that gives the mean of the Weibull distribution with fixed <span class="in">`lambda`</span> and <span class="in">`gamma`</span>:</span>
<span id="cb74-220"><a href="#cb74-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-223"><a href="#cb74-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-224"><a href="#cb74-224" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: weibull_mean</span></span>
<span id="cb74-225"><a href="#cb74-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-226"><a href="#cb74-226" aria-hidden="true" tabindex="-1"></a>weibull_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, gamma) {</span>
<span id="cb74-227"><a href="#cb74-227" aria-hidden="true" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> gamma) <span class="sc">/</span> lambda</span>
<span id="cb74-228"><a href="#cb74-228" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-229"><a href="#cb74-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-230"><a href="#cb74-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-231"><a href="#cb74-231" aria-hidden="true" tabindex="-1"></a>Therefore, playing around with this a bit, we can e.g. center the prior for <span class="in">`lambda`</span> around 0.7 and the prior for <span class="in">`gamma`</span> around 1.5, giving a mean survival time of <span class="in">`r round(weibull_mean(0.7, 1.5), 1)`</span> years.</span>
<span id="cb74-232"><a href="#cb74-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-233"><a href="#cb74-233" aria-hidden="true" tabindex="-1"></a>If we want to use Gamma distributions e.g. for <span class="in">`lambda`</span> and <span class="in">`gamma`</span>, we can use the <span class="in">`prior_gamma`</span> function. The two parameters of this distribution are the shape and the rate. The mean is shape divided by the rate. So easiest is to keep a rate of 1 and just set the shape to the mean value we need:</span>
<span id="cb74-234"><a href="#cb74-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-237"><a href="#cb74-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-238"><a href="#cb74-238" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod_spec</span></span>
<span id="cb74-239"><a href="#cb74-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-240"><a href="#cb74-240" aria-hidden="true" tabindex="-1"></a>os_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb74-241"><a href="#cb74-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb74-242"><a href="#cb74-242" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb74-243"><a href="#cb74-243" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb74-244"><a href="#cb74-244" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb74-245"><a href="#cb74-245" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-246"><a href="#cb74-246" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-247"><a href="#cb74-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-248"><a href="#cb74-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-249"><a href="#cb74-249" aria-hidden="true" tabindex="-1"></a>Because we use a large prior variance for <span class="in">`beta`</span>, we need to adjust the default initial value construction used in <span class="in">`jmpost`</span>. As explained <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/model_fitting.html#initial-values)</span>, we can change the shrinkage of the initial values to the mean. We can then check what the initial values will be, to make sure that they are reasonable:</span>
<span id="cb74-250"><a href="#cb74-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-253"><a href="#cb74-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-254"><a href="#cb74-254" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod_initial_values</span></span>
<span id="cb74-255"><a href="#cb74-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-256"><a href="#cb74-256" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.99</span>)</span>
<span id="cb74-257"><a href="#cb74-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-258"><a href="#cb74-258" aria-hidden="true" tabindex="-1"></a><span class="fu">initialValues</span>(os_mod, <span class="at">n_chains =</span> CHAINS)</span>
<span id="cb74-259"><a href="#cb74-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-260"><a href="#cb74-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-261"><a href="#cb74-261" aria-hidden="true" tabindex="-1"></a>Now we can fit the model:</span>
<span id="cb74-262"><a href="#cb74-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-265"><a href="#cb74-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-266"><a href="#cb74-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_model_fit</span></span>
<span id="cb74-267"><a href="#cb74-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-268"><a href="#cb74-268" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os1.rds"</span>)</span>
<span id="cb74-269"><a href="#cb74-269" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb74-270"><a href="#cb74-270" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb74-271"><a href="#cb74-271" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb74-272"><a href="#cb74-272" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb74-273"><a href="#cb74-273" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb74-274"><a href="#cb74-274" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data,</span>
<span id="cb74-275"><a href="#cb74-275" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb74-276"><a href="#cb74-276" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb74-277"><a href="#cb74-277" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb74-278"><a href="#cb74-278" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb74-279"><a href="#cb74-279" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb74-280"><a href="#cb74-280" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb74-281"><a href="#cb74-281" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb74-282"><a href="#cb74-282" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-283"><a href="#cb74-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results, <span class="at">file =</span> save_file)</span>
<span id="cb74-284"><a href="#cb74-284" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-285"><a href="#cb74-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-286"><a href="#cb74-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-287"><a href="#cb74-287" aria-hidden="true" tabindex="-1"></a>Note that here we can get warnings at the beginning of the chains' sampling process ("The current Metropolis proposal is about to be rejected ..."). As long as this only happens in the beginning, and not during the sampling later, then this is not a cause for concern.</span>
<span id="cb74-288"><a href="#cb74-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-289"><a href="#cb74-289" aria-hidden="true" tabindex="-1"></a>Let's check the convergence of the population parameters:</span>
<span id="cb74-290"><a href="#cb74-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-293"><a href="#cb74-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-294"><a href="#cb74-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence_os</span></span>
<span id="cb74-295"><a href="#cb74-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: os_model_fit</span></span>
<span id="cb74-296"><a href="#cb74-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-297"><a href="#cb74-297" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb74-298"><a href="#cb74-298" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb74-299"><a href="#cb74-299" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb74-300"><a href="#cb74-300" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span></span>
<span id="cb74-301"><a href="#cb74-301" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-302"><a href="#cb74-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-303"><a href="#cb74-303" aria-hidden="true" tabindex="-1"></a>mcmc_os_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results)</span>
<span id="cb74-304"><a href="#cb74-304" aria-hidden="true" tabindex="-1"></a>mcmc_os_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb74-305"><a href="#cb74-305" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb74-306"><a href="#cb74-306" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_os_results)</span>
<span id="cb74-307"><a href="#cb74-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-308"><a href="#cb74-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-309"><a href="#cb74-309" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpret covariate effects</span></span>
<span id="cb74-310"><a href="#cb74-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-311"><a href="#cb74-311" aria-hidden="true" tabindex="-1"></a>In order to better see which of the coefficients relate to which covariates, we can rename them as follows:</span>
<span id="cb74-312"><a href="#cb74-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-315"><a href="#cb74-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-316"><a href="#cb74-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rename_os_cov_coefs</span></span>
<span id="cb74-317"><a href="#cb74-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-318"><a href="#cb74-318" aria-hidden="true" tabindex="-1"></a>surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb74-319"><a href="#cb74-319" aria-hidden="true" tabindex="-1"></a>os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb74-320"><a href="#cb74-320" aria-hidden="true" tabindex="-1"></a>old_coef_names <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>)</span>
<span id="cb74-321"><a href="#cb74-321" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb74-322"><a href="#cb74-322" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb74-323"><a href="#cb74-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_os_results), <span class="fu">setNames</span>(old_coef_names, os_cov_names))</span>
<span id="cb74-324"><a href="#cb74-324" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-325"><a href="#cb74-325" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_os_results) <span class="sc">+</span></span>
<span id="cb74-326"><a href="#cb74-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb74-327"><a href="#cb74-327" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(draws_os_results)</span>
<span id="cb74-328"><a href="#cb74-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-329"><a href="#cb74-329" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_draws.rds"</span>)</span>
<span id="cb74-330"><a href="#cb74-330" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb74-331"><a href="#cb74-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(draws_os_results, <span class="at">file =</span> save_file)</span>
<span id="cb74-332"><a href="#cb74-332" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-333"><a href="#cb74-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-334"><a href="#cb74-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-335"><a href="#cb74-335" aria-hidden="true" tabindex="-1"></a>So we can see that the 90% credible interval (CI) for the covariates <span class="in">`arm`</span> and <span class="in">`ecog1`</span> excludes 0, so these are "significant" predictors of the hazard rate. On the other hand, the <span class="in">`race`</span> variable indicator and <span class="in">`age`</span> variables' CIs clearly include 0. The situation is less clear for <span class="in">`sex`</span> and <span class="in">`kg_est`</span>, the estimated growth rate: here the CIs barely include 0. The posterior probabilities for a hazard ratio above 1 are:</span>
<span id="cb74-336"><a href="#cb74-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-339"><a href="#cb74-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-340"><a href="#cb74-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_ratios</span></span>
<span id="cb74-341"><a href="#cb74-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-342"><a href="#cb74-342" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb74-343"><a href="#cb74-343" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span></span>
<span id="cb74-344"><a href="#cb74-344" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sexM, kg_est) <span class="sc">|&gt;</span></span>
<span id="cb74-345"><a href="#cb74-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise_all</span>(<span class="sc">~</span> <span class="fu">mean</span>(. <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb74-346"><a href="#cb74-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-347"><a href="#cb74-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-348"><a href="#cb74-348" aria-hidden="true" tabindex="-1"></a>So we have a more than 90% posterior probability that male patients have a higher hazard than females, and that patients with a higher estimated growth rate have a higher hazard than those with a lower growth rate - and this holds true even after adjusting for the treatment arm.</span>
<span id="cb74-349"><a href="#cb74-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-350"><a href="#cb74-350" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observation vs model fit</span></span>
<span id="cb74-351"><a href="#cb74-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-352"><a href="#cb74-352" aria-hidden="true" tabindex="-1"></a>A useful plot displays the model predicted survival function and overlays the non-parametric Kaplan-Meier plot to it. Such a plot is easily obtained using the <span class="in">`autoplot()`</span> function, as we will see below.</span>
<span id="cb74-353"><a href="#cb74-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-354"><a href="#cb74-354" aria-hidden="true" tabindex="-1"></a>The first step consists in generating the survival predictions at the group level with the <span class="in">`SurvivalQuantities()`</span> function. It is recommended to specify the sequence of time points at which the predictions should be made (using the argument <span class="in">`times`</span>):</span>
<span id="cb74-355"><a href="#cb74-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-358"><a href="#cb74-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-359"><a href="#cb74-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_surv_pred</span></span>
<span id="cb74-360"><a href="#cb74-360" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fu">max</span>(os_data_with_kg_est<span class="sc">$</span>os_time), <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb74-361"><a href="#cb74-361" aria-hidden="true" tabindex="-1"></a>os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb74-362"><a href="#cb74-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb74-363"><a href="#cb74-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb74-364"><a href="#cb74-364" aria-hidden="true" tabindex="-1"></a>        subj_df,</span>
<span id="cb74-365"><a href="#cb74-365" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb74-366"><a href="#cb74-366" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-367"><a href="#cb74-367" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-368"><a href="#cb74-368" aria-hidden="true" tabindex="-1"></a>os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb74-369"><a href="#cb74-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb74-370"><a href="#cb74-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb74-371"><a href="#cb74-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb74-372"><a href="#cb74-372" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-373"><a href="#cb74-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-374"><a href="#cb74-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-375"><a href="#cb74-375" aria-hidden="true" tabindex="-1"></a>Now we can use the <span class="in">`autoplot()`</span> method:</span>
<span id="cb74-376"><a href="#cb74-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-379"><a href="#cb74-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-380"><a href="#cb74-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_surv_plot</span></span>
<span id="cb74-381"><a href="#cb74-381" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-382"><a href="#cb74-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-383"><a href="#cb74-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-384"><a href="#cb74-384" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hazard and hazard rate estimation</span></span>
<span id="cb74-385"><a href="#cb74-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-386"><a href="#cb74-386" aria-hidden="true" tabindex="-1"></a>Similarly to the survival function estimation, we can also estimate the hazard function by treatment group.</span>
<span id="cb74-387"><a href="#cb74-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-390"><a href="#cb74-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-391"><a href="#cb74-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_pred</span></span>
<span id="cb74-392"><a href="#cb74-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-393"><a href="#cb74-393" aria-hidden="true" tabindex="-1"></a>os_hazard_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb74-394"><a href="#cb74-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb74-395"><a href="#cb74-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb74-396"><a href="#cb74-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"haz"</span></span>
<span id="cb74-397"><a href="#cb74-397" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-398"><a href="#cb74-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-399"><a href="#cb74-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-400"><a href="#cb74-400" aria-hidden="true" tabindex="-1"></a>Also this can be plotted using the <span class="in">`autoplot()`</span> method:</span>
<span id="cb74-401"><a href="#cb74-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-404"><a href="#cb74-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-405"><a href="#cb74-405" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_plot</span></span>
<span id="cb74-406"><a href="#cb74-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-407"><a href="#cb74-407" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_hazard_pred, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-408"><a href="#cb74-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-409"><a href="#cb74-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-410"><a href="#cb74-410" aria-hidden="true" tabindex="-1"></a>Finally, we can also estimate the hazard rate, which is constant over time here - because we use the Weibull proportional hazards model. We still show this more complicated code here because it will also work later for joint TGI-OS models, where the hazard rate is not constant any longer.</span>
<span id="cb74-411"><a href="#cb74-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-414"><a href="#cb74-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-415"><a href="#cb74-415" aria-hidden="true" tabindex="-1"></a>os_hr_est <span class="ot">&lt;-</span> os_hazard_pred <span class="sc">|&gt;</span></span>
<span id="cb74-416"><a href="#cb74-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb74-417"><a href="#cb74-417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group, time) <span class="sc">|&gt;</span></span>
<span id="cb74-418"><a href="#cb74-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb74-419"><a href="#cb74-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> group, <span class="at">values_from =</span> values) <span class="sc">|&gt;</span></span>
<span id="cb74-420"><a href="#cb74-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hr =</span> MPDL3280A <span class="sc">/</span> Docetaxel) <span class="sc">|&gt;</span></span>
<span id="cb74-421"><a href="#cb74-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb74-422"><a href="#cb74-422" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb74-423"><a href="#cb74-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">mean</span>(hr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb74-424"><a href="#cb74-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb74-425"><a href="#cb74-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">upper =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb74-426"><a href="#cb74-426" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb74-427"><a href="#cb74-427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="co"># Omit the time = 0 which has NA</span></span>
<span id="cb74-428"><a href="#cb74-428" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(os_hr_est)</span>
<span id="cb74-429"><a href="#cb74-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-430"><a href="#cb74-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-431"><a href="#cb74-431" aria-hidden="true" tabindex="-1"></a>Now we can plot this:</span>
<span id="cb74-432"><a href="#cb74-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-435"><a href="#cb74-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-436"><a href="#cb74-436" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(os_hr_est, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)) <span class="sc">+</span></span>
<span id="cb74-437"><a href="#cb74-437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb74-438"><a href="#cb74-438" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb74-439"><a href="#cb74-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-440"><a href="#cb74-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-441"><a href="#cb74-441" aria-hidden="true" tabindex="-1"></a>Similar, but not identical numbers we can obtain here of course directly from the group covariate coefficient:</span>
<span id="cb74-442"><a href="#cb74-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-445"><a href="#cb74-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-446"><a href="#cb74-446" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb74-447"><a href="#cb74-447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">hr =</span> <span class="fu">exp</span>(armMPDL3280A)) <span class="sc">|&gt;</span></span>
<span id="cb74-448"><a href="#cb74-448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="at">variable =</span> <span class="st">"hr"</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-449"><a href="#cb74-449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>()</span>
<span id="cb74-450"><a href="#cb74-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-451"><a href="#cb74-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-452"><a href="#cb74-452" aria-hidden="true" tabindex="-1"></a>The difference is due to the fact that the other covariates are ignored here by this simpler calculation.</span>
<span id="cb74-453"><a href="#cb74-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-454"><a href="#cb74-454" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model comparison</span></span>
<span id="cb74-455"><a href="#cb74-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-456"><a href="#cb74-456" aria-hidden="true" tabindex="-1"></a>We can use the <span class="co">[</span><span class="ot">Brier score</span><span class="co">](https://en.wikipedia.org/wiki/Brier_score)</span> to compare two different survival models. The Brier score is a measure of the mean squared difference between the predicted survival probability and the actual survival status. The lower the Brier score, the better the model.</span>
<span id="cb74-457"><a href="#cb74-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-458"><a href="#cb74-458" aria-hidden="true" tabindex="-1"></a>To calculate it, we need to use the <span class="in">`GridFixed`</span> input for <span class="in">`SurvivalQuantities()`</span>:</span>
<span id="cb74-459"><a href="#cb74-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-462"><a href="#cb74-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-463"><a href="#cb74-463" aria-hidden="true" tabindex="-1"></a>os_fixed_surv <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb74-464"><a href="#cb74-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb74-465"><a href="#cb74-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb74-466"><a href="#cb74-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb74-467"><a href="#cb74-467" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-468"><a href="#cb74-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-469"><a href="#cb74-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Current workaround if we have a logical event indicator:</span></span>
<span id="cb74-470"><a href="#cb74-470" aria-hidden="true" tabindex="-1"></a>os_fixed_surv<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb74-471"><a href="#cb74-471" aria-hidden="true" tabindex="-1"></a>    os_fixed_surv<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event</span>
<span id="cb74-472"><a href="#cb74-472" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-473"><a href="#cb74-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-474"><a href="#cb74-474" aria-hidden="true" tabindex="-1"></a>os_mod1_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv)</span>
<span id="cb74-475"><a href="#cb74-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-476"><a href="#cb74-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-477"><a href="#cb74-477" aria-hidden="true" tabindex="-1"></a>We can also look at the LOOIC. As for the TGI model, we can use the <span class="in">`loo()`</span> method in the <span class="in">`CmdStanMCMC`</span> object to calculate it:</span>
<span id="cb74-478"><a href="#cb74-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-481"><a href="#cb74-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-482"><a href="#cb74-482" aria-hidden="true" tabindex="-1"></a>os_mod1_looic <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-483"><a href="#cb74-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-484"><a href="#cb74-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-485"><a href="#cb74-485" aria-hidden="true" tabindex="-1"></a>Now suppose we have a second model, where we omit the <span class="in">`kg_est`</span> covariate. We can fit this model, just by omitting the <span class="in">`kg_est`</span> covariate in the formula of the <span class="in">`DataSurvival`</span> construction:</span>
<span id="cb74-486"><a href="#cb74-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-489"><a href="#cb74-489" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-490"><a href="#cb74-490" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod2_fit</span></span>
<span id="cb74-491"><a href="#cb74-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-492"><a href="#cb74-492" aria-hidden="true" tabindex="-1"></a>surv_data2 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb74-493"><a href="#cb74-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_kg_est,</span>
<span id="cb74-494"><a href="#cb74-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">-</span> kg_est)</span>
<span id="cb74-495"><a href="#cb74-495" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-496"><a href="#cb74-496" aria-hidden="true" tabindex="-1"></a>os_joint_data2 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb74-497"><a href="#cb74-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb74-498"><a href="#cb74-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data2</span>
<span id="cb74-499"><a href="#cb74-499" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-500"><a href="#cb74-500" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os2.rds"</span>)</span>
<span id="cb74-501"><a href="#cb74-501" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb74-502"><a href="#cb74-502" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb74-503"><a href="#cb74-503" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb74-504"><a href="#cb74-504" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb74-505"><a href="#cb74-505" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb74-506"><a href="#cb74-506" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data2,</span>
<span id="cb74-507"><a href="#cb74-507" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb74-508"><a href="#cb74-508" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb74-509"><a href="#cb74-509" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb74-510"><a href="#cb74-510" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb74-511"><a href="#cb74-511" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb74-512"><a href="#cb74-512" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb74-513"><a href="#cb74-513" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb74-514"><a href="#cb74-514" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-515"><a href="#cb74-515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results2, <span class="at">file =</span> save_file)</span>
<span id="cb74-516"><a href="#cb74-516" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-517"><a href="#cb74-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-518"><a href="#cb74-518" aria-hidden="true" tabindex="-1"></a>mcmc_os_results2 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results2)</span>
<span id="cb74-519"><a href="#cb74-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-520"><a href="#cb74-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-521"><a href="#cb74-521" aria-hidden="true" tabindex="-1"></a>Then we can calculate the Brier score and LOOIC as well:</span>
<span id="cb74-522"><a href="#cb74-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-525"><a href="#cb74-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-526"><a href="#cb74-526" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb74-527"><a href="#cb74-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb74-528"><a href="#cb74-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb74-529"><a href="#cb74-529" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb74-530"><a href="#cb74-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-531"><a href="#cb74-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-532"><a href="#cb74-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Current workaround if we have a logical event indicator:</span></span>
<span id="cb74-533"><a href="#cb74-533" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb74-534"><a href="#cb74-534" aria-hidden="true" tabindex="-1"></a>    os_fixed_surv2<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data<span class="sc">$</span>os_event</span>
<span id="cb74-535"><a href="#cb74-535" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-536"><a href="#cb74-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-537"><a href="#cb74-537" aria-hidden="true" tabindex="-1"></a>os_mod2_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv2)</span>
<span id="cb74-538"><a href="#cb74-538" aria-hidden="true" tabindex="-1"></a>os_mod2_looic <span class="ot">&lt;-</span> mcmc_os_results2<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-539"><a href="#cb74-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-540"><a href="#cb74-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-541"><a href="#cb74-541" aria-hidden="true" tabindex="-1"></a>Now we can compare the two models:</span>
<span id="cb74-542"><a href="#cb74-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-545"><a href="#cb74-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-546"><a href="#cb74-546" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_comparison</span></span>
<span id="cb74-547"><a href="#cb74-547" aria-hidden="true" tabindex="-1"></a>os_mod1_looic</span>
<span id="cb74-548"><a href="#cb74-548" aria-hidden="true" tabindex="-1"></a>os_mod2_looic</span>
<span id="cb74-549"><a href="#cb74-549" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(os_mod1_looic, os_mod2_looic)</span>
<span id="cb74-550"><a href="#cb74-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-551"><a href="#cb74-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-552"><a href="#cb74-552" aria-hidden="true" tabindex="-1"></a>So we see that according to the LOOIC, the model with the <span class="in">`kg_est`</span> covariate is slightly better than the model without it. However, the difference is small, and considering the difference in the expected log pointwise predictive density (ELPD) is small compared to the standard error, the improvement is not significant.</span>
<span id="cb74-553"><a href="#cb74-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-554"><a href="#cb74-554" aria-hidden="true" tabindex="-1"></a>We can plot the Brier scores:</span>
<span id="cb74-555"><a href="#cb74-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-556"><a href="#cb74-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-559"><a href="#cb74-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb74-560"><a href="#cb74-560" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: brier_scores_plot</span></span>
<span id="cb74-561"><a href="#cb74-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-562"><a href="#cb74-562" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb74-563"><a href="#cb74-563" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time_grid,</span>
<span id="cb74-564"><a href="#cb74-564" aria-hidden="true" tabindex="-1"></a>    <span class="at">brier_score_diff =</span> os_mod1_bs <span class="sc">-</span> os_mod2_bs</span>
<span id="cb74-565"><a href="#cb74-565" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb74-566"><a href="#cb74-566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> brier_score_diff)) <span class="sc">+</span></span>
<span id="cb74-567"><a href="#cb74-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb74-568"><a href="#cb74-568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Brier score difference (1 - 2)"</span>) <span class="sc">+</span></span>
<span id="cb74-569"><a href="#cb74-569" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb74-570"><a href="#cb74-570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb74-571"><a href="#cb74-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-572"><a href="#cb74-572" aria-hidden="true" tabindex="-1"></a>Also here we can see that the differences are very small, but for most time points the model with <span class="in">`kg_est`</span> is slightly better than the one without (because lower numbers are better and we looked at the difference model 1 minus model 2 scores).</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-os/1_os_weibull_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>