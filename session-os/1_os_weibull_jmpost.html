<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-04-10">

<title>1. OS model minimal workflow with jmpost – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f9c7e5d2d3782bd4f414016107dfc2cc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-os/0_setup.html">Session 2: OS</a></li><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">1. OS model minimal workflow with <code>jmpost</code></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">TGI-OS Training</a> 
        <div class="sidebar-tools-main">
    <a href="https://rconis.github.io/tgi-os-training/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 2: OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/1_os_weibull_jmpost.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. OS model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/2_os_weibull_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. OS model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/4_tgi_cb_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Claret-Bruno model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#tgi-model-fitting" id="toc-tgi-model-fitting" class="nav-link" data-scroll-target="#tgi-model-fitting">TGI model fitting</a></li>
  <li><a href="#extract-individual-growth-rate-estimates" id="toc-extract-individual-growth-rate-estimates" class="nav-link" data-scroll-target="#extract-individual-growth-rate-estimates">Extract individual growth rate estimates</a></li>
  <li><a href="#os-model-fitting" id="toc-os-model-fitting" class="nav-link" data-scroll-target="#os-model-fitting">OS model fitting</a></li>
  <li><a href="#interpret-covariate-effects" id="toc-interpret-covariate-effects" class="nav-link" data-scroll-target="#interpret-covariate-effects">Interpret covariate effects</a></li>
  <li><a href="#observation-vs-model-fit" id="toc-observation-vs-model-fit" class="nav-link" data-scroll-target="#observation-vs-model-fit">Observation vs model fit</a></li>
  <li><a href="#hazard-and-hazard-rate-estimation" id="toc-hazard-and-hazard-rate-estimation" class="nav-link" data-scroll-target="#hazard-and-hazard-rate-estimation">Hazard and hazard rate estimation</a></li>
  <li><a href="#alternative-models" id="toc-alternative-models" class="nav-link" data-scroll-target="#alternative-models">Alternative models</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model comparison</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-os/1_os_weibull_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-os/0_setup.html">Session 2: OS</a></li><li class="breadcrumb-item"><a href="../session-os/1_os_weibull_jmpost.html">1. OS model minimal workflow with <code>jmpost</code></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">1. OS model minimal workflow with <code>jmpost</code></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-04-10</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this document is to show a minimal workflow for fitting a Weibull OS model using the <code>jmpost</code> package.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>Here we execute the R code from the setup and data preparation chapter, see the <a href="../session-os/0_setup.html">full code here</a>.</p>
</section>
<section id="tgi-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="tgi-model-fitting">TGI model fitting</h2>
<p>Let’s use <code>jmpost</code> to fit the Stein-Fojo model to the TGI dataset. This works analogously to what we showed in the previous session.</p>
<p>First we again prepare the data objects, starting with the subject level data:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next we prepare the longitudinal data object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can create the <code>JointData</code> object for the TGI model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tgi_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We specify the Stein-Fojo model together with the priors for the model parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can fit the model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/tgi1.rds"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        tgi_mod,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> tgi_joint_data,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(tgi_results, <span class="at">file =</span> save_file)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function <code>saveObject()</code> was added to the package recently, please update your installation if it is not yet available.</p>
<p>Note that this is considerably faster than fitting the larger dataset of 701 patients. Let’s check the convergence of the population parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(tgi_results)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 10
   variable    mean median      sd     mad     q5    q95  rhat ess_bulk ess_tail
   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lm_sf_mu…  3.75   3.75  0.0375  0.0376   3.69   3.81  1.01      298.     572.
 2 lm_sf_mu… -0.270 -0.255 0.298   0.308   -0.789  0.163 1.00      641.     680.
 3 lm_sf_mu… -1.22  -1.16  0.360   0.343   -1.90  -0.708 0.999     723.     852.
 4 lm_sf_mu… -0.731 -0.723 0.174   0.167   -1.02  -0.462 1.00      604.     762.
 5 lm_sf_mu… -0.973 -0.969 0.157   0.150   -1.25  -0.728 1.00      641.     869.
 6 lm_sf_si…  0.129  0.129 0.00381 0.00373  0.123  0.135 1.00      883.     892.
 7 lm_sf_om…  0.531  0.529 0.0288  0.0294   0.486  0.583 1.00      518.     751.
 8 lm_sf_om…  1.09   1.08  0.212   0.207    0.771  1.44  1.00      704.     861.
 9 lm_sf_om…  1.45   1.42  0.271   0.251    1.07   1.95  0.999     731.     994.
10 lm_sf_om…  0.694  0.684 0.0963  0.0881   0.556  0.860 1.01      930.     904.
11 lm_sf_om…  0.994  0.983 0.103   0.100    0.840  1.17  1.01      762.     869.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>draws_tgi_results <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_tgi_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/check_convergence-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So this looks good.</p>
</section>
<section id="extract-individual-growth-rate-estimates" class="level2">
<h2 class="anchored" data-anchor-id="extract-individual-growth-rate-estimates">Extract individual growth rate estimates</h2>
<p>We can now extract the individual growth rate estimates from the model. Later, in the joint model, we are going to use the log of the growth parameter as the link. Therefore we also here first log transform the sampled values of the growth rate estimates <span class="math inline">\(\psi_{\text{kg}, i}\)</span>, and then take the mean. Since the relevant random effect parameter samples are already stored in the <code>mcmc_tgi_results</code> object, we can work with that via the <code>rvars</code> interface.</p>
<p>The only tricky part is that we need to match the IDs of the patients manually, because <code>jmpost</code> just numbers the patients in the order they appear in the data, which is then the index for all the random effects and individual growth parameters <span class="math inline">\(\psi_{\text{kg}, i}\)</span>.</p>
<p>However, we need to be careful to extract the data order from the <code>tgi_joint_data</code> object, because the subject data set is reordered by the sorted patient ID during the creation of the <code>DataJoint</code> object. If we don’t do this correctly, then we would permute the growth rates randomly between the patients and thereby destroy the link between the growth rates and the patients.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>log_growth_samples <span class="ot">&lt;-</span> mcmc_tgi_results <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We use here `rvars` because it allows to apply the</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mutation across all subjects at once.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_rvars</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">log_growth =</span> <span class="fu">log</span>(lm_sf_psi_kg))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>subj_log_kg_est <span class="ot">&lt;-</span> log_growth_samples <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset_draws</span>(<span class="at">variable =</span> <span class="st">"log_growth"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Important: Take the IDs from `tgi_joint_data` and not from `subj_data` here!</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> tgi_joint_data<span class="sc">@</span>subject<span class="sc">@</span>data<span class="sc">$</span>id)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(subj_log_kg_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 11
  variable    mean median    sd   mad    q5    q95  rhat ess_bulk ess_tail id   
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;
1 log_grow… -0.982 -0.808 0.902 0.927 -2.65  0.130 1.00      937.    1037. 1008 
2 log_grow… -1.09  -1.04  0.894 0.921 -2.62  0.246 0.999     929.     731. 1018 
3 log_grow… -1.01  -0.911 0.367 0.264 -1.72 -0.590 1.00      888.     717. 1019 
4 log_grow… -0.760 -0.729 0.594 0.619 -1.79  0.117 1.00      857.     950. 1021 
5 log_grow… -1.09  -1.03  0.885 0.910 -2.62  0.217 1.01      976.     852. 1026 
6 log_grow… -1.46  -1.38  0.814 0.845 -2.96 -0.313 1.00      905.     915. 1027 </code></pre>
</div>
</div>
<p>We now add the e.g.&nbsp;posterior mean estimate of the individual log growth rates to the OS data set, such that we will be able to use it below as a covariate in the OS model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>os_data_with_log_kg_est <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, arm, ecog, age, race, sex, os_time, os_event) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(subj_log_kg_est, mean, id), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">log_kg_est =</span> mean)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data_with_log_kg_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  id    arm       ecog    age race  sex   os_time os_event log_kg_est
  &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt; &lt;lgl&gt;         &lt;dbl&gt;
1 588   Docetaxel 0        61 WHITE F       2.05  FALSE       -0.571 
2 330   MPDL3280A 1        56 WHITE F       1.68  FALSE       -1.89  
3 791   Docetaxel 0        72 WHITE F       0.901 TRUE        -0.518 
4 635   Docetaxel 0        42 OTHER F       1.66  TRUE        -0.642 
5 365   MPDL3280A 0        64 WHITE F       1.43  TRUE        -0.427 
6 773   Docetaxel 0        65 WHITE M       1.63  FALSE        0.0340</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_data_with_log_kg.rds"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_data_with_log_kg_est, <span class="at">file =</span> save_file)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As a sanity check to make sure we linked the growth rates correctly to the patients, let’s compare the average log growth rates computed from the above data set with the average we would expect based on the log normal distribution. Remember from the TGI session that we have:</p>
<p><span class="math display">\[
\log(\psi_{k_{g}}) \sim \text{Normal}(\mu_{k_{g}}, \omega_{g})
\]</span></p>
<p>within each treatment arm.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the mean using the individual estimates:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>log_growth_summary <span class="ot">&lt;-</span> os_data_with_log_kg_est <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(arm) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(log_kg_est))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># And now compute the mean from the original model parameter samples:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>log_growth_check <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lm_sf_mu_kg"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">recode</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>            variable,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The order here is given by the order of the arm factor levels.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lm_sf_mu_kg[1]"</span> <span class="ot">=</span> <span class="st">"Docetaxel"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lm_sf_mu_kg[2]"</span> <span class="ot">=</span> <span class="st">"MPDL3280A"</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(arm, mean)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># We can compare:</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>log_growth_summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  arm         mean
  &lt;fct&gt;      &lt;dbl&gt;
1 Docetaxel -0.738
2 MPDL3280A -0.989</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>log_growth_check</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  arm         mean
  &lt;chr&gt;      &lt;dbl&gt;
1 Docetaxel -0.731
2 MPDL3280A -0.973</code></pre>
</div>
</div>
<p>So this looks good, and we can continue with this data set.</p>
</section>
<section id="os-model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="os-model-fitting">OS model fitting</h2>
<p>Now we can fit the OS model.</p>
<p>We start by preparing the <code>DataSurvival</code> object:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex <span class="sc">+</span> log_kg_est</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that we are not including the treatment arm here, but only the log growth rate estimates. In addition, the covariates in the model include the ECOG score, age, race and sex. The idea is that the treatment effect is fully captured in the log growth rate estimates, which is referred to as “Working assumption (1)” in the slides.</p>
<p>Now we can create the <code>JointData</code> object for the OS model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>os_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We specify the Weibull model together with the priors for the model parameters. We take vague priors for the regression coefficients <code>beta</code>. For <code>lambda</code> and <code>gamma</code>, we start from the scale of the survival data at hand: the average survival time is 1.3 years, just taking a crude average of all survival times.</p>
<p>We can quickly write the function that gives the mean of the Weibull distribution with fixed <code>lambda</code> and <code>gamma</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>weibull_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, gamma) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> gamma) <span class="sc">/</span> lambda</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Therefore, playing around with this a bit, we can e.g.&nbsp;center the prior for <code>lambda</code> around 0.7 and the prior for <code>gamma</code> around 1.5, giving a mean survival time of 1.3 years.</p>
<p>If we want to use Gamma distributions e.g.&nbsp;for <code>lambda</code> and <code>gamma</code>, we can use the <code>prior_gamma</code> function. The two parameters of this distribution are the shape and the rate. The mean is shape divided by the rate. So easiest is to keep a rate of 1 and just set the shape to the mean value we need:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>os_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Because we use a large prior variance for <code>beta</code>, we need to adjust the default initial value construction used in <code>jmpost</code>. As explained <a href="https://genentech.github.io/jmpost/main/articles/model_fitting.html#initial-values">here</a>, we can change the shrinkage of the initial values to the mean. We can then check what the initial values will be, to make sure that they are reasonable:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.999</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">initialValues</span>(os_mod, <span class="at">n_chains =</span> CHAINS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$sm_weibull_ph_lambda
[1] 0.6998024

[[1]]$sm_weibull_ph_gamma
[1] 1.503281

[[1]]$beta_os_cov
[1] -0.0007535511


[[2]]
[[2]]$sm_weibull_ph_lambda
[1] 0.6996494

[[2]]$sm_weibull_ph_gamma
[1] 1.500184

[[2]]$beta_os_cov
[1] 0.02279188


[[3]]
[[3]]$sm_weibull_ph_lambda
[1] 0.6995914

[[3]]$sm_weibull_ph_gamma
[1] 1.500092

[[3]]$beta_os_cov
[1] 0.01817745


[[4]]
[[4]]$sm_weibull_ph_lambda
[1] 0.7004638

[[4]]$sm_weibull_ph_gamma
[1] 1.499552

[[4]]$beta_os_cov
[1] 0.004554045</code></pre>
</div>
</div>
<p>So the values are now close to the means of the respective prior distributions. We can then see later if the chains were converging well. If not, we could as an alternative also manually set initial values, as explained <a href="https://genentech.github.io/jmpost/main/articles/quickstart.html#initial-values">here</a>.</p>
<p>Now we can fit the model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os1.rds"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results, <span class="at">file =</span> save_file)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that here we can get warnings at the beginning of the chains’ sampling process (“The current Metropolis proposal is about to be rejected …”). As long as this only happens in the beginning, and not during the sampling later, then this is not a cause for concern.</p>
<p>Let’s check the convergence of the population parameters:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>mcmc_os_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>mcmc_os_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 10
  variable           mean   median      sd     mad      q5    q95  rhat ess_bulk
  &lt;chr&gt;             &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 beta_os_cov[1]  0.724    0.728   0.207   0.214    0.386  1.06   1.00      957.
2 beta_os_cov[2]  0.00445  0.00463 0.00920 0.00937 -0.0101 0.0194 0.999    1043.
3 beta_os_cov[3]  0.542    0.542   0.400   0.419   -0.124  1.17   0.998     942.
4 beta_os_cov[4] -0.0268  -0.0307  0.221   0.221   -0.373  0.333  1.00     1046.
5 beta_os_cov[5]  0.302    0.303   0.201   0.198   -0.0342 0.630  1.00      718.
6 beta_os_cov[6]  0.597    0.587   0.172   0.170    0.321  0.880  1.00      742.
7 sm_weibull_ph…  1.69     1.68    0.135   0.131    1.47   1.92   1.00      933.
8 sm_weibull_ph…  0.248    0.208   0.164   0.115    0.0720 0.556  0.999     983.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_os_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/check_convergence_os-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpret-covariate-effects" class="level2">
<h2 class="anchored" data-anchor-id="interpret-covariate-effects">Interpret covariate effects</h2>
<p>In order to better see which of the coefficients relate to which covariates, we can rename them as follows:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>old_coef_names <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_os_results), <span class="fu">setNames</span>(old_coef_names, os_cov_names))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_os_results) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/rename_os_cov_coefs-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(draws_os_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 10
  variable           mean   median      sd     mad      q5    q95  rhat ess_bulk
  &lt;chr&gt;             &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 ecog1           0.724    0.728   0.207   0.214    0.386  1.06   1.00      957.
2 age             0.00445  0.00463 0.00920 0.00937 -0.0101 0.0194 0.999    1043.
3 raceOTHER       0.542    0.542   0.400   0.419   -0.124  1.17   0.998     942.
4 raceWHITE      -0.0268  -0.0307  0.221   0.221   -0.373  0.333  1.00     1046.
5 sexM            0.302    0.303   0.201   0.198   -0.0342 0.630  1.00      718.
6 log_kg_est      0.597    0.587   0.172   0.170    0.321  0.880  1.00      742.
7 sm_weibull_ph…  1.69     1.68    0.135   0.131    1.47   1.92   1.00      933.
8 sm_weibull_ph…  0.248    0.208   0.164   0.115    0.0720 0.556  0.999     983.
# ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_draws.rds"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(draws_os_results, <span class="at">file =</span> save_file)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So we can see that the 90% credible interval (CI) for the <code>log_kg_est</code> and <code>ecog1</code> covariate coefficients excludes 0, so both are “significant” predictors of the hazard rate. On the other hand, the <code>race</code> dummy variables’ and the <code>age</code> variable’s coefficient CIs clearly include 0. The situation is less clear for <code>sex</code>: here the CI barely includes 0.</p>
<p>In addition, we can also look at the posterior probabilities to have a hazard ratio above 1:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise_all</span>(<span class="sc">~</span> <span class="fu">mean</span>(. <span class="sc">&gt;</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 11
  ecog1   age raceOTHER raceWHITE  sexM log_kg_est sm_weibull_ph_gamma
  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;               &lt;dbl&gt;
1     1 0.677     0.912     0.432  0.93          1                   1
# ℹ 4 more variables: sm_weibull_ph_lambda &lt;dbl&gt;, .chain &lt;dbl&gt;,
#   .iteration &lt;dbl&gt;, .draw &lt;dbl&gt;</code></pre>
</div>
</div>
<p>So we have a more than 90% posterior probability that male patients have a higher hazard than females, and we also see a similarly strong effect here for the <code>OTHER</code> category of <code>race</code>. As we saw from the CI already, the <code>age</code> effect is not so strong.</p>
</section>
<section id="observation-vs-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="observation-vs-model-fit">Observation vs model fit</h2>
<p>A useful plot displays the model predicted survival function and overlays the non-parametric Kaplan-Meier plot to it. Such a plot is easily obtained using the <code>autoplot()</code> function, as we will see below.</p>
<p>The first step consists in generating the survival predictions at the group level with the <code>SurvivalQuantities()</code> function. It is recommended to specify the sequence of time points at which the predictions should be made (using the argument <code>times</code>):</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> <span class="dv">0</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> <span class="fu">max</span>(os_data_with_log_kg_est<span class="sc">$</span>os_time),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="dv">100</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        subj_df,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can use the <code>autoplot()</code> method:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/os_surv_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here the fit seems ok but not perfect, especially for the Docetaxel arm it could be improved maybe. We will try below alternative models to see if we can improve the fit.</p>
</section>
<section id="hazard-and-hazard-rate-estimation" class="level2">
<h2 class="anchored" data-anchor-id="hazard-and-hazard-rate-estimation">Hazard and hazard rate estimation</h2>
<p>Similarly to the survival function estimation, we can also estimate the hazard function by treatment group.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>os_hazard_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"haz"</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Also this can be plotted using the <code>autoplot()</code> method:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_hazard_pred, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/os_hazard_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can also estimate the hazard rate, which is constant over time here - because we use the Weibull proportional hazards model. We still show this more complicated code here because it will also work later for joint TGI-OS models, where the hazard rate may not be constant any longer.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>os_hr_est <span class="ot">&lt;-</span> os_hazard_pred <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group, time) <span class="sc">|&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> group, <span class="at">values_from =</span> values) <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hr =</span> MPDL3280A <span class="sc">/</span> Docetaxel) <span class="sc">|&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">mean</span>(hr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">upper =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="co"># Omit the time = 0 which has NA</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(os_hr_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      time              mean            lower          upper       
 Min.   :0.02276   Min.   :0.9028   Min.   :0.88   Min.   :0.9295  
 1st Qu.:0.58038   1st Qu.:0.9028   1st Qu.:0.88   1st Qu.:0.9295  
 Median :1.13801   Median :0.9028   Median :0.88   Median :0.9295  
 Mean   :1.13801   Mean   :0.9028   Mean   :0.88   Mean   :0.9295  
 3rd Qu.:1.69563   3rd Qu.:0.9028   3rd Qu.:0.88   3rd Qu.:0.9295  
 Max.   :2.25325   Max.   :0.9028   Max.   :0.88   Max.   :0.9295  </code></pre>
</div>
</div>
<p>Now we can plot this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(os_hr_est, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)) <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="alternative-models" class="level2">
<h2 class="anchored" data-anchor-id="alternative-models">Alternative models</h2>
<p>Above we felt that maybe we could improve the fit of the model further.</p>
<p>One idea is to add also the direct effect of the treatment arm as a covariate:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>surv_data2 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we add the arm covariate:</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">+</span> arm)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>os_joint_data2 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data2</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os2.rds"</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data2,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results2, <span class="at">file =</span> save_file)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>mcmc_os_results2 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can easily plot the survival functions and compare them with the Kaplan-Meier curves of the treatment arms, because we can reuse the above <code>os_surv_group_grid</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>os_surv_pred2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred2, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here we see a bit better “coverage” of the Docetaxel Kaplan-Meier curve by the confidence intervals of the model.</p>
<p>We could also consider the model with only the direct treatment arm effect, without the log growth rate estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>surv_data3 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we add the arm covariate:</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data2<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">-</span> log_kg_est)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>os_joint_data3 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data3</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os3.rds"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    os_results3 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    os_results3 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data3,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results3, <span class="at">file =</span> save_file)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>mcmc_os_results3 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s plot again the survival functions:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>os_surv_pred3 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results3,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred3, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/os_mod3_surv_pred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks very similar to the previous model.</p>
</section>
<section id="model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison">Model comparison</h2>
<p>For comparing models, we can use more formal tools, as we will see now.</p>
<p>We can use the <a href="https://en.wikipedia.org/wiki/Brier_score">Brier score</a> to compare two different survival models. The Brier score is a measure of the mean squared difference between the predicted survival probability and the actual survival status. The lower the Brier score, the better the model.</p>
<p>To calculate it, we need to use the <code>GridFixed</code> input for <code>SurvivalQuantities()</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>os_fixed_surv <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>os_mod1_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can also look at the LOOIC. As for the TGI model, we can use the <code>loo()</code> method in the <code>CmdStanMCMC</code> object to calculate it:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>os_mod1_looic <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Also for the two alternative models we can calculate the Brier score and LOOIC in the same way:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>os_mod2_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv2)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>os_mod2_looic <span class="ot">&lt;-</span> mcmc_os_results2<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>os_fixed_surv3 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results3,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>os_mod3_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv3)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>os_mod3_looic <span class="ot">&lt;-</span> mcmc_os_results3<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Of course in a real application with many models we can easily write a little function that does this for us repeatedly instead of just copy/pasting the code as we do here.</p>
<p>Now we can compare the three models.</p>
<p>Let’s start with the LOOIC:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>os_mod1_looic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 203 log-likelihood matrix.

         Estimate   SE
elpd_loo   -188.6  6.5
p_loo         8.6  0.8
looic       377.3 13.0
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.67).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>os_mod2_looic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 203 log-likelihood matrix.

         Estimate   SE
elpd_loo   -189.4  6.6
p_loo         9.9  0.8
looic       378.8 13.1
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.67).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>os_mod3_looic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 1000 by 203 log-likelihood matrix.

         Estimate   SE
elpd_loo   -193.4  5.6
p_loo         8.7  0.6
looic       386.8 11.1
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume independent draws (r_eff=1).

All Pareto k estimates are good (k &lt; 0.67).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(os_mod1_looic, os_mod2_looic, os_mod3_looic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       elpd_diff se_diff
model1  0.0       0.0   
model2 -0.7       1.3   
model3 -4.8       4.2   </code></pre>
</div>
</div>
<p>So we see that according to the LOOIC, the first model with just the <code>log_kg_est</code> covariate is slightly better than the model with the additional <code>arm</code> covariate. If we omit the <code>log_kg_est</code> covariate altogether and only include the <code>arm</code> covariate, then the model is worse than both of the other two models.</p>
<p>We can plot the Brier scores:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time_grid,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">1 - 2</span><span class="st">`</span> <span class="ot">=</span> os_mod1_bs <span class="sc">-</span> os_mod2_bs,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">1 - 3</span><span class="st">`</span> <span class="ot">=</span> os_mod1_bs <span class="sc">-</span> os_mod3_bs,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">2 - 3</span><span class="st">`</span> <span class="ot">=</span> os_mod2_bs <span class="sc">-</span> os_mod3_bs,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"1 - 2"</span>, <span class="st">"1 - 3"</span>, <span class="st">"2 - 3"</span>),</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"diff"</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"brier_score_diff"</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> brier_score_diff, <span class="at">color =</span> diff, <span class="at">group =</span> diff)) <span class="sc">+</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Brier score difference"</span>) <span class="sc">+</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_os_weibull_jmpost_files/figure-html/brier_scores_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When we look at the difference model 1 minus model 2, we see that this is slightly positive. Since lower numbers of the Brier score are better, this means that model 2 is slightly better here.</p>
<p>When we look at the difference model 1 minus model 3, we see that this is more clearly negative between times 0.25 and 1.75, meaning that model 1 is clearly better than model 3 there. Towards later times this reverses, and model 3 is better than model 1.</p>
<p>The Brier score provides a more nuanced and time-dependent way of comparing the different OS models. Here we could either select model 1 due to its simplicity and almost same performance as model 2.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb57" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "1. OS model minimal workflow with `jmpost`"</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> true</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>The purpose of this document is to show a minimal workflow for fitting a Weibull OS model using the <span class="in">`jmpost`</span> package.</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>Here we execute the R code from the setup and data preparation chapter, see the <span class="co">[</span><span class="ot">full code here</span><span class="co">](0_setup.qmd)</span>.</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup_and_load_data</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.duplicate.label =</span> <span class="st">"allow"</span>)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-os/_setup.qmd"</span>),</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-os/_setup.R"</span>)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-os/_setup.R"</span>))</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-os/_load_data.qmd"</span>),</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-os/_load_data.R"</span>)</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-os/_load_data.R"</span>))</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## TGI model fitting</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>Let's use <span class="in">`jmpost`</span> to fit the Stein-Fojo model to the TGI dataset. This works analogously to what we showed in the previous session.</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>First we again prepare the data objects, starting with the subject level data:</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: subj_df_prep</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>Next we prepare the longitudinal data object.</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: long_df_prep</span></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>Now we can create the <span class="in">`JointData`</span> object for the TGI model:</span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_data_prep</span></span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>tgi_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data</span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>We specify the Stein-Fojo model together with the priors for the model parameters:</span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_mod_spec</span></span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>tgi_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-115"><a href="#cb57-115" aria-hidden="true" tabindex="-1"></a>Now we can fit the model:</span>
<span id="cb57-116"><a href="#cb57-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-119"><a href="#cb57-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-120"><a href="#cb57-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tgi_model_fit</span></span>
<span id="cb57-121"><a href="#cb57-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-122"><a href="#cb57-122" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/tgi1.rds"</span>)</span>
<span id="cb57-123"><a href="#cb57-123" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-124"><a href="#cb57-124" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb57-125"><a href="#cb57-125" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-126"><a href="#cb57-126" aria-hidden="true" tabindex="-1"></a>    tgi_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb57-127"><a href="#cb57-127" aria-hidden="true" tabindex="-1"></a>        tgi_mod,</span>
<span id="cb57-128"><a href="#cb57-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> tgi_joint_data,</span>
<span id="cb57-129"><a href="#cb57-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb57-130"><a href="#cb57-130" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb57-131"><a href="#cb57-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb57-132"><a href="#cb57-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb57-133"><a href="#cb57-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb57-134"><a href="#cb57-134" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb57-135"><a href="#cb57-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb57-136"><a href="#cb57-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-137"><a href="#cb57-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(tgi_results, <span class="at">file =</span> save_file)</span>
<span id="cb57-138"><a href="#cb57-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-139"><a href="#cb57-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-140"><a href="#cb57-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-141"><a href="#cb57-141" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`saveObject()`</span> was added to the package recently, please update your installation if it is not yet available.</span>
<span id="cb57-142"><a href="#cb57-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-143"><a href="#cb57-143" aria-hidden="true" tabindex="-1"></a>Note that this is considerably faster than fitting the larger dataset of 701 patients.</span>
<span id="cb57-144"><a href="#cb57-144" aria-hidden="true" tabindex="-1"></a>Let's check the convergence of the population parameters:</span>
<span id="cb57-145"><a href="#cb57-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-148"><a href="#cb57-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-149"><a href="#cb57-149" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence</span></span>
<span id="cb57-150"><a href="#cb57-150" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: tgi_model_fit</span></span>
<span id="cb57-151"><a href="#cb57-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-152"><a href="#cb57-152" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb57-153"><a href="#cb57-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_bsld"</span>,</span>
<span id="cb57-154"><a href="#cb57-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_ks"</span>,</span>
<span id="cb57-155"><a href="#cb57-155" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_mu_kg"</span>,</span>
<span id="cb57-156"><a href="#cb57-156" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_sigma"</span>,</span>
<span id="cb57-157"><a href="#cb57-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_bsld"</span>,</span>
<span id="cb57-158"><a href="#cb57-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_ks"</span>,</span>
<span id="cb57-159"><a href="#cb57-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lm_sf_omega_kg"</span></span>
<span id="cb57-160"><a href="#cb57-160" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-161"><a href="#cb57-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-162"><a href="#cb57-162" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(tgi_results)</span>
<span id="cb57-163"><a href="#cb57-163" aria-hidden="true" tabindex="-1"></a>mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb57-164"><a href="#cb57-164" aria-hidden="true" tabindex="-1"></a>draws_tgi_results <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb57-165"><a href="#cb57-165" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_tgi_results)</span>
<span id="cb57-166"><a href="#cb57-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-167"><a href="#cb57-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-168"><a href="#cb57-168" aria-hidden="true" tabindex="-1"></a>So this looks good.</span>
<span id="cb57-169"><a href="#cb57-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-170"><a href="#cb57-170" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extract individual growth rate estimates</span></span>
<span id="cb57-171"><a href="#cb57-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-172"><a href="#cb57-172" aria-hidden="true" tabindex="-1"></a>We can now extract the individual growth rate estimates from the model. </span>
<span id="cb57-173"><a href="#cb57-173" aria-hidden="true" tabindex="-1"></a>Later, in the joint model, we are going to use the log of the growth parameter as the link. Therefore we also here first log transform the sampled values of the growth rate estimates $\psi_{\text{kg}, i}$, and then take the mean.</span>
<span id="cb57-174"><a href="#cb57-174" aria-hidden="true" tabindex="-1"></a>Since the relevant random effect parameter samples are already stored in the <span class="in">`mcmc_tgi_results`</span> object, we can work with that via the <span class="in">`rvars`</span> interface.</span>
<span id="cb57-175"><a href="#cb57-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-176"><a href="#cb57-176" aria-hidden="true" tabindex="-1"></a>The only tricky part is that we need to match the IDs of the patients manually, because <span class="in">`jmpost`</span> just numbers the patients in the order they appear in the data, which is then the index for all the random effects and individual growth parameters $\psi_{\text{kg}, i}$. </span>
<span id="cb57-177"><a href="#cb57-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-178"><a href="#cb57-178" aria-hidden="true" tabindex="-1"></a>However, we need to be careful to extract the data order from the <span class="in">`tgi_joint_data`</span> object, because the subject data set is reordered by the sorted patient ID during the creation of the <span class="in">`DataJoint`</span> object. If we don't do this correctly, then we would permute the growth rates randomly between the patients and thereby destroy the link between the growth rates and the patients.</span>
<span id="cb57-179"><a href="#cb57-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-182"><a href="#cb57-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-183"><a href="#cb57-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_log_growth_rates</span></span>
<span id="cb57-184"><a href="#cb57-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-185"><a href="#cb57-185" aria-hidden="true" tabindex="-1"></a>log_growth_samples <span class="ot">&lt;-</span> mcmc_tgi_results <span class="sc">|&gt;</span></span>
<span id="cb57-186"><a href="#cb57-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We use here `rvars` because it allows to apply the</span></span>
<span id="cb57-187"><a href="#cb57-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mutation across all subjects at once.</span></span>
<span id="cb57-188"><a href="#cb57-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_rvars</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-189"><a href="#cb57-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">log_growth =</span> <span class="fu">log</span>(lm_sf_psi_kg))</span>
<span id="cb57-190"><a href="#cb57-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-191"><a href="#cb57-191" aria-hidden="true" tabindex="-1"></a>subj_log_kg_est <span class="ot">&lt;-</span> log_growth_samples <span class="sc">|&gt;</span></span>
<span id="cb57-192"><a href="#cb57-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset_draws</span>(<span class="at">variable =</span> <span class="st">"log_growth"</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-193"><a href="#cb57-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-194"><a href="#cb57-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Important: Take the IDs from `tgi_joint_data` and not from `subj_data` here!</span></span>
<span id="cb57-195"><a href="#cb57-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> tgi_joint_data<span class="sc">@</span>subject<span class="sc">@</span>data<span class="sc">$</span>id)</span>
<span id="cb57-196"><a href="#cb57-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-197"><a href="#cb57-197" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(subj_log_kg_est)</span>
<span id="cb57-198"><a href="#cb57-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-199"><a href="#cb57-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-200"><a href="#cb57-200" aria-hidden="true" tabindex="-1"></a>We now add the e.g. posterior mean estimate of the individual log growth rates to the OS data set, such that we will be able to use it below as a covariate in the OS model:</span>
<span id="cb57-201"><a href="#cb57-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-204"><a href="#cb57-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-205"><a href="#cb57-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: add_log_kg_est_to_os_data</span></span>
<span id="cb57-206"><a href="#cb57-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-207"><a href="#cb57-207" aria-hidden="true" tabindex="-1"></a>os_data_with_log_kg_est <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb57-208"><a href="#cb57-208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, arm, ecog, age, race, sex, os_time, os_event) <span class="sc">|&gt;</span></span>
<span id="cb57-209"><a href="#cb57-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(subj_log_kg_est, mean, id), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-210"><a href="#cb57-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">log_kg_est =</span> mean)</span>
<span id="cb57-211"><a href="#cb57-211" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_data_with_log_kg_est)</span>
<span id="cb57-212"><a href="#cb57-212" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_data_with_log_kg.rds"</span>)</span>
<span id="cb57-213"><a href="#cb57-213" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-214"><a href="#cb57-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_data_with_log_kg_est, <span class="at">file =</span> save_file)</span>
<span id="cb57-215"><a href="#cb57-215" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-216"><a href="#cb57-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-217"><a href="#cb57-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-218"><a href="#cb57-218" aria-hidden="true" tabindex="-1"></a>As a sanity check to make sure we linked the growth rates correctly to the patients, let's compare the average log growth rates computed from the above data set with the average we would expect based on the log normal distribution. Remember from the TGI session that we have:</span>
<span id="cb57-219"><a href="#cb57-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-220"><a href="#cb57-220" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-221"><a href="#cb57-221" aria-hidden="true" tabindex="-1"></a>\log(\psi_{k_{g}}) \sim \text{Normal}(\mu_{k_{g}}, \omega_{g})</span>
<span id="cb57-222"><a href="#cb57-222" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-223"><a href="#cb57-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-224"><a href="#cb57-224" aria-hidden="true" tabindex="-1"></a>within each treatment arm.</span>
<span id="cb57-225"><a href="#cb57-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-228"><a href="#cb57-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-229"><a href="#cb57-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: log_growth_sanity_check</span></span>
<span id="cb57-230"><a href="#cb57-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-231"><a href="#cb57-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the mean using the individual estimates:</span></span>
<span id="cb57-232"><a href="#cb57-232" aria-hidden="true" tabindex="-1"></a>log_growth_summary <span class="ot">&lt;-</span> os_data_with_log_kg_est <span class="sc">|&gt;</span></span>
<span id="cb57-233"><a href="#cb57-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(arm) <span class="sc">|&gt;</span></span>
<span id="cb57-234"><a href="#cb57-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(log_kg_est))</span>
<span id="cb57-235"><a href="#cb57-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-236"><a href="#cb57-236" aria-hidden="true" tabindex="-1"></a><span class="co"># And now compute the mean from the original model parameter samples:</span></span>
<span id="cb57-237"><a href="#cb57-237" aria-hidden="true" tabindex="-1"></a>log_growth_check <span class="ot">&lt;-</span> mcmc_tgi_results<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lm_sf_mu_kg"</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-238"><a href="#cb57-238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb57-239"><a href="#cb57-239" aria-hidden="true" tabindex="-1"></a>        <span class="at">arm =</span> <span class="fu">recode</span>(</span>
<span id="cb57-240"><a href="#cb57-240" aria-hidden="true" tabindex="-1"></a>            variable,</span>
<span id="cb57-241"><a href="#cb57-241" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The order here is given by the order of the arm factor levels.</span></span>
<span id="cb57-242"><a href="#cb57-242" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lm_sf_mu_kg[1]"</span> <span class="ot">=</span> <span class="st">"Docetaxel"</span>,</span>
<span id="cb57-243"><a href="#cb57-243" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lm_sf_mu_kg[2]"</span> <span class="ot">=</span> <span class="st">"MPDL3280A"</span></span>
<span id="cb57-244"><a href="#cb57-244" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb57-245"><a href="#cb57-245" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb57-246"><a href="#cb57-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(arm, mean)</span>
<span id="cb57-247"><a href="#cb57-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-248"><a href="#cb57-248" aria-hidden="true" tabindex="-1"></a><span class="co"># We can compare:</span></span>
<span id="cb57-249"><a href="#cb57-249" aria-hidden="true" tabindex="-1"></a>log_growth_summary</span>
<span id="cb57-250"><a href="#cb57-250" aria-hidden="true" tabindex="-1"></a>log_growth_check</span>
<span id="cb57-251"><a href="#cb57-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-252"><a href="#cb57-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-253"><a href="#cb57-253" aria-hidden="true" tabindex="-1"></a>So this looks good, and we can continue with this data set.</span>
<span id="cb57-254"><a href="#cb57-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-255"><a href="#cb57-255" aria-hidden="true" tabindex="-1"></a><span class="fu">## OS model fitting</span></span>
<span id="cb57-256"><a href="#cb57-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-257"><a href="#cb57-257" aria-hidden="true" tabindex="-1"></a>Now we can fit the OS model. </span>
<span id="cb57-258"><a href="#cb57-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-259"><a href="#cb57-259" aria-hidden="true" tabindex="-1"></a>We start by preparing the <span class="in">`DataSurvival`</span> object:</span>
<span id="cb57-260"><a href="#cb57-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-263"><a href="#cb57-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-264"><a href="#cb57-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_df_prep</span></span>
<span id="cb57-265"><a href="#cb57-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-266"><a href="#cb57-266" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb57-267"><a href="#cb57-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb57-268"><a href="#cb57-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span></span>
<span id="cb57-269"><a href="#cb57-269" aria-hidden="true" tabindex="-1"></a>        ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex <span class="sc">+</span> log_kg_est</span>
<span id="cb57-270"><a href="#cb57-270" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-271"><a href="#cb57-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-272"><a href="#cb57-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-273"><a href="#cb57-273" aria-hidden="true" tabindex="-1"></a>Note that we are not including the treatment arm here, but only the log growth rate estimates. </span>
<span id="cb57-274"><a href="#cb57-274" aria-hidden="true" tabindex="-1"></a>In addition, the covariates in the model include the ECOG score, age, race and sex. The idea is that the treatment effect is fully captured in the log growth rate estimates, which is referred to as "Working assumption (1)" in the slides.</span>
<span id="cb57-275"><a href="#cb57-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-276"><a href="#cb57-276" aria-hidden="true" tabindex="-1"></a>Now we can create the <span class="in">`JointData`</span> object for the OS model:</span>
<span id="cb57-277"><a href="#cb57-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-280"><a href="#cb57-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-281"><a href="#cb57-281" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_data_prep</span></span>
<span id="cb57-282"><a href="#cb57-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-283"><a href="#cb57-283" aria-hidden="true" tabindex="-1"></a>os_joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb57-284"><a href="#cb57-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb57-285"><a href="#cb57-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb57-286"><a href="#cb57-286" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-287"><a href="#cb57-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-288"><a href="#cb57-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-289"><a href="#cb57-289" aria-hidden="true" tabindex="-1"></a>We specify the Weibull model together with the priors for the model parameters. We take vague priors for the regression coefficients <span class="in">`beta`</span>. For <span class="in">`lambda`</span> and <span class="in">`gamma`</span>, we start from the scale of the survival data at hand: </span>
<span id="cb57-290"><a href="#cb57-290" aria-hidden="true" tabindex="-1"></a>the average survival time is <span class="in">`r round(mean(os_data_with_log_kg_est$os_time), 1)`</span> years, just taking a crude average of all survival times. </span>
<span id="cb57-291"><a href="#cb57-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-292"><a href="#cb57-292" aria-hidden="true" tabindex="-1"></a>We can quickly write the function that gives the mean of the Weibull distribution with fixed <span class="in">`lambda`</span> and <span class="in">`gamma`</span>:</span>
<span id="cb57-293"><a href="#cb57-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-296"><a href="#cb57-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-297"><a href="#cb57-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: weibull_mean</span></span>
<span id="cb57-298"><a href="#cb57-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-299"><a href="#cb57-299" aria-hidden="true" tabindex="-1"></a>weibull_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, gamma) {</span>
<span id="cb57-300"><a href="#cb57-300" aria-hidden="true" tabindex="-1"></a>    base<span class="sc">::</span><span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> gamma) <span class="sc">/</span> lambda</span>
<span id="cb57-301"><a href="#cb57-301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-302"><a href="#cb57-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-303"><a href="#cb57-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-304"><a href="#cb57-304" aria-hidden="true" tabindex="-1"></a>Therefore, playing around with this a bit, we can e.g. center the prior for <span class="in">`lambda`</span> around 0.7 and the prior for <span class="in">`gamma`</span> around 1.5, giving a mean survival time of <span class="in">`r round(weibull_mean(0.7, 1.5), 1)`</span> years.</span>
<span id="cb57-305"><a href="#cb57-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-306"><a href="#cb57-306" aria-hidden="true" tabindex="-1"></a>If we want to use Gamma distributions e.g. for <span class="in">`lambda`</span> and <span class="in">`gamma`</span>, we can use the <span class="in">`prior_gamma`</span> function. The two parameters of this distribution are the shape and the rate. The mean is shape divided by the rate. So easiest is to keep a rate of 1 and just set the shape to the mean value we need:</span>
<span id="cb57-307"><a href="#cb57-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-310"><a href="#cb57-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-311"><a href="#cb57-311" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod_spec</span></span>
<span id="cb57-312"><a href="#cb57-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-313"><a href="#cb57-313" aria-hidden="true" tabindex="-1"></a>os_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb57-314"><a href="#cb57-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb57-315"><a href="#cb57-315" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb57-316"><a href="#cb57-316" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb57-317"><a href="#cb57-317" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb57-318"><a href="#cb57-318" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-319"><a href="#cb57-319" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-320"><a href="#cb57-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-321"><a href="#cb57-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-322"><a href="#cb57-322" aria-hidden="true" tabindex="-1"></a>Because we use a large prior variance for <span class="in">`beta`</span>, we need to adjust the default initial value construction used in <span class="in">`jmpost`</span>. As explained <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/model_fitting.html#initial-values)</span>, we can change the shrinkage of the initial values to the mean. We can then check what the initial values will be, to make sure that they are reasonable:</span>
<span id="cb57-323"><a href="#cb57-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-326"><a href="#cb57-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-327"><a href="#cb57-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod_initial_values</span></span>
<span id="cb57-328"><a href="#cb57-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-329"><a href="#cb57-329" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.999</span>)</span>
<span id="cb57-330"><a href="#cb57-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-331"><a href="#cb57-331" aria-hidden="true" tabindex="-1"></a><span class="fu">initialValues</span>(os_mod, <span class="at">n_chains =</span> CHAINS)</span>
<span id="cb57-332"><a href="#cb57-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-333"><a href="#cb57-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-334"><a href="#cb57-334" aria-hidden="true" tabindex="-1"></a>So the values are now close to the means of the respective prior distributions. We can then see later if the chains were converging well. If not, we could as an alternative also manually set initial values, as explained <span class="co">[</span><span class="ot">here</span><span class="co">](https://genentech.github.io/jmpost/main/articles/quickstart.html#initial-values)</span>.</span>
<span id="cb57-335"><a href="#cb57-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-336"><a href="#cb57-336" aria-hidden="true" tabindex="-1"></a>Now we can fit the model:</span>
<span id="cb57-337"><a href="#cb57-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-340"><a href="#cb57-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-341"><a href="#cb57-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_model_fit</span></span>
<span id="cb57-342"><a href="#cb57-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-343"><a href="#cb57-343" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os1.rds"</span>)</span>
<span id="cb57-344"><a href="#cb57-344" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-345"><a href="#cb57-345" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb57-346"><a href="#cb57-346" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-347"><a href="#cb57-347" aria-hidden="true" tabindex="-1"></a>    os_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb57-348"><a href="#cb57-348" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb57-349"><a href="#cb57-349" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data,</span>
<span id="cb57-350"><a href="#cb57-350" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb57-351"><a href="#cb57-351" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb57-352"><a href="#cb57-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb57-353"><a href="#cb57-353" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb57-354"><a href="#cb57-354" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb57-355"><a href="#cb57-355" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb57-356"><a href="#cb57-356" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb57-357"><a href="#cb57-357" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-358"><a href="#cb57-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results, <span class="at">file =</span> save_file)</span>
<span id="cb57-359"><a href="#cb57-359" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-360"><a href="#cb57-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-361"><a href="#cb57-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-362"><a href="#cb57-362" aria-hidden="true" tabindex="-1"></a>Note that here we can get warnings at the beginning of the chains' sampling process ("The current Metropolis proposal is about to be rejected ..."). As long as this only happens in the beginning, and not during the sampling later, then this is not a cause for concern.</span>
<span id="cb57-363"><a href="#cb57-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-364"><a href="#cb57-364" aria-hidden="true" tabindex="-1"></a>Let's check the convergence of the population parameters:</span>
<span id="cb57-365"><a href="#cb57-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-368"><a href="#cb57-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-369"><a href="#cb57-369" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_convergence_os</span></span>
<span id="cb57-370"><a href="#cb57-370" aria-hidden="true" tabindex="-1"></a><span class="co">#| dependson: os_model_fit</span></span>
<span id="cb57-371"><a href="#cb57-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-372"><a href="#cb57-372" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb57-373"><a href="#cb57-373" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_os_cov"</span>,</span>
<span id="cb57-374"><a href="#cb57-374" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_gamma"</span>,</span>
<span id="cb57-375"><a href="#cb57-375" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sm_weibull_ph_lambda"</span></span>
<span id="cb57-376"><a href="#cb57-376" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-377"><a href="#cb57-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-378"><a href="#cb57-378" aria-hidden="true" tabindex="-1"></a>mcmc_os_results <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results)</span>
<span id="cb57-379"><a href="#cb57-379" aria-hidden="true" tabindex="-1"></a>mcmc_os_results<span class="sc">$</span><span class="fu">summary</span>(vars)</span>
<span id="cb57-380"><a href="#cb57-380" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">draws</span>(vars)</span>
<span id="cb57-381"><a href="#cb57-381" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_os_results)</span>
<span id="cb57-382"><a href="#cb57-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-383"><a href="#cb57-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-384"><a href="#cb57-384" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpret covariate effects</span></span>
<span id="cb57-385"><a href="#cb57-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-386"><a href="#cb57-386" aria-hidden="true" tabindex="-1"></a>In order to better see which of the coefficients relate to which covariates, we can rename them as follows:</span>
<span id="cb57-387"><a href="#cb57-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-390"><a href="#cb57-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-391"><a href="#cb57-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rename_os_cov_coefs</span></span>
<span id="cb57-392"><a href="#cb57-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-393"><a href="#cb57-393" aria-hidden="true" tabindex="-1"></a>surv_data_design <span class="ot">&lt;-</span> <span class="fu">as_stan_list</span>(surv_data)<span class="sc">$</span>os_cov_design</span>
<span id="cb57-394"><a href="#cb57-394" aria-hidden="true" tabindex="-1"></a>os_cov_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(surv_data_design)</span>
<span id="cb57-395"><a href="#cb57-395" aria-hidden="true" tabindex="-1"></a>old_coef_names <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"beta_os_cov[{seq_along(os_cov_names)}]"</span>)</span>
<span id="cb57-396"><a href="#cb57-396" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb57-397"><a href="#cb57-397" aria-hidden="true" tabindex="-1"></a>    rename_variables,</span>
<span id="cb57-398"><a href="#cb57-398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">list</span>(draws_os_results), <span class="fu">setNames</span>(old_coef_names, os_cov_names))</span>
<span id="cb57-399"><a href="#cb57-399" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-400"><a href="#cb57-400" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_dens_overlay</span>(draws_os_results) <span class="sc">+</span></span>
<span id="cb57-401"><a href="#cb57-401" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb57-402"><a href="#cb57-402" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(draws_os_results)</span>
<span id="cb57-403"><a href="#cb57-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-404"><a href="#cb57-404" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os_draws.rds"</span>)</span>
<span id="cb57-405"><a href="#cb57-405" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-406"><a href="#cb57-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(draws_os_results, <span class="at">file =</span> save_file)</span>
<span id="cb57-407"><a href="#cb57-407" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-408"><a href="#cb57-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-409"><a href="#cb57-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-410"><a href="#cb57-410" aria-hidden="true" tabindex="-1"></a>So we can see that the 90% credible interval (CI) for the <span class="in">`log_kg_est`</span> and <span class="in">`ecog1`</span> covariate coefficients excludes 0, so both are "significant" predictors of the hazard rate. On the other hand, the <span class="in">`race`</span> dummy variables' and the <span class="in">`age`</span> variable's coefficient CIs clearly include 0. The situation is less clear for <span class="in">`sex`</span>: here the CI barely includes 0. </span>
<span id="cb57-411"><a href="#cb57-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-412"><a href="#cb57-412" aria-hidden="true" tabindex="-1"></a>In addition, we can also look at the posterior probabilities to have a hazard ratio above 1:</span>
<span id="cb57-413"><a href="#cb57-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-416"><a href="#cb57-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-417"><a href="#cb57-417" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_ratios</span></span>
<span id="cb57-418"><a href="#cb57-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-419"><a href="#cb57-419" aria-hidden="true" tabindex="-1"></a>draws_os_results <span class="sc">|&gt;</span></span>
<span id="cb57-420"><a href="#cb57-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-421"><a href="#cb57-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise_all</span>(<span class="sc">~</span> <span class="fu">mean</span>(. <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb57-422"><a href="#cb57-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-423"><a href="#cb57-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-424"><a href="#cb57-424" aria-hidden="true" tabindex="-1"></a>So we have a more than 90% posterior probability that male patients have a higher hazard than females, and we also see a similarly strong effect here for the <span class="in">`OTHER`</span> category of <span class="in">`race`</span>. As we saw from the CI already, the <span class="in">`age`</span> effect is not so strong.</span>
<span id="cb57-425"><a href="#cb57-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-426"><a href="#cb57-426" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observation vs model fit</span></span>
<span id="cb57-427"><a href="#cb57-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-428"><a href="#cb57-428" aria-hidden="true" tabindex="-1"></a>A useful plot displays the model predicted survival function and overlays the non-parametric Kaplan-Meier plot to it. Such a plot is easily obtained using the <span class="in">`autoplot()`</span> function, as we will see below.</span>
<span id="cb57-429"><a href="#cb57-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-430"><a href="#cb57-430" aria-hidden="true" tabindex="-1"></a>The first step consists in generating the survival predictions at the group level with the <span class="in">`SurvivalQuantities()`</span> function. It is recommended to specify the sequence of time points at which the predictions should be made (using the argument <span class="in">`times`</span>):</span>
<span id="cb57-431"><a href="#cb57-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-434"><a href="#cb57-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-435"><a href="#cb57-435" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_surv_pred</span></span>
<span id="cb57-436"><a href="#cb57-436" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb57-437"><a href="#cb57-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> <span class="dv">0</span>,</span>
<span id="cb57-438"><a href="#cb57-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> <span class="fu">max</span>(os_data_with_log_kg_est<span class="sc">$</span>os_time),</span>
<span id="cb57-439"><a href="#cb57-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="dv">100</span></span>
<span id="cb57-440"><a href="#cb57-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-441"><a href="#cb57-441" aria-hidden="true" tabindex="-1"></a>os_surv_group_grid <span class="ot">&lt;-</span> <span class="fu">GridGrouped</span>(</span>
<span id="cb57-442"><a href="#cb57-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> time_grid,</span>
<span id="cb57-443"><a href="#cb57-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> <span class="fu">with</span>(</span>
<span id="cb57-444"><a href="#cb57-444" aria-hidden="true" tabindex="-1"></a>        subj_df,</span>
<span id="cb57-445"><a href="#cb57-445" aria-hidden="true" tabindex="-1"></a>        <span class="fu">split</span>(<span class="fu">as.character</span>(id), arm)</span>
<span id="cb57-446"><a href="#cb57-446" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-447"><a href="#cb57-447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-448"><a href="#cb57-448" aria-hidden="true" tabindex="-1"></a>os_surv_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-449"><a href="#cb57-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb57-450"><a href="#cb57-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb57-451"><a href="#cb57-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-452"><a href="#cb57-452" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-453"><a href="#cb57-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-454"><a href="#cb57-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-455"><a href="#cb57-455" aria-hidden="true" tabindex="-1"></a>Now we can use the <span class="in">`autoplot()`</span> method:</span>
<span id="cb57-456"><a href="#cb57-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-459"><a href="#cb57-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-460"><a href="#cb57-460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_surv_plot</span></span>
<span id="cb57-461"><a href="#cb57-461" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-462"><a href="#cb57-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-463"><a href="#cb57-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-464"><a href="#cb57-464" aria-hidden="true" tabindex="-1"></a>Here the fit seems ok but not perfect, especially for the Docetaxel arm it could be improved maybe. We will try below alternative models to see if we can improve the fit.</span>
<span id="cb57-465"><a href="#cb57-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-466"><a href="#cb57-466" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hazard and hazard rate estimation</span></span>
<span id="cb57-467"><a href="#cb57-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-468"><a href="#cb57-468" aria-hidden="true" tabindex="-1"></a>Similarly to the survival function estimation, we can also estimate the hazard function by treatment group.</span>
<span id="cb57-469"><a href="#cb57-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-472"><a href="#cb57-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-473"><a href="#cb57-473" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_pred</span></span>
<span id="cb57-474"><a href="#cb57-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-475"><a href="#cb57-475" aria-hidden="true" tabindex="-1"></a>os_hazard_pred <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-476"><a href="#cb57-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb57-477"><a href="#cb57-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb57-478"><a href="#cb57-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"haz"</span></span>
<span id="cb57-479"><a href="#cb57-479" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-480"><a href="#cb57-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-481"><a href="#cb57-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-482"><a href="#cb57-482" aria-hidden="true" tabindex="-1"></a>Also this can be plotted using the <span class="in">`autoplot()`</span> method:</span>
<span id="cb57-483"><a href="#cb57-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-486"><a href="#cb57-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-487"><a href="#cb57-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_hazard_plot</span></span>
<span id="cb57-488"><a href="#cb57-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-489"><a href="#cb57-489" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_hazard_pred, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-490"><a href="#cb57-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-491"><a href="#cb57-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-492"><a href="#cb57-492" aria-hidden="true" tabindex="-1"></a>Finally, we can also estimate the hazard rate, which is constant over time here - because we use the Weibull proportional hazards model. We still show this more complicated code here because it will also work later for joint TGI-OS models, where the hazard rate may not be constant any longer.</span>
<span id="cb57-493"><a href="#cb57-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-496"><a href="#cb57-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-497"><a href="#cb57-497" aria-hidden="true" tabindex="-1"></a>os_hr_est <span class="ot">&lt;-</span> os_hazard_pred <span class="sc">|&gt;</span></span>
<span id="cb57-498"><a href="#cb57-498" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-499"><a href="#cb57-499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group, time) <span class="sc">|&gt;</span></span>
<span id="cb57-500"><a href="#cb57-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb57-501"><a href="#cb57-501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> group, <span class="at">values_from =</span> values) <span class="sc">|&gt;</span></span>
<span id="cb57-502"><a href="#cb57-502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hr =</span> MPDL3280A <span class="sc">/</span> Docetaxel) <span class="sc">|&gt;</span></span>
<span id="cb57-503"><a href="#cb57-503" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb57-504"><a href="#cb57-504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb57-505"><a href="#cb57-505" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean =</span> <span class="fu">mean</span>(hr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-506"><a href="#cb57-506" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.05</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-507"><a href="#cb57-507" aria-hidden="true" tabindex="-1"></a>        <span class="at">upper =</span> <span class="fu">quantile</span>(hr, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-508"><a href="#cb57-508" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb57-509"><a href="#cb57-509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>() <span class="co"># Omit the time = 0 which has NA</span></span>
<span id="cb57-510"><a href="#cb57-510" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(os_hr_est)</span>
<span id="cb57-511"><a href="#cb57-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-512"><a href="#cb57-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-513"><a href="#cb57-513" aria-hidden="true" tabindex="-1"></a>Now we can plot this:</span>
<span id="cb57-514"><a href="#cb57-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-517"><a href="#cb57-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-518"><a href="#cb57-518" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(os_hr_est, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mean, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)) <span class="sc">+</span></span>
<span id="cb57-519"><a href="#cb57-519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb57-520"><a href="#cb57-520" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)</span>
<span id="cb57-521"><a href="#cb57-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-522"><a href="#cb57-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-523"><a href="#cb57-523" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alternative models</span></span>
<span id="cb57-524"><a href="#cb57-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-525"><a href="#cb57-525" aria-hidden="true" tabindex="-1"></a>Above we felt that maybe we could improve the fit of the model further. </span>
<span id="cb57-526"><a href="#cb57-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-527"><a href="#cb57-527" aria-hidden="true" tabindex="-1"></a>One idea is to add also the direct effect of the treatment arm as a covariate:</span>
<span id="cb57-528"><a href="#cb57-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-531"><a href="#cb57-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-532"><a href="#cb57-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod2_fit</span></span>
<span id="cb57-533"><a href="#cb57-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-534"><a href="#cb57-534" aria-hidden="true" tabindex="-1"></a>surv_data2 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb57-535"><a href="#cb57-535" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb57-536"><a href="#cb57-536" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we add the arm covariate:</span></span>
<span id="cb57-537"><a href="#cb57-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">+</span> arm)</span>
<span id="cb57-538"><a href="#cb57-538" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-539"><a href="#cb57-539" aria-hidden="true" tabindex="-1"></a>os_joint_data2 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb57-540"><a href="#cb57-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb57-541"><a href="#cb57-541" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data2</span>
<span id="cb57-542"><a href="#cb57-542" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-543"><a href="#cb57-543" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os2.rds"</span>)</span>
<span id="cb57-544"><a href="#cb57-544" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-545"><a href="#cb57-545" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb57-546"><a href="#cb57-546" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-547"><a href="#cb57-547" aria-hidden="true" tabindex="-1"></a>    os_results2 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb57-548"><a href="#cb57-548" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb57-549"><a href="#cb57-549" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data2,</span>
<span id="cb57-550"><a href="#cb57-550" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb57-551"><a href="#cb57-551" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb57-552"><a href="#cb57-552" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb57-553"><a href="#cb57-553" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb57-554"><a href="#cb57-554" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb57-555"><a href="#cb57-555" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb57-556"><a href="#cb57-556" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb57-557"><a href="#cb57-557" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-558"><a href="#cb57-558" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results2, <span class="at">file =</span> save_file)</span>
<span id="cb57-559"><a href="#cb57-559" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-560"><a href="#cb57-560" aria-hidden="true" tabindex="-1"></a>mcmc_os_results2 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results2)</span>
<span id="cb57-561"><a href="#cb57-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-562"><a href="#cb57-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-563"><a href="#cb57-563" aria-hidden="true" tabindex="-1"></a>We can easily plot the survival functions and compare them with the Kaplan-Meier curves of the treatment arms, because we can reuse the above <span class="in">`os_surv_group_grid`</span>:</span>
<span id="cb57-564"><a href="#cb57-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-567"><a href="#cb57-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-568"><a href="#cb57-568" aria-hidden="true" tabindex="-1"></a>os_surv_pred2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-569"><a href="#cb57-569" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb57-570"><a href="#cb57-570" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb57-571"><a href="#cb57-571" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-572"><a href="#cb57-572" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-573"><a href="#cb57-573" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred2, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-574"><a href="#cb57-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-575"><a href="#cb57-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-576"><a href="#cb57-576" aria-hidden="true" tabindex="-1"></a>Here we see a bit better "coverage" of the Docetaxel Kaplan-Meier curve by the confidence intervals of the model.</span>
<span id="cb57-577"><a href="#cb57-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-578"><a href="#cb57-578" aria-hidden="true" tabindex="-1"></a>We could also consider the model with only the direct treatment arm effect, without the log growth rate estimates:</span>
<span id="cb57-579"><a href="#cb57-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-582"><a href="#cb57-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-583"><a href="#cb57-583" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod3_fit</span></span>
<span id="cb57-584"><a href="#cb57-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-585"><a href="#cb57-585" aria-hidden="true" tabindex="-1"></a>surv_data3 <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb57-586"><a href="#cb57-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_with_log_kg_est,</span>
<span id="cb57-587"><a href="#cb57-587" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here we add the arm covariate:</span></span>
<span id="cb57-588"><a href="#cb57-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">update</span>(surv_data2<span class="sc">@</span>formula, . <span class="sc">~</span> . <span class="sc">-</span> log_kg_est)</span>
<span id="cb57-589"><a href="#cb57-589" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-590"><a href="#cb57-590" aria-hidden="true" tabindex="-1"></a>os_joint_data3 <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb57-591"><a href="#cb57-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb57-592"><a href="#cb57-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data3</span>
<span id="cb57-593"><a href="#cb57-593" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-594"><a href="#cb57-594" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-os/os3.rds"</span>)</span>
<span id="cb57-595"><a href="#cb57-595" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb57-596"><a href="#cb57-596" aria-hidden="true" tabindex="-1"></a>    os_results3 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb57-597"><a href="#cb57-597" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-598"><a href="#cb57-598" aria-hidden="true" tabindex="-1"></a>    os_results3 <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb57-599"><a href="#cb57-599" aria-hidden="true" tabindex="-1"></a>        os_mod,</span>
<span id="cb57-600"><a href="#cb57-600" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> os_joint_data3,</span>
<span id="cb57-601"><a href="#cb57-601" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb57-602"><a href="#cb57-602" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb57-603"><a href="#cb57-603" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb57-604"><a href="#cb57-604" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb57-605"><a href="#cb57-605" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb57-606"><a href="#cb57-606" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb57-607"><a href="#cb57-607" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb57-608"><a href="#cb57-608" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-609"><a href="#cb57-609" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(os_results3, <span class="at">file =</span> save_file)</span>
<span id="cb57-610"><a href="#cb57-610" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-611"><a href="#cb57-611" aria-hidden="true" tabindex="-1"></a>mcmc_os_results3 <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as.CmdStanMCMC</span>(os_results3)</span>
<span id="cb57-612"><a href="#cb57-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-613"><a href="#cb57-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-614"><a href="#cb57-614" aria-hidden="true" tabindex="-1"></a>Let's plot again the survival functions:</span>
<span id="cb57-615"><a href="#cb57-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-618"><a href="#cb57-618" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-619"><a href="#cb57-619" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: os_mod3_surv_pred</span></span>
<span id="cb57-620"><a href="#cb57-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-621"><a href="#cb57-621" aria-hidden="true" tabindex="-1"></a>os_surv_pred3 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-622"><a href="#cb57-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results3,</span>
<span id="cb57-623"><a href="#cb57-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> os_surv_group_grid,</span>
<span id="cb57-624"><a href="#cb57-624" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-625"><a href="#cb57-625" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-626"><a href="#cb57-626" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(os_surv_pred3, <span class="at">add_km =</span> <span class="cn">TRUE</span>, <span class="at">add_wrap =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-627"><a href="#cb57-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-628"><a href="#cb57-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-629"><a href="#cb57-629" aria-hidden="true" tabindex="-1"></a>This looks very similar to the previous model.</span>
<span id="cb57-630"><a href="#cb57-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-631"><a href="#cb57-631" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model comparison</span></span>
<span id="cb57-632"><a href="#cb57-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-633"><a href="#cb57-633" aria-hidden="true" tabindex="-1"></a>For comparing models, we can use more formal tools, as we will see now.</span>
<span id="cb57-634"><a href="#cb57-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-635"><a href="#cb57-635" aria-hidden="true" tabindex="-1"></a>We can use the <span class="co">[</span><span class="ot">Brier score</span><span class="co">](https://en.wikipedia.org/wiki/Brier_score)</span> to compare two different survival models. The Brier score is a measure of the mean squared difference between the predicted survival probability and the actual survival status. The lower the Brier score, the better the model.</span>
<span id="cb57-636"><a href="#cb57-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-637"><a href="#cb57-637" aria-hidden="true" tabindex="-1"></a>To calculate it, we need to use the <span class="in">`GridFixed`</span> input for <span class="in">`SurvivalQuantities()`</span>:</span>
<span id="cb57-638"><a href="#cb57-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-641"><a href="#cb57-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-642"><a href="#cb57-642" aria-hidden="true" tabindex="-1"></a>os_fixed_surv <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-643"><a href="#cb57-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results,</span>
<span id="cb57-644"><a href="#cb57-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb57-645"><a href="#cb57-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-646"><a href="#cb57-646" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-647"><a href="#cb57-647" aria-hidden="true" tabindex="-1"></a>os_mod1_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv)</span>
<span id="cb57-648"><a href="#cb57-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-649"><a href="#cb57-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-650"><a href="#cb57-650" aria-hidden="true" tabindex="-1"></a>We can also look at the LOOIC. As for the TGI model, we can use the <span class="in">`loo()`</span> method in the <span class="in">`CmdStanMCMC`</span> object to calculate it:</span>
<span id="cb57-651"><a href="#cb57-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-654"><a href="#cb57-654" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-655"><a href="#cb57-655" aria-hidden="true" tabindex="-1"></a>os_mod1_looic <span class="ot">&lt;-</span> mcmc_os_results<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-656"><a href="#cb57-656" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-657"><a href="#cb57-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-658"><a href="#cb57-658" aria-hidden="true" tabindex="-1"></a>Also for the two alternative models we can calculate the Brier score and LOOIC in the same way:</span>
<span id="cb57-659"><a href="#cb57-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-662"><a href="#cb57-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-663"><a href="#cb57-663" aria-hidden="true" tabindex="-1"></a>os_fixed_surv2 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-664"><a href="#cb57-664" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results2,</span>
<span id="cb57-665"><a href="#cb57-665" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb57-666"><a href="#cb57-666" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-667"><a href="#cb57-667" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-668"><a href="#cb57-668" aria-hidden="true" tabindex="-1"></a>os_mod2_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv2)</span>
<span id="cb57-669"><a href="#cb57-669" aria-hidden="true" tabindex="-1"></a>os_mod2_looic <span class="ot">&lt;-</span> mcmc_os_results2<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-670"><a href="#cb57-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-671"><a href="#cb57-671" aria-hidden="true" tabindex="-1"></a>os_fixed_surv3 <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb57-672"><a href="#cb57-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> os_results3,</span>
<span id="cb57-673"><a href="#cb57-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb57-674"><a href="#cb57-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb57-675"><a href="#cb57-675" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-676"><a href="#cb57-676" aria-hidden="true" tabindex="-1"></a>os_mod3_bs <span class="ot">&lt;-</span> <span class="fu">brierScore</span>(os_fixed_surv3)</span>
<span id="cb57-677"><a href="#cb57-677" aria-hidden="true" tabindex="-1"></a>os_mod3_looic <span class="ot">&lt;-</span> mcmc_os_results3<span class="sc">$</span><span class="fu">loo</span>(<span class="at">r_eff =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-678"><a href="#cb57-678" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-679"><a href="#cb57-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-680"><a href="#cb57-680" aria-hidden="true" tabindex="-1"></a>Of course in a real application with many models we can easily write a little function that does this for us repeatedly instead of just copy/pasting the code as we do here.</span>
<span id="cb57-681"><a href="#cb57-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-682"><a href="#cb57-682" aria-hidden="true" tabindex="-1"></a>Now we can compare the three models. </span>
<span id="cb57-683"><a href="#cb57-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-684"><a href="#cb57-684" aria-hidden="true" tabindex="-1"></a>Let's start with the LOOIC:</span>
<span id="cb57-685"><a href="#cb57-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-688"><a href="#cb57-688" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-689"><a href="#cb57-689" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_comparison</span></span>
<span id="cb57-690"><a href="#cb57-690" aria-hidden="true" tabindex="-1"></a>os_mod1_looic</span>
<span id="cb57-691"><a href="#cb57-691" aria-hidden="true" tabindex="-1"></a>os_mod2_looic</span>
<span id="cb57-692"><a href="#cb57-692" aria-hidden="true" tabindex="-1"></a>os_mod3_looic</span>
<span id="cb57-693"><a href="#cb57-693" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(os_mod1_looic, os_mod2_looic, os_mod3_looic)</span>
<span id="cb57-694"><a href="#cb57-694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-695"><a href="#cb57-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-696"><a href="#cb57-696" aria-hidden="true" tabindex="-1"></a>So we see that according to the LOOIC, the first model with just the <span class="in">`log_kg_est`</span> covariate is slightly better than the model with the additional <span class="in">`arm`</span> covariate. If we omit the <span class="in">`log_kg_est`</span> covariate altogether and only include the <span class="in">`arm`</span> covariate, then the model is worse than both of the other two models.</span>
<span id="cb57-697"><a href="#cb57-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-698"><a href="#cb57-698" aria-hidden="true" tabindex="-1"></a>We can plot the Brier scores:</span>
<span id="cb57-699"><a href="#cb57-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-702"><a href="#cb57-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-703"><a href="#cb57-703" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: brier_scores_plot</span></span>
<span id="cb57-704"><a href="#cb57-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-705"><a href="#cb57-705" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb57-706"><a href="#cb57-706" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time_grid,</span>
<span id="cb57-707"><a href="#cb57-707" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">1 - 2</span><span class="st">`</span> <span class="ot">=</span> os_mod1_bs <span class="sc">-</span> os_mod2_bs,</span>
<span id="cb57-708"><a href="#cb57-708" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">1 - 3</span><span class="st">`</span> <span class="ot">=</span> os_mod1_bs <span class="sc">-</span> os_mod3_bs,</span>
<span id="cb57-709"><a href="#cb57-709" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">2 - 3</span><span class="st">`</span> <span class="ot">=</span> os_mod2_bs <span class="sc">-</span> os_mod3_bs,</span>
<span id="cb57-710"><a href="#cb57-710" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb57-711"><a href="#cb57-711" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb57-712"><a href="#cb57-712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb57-713"><a href="#cb57-713" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"1 - 2"</span>, <span class="st">"1 - 3"</span>, <span class="st">"2 - 3"</span>),</span>
<span id="cb57-714"><a href="#cb57-714" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"diff"</span>,</span>
<span id="cb57-715"><a href="#cb57-715" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"brier_score_diff"</span></span>
<span id="cb57-716"><a href="#cb57-716" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb57-717"><a href="#cb57-717" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> brier_score_diff, <span class="at">color =</span> diff, <span class="at">group =</span> diff)) <span class="sc">+</span></span>
<span id="cb57-718"><a href="#cb57-718" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb57-719"><a href="#cb57-719" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Brier score difference"</span>) <span class="sc">+</span></span>
<span id="cb57-720"><a href="#cb57-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb57-721"><a href="#cb57-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-722"><a href="#cb57-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-723"><a href="#cb57-723" aria-hidden="true" tabindex="-1"></a>When we look at the difference model 1 minus model 2, we see that this is slightly positive. Since lower numbers of the Brier score are better, this means that model 2 is slightly better here. </span>
<span id="cb57-724"><a href="#cb57-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-725"><a href="#cb57-725" aria-hidden="true" tabindex="-1"></a>When we look at the difference model 1 minus model 3, we see that this is more clearly negative between times 0.25 and 1.75, meaning that model 1 is clearly better than model 3 there. Towards later times this reverses, and model 3 is better than model 1.</span>
<span id="cb57-726"><a href="#cb57-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-727"><a href="#cb57-727" aria-hidden="true" tabindex="-1"></a>The Brier score provides a more nuanced and time-dependent way of comparing the different OS models. Here we could either select model 1 due to its simplicity and almost same performance as model 2. </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-os/1_os_weibull_jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>