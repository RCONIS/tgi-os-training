<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Sabanés Bové">
<meta name="author" content="Francois Mercier">
<meta name="dcterms.date" content="2025-11-17">

<title>1. Calculate Bayesian Predictive Power – TGI-OS Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-fe572088fed4c8b78605e513f5ffbe45.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-pts/0_setup.html">Session 4: PTS</a></li><li class="breadcrumb-item"><a href="../session-pts/1_pts-jmpost.html">1. Calculate Bayesian Predictive Power</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      <div class="sidebar-tools-main">
    <a href="https://rconis.github.io/tgi-os-training/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contents</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 5: BHM</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-bhm/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-bhm/1_bhm-jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. Bayesian Hierarchical Joint Modeling for Historical Data Borrowing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 4: PTS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-pts/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-pts/1_pts-jmpost.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. Calculate Bayesian Predictive Power</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 3: TGI-OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-jm/1_jm-jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI-OS joint model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 2: OS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup and data preparation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/1_os_weibull_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. OS model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-os/2_os_weibull_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. OS model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Session 1: TGI</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">0. Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/1_tgi_sf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. TGI model minimal workflow with <code>brms</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/2_tgi_sf_jmpost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. TGI model minimal workflow with <code>jmpost</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/3_tgi_gsf_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Generalized Stein-Fojo model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session-tgi/4_tgi_cb_brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Claret-Bruno model</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-and-load-data" id="toc-setup-and-load-data" class="nav-link active" data-scroll-target="#setup-and-load-data">Setup and load data</a></li>
  <li><a href="#fit-our-joint-tgi-os-model" id="toc-fit-our-joint-tgi-os-model" class="nav-link" data-scroll-target="#fit-our-joint-tgi-os-model">Fit our joint TGI-OS model</a></li>
  <li><a href="#marginal-hazard-ratio-estimation" id="toc-marginal-hazard-ratio-estimation" class="nav-link" data-scroll-target="#marginal-hazard-ratio-estimation">Marginal Hazard Ratio Estimation</a></li>
  <li><a href="#comparison-with-simple-cox-ph-results" id="toc-comparison-with-simple-cox-ph-results" class="nav-link" data-scroll-target="#comparison-with-simple-cox-ph-results">Comparison with simple Cox PH results</a></li>
  <li><a href="#pts-based-on-frequentist-hr-properties" id="toc-pts-based-on-frequentist-hr-properties" class="nav-link" data-scroll-target="#pts-based-on-frequentist-hr-properties">PTS based on frequentist HR properties</a></li>
  <li><a href="#pts-based-on-frequentist-log-rank-test-properties" id="toc-pts-based-on-frequentist-log-rank-test-properties" class="nav-link" data-scroll-target="#pts-based-on-frequentist-log-rank-test-properties">PTS based on frequentist log-rank test properties</a></li>
  <li><a href="#individual-samples-based-predictive-power" id="toc-individual-samples-based-predictive-power" class="nav-link" data-scroll-target="#individual-samples-based-predictive-power">Individual Samples based Predictive Power</a>
  <ul class="collapse">
  <li><a href="#add-new-patients-and-generate-random-lost-to-follow-up-flag" id="toc-add-new-patients-and-generate-random-lost-to-follow-up-flag" class="nav-link" data-scroll-target="#add-new-patients-and-generate-random-lost-to-follow-up-flag">Add new patients and generate random lost-to-follow-up flag</a></li>
  <li><a href="#refit-the-joint-model-with-augmented-data" id="toc-refit-the-joint-model-with-augmented-data" class="nav-link" data-scroll-target="#refit-the-joint-model-with-augmented-data">Refit the joint model with augmented data</a></li>
  <li><a href="#individual-sampling-of-os-events" id="toc-individual-sampling-of-os-events" class="nav-link" data-scroll-target="#individual-sampling-of-os-events">Individual Sampling of OS events</a></li>
  <li><a href="#simplified-rcpp-implementation-for-single-patientsample" id="toc-simplified-rcpp-implementation-for-single-patientsample" class="nav-link" data-scroll-target="#simplified-rcpp-implementation-for-single-patientsample">Simplified Rcpp implementation for single patient/sample</a></li>
  <li><a href="#rcpp-implementation-for-all-patients-and-samples" id="toc-rcpp-implementation-for-all-patients-and-samples" class="nav-link" data-scroll-target="#rcpp-implementation-for-all-patients-and-samples">Rcpp implementation for all patients and samples</a></li>
  <li><a href="#generating-os-data-set-samples" id="toc-generating-os-data-set-samples" class="nav-link" data-scroll-target="#generating-os-data-set-samples">Generating OS data set samples</a></li>
  <li><a href="#calculate-log-rank-statistic-for-each-sampled-os-data-set" id="toc-calculate-log-rank-statistic-for-each-sampled-os-data-set" class="nav-link" data-scroll-target="#calculate-log-rank-statistic-for-each-sampled-os-data-set">Calculate log rank statistic for each sampled OS data set</a></li>
  <li><a href="#hazard-ratio-based-pts" id="toc-hazard-ratio-based-pts" class="nav-link" data-scroll-target="#hazard-ratio-based-pts">Hazard Ratio based PTS</a></li>
  <li><a href="#plot-kaplan-meier-curves-predictions" id="toc-plot-kaplan-meier-curves-predictions" class="nav-link" data-scroll-target="#plot-kaplan-meier-curves-predictions">Plot Kaplan-Meier curves predictions</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-pts/1_pts-jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../session-pts/0_setup.html">Session 4: PTS</a></li><li class="breadcrumb-item"><a href="../session-pts/1_pts-jmpost.html">1. Calculate Bayesian Predictive Power</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">1. Calculate Bayesian Predictive Power</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Sabanés Bové </p>
             <p>Francois Mercier </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-11-17</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this document is to show how we can calculate the probability of success given interim data of a clinical trial, based on the TGI-OS joint model results.</p>
<section id="setup-and-load-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-load-data">Setup and load data</h2>
<p>Here we execute the R code from the setup and data preparation chapter, see the <a href="../session-pts/0_setup.html">full code here</a>.</p>
</section>
<section id="fit-our-joint-tgi-os-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-our-joint-tgi-os-model">Fit our joint TGI-OS model</h2>
<p>Let’s fit again the same joint TGI-OS model as in the previous session. Now we just put all the code together in a single chunk, and it is a good repetition to see all the steps in one place:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>joint_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="fu">linkGrowth</span>(</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">prior =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.99</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co"># initialValues(joint_mod, n_chains = CHAINS)</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1.rds"</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        joint_mod,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> joint_data,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="marginal-hazard-ratio-estimation" class="level2">
<h2 class="anchored" data-anchor-id="marginal-hazard-ratio-estimation">Marginal Hazard Ratio Estimation</h2>
<p>First, we will try to apply the methodology from <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.8713">Oudenhoven et al (2020)</a> to estimate the marginal hazard ratio, using our joint model results. We use the new <code>jmpost</code> function called <code>populationHR()</code> for this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1hr.rds"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    pop_hr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    pop_hr <span class="ot">&lt;-</span> <span class="fu">populationHR</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        joint_results,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">hr_formula =</span> <span class="sc">~</span>arm</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(pop_hr, <span class="at">file =</span> save_file)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>pop_hr<span class="sc">$</span>summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          mean     median      X2.5.      X97.5.
bs(time, df = 10)1  -3.1898619 -3.1492166 -4.6595480 -1.94483471
bs(time, df = 10)2  -2.1685007 -2.1557204 -2.9129270 -1.44921371
bs(time, df = 10)3  -1.7541631 -1.7457712 -2.2606129 -1.27922919
bs(time, df = 10)4  -1.7402008 -1.7351076 -2.1929390 -1.32483535
bs(time, df = 10)5  -1.2832478 -1.2744974 -1.6118038 -0.99434352
bs(time, df = 10)6  -1.3567217 -1.3465337 -1.7256844 -1.02999961
bs(time, df = 10)7  -0.8752984 -0.8702259 -1.1870137 -0.60171732
bs(time, df = 10)8  -1.2314025 -1.2226766 -1.8595341 -0.71176107
bs(time, df = 10)9  -0.1212043 -0.1255963 -0.6237809  0.40773756
bs(time, df = 10)10 -0.5070327 -0.4897161 -1.1333247  0.02179326
armMPDL3280A        -0.2448721 -0.2361508 -0.5174069 -0.00558422</code></pre>
</div>
</div>
<p>So here we have the marginal log hazard ratio estimates of the baseline spline components and the treatment arm. Therefore we can get the hazard ratio estimates by exponentiating the log hazard ratio estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hr_est <span class="ot">&lt;-</span> pop_hr<span class="sc">$</span>summary[<span class="st">"armMPDL3280A"</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(exp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>So we get a marginal hazard ratio estimate of around 0.783 and a 95% credible interval of 0.6 - 0.99.</p>
</section>
<section id="comparison-with-simple-cox-ph-results" class="level2">
<h2 class="anchored" data-anchor-id="comparison-with-simple-cox-ph-results">Comparison with simple Cox PH results</h2>
<p>We can do a little sanity check by comparing this with a very simple Cox model:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cox_mod <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>(joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>formula, <span class="sc">~</span> . <span class="sc">+</span> arm),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_mod)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = update(joint_results@data@survival@formula, 
    ~. + arm), data = joint_results@data@survival@data)

  n= 203, number of events= 108 

                  coef exp(coef)  se(coef)      z Pr(&gt;|z|)   
ecog1         0.617895  1.855019  0.209174  2.954  0.00314 **
age           0.002656  1.002659  0.009982  0.266  0.79018   
raceOTHER     0.602237  1.826200  0.400528  1.504  0.13268   
raceWHITE     0.082344  1.085829  0.229687  0.359  0.71997   
sexM          0.297556  1.346563  0.201567  1.476  0.13989   
armMPDL3280A -0.330645  0.718460  0.198119 -1.669  0.09513 . 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

             exp(coef) exp(-coef) lower .95 upper .95
ecog1           1.8550     0.5391    1.2311     2.795
age             1.0027     0.9973    0.9832     1.022
raceOTHER       1.8262     0.5476    0.8329     4.004
raceWHITE       1.0858     0.9210    0.6922     1.703
sexM            1.3466     0.7426    0.9071     1.999
armMPDL3280A    0.7185     1.3919    0.4873     1.059

Concordance= 0.621  (se = 0.027 )
Likelihood ratio test= 14.6  on 6 df,   p=0.02
Wald test            = 14.34  on 6 df,   p=0.03
Score (logrank) test = 14.63  on 6 df,   p=0.02</code></pre>
</div>
</div>
<p>Here we get a different HR estimate of around 0.72, which is lower than the one we got from the joint model. We should expect different results because the joint model takes into account the TGI effect, while the Cox model does not.</p>
<p>And if we just put the treatment arm into the Cox model we get:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cox_mod_arm <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>(joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>formula, . <span class="sc">~</span> arm),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>cox_mod_arm</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = update(joint_results@data@survival@formula, 
    . ~ arm), data = joint_results@data@survival@data)

                coef exp(coef) se(coef)      z    p
armMPDL3280A -0.2414    0.7855   0.1928 -1.252 0.21

Likelihood ratio test=1.56  on 1 df, p=0.2109
n= 203, number of events= 108 </code></pre>
</div>
</div>
<p>Here we get a HR of 0.785 that is close to the marginal HR estimate above (when we did not condition on the other covariates), which is reassuring. On the other hand, the 95% confidence interval is:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">confint</span>(cox_mod_arm)[<span class="st">"armMPDL3280A"</span>, ])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5 %    97.5 % 
0.5383409 1.1461249 </code></pre>
</div>
</div>
<p>so actually overlaps the null hypothesis of 1. So we see that the joint model helped us to obtain a more precise estimate of the marginal hazard ratio.</p>
</section>
<section id="pts-based-on-frequentist-hr-properties" class="level2">
<h2 class="anchored" data-anchor-id="pts-based-on-frequentist-hr-properties">PTS based on frequentist HR properties</h2>
<p>From now on we pretend that the data we have analyzed so far is the interim data of the Oak trial, and we want to calculate the predictive power of the trial based on this interim data.</p>
<p>Let’s first try to use the log HR (<span class="math inline">\(\delta\)</span>) frequentist distribution to calculate the predictive power of the trial. We have:</p>
<p><span class="math display">\[
\hat{\delta}_{\text{fin}} \vert \hat{\delta}_{\text{int}}
\sim
\text{Normal}(\hat{\delta}_{\text{int}}, \sigma^2_{\text{int}})
\]</span></p>
<p>where the predictive variance is given by</p>
<p><span class="math display">\[
\sigma^2_{\text{int}} = \frac{1}{4\overline{p}r(1-r)} \frac{\overline{m}}{\overline{n} (\overline{n} + \overline{m})}
\]</span></p>
<p>On the other hand, assuming that we have observed the final data, then the variance estimate for the estimator <span class="math inline">\(\hat{\delta}_{\text{fin}}\)</span> is given by:</p>
<p><span class="math display">\[
\sigma^2_{\text{fin}} = \frac{1}{4\overline{p}r(1-r)} \frac{1}{\overline{n} + \overline{m}}
\]</span></p>
<p>So the <span class="math inline">\((1-\alpha)\)</span>-confidence interval for the final log HR is given by:</p>
<p><span class="math display">\[
\hat{\delta}_{\text{fin}} \pm z_{1 - \alpha/2} \sigma_{\text{fin}}
\]</span></p>
<p>and the null hypothesis is rejected if the upper bound of this confidence interval is below 0, i.e.&nbsp;if:</p>
<p><span class="math display">\[
\hat{\delta}_{\text{fin}} + z_{1 - \alpha/2} \sigma_{\text{fin}} &lt; 0.
\]</span></p>
<p>Now let’s again take the perspective that we are at the interim analysis and we want to calculate the predictive probability of this event, then:</p>
<p><span class="math display">\[
\begin{align*}
\mathbb{P}(\hat{\delta}_{\text{fin}} + z_{1 - \alpha/2} \sigma_{\text{fin}} &lt; 0)
&amp;=
\mathbb{P}(\hat{\delta}_{\text{fin}} &lt; - z_{1 - \alpha/2} \sigma_{\text{fin}}) \\
&amp;=
\mathbb{P}\left(
\frac{\hat{\delta}_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}} &lt;
\frac{- z_{1 - \alpha/2} \sigma_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}
\right) \\
&amp;=
\Phi\left(
  \frac{- z_{1 - \alpha/2} \sigma_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}
\right)
\end{align*}
\]</span></p>
<p>because the left-hand side is a standard normal variable according to our formula above. Let’s first write a little function to calculate this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pts_freq_hr <span class="ot">&lt;-</span> <span class="cf">function</span>(delta_int, var_int, var_final, <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    z_alpha <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    delta_final <span class="ot">&lt;-</span> <span class="sc">-</span>z_alpha <span class="sc">*</span> <span class="fu">sqrt</span>(var_final)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>((delta_final <span class="sc">-</span> delta_int) <span class="sc">/</span> <span class="fu">sqrt</span>(var_int))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For <span class="math inline">\(\hat{\delta}_{\text{int}}\)</span> we are going to plug in our MCMC samples for the marginal log HR <span class="math inline">\(\hat{\delta}_{\text{int}}\)</span> to compute the PTS based on this:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>log_hr_samples <span class="ot">&lt;-</span> pop_hr[[<span class="dv">2</span>]][<span class="st">"armMPDL3280A"</span>, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>But first we also need the quantities that go into the variance formula:</p>
<ul>
<li><span class="math inline">\(\overline{p}\)</span>: average event rate</li>
<li><span class="math inline">\(r\)</span>: proportion of patients in the treatment arm</li>
<li><span class="math inline">\(\overline{n}\)</span>: average arm size in interim data</li>
<li><span class="math inline">\(\overline{m}\)</span>: average arm size in follow up</li>
</ul>
<p>So let’s calculate these and the resulting variances:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>avg_event_rate <span class="ot">&lt;-</span> <span class="fu">mean</span>(os_data<span class="sc">$</span>os_event)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>prop_pts_treatment <span class="ot">&lt;-</span> <span class="fu">mean</span>(os_data<span class="sc">$</span>arm <span class="sc">==</span> <span class="st">"MPDL3280A"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>avg_arm_size_interim <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">table</span>(os_data<span class="sc">$</span>arm))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>total_size_final <span class="ot">&lt;-</span> <span class="dv">850</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>avg_arm_size_followup <span class="ot">&lt;-</span> (total_size_final <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> avg_arm_size_interim) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>var_int <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span> <span class="sc">*</span> avg_event_rate <span class="sc">*</span> prop_pts_treatment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prop_pts_treatment)) <span class="sc">*</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    avg_arm_size_followup <span class="sc">/</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    (avg_arm_size_interim <span class="sc">*</span> (avg_arm_size_interim <span class="sc">+</span> avg_arm_size_followup))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>var_final <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span> <span class="sc">*</span> avg_event_rate <span class="sc">*</span> prop_pts_treatment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prop_pts_treatment)) <span class="sc">*</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    (avg_arm_size_interim <span class="sc">+</span> avg_arm_size_followup)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we can calculate the PTS based on the frequentist HR properties:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>pts_freq_hr_result <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">pts_freq_hr</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_int =</span> log_hr_samples,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_int =</span> var_int,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_final =</span> var_final</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>pts_freq_hr_result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7318325</code></pre>
</div>
</div>
<p>So we obtain a PTS of 73.2% here.</p>
</section>
<section id="pts-based-on-frequentist-log-rank-test-properties" class="level2">
<h2 class="anchored" data-anchor-id="pts-based-on-frequentist-log-rank-test-properties">PTS based on frequentist log-rank test properties</h2>
<p>Now we want to leverage the <code>rpact</code> function <a href="https://rpact-com.github.io/rpact/reference/getConditionalPower.html"><code>getConditionalPower()</code></a> to calculate the predictive power of the trial based on the log-rank test statistic properties.</p>
<p>Looking at the function’s example, we first have to create a <code>DataSet</code> object with the interim data. Here it is important that we for <code>cumLogRanks</code> also the z scores from a Cox regression can be used, which means for our case that can insert here the z-scores defined as:</p>
<p><span class="math display">\[
z = \frac{\hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}
\]</span></p>
<p>values.</p>
<p>But let’s first try this with a simple fixed <span class="math inline">\(z\)</span> value to see how it works:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpact)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Installation qualification for rpact 4.2.1 has not yet been performed.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Please run testPackage() before using the package in GxP relevant environments.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fl">0.9</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(var_int) <span class="co"># Instead of log(0.9) we put later the marginal log HR MCMC sample</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">getDataset</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumEvents =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumLogRanks =</span> z,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumAllocationRatios =</span> prop_pts_treatment</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<p><em>Dataset of survival data</em></p>
<ul>
<li><em>Stages</em>: 1</li>
<li><em>Cumulative events</em>: 108</li>
<li><em>Cumulative allocation ratios</em>: 0.527</li>
<li><em>Cumulative log-ranks</em>: -0.886</li>
</ul>
<p><em>Calculated data</em></p>
<ul>
<li><em>Number of events</em>: 108</li>
<li><em>Allocation ratios</em>: 0.527093596059113</li>
<li><em>Log-ranks</em>: -0.886</li>
</ul>
</div>
</div>
<p>This is the data set from the first stage, i.e.&nbsp;our interim analysis.</p>
<p>Now we need to define the design of the group sequential trial:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>events_final <span class="ot">&lt;-</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">getDesignGroupSequential</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">kMax =</span> <span class="dv">2</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">informationRates =</span> <span class="fu">c</span>(<span class="fu">sum</span>(os_data<span class="sc">$</span>os_event) <span class="sc">/</span> events_final, <span class="dv">1</span>),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.05</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>design</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<p><em>Design parameters and output of group sequential design</em></p>
<p><em>User defined parameters</em></p>
<ul>
<li><em>Information rates</em>: 0.239, 1.000</li>
<li><em>Significance level</em>: 0.0500</li>
</ul>
<p><em>Derived from user defined parameters</em></p>
<ul>
<li><em>Maximum number of stages</em>: 2</li>
<li><em>Stages</em>: 1, 2</li>
<li><em>Futility bounds (non-binding)</em>: -Inf</li>
</ul>
<p><em>Default parameters</em></p>
<ul>
<li><em>Type of design</em>: O’Brien &amp; Fleming</li>
<li><em>Type II error rate</em>: 0.2000</li>
<li><em>Binding futility</em>: FALSE</li>
<li><em>Test</em>: one-sided</li>
<li><em>Tolerance</em>: 1e-08</li>
</ul>
<p><em>Output</em></p>
<ul>
<li><em>Cumulative alpha spending</em>: 0.000377, 0.050000</li>
<li><em>Critical values</em>: 3.369, 1.646</li>
<li><em>Stage levels (one-sided)</em>: 0.000377, 0.049833</li>
</ul>
</div>
</div>
<p>We see that the significance level is almost full for the final analysis, because by default the O’Brien &amp; Fleming design is used, which only assigns a very small <span class="math inline">\(\alpha\)</span> to the interim analysis. This is kind of what we need here.</p>
<p>Finally we put the <code>design</code> and <code>data</code> in a <code>StageResults</code> object, which is the input for the <code>getConditionalPower()</code> function:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>stageResults <span class="ot">&lt;-</span> <span class="fu">getStageResults</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">design =</span> design,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataInput =</span> data,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">stage =</span> <span class="dv">1</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">directionUpper =</span> <span class="cn">FALSE</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>condPower <span class="ot">&lt;-</span> <span class="fu">getConditionalPower</span>(</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">stageResults =</span> stageResults,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">thetaH1 =</span> <span class="fl">0.9</span>, <span class="co"># Here we put later the marginal hazard ratio MCMC sample</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPlanned =</span> total_size_final,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">allocationRatioPlanned =</span> <span class="dv">1</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(condPower)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Technical developer summary of the Conditional power results survival object ("ConditionalPowerResultsSurvival"):

  [u] Planned sample size              : NA, 850 
  [d] Planned allocation ratio         : 1 
  [.] %simulated%                      : FALSE 
  [g] Conditional power                : NA, 0.5577 
  [u] Assumed effect under alternative : 0.9 

Legend:
  u: user defined
  &gt;: derived value
  d: default value
  g: generated/calculated value
  .: not applicable or hidden

Conditional power results survival table:
     Planned sample size Conditional power
[1,]                  NA                NA
[2,]                 850         0.5576662</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>condPower<span class="sc">$</span>conditionalPower[<span class="dv">2</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5576662</code></pre>
</div>
</div>
<p>OK so now that we know how it works we wrap this in a little function again.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2 <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    delta_int,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    var_int,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    var_final,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    events_int,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    alloc_int,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    events_final,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">getDataset</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumEvents =</span> events_int,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumLogRanks =</span> delta_int <span class="sc">/</span> <span class="fu">sqrt</span>(var_int),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumAllocationRatios =</span> alloc_int</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    design <span class="ot">&lt;-</span> <span class="fu">getDesignGroupSequential</span>(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">kMax =</span> <span class="dv">2</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">informationRates =</span> <span class="fu">c</span>(events_int <span class="sc">/</span> events_final, <span class="dv">1</span>),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> alpha</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    stageResults <span class="ot">&lt;-</span> <span class="fu">getStageResults</span>(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">design =</span> design,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">dataInput =</span> data,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">stage =</span> <span class="dv">1</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">directionUpper =</span> <span class="cn">FALSE</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    condPower <span class="ot">&lt;-</span> <span class="fu">getConditionalPower</span>(</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">stageResults =</span> stageResults,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">thetaH1 =</span> <span class="fu">exp</span>(delta_int),</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">nPlanned =</span> total_size_final,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">allocationRatioPlanned =</span> <span class="dv">1</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    condPower<span class="sc">$</span>conditionalPower[<span class="dv">2</span>]</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s try it out with the same example first again:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pts_freq_hr2</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_int =</span> <span class="fu">log</span>(<span class="fl">0.9</span>),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_int =</span> var_int,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_final =</span> var_final,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">events_int =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alloc_int =</span> prop_pts_treatment,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">events_final =</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5576662</code></pre>
</div>
</div>
<p>OK so that gives the same result as before, which is good. Now we can plug in the MCMC samples for the marginal log HR:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1hr2.rds"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    pts_freq_hr2_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    pts_freq_hr2_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        log_hr_samples,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        pts_freq_hr2,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">var_int =</span> var_int,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">var_final =</span> var_final,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">events_int =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">alloc_int =</span> prop_pts_treatment,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">events_final =</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(pts_freq_hr2_samples, <span class="at">file =</span> save_file)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2_result <span class="ot">&lt;-</span> <span class="fu">mean</span>(pts_freq_hr2_samples)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2_result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8415316</code></pre>
</div>
</div>
<p>So here we get a PTS of 84.2%, which is higher than the one we got before.</p>
</section>
<section id="individual-samples-based-predictive-power" class="level2">
<h2 class="anchored" data-anchor-id="individual-samples-based-predictive-power">Individual Samples based Predictive Power</h2>
<p>This is a good motivation to try out the conditional sampling approach to calculate the predictive power, which is based on the individual samples of the joint model. It does not involved any frequentist assumptions to calculate the PTS.</p>
<p>We will perform the following steps in this algorithm:</p>
<ol type="1">
<li>We add as many new patients to the survival data set as we expect to still enter the trial.
<ul>
<li>These patients have survival time 0 and are censored at that time, which means they are completely new patients.</li>
</ul></li>
<li>We refit the joint model with this augmented data set. This simplifies the subsequent sampling process.</li>
<li>For each patient who is still being followed up for OS at IA (=does not have an event yet and did not drop out)
<ul>
<li>Obtain individual survival distribution MCMC samples over a long enough time grid</li>
<li>Condition on last observed censored OS time, sample once per MCMC sample from the conditional survival distribution</li>
</ul></li>
<li>Define “End of Study” time, e.g.&nbsp;based on number of events observed, calendar time, etc.</li>
<li>Apply summary statistic of interest to the complete “End of Study” OS data set samples and aggregate appropriately
<ul>
<li>For example, we can use the log-rank test statistic as summary statistic</li>
</ul></li>
<li>Calculate the proportion of samples that are above the critical value for the summary statistic, e.g.&nbsp;log-rank test statistic</li>
</ol>
<p>Note that for the first step, we need to add some random information to the data set, because unfortunately the real data does not differentiate between patients who are still being followed up and those who have dropped out.</p>
<section id="add-new-patients-and-generate-random-lost-to-follow-up-flag" class="level3">
<h3 class="anchored" data-anchor-id="add-new-patients-and-generate-random-lost-to-follow-up-flag">Add new patients and generate random lost-to-follow-up flag</h3>
<p>Basically for those patients with a censored survival time, we randomly assign a lost-to-follow-up flag with a probability of 10%, so that we can simulate some patients who are still being followed up and some who are not. We sample the covariates from the distribution of the already observed patients.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">689</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>lost_to_follow_up_flag <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">nrow</span>(os_data),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>os_data <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lost_to_follow_up =</span> <span class="sc">!</span>os_event <span class="sc">&amp;</span> lost_to_follow_up_flag)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>n_lost_to_follow_up <span class="ot">&lt;-</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>lost_to_follow_up)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>n_lost_to_follow_up</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">359</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>n_new_patients <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> avg_arm_size_followup</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>os_data_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(<span class="fu">as.integer</span>(<span class="fu">as.character</span>(os_data<span class="sc">$</span>id))) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">length.out =</span> n_new_patients),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Docetaxel"</span>, <span class="st">"MPDL3280A"</span>), <span class="fu">c</span>(<span class="fu">floor</span>(avg_arm_size_followup), <span class="fu">ceiling</span>(avg_arm_size_followup))),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">os_time =</span> <span class="dv">0</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">os_event =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lost_to_follow_up =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>ecog, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>age, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">race =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>race, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>sex, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>os_data_augmented <span class="ot">&lt;-</span> os_data[, <span class="fu">names</span>(os_data_new)] <span class="sc">|&gt;</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id)) <span class="sc">|&gt;</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(os_data_new) <span class="sc">|&gt;</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(id))</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>n_censored <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span>os_data_augmented<span class="sc">$</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>os_data_augmented<span class="sc">$</span>lost_to_follow_up)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>n_censored</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 732</code></pre>
</div>
</div>
<p>So now we have 10 patients who have been lost to follow-up and 732 patients who are still being followed up for OS (or who will still be entering the trial). These 732 patients will be the ones we will perform the individual sampling for.</p>
</section>
<section id="refit-the-joint-model-with-augmented-data" class="level3">
<h3 class="anchored" data-anchor-id="refit-the-joint-model-with-augmented-data">Refit the joint model with augmented data</h3>
<p>First we need to refit the joint model to this augmented data set. That is the easiest way to also get survival curve samples for the patients who are yet to be enrolled in the trial.</p>
<p>We notice that here we also need to add at least some random baseline samples to the longitudinal data set, otherwise it does not work.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>subj_aug_df <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>subj_aug_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_aug_df,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>new_long_df <span class="ot">&lt;-</span> os_data_new <span class="sc">|&gt;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, os_time) <span class="sc">|&gt;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">year =</span> os_time) <span class="sc">|&gt;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sld =</span> <span class="fu">sample</span>(tumor_data<span class="sc">$</span>sld, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>long_aug_df <span class="ot">&lt;-</span> long_df <span class="sc">|&gt;</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id)) <span class="sc">|&gt;</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(new_long_df) <span class="sc">|&gt;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(id))</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">identical</span>(<span class="fu">levels</span>(long_aug_df<span class="sc">$</span>id), <span class="fu">levels</span>(subj_aug_df<span class="sc">$</span>id)))</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>long_aug_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_aug_df,</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>surv_aug_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_augmented,</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>joint_aug_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_aug_data,</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_aug_data,</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_aug_data</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm2.rds"</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    joint_aug_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    joint_aug_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        joint_mod,</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> joint_aug_data,</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(joint_aug_results, <span class="at">file =</span> save_file)</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="individual-sampling-of-os-events" class="level3">
<h3 class="anchored" data-anchor-id="individual-sampling-of-os-events">Individual Sampling of OS events</h3>
<p>Now we can perform the individual sampling of the OS events for the patients who are still being followed up. Let’s start with a single patient:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>patient_id <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>lost_to_follow_up) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>So for this patient 588, we can extract the individual survival distribution MCMC samples from the joint model results along a time grid that extrapolates long enough into the future, say 10 years after the last observed OS time:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>length_time_grid <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>time_grid_end <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(os_data_augmented<span class="sc">$</span>os_time) <span class="sc">+</span> <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, time_grid_end, <span class="at">length =</span> length_time_grid)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm2_surv_samples.rds"</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">object =</span> joint_aug_results,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_surv_samples, <span class="at">file =</span> save_file)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>os_surv_samples_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(os_surv_samples)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>os_surv_samples_patient <span class="ot">&lt;-</span> os_surv_samples_df <span class="sc">|&gt;</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> patient_id) <span class="sc">|&gt;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>group) <span class="sc">|&gt;</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>ITER, length_time_grid))</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_surv_samples_patient)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now let’s zoom in on the first sampled survival curve of this patient, where we show also the last observed OS time as a vertical dashed line:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>first_surv_sample <span class="ot">&lt;-</span> os_surv_samples_patient <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample_id <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>patient_last_os_time <span class="ot">&lt;-</span> os_data_augmented<span class="sc">$</span>os_time[os_data_augmented<span class="sc">$</span>id <span class="sc">==</span> patient_id]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>first_surv_sample_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(first_surv_sample, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Individual Survival Curve for Patient"</span>, patient_id),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Survival Probability"</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> patient_last_os_time,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>first_surv_sample_plot</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/plot_individual_survival_curve-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As described in the slides, we can now sample a survival time for this patient from the conditional survival distribution, given the last observed OS time, by:</p>
<ol type="1">
<li>Drawing a standard uniform random number <span class="math inline">\(p \sim U(0, 1)\)</span></li>
<li>Finding the time <span class="math inline">\(t\)</span> such that <span class="math inline">\((1-p)S(c) - S(t) = 0\)</span> where $c = 2.1 is the last observed OS time</li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear approximation function for the survival function:</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>surv_approx <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> first_surv_sample<span class="sc">$</span>time,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> first_surv_sample<span class="sc">$</span>values,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">rule =</span> <span class="dv">2</span> <span class="co"># extrapolation outside interval via closest data extreme</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival function value at the time of censoring:</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>surv_at_censoring <span class="ot">&lt;-</span> <span class="fu">surv_approx</span>(patient_last_os_time)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the time t such that (1-p) * S(c) - S(t) = 0:</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(t) (<span class="dv">1</span> <span class="sc">-</span> p) <span class="sc">*</span> surv_at_censoring <span class="sc">-</span> <span class="fu">surv_approx</span>(t),</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>, time_grid_end)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span>root</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>t</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.819322</code></pre>
</div>
</div>
<p>We can plot the conditional survival function together with this sampled survival time:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>first_surv_sample <span class="ot">&lt;-</span> first_surv_sample <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">cond_values =</span> <span class="fu">ifelse</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>            time <span class="sc">&lt;=</span> patient_last_os_time,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>            values <span class="sc">/</span> surv_at_censoring</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    first_surv_sample,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> cond_values)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Individual Conditional Survival Curve for Patient"</span>,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>            patient_id</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Survival Probability"</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> patient_last_os_time,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> t,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">yintercept =</span> <span class="dv">1</span> <span class="sc">-</span> p,</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">t =</span> t, <span class="at">p =</span> p),</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> p),</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The challenge is now to do this efficiently for all patients who are still being followed up for OS, and for all of their MCMC samples.</p>
</section>
<section id="simplified-rcpp-implementation-for-single-patientsample" class="level3">
<h3 class="anchored" data-anchor-id="simplified-rcpp-implementation-for-single-patientsample">Simplified Rcpp implementation for single patient/sample</h3>
<p>For now, let’s create a simpler <code>Rcpp</code> function that handles a single patient’s single MCMC sample:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Rcpp function for single patient, single sample.</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="fu">here</span>(<span class="st">"session-pts/conditional_sampling.cpp"</span>))</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function with a simple example.</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3453</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>t_cpp_simple <span class="ot">&lt;-</span> <span class="fu">sample_single_conditional_survival_time</span>(</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> first_surv_sample<span class="sc">$</span>time,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> first_surv_sample<span class="sc">$</span>values,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_time =</span> patient_last_os_time</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot <span class="sc">+</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">data.frame</span>(</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">t =</span> t_cpp_simple<span class="sc">$</span>t_result,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">p =</span> t_cpp_simple<span class="sc">$</span>uniform_sample</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> p),</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/simple_rcpp_conditional_sampling-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="rcpp-implementation-for-all-patients-and-samples" class="level3">
<h3 class="anchored" data-anchor-id="rcpp-implementation-for-all-patients-and-samples">Rcpp implementation for all patients and samples</h3>
<p>Let’s use the second <code>Rcpp</code> function that handles all patients and all MCMC samples at once. We just need to prepare the data in the right format:</p>
<ul>
<li>The first argument is the time grid, which we already have.</li>
<li>The second argument is a matrix of survival values, where each row is a sample/patient combination and each column is a time point.</li>
<li>The third argument is a vector of censoring times, where each element corresponds to a sample/patient combination.</li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First subset to the patients where we need to sample from the conditional survival distribution.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>pt_to_sample <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>lost_to_follow_up)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>pt_to_sample_ids <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>id</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> os_surv_samples<span class="sc">@</span>quantities</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>include_qs <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups <span class="sc">%in%</span> pt_to_sample_ids</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>qs_samples <span class="ot">&lt;-</span> qs<span class="sc">@</span>quantities[, include_qs]</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>qs_times <span class="ot">&lt;-</span> qs<span class="sc">@</span>times[include_qs]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>qs_groups <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups[include_qs]</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>surv_values_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    qs_samples,</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER <span class="sc">*</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> length_time_grid</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(surv_values_samples)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 732000    100</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>surv_values_pt_ids <span class="ot">&lt;-</span> <span class="fu">rep</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">each =</span> ITER</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>censoring_times <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>os_time[<span class="fu">match</span>(</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    surv_values_pt_ids,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(censoring_times)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 732000</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>cond_surv_time_samples <span class="ot">&lt;-</span> <span class="fu">sample_conditional_survival_times</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> time_grid,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> surv_values_samples,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_times =</span> censoring_times</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(cond_surv_time_samples<span class="sc">$</span>beyond_max_time)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003687158</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cond_surv_time_samples<span class="sc">$</span>t_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
1.170e-05 9.700e-01 1.793e+00 2.221e+00 2.889e+00 1.230e+01 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(cond_surv_time_samples<span class="sc">$</span>uniform_samples)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/rcpp_conditional_sampling_all-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>os_cond_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    cond_surv_time_samples<span class="sc">$</span>t_results,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">seq_len</span>(ITER), <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>So this function is very fast, and in this case we have less than 1% of the samples where we did not have a long enough time grid, which seems sufficient for our purposes.</p>
</section>
<section id="generating-os-data-set-samples" class="level3">
<h3 class="anchored" data-anchor-id="generating-os-data-set-samples">Generating OS data set samples</h3>
<p>Now that we have the OS events for the patients who are still being followed up, we can generate the complete OS data set samples for each MCMC sample.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Where do we need to replace the OS times?</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>os_rows_to_replace <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    os_data_augmented<span class="sc">$</span>id</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># From which column do we take the sampled OS times?</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>os_cond_samples_cols <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(os_cond_samples)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>os_data_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="cf">function</span>(i) {</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the original OS data</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    os_data_sample <span class="ot">&lt;-</span> os_data_augmented[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"arm"</span>, <span class="st">"os_time"</span>, <span class="st">"os_event"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"ecog"</span>, <span class="st">"age"</span>)]</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the sampled OS times for the patients who are still being followed up.</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_time[os_rows_to_replace] <span class="ot">&lt;-</span> os_cond_samples[</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>        os_cond_samples_cols</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the OS event to TRUE for those patients, because we assume they have an event now.</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_event[os_rows_to_replace] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    os_data_sample</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="calculate-log-rank-statistic-for-each-sampled-os-data-set" class="level3">
<h3 class="anchored" data-anchor-id="calculate-log-rank-statistic-for-each-sampled-os-data-set">Calculate log rank statistic for each sampled OS data set</h3>
<p>Now it is easy to calculate the log-rank test statistic for each sampled OS data set. Here we don’t adjust for any covariates.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>log_rank_stats_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    surv_diff <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survdiff</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    surv_diff<span class="sc">$</span>chisq</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>log_rank_stats <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, log_rank_stats_fun)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(log_rank_stats)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>log_rank_at_ia <span class="ot">&lt;-</span> <span class="fu">log_rank_stats_fun</span>(os_data_augmented)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>log_rank_at_ia</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.584927</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> log_rank_at_ia, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>critical_value <span class="ot">&lt;-</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="at">df =</span> <span class="dv">1</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> critical_value, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/calculate_log_rank_statistic-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And using the critical value of the log-rank test statistic for a significance level of 0.05, we can calculate the PTS:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>pts_log_rank <span class="ot">&lt;-</span> <span class="fu">mean</span>(log_rank_stats <span class="sc">&gt;</span> critical_value)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>pts_log_rank</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.693</code></pre>
</div>
</div>
<p>So we see that this PTS with 69.3% is a bit lower than the previous PTS estimates.</p>
</section>
<section id="hazard-ratio-based-pts" class="level3">
<h3 class="anchored" data-anchor-id="hazard-ratio-based-pts">Hazard Ratio based PTS</h3>
<p>We can also calculate the PTS in an analogous way using the hazard ratio estimates:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>hr_pval_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    cox_mod <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm <span class="sc">+</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(cox_mod)<span class="sc">$</span>coefficients[<span class="dv">1</span>, <span class="dv">5</span>]</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>hr_pvals <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, hr_pval_fun)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>pts_hr <span class="ot">&lt;-</span> <span class="fu">mean</span>(hr_pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>pts_hr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.828</code></pre>
</div>
</div>
<p>In this PTS estimate we can adjust for the covariates. We see that the result of 82.8% is in line with the frequentist based PTS estimate for the HR which we calculated earlier.</p>
</section>
<section id="plot-kaplan-meier-curves-predictions" class="level3">
<h3 class="anchored" data-anchor-id="plot-kaplan-meier-curves-predictions">Plot Kaplan-Meier curves predictions</h3>
<p>Similarly we can extract the Kaplan-Meier curves for each sampled OS data set and plot them:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>km_curves <span class="ot">&lt;-</span> <span class="fu">lapply</span>(os_data_samples, <span class="cf">function</span>(df) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    survfit_obj <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> df)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    times <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>time</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    surv_probs <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>surv</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>strata</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    n_control <span class="ot">&lt;-</span> strata[<span class="dv">1</span>]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    n_treatment <span class="ot">&lt;-</span> strata[<span class="dv">2</span>]</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    control_fun <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        times[<span class="dv">1</span><span class="sc">:</span>n_control],</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">1</span>, surv_probs[<span class="dv">1</span><span class="sc">:</span>n_control]),</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> <span class="cn">TRUE</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    treatment_fun <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>        times[(n_control <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(times)],</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">1</span>, surv_probs[(n_control <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(surv_probs)]),</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> <span class="cn">TRUE</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    control_vals <span class="ot">&lt;-</span> <span class="fu">control_fun</span>(time_grid)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    treatment_vals <span class="ot">&lt;-</span> <span class="fu">treatment_fun</span>(time_grid)</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">control =</span> control_vals, <span class="at">treatment =</span> treatment_vals)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>km_control_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(km_curves, <span class="cf">function</span>(x) x<span class="sc">$</span>control)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>km_treatment_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(km_curves, <span class="cf">function</span>(x) x<span class="sc">$</span>treatment)</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>survfit_ia <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> os_data_augmented)</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(survfit_ia, <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(time_grid)))</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the mean KM curves for each arm.</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(time_grid, <span class="fu">rowMeans</span>(km_control_samples), <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(time_grid, <span class="fu">rowMeans</span>(km_treatment_samples), <span class="at">col =</span> <span class="dv">2</span>)</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Add pointwise confidence intervals as shaded areas.</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>km_control_ci <span class="ot">&lt;-</span> <span class="fu">apply</span>(km_control_samples, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>km_treatment_ci <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>    km_treatment_samples,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>    quantile,</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(time_grid, <span class="fu">rev</span>(time_grid)),</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(km_control_ci[<span class="dv">1</span>, ], <span class="fu">rev</span>(km_control_ci[<span class="dv">2</span>, ])),</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="dv">1</span>, <span class="at">alpha.f =</span> <span class="fl">0.2</span>),</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(</span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(time_grid, <span class="fu">rev</span>(time_grid)),</span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(km_treatment_ci[<span class="dv">1</span>, ], <span class="fu">rev</span>(km_treatment_ci[<span class="dv">2</span>, ])),</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="dv">2</span>, <span class="at">alpha.f =</span> <span class="fl">0.2</span>),</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1_pts-jmpost_files/figure-html/plot_kaplan_meier_curves-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that we assume a very long follow up of the data here. Obviously we could cut the data sets at a certain number of events or a specific time point easily.</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "1. Calculate Bayesian Predictive Power"</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Daniel Sabanés Bové</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - Francois Mercier</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> last-modified</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: inline</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: mathjax</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="an">cache:</span><span class="co"> true</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>The purpose of this document is to show how we can calculate the probability of success given interim data of a clinical trial, based on the TGI-OS joint model results.</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and load data</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>Here we execute the R code from the setup and data preparation chapter, see the <span class="co">[</span><span class="ot">full code here</span><span class="co">](0_setup.qmd)</span>.</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup_and_load_data</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.duplicate.label =</span> <span class="st">"allow"</span>)</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-pts/_setup.qmd"</span>),</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-pts/_setup.R"</span>)</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-pts/_setup.R"</span>))</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">purl</span>(</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"session-pts/_load_data.qmd"</span>),</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="fu">here</span>(<span class="st">"session-pts/_load_data.R"</span>)</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"session-pts/_load_data.R"</span>))</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit our joint TGI-OS model</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>Let's fit again the same joint TGI-OS model as in the previous session. Now we just put all the code together in a single chunk, and it is a good repetition to see all the steps in one place:</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit_joint_model</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>subj_df <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>subj_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_df,</span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>long_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_df,</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>surv_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data,</span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>joint_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_data,</span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_data,</span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_data</span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>joint_mod <span class="ot">&lt;-</span> <span class="fu">JointModel</span>(</span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> <span class="fu">LongitudinalSteinFojo</span>(</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_bsld =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="dv">65</span>), <span class="dv">1</span>),</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_ks =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">0.52</span>), <span class="dv">1</span>),</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>        <span class="at">mu_kg =</span> <span class="fu">prior_normal</span>(<span class="fu">log</span>(<span class="fl">1.04</span>), <span class="dv">1</span>),</span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_bsld =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_ks =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">omega_kg =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>),</span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">sigma =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">set_limits</span>(<span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> <span class="fu">SurvivalWeibullPH</span>(</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="fu">prior_gamma</span>(<span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">gamma =</span> <span class="fu">prior_gamma</span>(<span class="fl">1.5</span>, <span class="dv">1</span>),</span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">beta =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="fu">linkGrowth</span>(</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">prior =</span> <span class="fu">prior_normal</span>(<span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"jmpost.prior_shrinkage"</span> <span class="ot">=</span> <span class="fl">0.99</span>)</span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a><span class="co"># initialValues(joint_mod, n_chains = CHAINS)</span></span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1.rds"</span>)</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>    joint_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>    joint_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>        joint_mod,</span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> joint_data,</span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(joint_results, <span class="at">file =</span> save_file)</span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal Hazard Ratio Estimation</span></span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>First, we will try to apply the methodology from <span class="co">[</span><span class="ot">Oudenhoven et al (2020)</span><span class="co">](https://onlinelibrary.wiley.com/doi/10.1002/sim.8713)</span> to estimate the marginal hazard ratio, using our joint model results.</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>We use the new <span class="in">`jmpost`</span> function called <span class="in">`populationHR()`</span> for this:</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_marginal_hr</span></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1hr.rds"</span>)</span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>    pop_hr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>    pop_hr <span class="ot">&lt;-</span> <span class="fu">populationHR</span>(</span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>        joint_results,</span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">hr_formula =</span> <span class="sc">~</span>arm</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(pop_hr, <span class="at">file =</span> save_file)</span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>pop_hr<span class="sc">$</span>summary</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>So here we have the marginal log hazard ratio estimates of the baseline spline components and the treatment arm.</span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>Therefore we can get the hazard ratio estimates by exponentiating the log hazard ratio estimates:</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: exponentiate_hr_estimates</span></span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>hr_est <span class="ot">&lt;-</span> pop_hr<span class="sc">$</span>summary[<span class="st">"armMPDL3280A"</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(exp)</span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>So we get a marginal hazard ratio estimate of around <span class="in">`r round(hr_est["mean"], 3)`</span> and a 95% credible interval of <span class="in">`r paste0(signif(hr_est[c("X2.5.", "X97.5.")], 2), collapse = " - ")`</span>. </span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison with simple Cox PH results</span></span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>We can do a little sanity check by comparing this with a very simple Cox model:</span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox_model_comparison</span></span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>cox_mod <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>(joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>formula, <span class="sc">~</span> . <span class="sc">+</span> arm),</span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data</span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_mod)</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>Here we get a different HR estimate of around <span class="in">`r round(exp(coef(cox_mod)["armMPDL3280A"]), 2)`</span>, which is lower than the one we got from the joint model. </span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>We should expect different results because the joint model takes into account the TGI effect, while the Cox model does not.</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>And if we just put the treatment arm into the Cox model we get:</span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox_model_arm_only</span></span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>cox_mod_arm <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update</span>(joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>formula, . <span class="sc">~</span> arm),</span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> joint_results<span class="sc">@</span>data<span class="sc">@</span>survival<span class="sc">@</span>data</span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>cox_mod_arm</span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>Here we get a HR of <span class="in">`r round(exp(coef(cox_mod_arm)["armMPDL3280A"]), 3)`</span> that is close to the marginal HR estimate above (when we did not condition on the other covariates), which is reassuring.</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a>On the other hand, the 95% confidence interval is:</span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox_confidence_interval</span></span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">confint</span>(cox_mod_arm)[<span class="st">"armMPDL3280A"</span>, ])</span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a>so actually overlaps the null hypothesis of 1. So we see that the joint model helped us to obtain a more precise estimate of the marginal hazard ratio.</span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a><span class="fu">## PTS based on frequentist HR properties</span></span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-200"><a href="#cb61-200" aria-hidden="true" tabindex="-1"></a>From now on we pretend that the data we have analyzed so far is the interim data of the Oak trial, and we want to calculate the predictive power of the trial based on this interim data.</span>
<span id="cb61-201"><a href="#cb61-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a>Let's first try to use the log HR ($\delta$) frequentist distribution to calculate the predictive power of the trial. We have:</span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{\text{fin}} \vert \hat{\delta}_{\text{int}} </span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a>\sim</span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a>\text{Normal}(\hat{\delta}_{\text{int}}, \sigma^2_{\text{int}}) </span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>where the predictive variance is given by</span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a>\sigma^2_{\text{int}} = \frac{1}{4\overline{p}r(1-r)} \frac{\overline{m}}{\overline{n} (\overline{n} + \overline{m})}</span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a>On the other hand, assuming that we have observed the final data, then the variance estimate for the estimator $\hat{\delta}_{\text{fin}}$ is given by:</span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a>\sigma^2_{\text{fin}} = \frac{1}{4\overline{p}r(1-r)} \frac{1}{\overline{n} + \overline{m}}</span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a>So the $(1-\alpha)$-confidence interval for the final log HR is given by:</span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-224"><a href="#cb61-224" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-225"><a href="#cb61-225" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{\text{fin}} \pm z_{1 - \alpha/2} \sigma_{\text{fin}}</span>
<span id="cb61-226"><a href="#cb61-226" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-227"><a href="#cb61-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-228"><a href="#cb61-228" aria-hidden="true" tabindex="-1"></a>and the null hypothesis is rejected if the upper bound of this confidence interval is below 0, i.e. if:</span>
<span id="cb61-229"><a href="#cb61-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-230"><a href="#cb61-230" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-231"><a href="#cb61-231" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{\text{fin}} + z_{1 - \alpha/2} \sigma_{\text{fin}} &lt; 0.</span>
<span id="cb61-232"><a href="#cb61-232" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-233"><a href="#cb61-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-234"><a href="#cb61-234" aria-hidden="true" tabindex="-1"></a>Now let's again take the perspective that we are at the interim analysis and we want to calculate the predictive probability of this event, then:</span>
<span id="cb61-235"><a href="#cb61-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-236"><a href="#cb61-236" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-237"><a href="#cb61-237" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb61-238"><a href="#cb61-238" aria-hidden="true" tabindex="-1"></a>\mathbb{P}(\hat{\delta}_{\text{fin}} + z_{1 - \alpha/2} \sigma_{\text{fin}} &lt; 0)</span>
<span id="cb61-239"><a href="#cb61-239" aria-hidden="true" tabindex="-1"></a>&amp;= </span>
<span id="cb61-240"><a href="#cb61-240" aria-hidden="true" tabindex="-1"></a>\mathbb{P}(\hat{\delta}_{\text{fin}} &lt; - z_{1 - \alpha/2} \sigma_{\text{fin}}) <span class="sc">\\</span></span>
<span id="cb61-241"><a href="#cb61-241" aria-hidden="true" tabindex="-1"></a>&amp;= </span>
<span id="cb61-242"><a href="#cb61-242" aria-hidden="true" tabindex="-1"></a>\mathbb{P}\left(</span>
<span id="cb61-243"><a href="#cb61-243" aria-hidden="true" tabindex="-1"></a>\frac{\hat{\delta}_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}} &lt;</span>
<span id="cb61-244"><a href="#cb61-244" aria-hidden="true" tabindex="-1"></a>\frac{- z_{1 - \alpha/2} \sigma_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}</span>
<span id="cb61-245"><a href="#cb61-245" aria-hidden="true" tabindex="-1"></a>\right) <span class="sc">\\</span></span>
<span id="cb61-246"><a href="#cb61-246" aria-hidden="true" tabindex="-1"></a>&amp;= </span>
<span id="cb61-247"><a href="#cb61-247" aria-hidden="true" tabindex="-1"></a>\Phi\left(</span>
<span id="cb61-248"><a href="#cb61-248" aria-hidden="true" tabindex="-1"></a>  \frac{- z_{1 - \alpha/2} \sigma_{\text{fin}} - \hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}</span>
<span id="cb61-249"><a href="#cb61-249" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb61-250"><a href="#cb61-250" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb61-251"><a href="#cb61-251" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-252"><a href="#cb61-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-253"><a href="#cb61-253" aria-hidden="true" tabindex="-1"></a>because the left-hand side is a standard normal variable according to our formula above.</span>
<span id="cb61-254"><a href="#cb61-254" aria-hidden="true" tabindex="-1"></a>Let's first write a little function to calculate this:</span>
<span id="cb61-255"><a href="#cb61-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-258"><a href="#cb61-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-259"><a href="#cb61-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pts_freq_hr_function</span></span>
<span id="cb61-260"><a href="#cb61-260" aria-hidden="true" tabindex="-1"></a>pts_freq_hr <span class="ot">&lt;-</span> <span class="cf">function</span>(delta_int, var_int, var_final, <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb61-261"><a href="#cb61-261" aria-hidden="true" tabindex="-1"></a>    z_alpha <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb61-262"><a href="#cb61-262" aria-hidden="true" tabindex="-1"></a>    delta_final <span class="ot">&lt;-</span> <span class="sc">-</span>z_alpha <span class="sc">*</span> <span class="fu">sqrt</span>(var_final)</span>
<span id="cb61-263"><a href="#cb61-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>((delta_final <span class="sc">-</span> delta_int) <span class="sc">/</span> <span class="fu">sqrt</span>(var_int))</span>
<span id="cb61-264"><a href="#cb61-264" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-265"><a href="#cb61-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-266"><a href="#cb61-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-267"><a href="#cb61-267" aria-hidden="true" tabindex="-1"></a>For $\hat{\delta}_{\text{int}}$ we are going to plug in our MCMC samples for the marginal log HR $\hat{\delta}_{\text{int}}$ to compute the PTS based on this:</span>
<span id="cb61-268"><a href="#cb61-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-271"><a href="#cb61-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-272"><a href="#cb61-272" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_log_hr_samples</span></span>
<span id="cb61-273"><a href="#cb61-273" aria-hidden="true" tabindex="-1"></a>log_hr_samples <span class="ot">&lt;-</span> pop_hr[[<span class="dv">2</span>]][<span class="st">"armMPDL3280A"</span>, ]</span>
<span id="cb61-274"><a href="#cb61-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-275"><a href="#cb61-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-276"><a href="#cb61-276" aria-hidden="true" tabindex="-1"></a>But first we also need the quantities that go into the variance formula:</span>
<span id="cb61-277"><a href="#cb61-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-278"><a href="#cb61-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\overline{p}$: average event rate</span>
<span id="cb61-279"><a href="#cb61-279" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$r$: proportion of patients in the treatment arm</span>
<span id="cb61-280"><a href="#cb61-280" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\overline{n}$: average arm size in interim data</span>
<span id="cb61-281"><a href="#cb61-281" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\overline{m}$: average arm size in follow up</span>
<span id="cb61-282"><a href="#cb61-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-283"><a href="#cb61-283" aria-hidden="true" tabindex="-1"></a>So let's calculate these and the resulting variances:</span>
<span id="cb61-284"><a href="#cb61-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-287"><a href="#cb61-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-288"><a href="#cb61-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_variance_quantities</span></span>
<span id="cb61-289"><a href="#cb61-289" aria-hidden="true" tabindex="-1"></a>avg_event_rate <span class="ot">&lt;-</span> <span class="fu">mean</span>(os_data<span class="sc">$</span>os_event)</span>
<span id="cb61-290"><a href="#cb61-290" aria-hidden="true" tabindex="-1"></a>prop_pts_treatment <span class="ot">&lt;-</span> <span class="fu">mean</span>(os_data<span class="sc">$</span>arm <span class="sc">==</span> <span class="st">"MPDL3280A"</span>)</span>
<span id="cb61-291"><a href="#cb61-291" aria-hidden="true" tabindex="-1"></a>avg_arm_size_interim <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">table</span>(os_data<span class="sc">$</span>arm))</span>
<span id="cb61-292"><a href="#cb61-292" aria-hidden="true" tabindex="-1"></a>total_size_final <span class="ot">&lt;-</span> <span class="dv">850</span></span>
<span id="cb61-293"><a href="#cb61-293" aria-hidden="true" tabindex="-1"></a>avg_arm_size_followup <span class="ot">&lt;-</span> (total_size_final <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> avg_arm_size_interim) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb61-294"><a href="#cb61-294" aria-hidden="true" tabindex="-1"></a>var_int <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb61-295"><a href="#cb61-295" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span> <span class="sc">*</span> avg_event_rate <span class="sc">*</span> prop_pts_treatment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prop_pts_treatment)) <span class="sc">*</span></span>
<span id="cb61-296"><a href="#cb61-296" aria-hidden="true" tabindex="-1"></a>    avg_arm_size_followup <span class="sc">/</span></span>
<span id="cb61-297"><a href="#cb61-297" aria-hidden="true" tabindex="-1"></a>    (avg_arm_size_interim <span class="sc">*</span> (avg_arm_size_interim <span class="sc">+</span> avg_arm_size_followup))</span>
<span id="cb61-298"><a href="#cb61-298" aria-hidden="true" tabindex="-1"></a>var_final <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb61-299"><a href="#cb61-299" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span> <span class="sc">*</span> avg_event_rate <span class="sc">*</span> prop_pts_treatment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prop_pts_treatment)) <span class="sc">*</span></span>
<span id="cb61-300"><a href="#cb61-300" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span></span>
<span id="cb61-301"><a href="#cb61-301" aria-hidden="true" tabindex="-1"></a>    (avg_arm_size_interim <span class="sc">+</span> avg_arm_size_followup)</span>
<span id="cb61-302"><a href="#cb61-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-303"><a href="#cb61-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-304"><a href="#cb61-304" aria-hidden="true" tabindex="-1"></a>Now we can calculate the PTS based on the frequentist HR properties:</span>
<span id="cb61-305"><a href="#cb61-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-308"><a href="#cb61-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-309"><a href="#cb61-309" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_pts_freq_hr</span></span>
<span id="cb61-310"><a href="#cb61-310" aria-hidden="true" tabindex="-1"></a>pts_freq_hr_result <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">pts_freq_hr</span>(</span>
<span id="cb61-311"><a href="#cb61-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_int =</span> log_hr_samples,</span>
<span id="cb61-312"><a href="#cb61-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_int =</span> var_int,</span>
<span id="cb61-313"><a href="#cb61-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_final =</span> var_final</span>
<span id="cb61-314"><a href="#cb61-314" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb61-315"><a href="#cb61-315" aria-hidden="true" tabindex="-1"></a>pts_freq_hr_result</span>
<span id="cb61-316"><a href="#cb61-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-317"><a href="#cb61-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-318"><a href="#cb61-318" aria-hidden="true" tabindex="-1"></a>So we obtain a PTS of <span class="in">`r round(pts_freq_hr_result * 100, 1)`</span>% here.</span>
<span id="cb61-319"><a href="#cb61-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-320"><a href="#cb61-320" aria-hidden="true" tabindex="-1"></a><span class="fu">## PTS based on frequentist log-rank test properties</span></span>
<span id="cb61-321"><a href="#cb61-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-322"><a href="#cb61-322" aria-hidden="true" tabindex="-1"></a>Now we want to leverage the <span class="in">`rpact`</span> function <span class="co">[</span><span class="ot">`getConditionalPower()`</span><span class="co">](https://rpact-com.github.io/rpact/reference/getConditionalPower.html)</span> to calculate the predictive power of the trial based on the log-rank test statistic properties.</span>
<span id="cb61-323"><a href="#cb61-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-324"><a href="#cb61-324" aria-hidden="true" tabindex="-1"></a>Looking at the function's example, we first have to create a <span class="in">`DataSet`</span> object with the interim data.</span>
<span id="cb61-325"><a href="#cb61-325" aria-hidden="true" tabindex="-1"></a>Here it is important that we for <span class="in">`cumLogRanks`</span> also the z scores from a Cox regression can be used, which means for our case that can insert here the z-scores defined as:</span>
<span id="cb61-326"><a href="#cb61-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-327"><a href="#cb61-327" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-328"><a href="#cb61-328" aria-hidden="true" tabindex="-1"></a>z = \frac{\hat{\delta}_{\text{int}}}{\sigma_{\text{int}}}</span>
<span id="cb61-329"><a href="#cb61-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-330"><a href="#cb61-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-331"><a href="#cb61-331" aria-hidden="true" tabindex="-1"></a>values.</span>
<span id="cb61-332"><a href="#cb61-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-333"><a href="#cb61-333" aria-hidden="true" tabindex="-1"></a>But let's first try this with a simple fixed $z$ value to see how it works:</span>
<span id="cb61-334"><a href="#cb61-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-337"><a href="#cb61-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-338"><a href="#cb61-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rpact_dataset_example</span></span>
<span id="cb61-339"><a href="#cb61-339" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpact)</span>
<span id="cb61-340"><a href="#cb61-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-341"><a href="#cb61-341" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fl">0.9</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(var_int) <span class="co"># Instead of log(0.9) we put later the marginal log HR MCMC sample</span></span>
<span id="cb61-342"><a href="#cb61-342" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">getDataset</span>(</span>
<span id="cb61-343"><a href="#cb61-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumEvents =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb61-344"><a href="#cb61-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumLogRanks =</span> z,</span>
<span id="cb61-345"><a href="#cb61-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">cumAllocationRatios =</span> prop_pts_treatment</span>
<span id="cb61-346"><a href="#cb61-346" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-347"><a href="#cb61-347" aria-hidden="true" tabindex="-1"></a>data</span>
<span id="cb61-348"><a href="#cb61-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-349"><a href="#cb61-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-350"><a href="#cb61-350" aria-hidden="true" tabindex="-1"></a>This is the data set from the first stage, i.e. our interim analysis.</span>
<span id="cb61-351"><a href="#cb61-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-352"><a href="#cb61-352" aria-hidden="true" tabindex="-1"></a>Now we need to define the design of the group sequential trial:</span>
<span id="cb61-353"><a href="#cb61-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-356"><a href="#cb61-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-357"><a href="#cb61-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: define_group_sequential_design</span></span>
<span id="cb61-358"><a href="#cb61-358" aria-hidden="true" tabindex="-1"></a>events_final <span class="ot">&lt;-</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb61-359"><a href="#cb61-359" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">getDesignGroupSequential</span>(</span>
<span id="cb61-360"><a href="#cb61-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">kMax =</span> <span class="dv">2</span>,</span>
<span id="cb61-361"><a href="#cb61-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">informationRates =</span> <span class="fu">c</span>(<span class="fu">sum</span>(os_data<span class="sc">$</span>os_event) <span class="sc">/</span> events_final, <span class="dv">1</span>),</span>
<span id="cb61-362"><a href="#cb61-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.05</span></span>
<span id="cb61-363"><a href="#cb61-363" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-364"><a href="#cb61-364" aria-hidden="true" tabindex="-1"></a>design</span>
<span id="cb61-365"><a href="#cb61-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-366"><a href="#cb61-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-367"><a href="#cb61-367" aria-hidden="true" tabindex="-1"></a>We see that the significance level is almost full for the final analysis, because by default the O'Brien &amp; Fleming design is used, which only assigns a very small $\alpha$ to the interim analysis. This is kind of what we need here.</span>
<span id="cb61-368"><a href="#cb61-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-369"><a href="#cb61-369" aria-hidden="true" tabindex="-1"></a>Finally we put the <span class="in">`design`</span> and <span class="in">`data`</span> in a <span class="in">`StageResults`</span> object, which is the input for the <span class="in">`getConditionalPower()`</span> function:</span>
<span id="cb61-370"><a href="#cb61-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-373"><a href="#cb61-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-374"><a href="#cb61-374" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_conditional_power</span></span>
<span id="cb61-375"><a href="#cb61-375" aria-hidden="true" tabindex="-1"></a>stageResults <span class="ot">&lt;-</span> <span class="fu">getStageResults</span>(</span>
<span id="cb61-376"><a href="#cb61-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">design =</span> design,</span>
<span id="cb61-377"><a href="#cb61-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataInput =</span> data,</span>
<span id="cb61-378"><a href="#cb61-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">stage =</span> <span class="dv">1</span>,</span>
<span id="cb61-379"><a href="#cb61-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">directionUpper =</span> <span class="cn">FALSE</span></span>
<span id="cb61-380"><a href="#cb61-380" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-381"><a href="#cb61-381" aria-hidden="true" tabindex="-1"></a>condPower <span class="ot">&lt;-</span> <span class="fu">getConditionalPower</span>(</span>
<span id="cb61-382"><a href="#cb61-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">stageResults =</span> stageResults,</span>
<span id="cb61-383"><a href="#cb61-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">thetaH1 =</span> <span class="fl">0.9</span>, <span class="co"># Here we put later the marginal hazard ratio MCMC sample</span></span>
<span id="cb61-384"><a href="#cb61-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">nPlanned =</span> total_size_final,</span>
<span id="cb61-385"><a href="#cb61-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">allocationRatioPlanned =</span> <span class="dv">1</span></span>
<span id="cb61-386"><a href="#cb61-386" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-387"><a href="#cb61-387" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(condPower)</span>
<span id="cb61-388"><a href="#cb61-388" aria-hidden="true" tabindex="-1"></a>condPower<span class="sc">$</span>conditionalPower[<span class="dv">2</span>]</span>
<span id="cb61-389"><a href="#cb61-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-390"><a href="#cb61-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-391"><a href="#cb61-391" aria-hidden="true" tabindex="-1"></a>OK so now that we know how it works we wrap this in a little function again.</span>
<span id="cb61-392"><a href="#cb61-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-395"><a href="#cb61-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-396"><a href="#cb61-396" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pts_freq_hr2_function</span></span>
<span id="cb61-397"><a href="#cb61-397" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2 <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb61-398"><a href="#cb61-398" aria-hidden="true" tabindex="-1"></a>    delta_int,</span>
<span id="cb61-399"><a href="#cb61-399" aria-hidden="true" tabindex="-1"></a>    var_int,</span>
<span id="cb61-400"><a href="#cb61-400" aria-hidden="true" tabindex="-1"></a>    var_final,</span>
<span id="cb61-401"><a href="#cb61-401" aria-hidden="true" tabindex="-1"></a>    events_int,</span>
<span id="cb61-402"><a href="#cb61-402" aria-hidden="true" tabindex="-1"></a>    alloc_int,</span>
<span id="cb61-403"><a href="#cb61-403" aria-hidden="true" tabindex="-1"></a>    events_final,</span>
<span id="cb61-404"><a href="#cb61-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb61-405"><a href="#cb61-405" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">getDataset</span>(</span>
<span id="cb61-406"><a href="#cb61-406" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumEvents =</span> events_int,</span>
<span id="cb61-407"><a href="#cb61-407" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumLogRanks =</span> delta_int <span class="sc">/</span> <span class="fu">sqrt</span>(var_int),</span>
<span id="cb61-408"><a href="#cb61-408" aria-hidden="true" tabindex="-1"></a>        <span class="at">cumAllocationRatios =</span> alloc_int</span>
<span id="cb61-409"><a href="#cb61-409" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-410"><a href="#cb61-410" aria-hidden="true" tabindex="-1"></a>    design <span class="ot">&lt;-</span> <span class="fu">getDesignGroupSequential</span>(</span>
<span id="cb61-411"><a href="#cb61-411" aria-hidden="true" tabindex="-1"></a>        <span class="at">kMax =</span> <span class="dv">2</span>,</span>
<span id="cb61-412"><a href="#cb61-412" aria-hidden="true" tabindex="-1"></a>        <span class="at">informationRates =</span> <span class="fu">c</span>(events_int <span class="sc">/</span> events_final, <span class="dv">1</span>),</span>
<span id="cb61-413"><a href="#cb61-413" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> alpha</span>
<span id="cb61-414"><a href="#cb61-414" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-415"><a href="#cb61-415" aria-hidden="true" tabindex="-1"></a>    stageResults <span class="ot">&lt;-</span> <span class="fu">getStageResults</span>(</span>
<span id="cb61-416"><a href="#cb61-416" aria-hidden="true" tabindex="-1"></a>        <span class="at">design =</span> design,</span>
<span id="cb61-417"><a href="#cb61-417" aria-hidden="true" tabindex="-1"></a>        <span class="at">dataInput =</span> data,</span>
<span id="cb61-418"><a href="#cb61-418" aria-hidden="true" tabindex="-1"></a>        <span class="at">stage =</span> <span class="dv">1</span>,</span>
<span id="cb61-419"><a href="#cb61-419" aria-hidden="true" tabindex="-1"></a>        <span class="at">directionUpper =</span> <span class="cn">FALSE</span></span>
<span id="cb61-420"><a href="#cb61-420" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-421"><a href="#cb61-421" aria-hidden="true" tabindex="-1"></a>    condPower <span class="ot">&lt;-</span> <span class="fu">getConditionalPower</span>(</span>
<span id="cb61-422"><a href="#cb61-422" aria-hidden="true" tabindex="-1"></a>        <span class="at">stageResults =</span> stageResults,</span>
<span id="cb61-423"><a href="#cb61-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">thetaH1 =</span> <span class="fu">exp</span>(delta_int),</span>
<span id="cb61-424"><a href="#cb61-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">nPlanned =</span> total_size_final,</span>
<span id="cb61-425"><a href="#cb61-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">allocationRatioPlanned =</span> <span class="dv">1</span></span>
<span id="cb61-426"><a href="#cb61-426" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-427"><a href="#cb61-427" aria-hidden="true" tabindex="-1"></a>    condPower<span class="sc">$</span>conditionalPower[<span class="dv">2</span>]</span>
<span id="cb61-428"><a href="#cb61-428" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-429"><a href="#cb61-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-430"><a href="#cb61-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-431"><a href="#cb61-431" aria-hidden="true" tabindex="-1"></a>Let's try it out with the same example first again:</span>
<span id="cb61-432"><a href="#cb61-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-435"><a href="#cb61-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-436"><a href="#cb61-436" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test_pts_freq_hr2</span></span>
<span id="cb61-437"><a href="#cb61-437" aria-hidden="true" tabindex="-1"></a><span class="fu">pts_freq_hr2</span>(</span>
<span id="cb61-438"><a href="#cb61-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_int =</span> <span class="fu">log</span>(<span class="fl">0.9</span>),</span>
<span id="cb61-439"><a href="#cb61-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_int =</span> var_int,</span>
<span id="cb61-440"><a href="#cb61-440" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_final =</span> var_final,</span>
<span id="cb61-441"><a href="#cb61-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">events_int =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb61-442"><a href="#cb61-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">alloc_int =</span> prop_pts_treatment,</span>
<span id="cb61-443"><a href="#cb61-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">events_final =</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb61-444"><a href="#cb61-444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-445"><a href="#cb61-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-446"><a href="#cb61-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-447"><a href="#cb61-447" aria-hidden="true" tabindex="-1"></a>OK so that gives the same result as before, which is good. Now we can plug in the MCMC samples for the marginal log HR:</span>
<span id="cb61-448"><a href="#cb61-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-451"><a href="#cb61-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-452"><a href="#cb61-452" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_pts_freq_hr2</span></span>
<span id="cb61-453"><a href="#cb61-453" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm1hr2.rds"</span>)</span>
<span id="cb61-454"><a href="#cb61-454" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb61-455"><a href="#cb61-455" aria-hidden="true" tabindex="-1"></a>    pts_freq_hr2_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb61-456"><a href="#cb61-456" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb61-457"><a href="#cb61-457" aria-hidden="true" tabindex="-1"></a>    pts_freq_hr2_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb61-458"><a href="#cb61-458" aria-hidden="true" tabindex="-1"></a>        log_hr_samples,</span>
<span id="cb61-459"><a href="#cb61-459" aria-hidden="true" tabindex="-1"></a>        pts_freq_hr2,</span>
<span id="cb61-460"><a href="#cb61-460" aria-hidden="true" tabindex="-1"></a>        <span class="at">var_int =</span> var_int,</span>
<span id="cb61-461"><a href="#cb61-461" aria-hidden="true" tabindex="-1"></a>        <span class="at">var_final =</span> var_final,</span>
<span id="cb61-462"><a href="#cb61-462" aria-hidden="true" tabindex="-1"></a>        <span class="at">events_int =</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>os_event),</span>
<span id="cb61-463"><a href="#cb61-463" aria-hidden="true" tabindex="-1"></a>        <span class="at">alloc_int =</span> prop_pts_treatment,</span>
<span id="cb61-464"><a href="#cb61-464" aria-hidden="true" tabindex="-1"></a>        <span class="at">events_final =</span> total_size_final <span class="sc">*</span> avg_event_rate</span>
<span id="cb61-465"><a href="#cb61-465" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-466"><a href="#cb61-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(pts_freq_hr2_samples, <span class="at">file =</span> save_file)</span>
<span id="cb61-467"><a href="#cb61-467" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-468"><a href="#cb61-468" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2_result <span class="ot">&lt;-</span> <span class="fu">mean</span>(pts_freq_hr2_samples)</span>
<span id="cb61-469"><a href="#cb61-469" aria-hidden="true" tabindex="-1"></a>pts_freq_hr2_result</span>
<span id="cb61-470"><a href="#cb61-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-471"><a href="#cb61-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-472"><a href="#cb61-472" aria-hidden="true" tabindex="-1"></a>So here we get a PTS of <span class="in">`r round(pts_freq_hr2_result * 100, 1)`</span>%, which is higher than the one we got before.</span>
<span id="cb61-473"><a href="#cb61-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-474"><a href="#cb61-474" aria-hidden="true" tabindex="-1"></a><span class="fu">## Individual Samples based Predictive Power</span></span>
<span id="cb61-475"><a href="#cb61-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-476"><a href="#cb61-476" aria-hidden="true" tabindex="-1"></a>This is a good motivation to try out the conditional sampling approach to calculate the predictive power, which is based on the individual samples of the joint model. It does not involved any frequentist assumptions to calculate the PTS.</span>
<span id="cb61-477"><a href="#cb61-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-478"><a href="#cb61-478" aria-hidden="true" tabindex="-1"></a>We will perform the following steps in this algorithm:</span>
<span id="cb61-479"><a href="#cb61-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-480"><a href="#cb61-480" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>We add as many new patients to the survival data set as we expect to still enter the trial.</span>
<span id="cb61-481"><a href="#cb61-481" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>These patients have survival time 0 and are censored at that time, which means they are completely new patients.</span>
<span id="cb61-482"><a href="#cb61-482" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>We refit the joint model with this augmented data set. This simplifies the subsequent sampling process.</span>
<span id="cb61-483"><a href="#cb61-483" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>For each patient who is still being followed up for OS at IA (=does not have an event yet and did not drop out)</span>
<span id="cb61-484"><a href="#cb61-484" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Obtain individual survival distribution MCMC samples over a long enough time grid</span>
<span id="cb61-485"><a href="#cb61-485" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Condition on last observed censored OS time, sample once per MCMC sample from the conditional survival distribution</span>
<span id="cb61-486"><a href="#cb61-486" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Define "End of Study" time, e.g. based on number of events observed, calendar time, etc.</span>
<span id="cb61-487"><a href="#cb61-487" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Apply summary statistic of interest to the complete "End of Study" OS data set samples and aggregate appropriately</span>
<span id="cb61-488"><a href="#cb61-488" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>For example, we can use the log-rank test statistic as summary statistic</span>
<span id="cb61-489"><a href="#cb61-489" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Calculate the proportion of samples that are above the critical value for the summary statistic, e.g. log-rank test statistic</span>
<span id="cb61-490"><a href="#cb61-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-491"><a href="#cb61-491" aria-hidden="true" tabindex="-1"></a>Note that for the first step, we need to add some random information to the data set, because unfortunately the real data does not differentiate between patients who are still being followed up and those who have dropped out.</span>
<span id="cb61-492"><a href="#cb61-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-493"><a href="#cb61-493" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add new patients and generate random lost-to-follow-up flag</span></span>
<span id="cb61-494"><a href="#cb61-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-495"><a href="#cb61-495" aria-hidden="true" tabindex="-1"></a>Basically for those patients with a censored survival time, we randomly assign a lost-to-follow-up flag with a probability of 10%, so that we can simulate some patients who are still being followed up and some who are not. We sample the covariates from the distribution of the already observed patients.</span>
<span id="cb61-496"><a href="#cb61-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-499"><a href="#cb61-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-500"><a href="#cb61-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate_lost_to_follow_up</span></span>
<span id="cb61-501"><a href="#cb61-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-502"><a href="#cb61-502" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">689</span>)</span>
<span id="cb61-503"><a href="#cb61-503" aria-hidden="true" tabindex="-1"></a>lost_to_follow_up_flag <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb61-504"><a href="#cb61-504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb61-505"><a href="#cb61-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">nrow</span>(os_data),</span>
<span id="cb61-506"><a href="#cb61-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-507"><a href="#cb61-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>)</span>
<span id="cb61-508"><a href="#cb61-508" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-509"><a href="#cb61-509" aria-hidden="true" tabindex="-1"></a>os_data <span class="ot">&lt;-</span> os_data <span class="sc">|&gt;</span></span>
<span id="cb61-510"><a href="#cb61-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lost_to_follow_up =</span> <span class="sc">!</span>os_event <span class="sc">&amp;</span> lost_to_follow_up_flag)</span>
<span id="cb61-511"><a href="#cb61-511" aria-hidden="true" tabindex="-1"></a>n_lost_to_follow_up <span class="ot">&lt;-</span> <span class="fu">sum</span>(os_data<span class="sc">$</span>lost_to_follow_up)</span>
<span id="cb61-512"><a href="#cb61-512" aria-hidden="true" tabindex="-1"></a>n_lost_to_follow_up</span>
<span id="cb61-513"><a href="#cb61-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-514"><a href="#cb61-514" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">359</span>)</span>
<span id="cb61-515"><a href="#cb61-515" aria-hidden="true" tabindex="-1"></a>n_new_patients <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> avg_arm_size_followup</span>
<span id="cb61-516"><a href="#cb61-516" aria-hidden="true" tabindex="-1"></a>os_data_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb61-517"><a href="#cb61-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">max</span>(<span class="fu">as.integer</span>(<span class="fu">as.character</span>(os_data<span class="sc">$</span>id))) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">length.out =</span> n_new_patients),</span>
<span id="cb61-518"><a href="#cb61-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Docetaxel"</span>, <span class="st">"MPDL3280A"</span>), <span class="fu">c</span>(<span class="fu">floor</span>(avg_arm_size_followup), <span class="fu">ceiling</span>(avg_arm_size_followup))),</span>
<span id="cb61-519"><a href="#cb61-519" aria-hidden="true" tabindex="-1"></a>    <span class="at">os_time =</span> <span class="dv">0</span>,</span>
<span id="cb61-520"><a href="#cb61-520" aria-hidden="true" tabindex="-1"></a>    <span class="at">os_event =</span> <span class="cn">FALSE</span>,</span>
<span id="cb61-521"><a href="#cb61-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">lost_to_follow_up =</span> <span class="cn">FALSE</span>,</span>
<span id="cb61-522"><a href="#cb61-522" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>ecog, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-523"><a href="#cb61-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>age, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-524"><a href="#cb61-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">race =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>race, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-525"><a href="#cb61-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> <span class="fu">sample</span>(os_data<span class="sc">$</span>sex, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-526"><a href="#cb61-526" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-527"><a href="#cb61-527" aria-hidden="true" tabindex="-1"></a>os_data_augmented <span class="ot">&lt;-</span> os_data[, <span class="fu">names</span>(os_data_new)] <span class="sc">|&gt;</span></span>
<span id="cb61-528"><a href="#cb61-528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id)) <span class="sc">|&gt;</span></span>
<span id="cb61-529"><a href="#cb61-529" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(os_data_new) <span class="sc">|&gt;</span></span>
<span id="cb61-530"><a href="#cb61-530" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(id))</span>
<span id="cb61-531"><a href="#cb61-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-532"><a href="#cb61-532" aria-hidden="true" tabindex="-1"></a>n_censored <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span>os_data_augmented<span class="sc">$</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>os_data_augmented<span class="sc">$</span>lost_to_follow_up)</span>
<span id="cb61-533"><a href="#cb61-533" aria-hidden="true" tabindex="-1"></a>n_censored</span>
<span id="cb61-534"><a href="#cb61-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-535"><a href="#cb61-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-536"><a href="#cb61-536" aria-hidden="true" tabindex="-1"></a>So now we have <span class="in">`r n_lost_to_follow_up`</span> patients who have been lost to follow-up and <span class="in">`r n_censored`</span> patients who are still being followed up for OS (or who will still be entering the trial). These <span class="in">`r n_censored`</span> patients will be the ones we will perform the individual sampling for.</span>
<span id="cb61-537"><a href="#cb61-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-538"><a href="#cb61-538" aria-hidden="true" tabindex="-1"></a><span class="fu">### Refit the joint model with augmented data</span></span>
<span id="cb61-539"><a href="#cb61-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-540"><a href="#cb61-540" aria-hidden="true" tabindex="-1"></a>First we need to refit the joint model to this augmented data set. That is the easiest way to also get survival curve samples for the patients who are yet to be enrolled in the trial.</span>
<span id="cb61-541"><a href="#cb61-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-542"><a href="#cb61-542" aria-hidden="true" tabindex="-1"></a>We notice that here we also need to add at least some random baseline samples to the longitudinal data set, otherwise it does not work.</span>
<span id="cb61-543"><a href="#cb61-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-546"><a href="#cb61-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-547"><a href="#cb61-547" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: refit_joint_model_augmented</span></span>
<span id="cb61-548"><a href="#cb61-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-549"><a href="#cb61-549" aria-hidden="true" tabindex="-1"></a>subj_aug_df <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb61-550"><a href="#cb61-550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study =</span> <span class="st">"OAK"</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-551"><a href="#cb61-551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(study, id, arm)</span>
<span id="cb61-552"><a href="#cb61-552" aria-hidden="true" tabindex="-1"></a>subj_aug_data <span class="ot">&lt;-</span> <span class="fu">DataSubject</span>(</span>
<span id="cb61-553"><a href="#cb61-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> subj_aug_df,</span>
<span id="cb61-554"><a href="#cb61-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"id"</span>,</span>
<span id="cb61-555"><a href="#cb61-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">arm =</span> <span class="st">"arm"</span>,</span>
<span id="cb61-556"><a href="#cb61-556" aria-hidden="true" tabindex="-1"></a>    <span class="at">study =</span> <span class="st">"study"</span></span>
<span id="cb61-557"><a href="#cb61-557" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-558"><a href="#cb61-558" aria-hidden="true" tabindex="-1"></a>long_df <span class="ot">&lt;-</span> tumor_data <span class="sc">|&gt;</span></span>
<span id="cb61-559"><a href="#cb61-559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, year, sld)</span>
<span id="cb61-560"><a href="#cb61-560" aria-hidden="true" tabindex="-1"></a>new_long_df <span class="ot">&lt;-</span> os_data_new <span class="sc">|&gt;</span></span>
<span id="cb61-561"><a href="#cb61-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, os_time) <span class="sc">|&gt;</span></span>
<span id="cb61-562"><a href="#cb61-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">year =</span> os_time) <span class="sc">|&gt;</span></span>
<span id="cb61-563"><a href="#cb61-563" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sld =</span> <span class="fu">sample</span>(tumor_data<span class="sc">$</span>sld, n_new_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb61-564"><a href="#cb61-564" aria-hidden="true" tabindex="-1"></a>long_aug_df <span class="ot">&lt;-</span> long_df <span class="sc">|&gt;</span></span>
<span id="cb61-565"><a href="#cb61-565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id)) <span class="sc">|&gt;</span></span>
<span id="cb61-566"><a href="#cb61-566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(new_long_df) <span class="sc">|&gt;</span></span>
<span id="cb61-567"><a href="#cb61-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(id))</span>
<span id="cb61-568"><a href="#cb61-568" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">identical</span>(<span class="fu">levels</span>(long_aug_df<span class="sc">$</span>id), <span class="fu">levels</span>(subj_aug_df<span class="sc">$</span>id)))</span>
<span id="cb61-569"><a href="#cb61-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-570"><a href="#cb61-570" aria-hidden="true" tabindex="-1"></a>long_aug_data <span class="ot">&lt;-</span> <span class="fu">DataLongitudinal</span>(</span>
<span id="cb61-571"><a href="#cb61-571" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> long_aug_df,</span>
<span id="cb61-572"><a href="#cb61-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sld <span class="sc">~</span> year</span>
<span id="cb61-573"><a href="#cb61-573" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-574"><a href="#cb61-574" aria-hidden="true" tabindex="-1"></a>surv_aug_data <span class="ot">&lt;-</span> <span class="fu">DataSurvival</span>(</span>
<span id="cb61-575"><a href="#cb61-575" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> os_data_augmented,</span>
<span id="cb61-576"><a href="#cb61-576" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex</span>
<span id="cb61-577"><a href="#cb61-577" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-578"><a href="#cb61-578" aria-hidden="true" tabindex="-1"></a>joint_aug_data <span class="ot">&lt;-</span> <span class="fu">DataJoint</span>(</span>
<span id="cb61-579"><a href="#cb61-579" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> subj_aug_data,</span>
<span id="cb61-580"><a href="#cb61-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitudinal =</span> long_aug_data,</span>
<span id="cb61-581"><a href="#cb61-581" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival =</span> surv_aug_data</span>
<span id="cb61-582"><a href="#cb61-582" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-583"><a href="#cb61-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-584"><a href="#cb61-584" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm2.rds"</span>)</span>
<span id="cb61-585"><a href="#cb61-585" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb61-586"><a href="#cb61-586" aria-hidden="true" tabindex="-1"></a>    joint_aug_results <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb61-587"><a href="#cb61-587" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb61-588"><a href="#cb61-588" aria-hidden="true" tabindex="-1"></a>    joint_aug_results <span class="ot">&lt;-</span> <span class="fu">sampleStanModel</span>(</span>
<span id="cb61-589"><a href="#cb61-589" aria-hidden="true" tabindex="-1"></a>        joint_mod,</span>
<span id="cb61-590"><a href="#cb61-590" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> joint_aug_data,</span>
<span id="cb61-591"><a href="#cb61-591" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_sampling =</span> ITER,</span>
<span id="cb61-592"><a href="#cb61-592" aria-hidden="true" tabindex="-1"></a>        <span class="at">iter_warmup =</span> WARMUP,</span>
<span id="cb61-593"><a href="#cb61-593" aria-hidden="true" tabindex="-1"></a>        <span class="at">chains =</span> CHAINS,</span>
<span id="cb61-594"><a href="#cb61-594" aria-hidden="true" tabindex="-1"></a>        <span class="at">parallel_chains =</span> CHAINS,</span>
<span id="cb61-595"><a href="#cb61-595" aria-hidden="true" tabindex="-1"></a>        <span class="at">thin =</span> CHAINS,</span>
<span id="cb61-596"><a href="#cb61-596" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> BAYES.SEED,</span>
<span id="cb61-597"><a href="#cb61-597" aria-hidden="true" tabindex="-1"></a>        <span class="at">refresh =</span> REFRESH</span>
<span id="cb61-598"><a href="#cb61-598" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-599"><a href="#cb61-599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveObject</span>(joint_aug_results, <span class="at">file =</span> save_file)</span>
<span id="cb61-600"><a href="#cb61-600" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-601"><a href="#cb61-601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-602"><a href="#cb61-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-603"><a href="#cb61-603" aria-hidden="true" tabindex="-1"></a><span class="fu">### Individual Sampling of OS events</span></span>
<span id="cb61-604"><a href="#cb61-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-605"><a href="#cb61-605" aria-hidden="true" tabindex="-1"></a>Now we can perform the individual sampling of the OS events for the patients who are still being followed up. </span>
<span id="cb61-606"><a href="#cb61-606" aria-hidden="true" tabindex="-1"></a>Let's start with a single patient:</span>
<span id="cb61-607"><a href="#cb61-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-610"><a href="#cb61-610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-611"><a href="#cb61-611" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: individual_sampling_single_patient</span></span>
<span id="cb61-612"><a href="#cb61-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-613"><a href="#cb61-613" aria-hidden="true" tabindex="-1"></a>patient_id <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb61-614"><a href="#cb61-614" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>lost_to_follow_up) <span class="sc">|&gt;</span></span>
<span id="cb61-615"><a href="#cb61-615" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb61-616"><a href="#cb61-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-617"><a href="#cb61-617" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">1</span>)</span>
<span id="cb61-618"><a href="#cb61-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-619"><a href="#cb61-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-620"><a href="#cb61-620" aria-hidden="true" tabindex="-1"></a>So for this patient <span class="in">`r patient_id`</span>, we can extract the individual survival distribution MCMC samples from the joint model results along a time grid that extrapolates long enough into the future, say 10 years after the last observed OS time:</span>
<span id="cb61-621"><a href="#cb61-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-624"><a href="#cb61-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-625"><a href="#cb61-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_individual_survival_samples</span></span>
<span id="cb61-626"><a href="#cb61-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache.lazy: false</span></span>
<span id="cb61-627"><a href="#cb61-627" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-628"><a href="#cb61-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-629"><a href="#cb61-629" aria-hidden="true" tabindex="-1"></a>length_time_grid <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb61-630"><a href="#cb61-630" aria-hidden="true" tabindex="-1"></a>time_grid_end <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(os_data_augmented<span class="sc">$</span>os_time) <span class="sc">+</span> <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb61-631"><a href="#cb61-631" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, time_grid_end, <span class="at">length =</span> length_time_grid)</span>
<span id="cb61-632"><a href="#cb61-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-633"><a href="#cb61-633" aria-hidden="true" tabindex="-1"></a>save_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"session-pts/jm2_surv_samples.rds"</span>)</span>
<span id="cb61-634"><a href="#cb61-634" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(save_file)) {</span>
<span id="cb61-635"><a href="#cb61-635" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(save_file)</span>
<span id="cb61-636"><a href="#cb61-636" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb61-637"><a href="#cb61-637" aria-hidden="true" tabindex="-1"></a>    os_surv_samples <span class="ot">&lt;-</span> <span class="fu">SurvivalQuantities</span>(</span>
<span id="cb61-638"><a href="#cb61-638" aria-hidden="true" tabindex="-1"></a>        <span class="at">object =</span> joint_aug_results,</span>
<span id="cb61-639"><a href="#cb61-639" aria-hidden="true" tabindex="-1"></a>        <span class="at">grid =</span> <span class="fu">GridFixed</span>(<span class="at">times =</span> time_grid),</span>
<span id="cb61-640"><a href="#cb61-640" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"surv"</span></span>
<span id="cb61-641"><a href="#cb61-641" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-642"><a href="#cb61-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(os_surv_samples, <span class="at">file =</span> save_file)</span>
<span id="cb61-643"><a href="#cb61-643" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-644"><a href="#cb61-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-645"><a href="#cb61-645" aria-hidden="true" tabindex="-1"></a>os_surv_samples_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(os_surv_samples)</span>
<span id="cb61-646"><a href="#cb61-646" aria-hidden="true" tabindex="-1"></a>os_surv_samples_patient <span class="ot">&lt;-</span> os_surv_samples_df <span class="sc">|&gt;</span></span>
<span id="cb61-647"><a href="#cb61-647" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> patient_id) <span class="sc">|&gt;</span></span>
<span id="cb61-648"><a href="#cb61-648" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>group) <span class="sc">|&gt;</span></span>
<span id="cb61-649"><a href="#cb61-649" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sample_id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>ITER, length_time_grid))</span>
<span id="cb61-650"><a href="#cb61-650" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(os_surv_samples_patient)</span>
<span id="cb61-651"><a href="#cb61-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-652"><a href="#cb61-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-653"><a href="#cb61-653" aria-hidden="true" tabindex="-1"></a>Now let's zoom in on the first sampled survival curve of this patient, where we show also the last observed OS time as a vertical dashed line:</span>
<span id="cb61-654"><a href="#cb61-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-657"><a href="#cb61-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-658"><a href="#cb61-658" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_individual_survival_curve</span></span>
<span id="cb61-659"><a href="#cb61-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-660"><a href="#cb61-660" aria-hidden="true" tabindex="-1"></a>first_surv_sample <span class="ot">&lt;-</span> os_surv_samples_patient <span class="sc">|&gt;</span></span>
<span id="cb61-661"><a href="#cb61-661" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(sample_id <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb61-662"><a href="#cb61-662" aria-hidden="true" tabindex="-1"></a>patient_last_os_time <span class="ot">&lt;-</span> os_data_augmented<span class="sc">$</span>os_time[os_data_augmented<span class="sc">$</span>id <span class="sc">==</span> patient_id]</span>
<span id="cb61-663"><a href="#cb61-663" aria-hidden="true" tabindex="-1"></a>first_surv_sample_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(first_surv_sample, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> values)) <span class="sc">+</span></span>
<span id="cb61-664"><a href="#cb61-664" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb61-665"><a href="#cb61-665" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb61-666"><a href="#cb61-666" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Individual Survival Curve for Patient"</span>, patient_id),</span>
<span id="cb61-667"><a href="#cb61-667" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb61-668"><a href="#cb61-668" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Survival Probability"</span></span>
<span id="cb61-669"><a href="#cb61-669" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-670"><a href="#cb61-670" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb61-671"><a href="#cb61-671" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> patient_last_os_time,</span>
<span id="cb61-672"><a href="#cb61-672" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb61-673"><a href="#cb61-673" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb61-674"><a href="#cb61-674" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-675"><a href="#cb61-675" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb61-676"><a href="#cb61-676" aria-hidden="true" tabindex="-1"></a>first_surv_sample_plot</span>
<span id="cb61-677"><a href="#cb61-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-678"><a href="#cb61-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-679"><a href="#cb61-679" aria-hidden="true" tabindex="-1"></a>As described in the slides, we can now sample a survival time for this patient from the conditional survival distribution, given the last observed OS time, by:</span>
<span id="cb61-680"><a href="#cb61-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-681"><a href="#cb61-681" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Drawing a standard uniform random number $p \sim U(0, 1)$</span>
<span id="cb61-682"><a href="#cb61-682" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Finding the time $t$ such that $(1-p)S(c) - S(t) = 0$ where $c = <span class="in">`r round(patient_last_os_time, 1)`</span> is the last observed OS time</span>
<span id="cb61-683"><a href="#cb61-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-686"><a href="#cb61-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-687"><a href="#cb61-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sample_conditional_survival_time</span></span>
<span id="cb61-688"><a href="#cb61-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-689"><a href="#cb61-689" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb61-690"><a href="#cb61-690" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb61-691"><a href="#cb61-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-692"><a href="#cb61-692" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear approximation function for the survival function:</span></span>
<span id="cb61-693"><a href="#cb61-693" aria-hidden="true" tabindex="-1"></a>surv_approx <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(</span>
<span id="cb61-694"><a href="#cb61-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> first_surv_sample<span class="sc">$</span>time,</span>
<span id="cb61-695"><a href="#cb61-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> first_surv_sample<span class="sc">$</span>values,</span>
<span id="cb61-696"><a href="#cb61-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">rule =</span> <span class="dv">2</span> <span class="co"># extrapolation outside interval via closest data extreme</span></span>
<span id="cb61-697"><a href="#cb61-697" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-698"><a href="#cb61-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-699"><a href="#cb61-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival function value at the time of censoring:</span></span>
<span id="cb61-700"><a href="#cb61-700" aria-hidden="true" tabindex="-1"></a>surv_at_censoring <span class="ot">&lt;-</span> <span class="fu">surv_approx</span>(patient_last_os_time)</span>
<span id="cb61-701"><a href="#cb61-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-702"><a href="#cb61-702" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the time t such that (1-p) * S(c) - S(t) = 0:</span></span>
<span id="cb61-703"><a href="#cb61-703" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb61-704"><a href="#cb61-704" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(t) (<span class="dv">1</span> <span class="sc">-</span> p) <span class="sc">*</span> surv_at_censoring <span class="sc">-</span> <span class="fu">surv_approx</span>(t),</span>
<span id="cb61-705"><a href="#cb61-705" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>, time_grid_end)</span>
<span id="cb61-706"><a href="#cb61-706" aria-hidden="true" tabindex="-1"></a>)<span class="sc">$</span>root</span>
<span id="cb61-707"><a href="#cb61-707" aria-hidden="true" tabindex="-1"></a>t</span>
<span id="cb61-708"><a href="#cb61-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-709"><a href="#cb61-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-710"><a href="#cb61-710" aria-hidden="true" tabindex="-1"></a>We can plot the conditional survival function together with this sampled survival time:</span>
<span id="cb61-711"><a href="#cb61-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-714"><a href="#cb61-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-715"><a href="#cb61-715" aria-hidden="true" tabindex="-1"></a>first_surv_sample <span class="ot">&lt;-</span> first_surv_sample <span class="sc">|&gt;</span></span>
<span id="cb61-716"><a href="#cb61-716" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb61-717"><a href="#cb61-717" aria-hidden="true" tabindex="-1"></a>        <span class="at">cond_values =</span> <span class="fu">ifelse</span>(</span>
<span id="cb61-718"><a href="#cb61-718" aria-hidden="true" tabindex="-1"></a>            time <span class="sc">&lt;=</span> patient_last_os_time,</span>
<span id="cb61-719"><a href="#cb61-719" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span>,</span>
<span id="cb61-720"><a href="#cb61-720" aria-hidden="true" tabindex="-1"></a>            values <span class="sc">/</span> surv_at_censoring</span>
<span id="cb61-721"><a href="#cb61-721" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb61-722"><a href="#cb61-722" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-723"><a href="#cb61-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-724"><a href="#cb61-724" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb61-725"><a href="#cb61-725" aria-hidden="true" tabindex="-1"></a>    first_surv_sample,</span>
<span id="cb61-726"><a href="#cb61-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> cond_values)</span>
<span id="cb61-727"><a href="#cb61-727" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb61-728"><a href="#cb61-728" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb61-729"><a href="#cb61-729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb61-730"><a href="#cb61-730" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(</span>
<span id="cb61-731"><a href="#cb61-731" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Individual Conditional Survival Curve for Patient"</span>,</span>
<span id="cb61-732"><a href="#cb61-732" aria-hidden="true" tabindex="-1"></a>            patient_id</span>
<span id="cb61-733"><a href="#cb61-733" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb61-734"><a href="#cb61-734" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Time (years)"</span>,</span>
<span id="cb61-735"><a href="#cb61-735" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Survival Probability"</span></span>
<span id="cb61-736"><a href="#cb61-736" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-737"><a href="#cb61-737" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb61-738"><a href="#cb61-738" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> patient_last_os_time,</span>
<span id="cb61-739"><a href="#cb61-739" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb61-740"><a href="#cb61-740" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb61-741"><a href="#cb61-741" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-742"><a href="#cb61-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb61-743"><a href="#cb61-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb61-744"><a href="#cb61-744" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> t,</span>
<span id="cb61-745"><a href="#cb61-745" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb61-746"><a href="#cb61-746" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb61-747"><a href="#cb61-747" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-748"><a href="#cb61-748" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb61-749"><a href="#cb61-749" aria-hidden="true" tabindex="-1"></a>        <span class="at">yintercept =</span> <span class="dv">1</span> <span class="sc">-</span> p,</span>
<span id="cb61-750"><a href="#cb61-750" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb61-751"><a href="#cb61-751" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb61-752"><a href="#cb61-752" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-753"><a href="#cb61-753" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb61-754"><a href="#cb61-754" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">t =</span> t, <span class="at">p =</span> p),</span>
<span id="cb61-755"><a href="#cb61-755" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> p),</span>
<span id="cb61-756"><a href="#cb61-756" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb61-757"><a href="#cb61-757" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb61-758"><a href="#cb61-758" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-759"><a href="#cb61-759" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot</span>
<span id="cb61-760"><a href="#cb61-760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-761"><a href="#cb61-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-762"><a href="#cb61-762" aria-hidden="true" tabindex="-1"></a>The challenge is now to do this efficiently for all patients who are still being followed up for OS, and for all of their MCMC samples.</span>
<span id="cb61-763"><a href="#cb61-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-764"><a href="#cb61-764" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simplified Rcpp implementation for single patient/sample</span></span>
<span id="cb61-765"><a href="#cb61-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-766"><a href="#cb61-766" aria-hidden="true" tabindex="-1"></a>For now, let's create a simpler <span class="in">`Rcpp`</span> function that handles a single patient's single MCMC sample:</span>
<span id="cb61-767"><a href="#cb61-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-770"><a href="#cb61-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-771"><a href="#cb61-771" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: simple_rcpp_conditional_sampling</span></span>
<span id="cb61-772"><a href="#cb61-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-773"><a href="#cb61-773" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb61-774"><a href="#cb61-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-775"><a href="#cb61-775" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Rcpp function for single patient, single sample.</span></span>
<span id="cb61-776"><a href="#cb61-776" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="fu">here</span>(<span class="st">"session-pts/conditional_sampling.cpp"</span>))</span>
<span id="cb61-777"><a href="#cb61-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-778"><a href="#cb61-778" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function with a simple example.</span></span>
<span id="cb61-779"><a href="#cb61-779" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3453</span>)</span>
<span id="cb61-780"><a href="#cb61-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-781"><a href="#cb61-781" aria-hidden="true" tabindex="-1"></a>t_cpp_simple <span class="ot">&lt;-</span> <span class="fu">sample_single_conditional_survival_time</span>(</span>
<span id="cb61-782"><a href="#cb61-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> first_surv_sample<span class="sc">$</span>time,</span>
<span id="cb61-783"><a href="#cb61-783" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> first_surv_sample<span class="sc">$</span>values,</span>
<span id="cb61-784"><a href="#cb61-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_time =</span> patient_last_os_time</span>
<span id="cb61-785"><a href="#cb61-785" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-786"><a href="#cb61-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-787"><a href="#cb61-787" aria-hidden="true" tabindex="-1"></a>first_cond_surv_sample_plot <span class="sc">+</span></span>
<span id="cb61-788"><a href="#cb61-788" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb61-789"><a href="#cb61-789" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">data.frame</span>(</span>
<span id="cb61-790"><a href="#cb61-790" aria-hidden="true" tabindex="-1"></a>            <span class="at">t =</span> t_cpp_simple<span class="sc">$</span>t_result,</span>
<span id="cb61-791"><a href="#cb61-791" aria-hidden="true" tabindex="-1"></a>            <span class="at">p =</span> t_cpp_simple<span class="sc">$</span>uniform_sample</span>
<span id="cb61-792"><a href="#cb61-792" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb61-793"><a href="#cb61-793" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> <span class="dv">1</span> <span class="sc">-</span> p),</span>
<span id="cb61-794"><a href="#cb61-794" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb61-795"><a href="#cb61-795" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb61-796"><a href="#cb61-796" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-797"><a href="#cb61-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-798"><a href="#cb61-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-799"><a href="#cb61-799" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rcpp implementation for all patients and samples</span></span>
<span id="cb61-800"><a href="#cb61-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-801"><a href="#cb61-801" aria-hidden="true" tabindex="-1"></a>Let's use the second <span class="in">`Rcpp`</span> function that handles all patients and all MCMC samples at once.</span>
<span id="cb61-802"><a href="#cb61-802" aria-hidden="true" tabindex="-1"></a>We just need to prepare the data in the right format:</span>
<span id="cb61-803"><a href="#cb61-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-804"><a href="#cb61-804" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The first argument is the time grid, which we already have.</span>
<span id="cb61-805"><a href="#cb61-805" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The second argument is a matrix of survival values, where each row is a sample/patient combination and each column is a time point.</span>
<span id="cb61-806"><a href="#cb61-806" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The third argument is a vector of censoring times, where each element corresponds to a sample/patient combination.</span>
<span id="cb61-807"><a href="#cb61-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-810"><a href="#cb61-810" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-811"><a href="#cb61-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rcpp_conditional_sampling_all</span></span>
<span id="cb61-812"><a href="#cb61-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-813"><a href="#cb61-813" aria-hidden="true" tabindex="-1"></a><span class="co"># First subset to the patients where we need to sample from the conditional survival distribution.</span></span>
<span id="cb61-814"><a href="#cb61-814" aria-hidden="true" tabindex="-1"></a>pt_to_sample <span class="ot">&lt;-</span> os_data_augmented <span class="sc">|&gt;</span></span>
<span id="cb61-815"><a href="#cb61-815" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>os_event <span class="sc">&amp;</span> <span class="sc">!</span>lost_to_follow_up)</span>
<span id="cb61-816"><a href="#cb61-816" aria-hidden="true" tabindex="-1"></a>pt_to_sample_ids <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>id</span>
<span id="cb61-817"><a href="#cb61-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-818"><a href="#cb61-818" aria-hidden="true" tabindex="-1"></a>qs <span class="ot">&lt;-</span> os_surv_samples<span class="sc">@</span>quantities</span>
<span id="cb61-819"><a href="#cb61-819" aria-hidden="true" tabindex="-1"></a>include_qs <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups <span class="sc">%in%</span> pt_to_sample_ids</span>
<span id="cb61-820"><a href="#cb61-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-821"><a href="#cb61-821" aria-hidden="true" tabindex="-1"></a>qs_samples <span class="ot">&lt;-</span> qs<span class="sc">@</span>quantities[, include_qs]</span>
<span id="cb61-822"><a href="#cb61-822" aria-hidden="true" tabindex="-1"></a>qs_times <span class="ot">&lt;-</span> qs<span class="sc">@</span>times[include_qs]</span>
<span id="cb61-823"><a href="#cb61-823" aria-hidden="true" tabindex="-1"></a>qs_groups <span class="ot">&lt;-</span> qs<span class="sc">@</span>groups[include_qs]</span>
<span id="cb61-824"><a href="#cb61-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-825"><a href="#cb61-825" aria-hidden="true" tabindex="-1"></a>surv_values_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb61-826"><a href="#cb61-826" aria-hidden="true" tabindex="-1"></a>    qs_samples,</span>
<span id="cb61-827"><a href="#cb61-827" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER <span class="sc">*</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb61-828"><a href="#cb61-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> length_time_grid</span>
<span id="cb61-829"><a href="#cb61-829" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-830"><a href="#cb61-830" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(surv_values_samples)</span>
<span id="cb61-831"><a href="#cb61-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-832"><a href="#cb61-832" aria-hidden="true" tabindex="-1"></a>surv_values_pt_ids <span class="ot">&lt;-</span> <span class="fu">rep</span>(</span>
<span id="cb61-833"><a href="#cb61-833" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)),</span>
<span id="cb61-834"><a href="#cb61-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">each =</span> ITER</span>
<span id="cb61-835"><a href="#cb61-835" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-836"><a href="#cb61-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-837"><a href="#cb61-837" aria-hidden="true" tabindex="-1"></a>censoring_times <span class="ot">&lt;-</span> pt_to_sample<span class="sc">$</span>os_time[<span class="fu">match</span>(</span>
<span id="cb61-838"><a href="#cb61-838" aria-hidden="true" tabindex="-1"></a>    surv_values_pt_ids,</span>
<span id="cb61-839"><a href="#cb61-839" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids</span>
<span id="cb61-840"><a href="#cb61-840" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb61-841"><a href="#cb61-841" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(censoring_times)</span>
<span id="cb61-842"><a href="#cb61-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-843"><a href="#cb61-843" aria-hidden="true" tabindex="-1"></a>cond_surv_time_samples <span class="ot">&lt;-</span> <span class="fu">sample_conditional_survival_times</span>(</span>
<span id="cb61-844"><a href="#cb61-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_grid =</span> time_grid,</span>
<span id="cb61-845"><a href="#cb61-845" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv_values =</span> surv_values_samples,</span>
<span id="cb61-846"><a href="#cb61-846" aria-hidden="true" tabindex="-1"></a>    <span class="at">censoring_times =</span> censoring_times</span>
<span id="cb61-847"><a href="#cb61-847" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-848"><a href="#cb61-848" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(cond_surv_time_samples<span class="sc">$</span>beyond_max_time)</span>
<span id="cb61-849"><a href="#cb61-849" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cond_surv_time_samples<span class="sc">$</span>t_results)</span>
<span id="cb61-850"><a href="#cb61-850" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(cond_surv_time_samples<span class="sc">$</span>uniform_samples)</span>
<span id="cb61-851"><a href="#cb61-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-852"><a href="#cb61-852" aria-hidden="true" tabindex="-1"></a>os_cond_samples <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb61-853"><a href="#cb61-853" aria-hidden="true" tabindex="-1"></a>    cond_surv_time_samples<span class="sc">$</span>t_results,</span>
<span id="cb61-854"><a href="#cb61-854" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> ITER,</span>
<span id="cb61-855"><a href="#cb61-855" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">length</span>(pt_to_sample_ids),</span>
<span id="cb61-856"><a href="#cb61-856" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">seq_len</span>(ITER), <span class="fu">head</span>(qs_groups, <span class="fu">length</span>(pt_to_sample_ids)))</span>
<span id="cb61-857"><a href="#cb61-857" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-858"><a href="#cb61-858" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-859"><a href="#cb61-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-860"><a href="#cb61-860" aria-hidden="true" tabindex="-1"></a>So this function is very fast, and in this case we have less than 1% of the samples where we did not have a long enough time grid, which seems sufficient for our purposes.</span>
<span id="cb61-861"><a href="#cb61-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-862"><a href="#cb61-862" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generating OS data set samples</span></span>
<span id="cb61-863"><a href="#cb61-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-864"><a href="#cb61-864" aria-hidden="true" tabindex="-1"></a>Now that we have the OS events for the patients who are still being followed up, we can generate the complete OS data set samples for each MCMC sample.</span>
<span id="cb61-865"><a href="#cb61-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-868"><a href="#cb61-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-869"><a href="#cb61-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate_os_data_samples</span></span>
<span id="cb61-870"><a href="#cb61-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-871"><a href="#cb61-871" aria-hidden="true" tabindex="-1"></a><span class="co"># Where do we need to replace the OS times?</span></span>
<span id="cb61-872"><a href="#cb61-872" aria-hidden="true" tabindex="-1"></a>os_rows_to_replace <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb61-873"><a href="#cb61-873" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb61-874"><a href="#cb61-874" aria-hidden="true" tabindex="-1"></a>    os_data_augmented<span class="sc">$</span>id</span>
<span id="cb61-875"><a href="#cb61-875" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-876"><a href="#cb61-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-877"><a href="#cb61-877" aria-hidden="true" tabindex="-1"></a><span class="co"># From which column do we take the sampled OS times?</span></span>
<span id="cb61-878"><a href="#cb61-878" aria-hidden="true" tabindex="-1"></a>os_cond_samples_cols <span class="ot">&lt;-</span> <span class="fu">match</span>(</span>
<span id="cb61-879"><a href="#cb61-879" aria-hidden="true" tabindex="-1"></a>    pt_to_sample_ids,</span>
<span id="cb61-880"><a href="#cb61-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(os_cond_samples)</span>
<span id="cb61-881"><a href="#cb61-881" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-882"><a href="#cb61-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-883"><a href="#cb61-883" aria-hidden="true" tabindex="-1"></a>os_data_samples <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="cf">function</span>(i) {</span>
<span id="cb61-884"><a href="#cb61-884" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the original OS data</span></span>
<span id="cb61-885"><a href="#cb61-885" aria-hidden="true" tabindex="-1"></a>    os_data_sample <span class="ot">&lt;-</span> os_data_augmented[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"arm"</span>, <span class="st">"os_time"</span>, <span class="st">"os_event"</span>, <span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"ecog"</span>, <span class="st">"age"</span>)]</span>
<span id="cb61-886"><a href="#cb61-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-887"><a href="#cb61-887" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the sampled OS times for the patients who are still being followed up.</span></span>
<span id="cb61-888"><a href="#cb61-888" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_time[os_rows_to_replace] <span class="ot">&lt;-</span> os_cond_samples[</span>
<span id="cb61-889"><a href="#cb61-889" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb61-890"><a href="#cb61-890" aria-hidden="true" tabindex="-1"></a>        os_cond_samples_cols</span>
<span id="cb61-891"><a href="#cb61-891" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-892"><a href="#cb61-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-893"><a href="#cb61-893" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the OS event to TRUE for those patients, because we assume they have an event now.</span></span>
<span id="cb61-894"><a href="#cb61-894" aria-hidden="true" tabindex="-1"></a>    os_data_sample<span class="sc">$</span>os_event[os_rows_to_replace] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb61-895"><a href="#cb61-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-896"><a href="#cb61-896" aria-hidden="true" tabindex="-1"></a>    os_data_sample</span>
<span id="cb61-897"><a href="#cb61-897" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-898"><a href="#cb61-898" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-899"><a href="#cb61-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-900"><a href="#cb61-900" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculate log rank statistic for each sampled OS data set</span></span>
<span id="cb61-901"><a href="#cb61-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-902"><a href="#cb61-902" aria-hidden="true" tabindex="-1"></a>Now it is easy to calculate the log-rank test statistic for each sampled OS data set.</span>
<span id="cb61-903"><a href="#cb61-903" aria-hidden="true" tabindex="-1"></a>Here we don't adjust for any covariates.</span>
<span id="cb61-904"><a href="#cb61-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-907"><a href="#cb61-907" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-908"><a href="#cb61-908" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_log_rank_statistic</span></span>
<span id="cb61-909"><a href="#cb61-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-910"><a href="#cb61-910" aria-hidden="true" tabindex="-1"></a>log_rank_stats_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb61-911"><a href="#cb61-911" aria-hidden="true" tabindex="-1"></a>    surv_diff <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survdiff</span>(</span>
<span id="cb61-912"><a href="#cb61-912" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm,</span>
<span id="cb61-913"><a href="#cb61-913" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb61-914"><a href="#cb61-914" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-915"><a href="#cb61-915" aria-hidden="true" tabindex="-1"></a>    surv_diff<span class="sc">$</span>chisq</span>
<span id="cb61-916"><a href="#cb61-916" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-917"><a href="#cb61-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-918"><a href="#cb61-918" aria-hidden="true" tabindex="-1"></a>log_rank_stats <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, log_rank_stats_fun)</span>
<span id="cb61-919"><a href="#cb61-919" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(log_rank_stats)</span>
<span id="cb61-920"><a href="#cb61-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-921"><a href="#cb61-921" aria-hidden="true" tabindex="-1"></a>log_rank_at_ia <span class="ot">&lt;-</span> <span class="fu">log_rank_stats_fun</span>(os_data_augmented)</span>
<span id="cb61-922"><a href="#cb61-922" aria-hidden="true" tabindex="-1"></a>log_rank_at_ia</span>
<span id="cb61-923"><a href="#cb61-923" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> log_rank_at_ia, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb61-924"><a href="#cb61-924" aria-hidden="true" tabindex="-1"></a>critical_value <span class="ot">&lt;-</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="at">df =</span> <span class="dv">1</span>)</span>
<span id="cb61-925"><a href="#cb61-925" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> critical_value, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb61-926"><a href="#cb61-926" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-927"><a href="#cb61-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-928"><a href="#cb61-928" aria-hidden="true" tabindex="-1"></a>And using the critical value of the log-rank test statistic for a significance level of 0.05, we can calculate the PTS:</span>
<span id="cb61-929"><a href="#cb61-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-932"><a href="#cb61-932" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-933"><a href="#cb61-933" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_pts_log_rank</span></span>
<span id="cb61-934"><a href="#cb61-934" aria-hidden="true" tabindex="-1"></a>pts_log_rank <span class="ot">&lt;-</span> <span class="fu">mean</span>(log_rank_stats <span class="sc">&gt;</span> critical_value)</span>
<span id="cb61-935"><a href="#cb61-935" aria-hidden="true" tabindex="-1"></a>pts_log_rank</span>
<span id="cb61-936"><a href="#cb61-936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-937"><a href="#cb61-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-938"><a href="#cb61-938" aria-hidden="true" tabindex="-1"></a>So we see that this PTS with <span class="in">`r round(pts_log_rank * 100, 1)`</span>% is a bit lower than the previous PTS estimates. </span>
<span id="cb61-939"><a href="#cb61-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-940"><a href="#cb61-940" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hazard Ratio based PTS</span></span>
<span id="cb61-941"><a href="#cb61-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-942"><a href="#cb61-942" aria-hidden="true" tabindex="-1"></a>We can also calculate the PTS in an analogous way using the hazard ratio estimates:</span>
<span id="cb61-943"><a href="#cb61-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-946"><a href="#cb61-946" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-947"><a href="#cb61-947" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: calculate_pts_hr</span></span>
<span id="cb61-948"><a href="#cb61-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-949"><a href="#cb61-949" aria-hidden="true" tabindex="-1"></a>hr_pval_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb61-950"><a href="#cb61-950" aria-hidden="true" tabindex="-1"></a>    cox_mod <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb61-951"><a href="#cb61-951" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm <span class="sc">+</span> ecog <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex,</span>
<span id="cb61-952"><a href="#cb61-952" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> df</span>
<span id="cb61-953"><a href="#cb61-953" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-954"><a href="#cb61-954" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(cox_mod)<span class="sc">$</span>coefficients[<span class="dv">1</span>, <span class="dv">5</span>]</span>
<span id="cb61-955"><a href="#cb61-955" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-956"><a href="#cb61-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-957"><a href="#cb61-957" aria-hidden="true" tabindex="-1"></a>hr_pvals <span class="ot">&lt;-</span> <span class="fu">sapply</span>(os_data_samples, hr_pval_fun)</span>
<span id="cb61-958"><a href="#cb61-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-959"><a href="#cb61-959" aria-hidden="true" tabindex="-1"></a>pts_hr <span class="ot">&lt;-</span> <span class="fu">mean</span>(hr_pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb61-960"><a href="#cb61-960" aria-hidden="true" tabindex="-1"></a>pts_hr</span>
<span id="cb61-961"><a href="#cb61-961" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-962"><a href="#cb61-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-963"><a href="#cb61-963" aria-hidden="true" tabindex="-1"></a>In this PTS estimate we can adjust for the covariates. We see that the result of <span class="in">`r round(pts_hr * 100, 1)`</span>% is in line with the frequentist based PTS estimate for the HR which we calculated earlier.</span>
<span id="cb61-964"><a href="#cb61-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-965"><a href="#cb61-965" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot Kaplan-Meier curves predictions</span></span>
<span id="cb61-966"><a href="#cb61-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-967"><a href="#cb61-967" aria-hidden="true" tabindex="-1"></a>Similarly we can extract the Kaplan-Meier curves for each sampled OS data set and plot them:</span>
<span id="cb61-968"><a href="#cb61-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-971"><a href="#cb61-971" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-972"><a href="#cb61-972" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_kaplan_meier_curves</span></span>
<span id="cb61-973"><a href="#cb61-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-974"><a href="#cb61-974" aria-hidden="true" tabindex="-1"></a>km_curves <span class="ot">&lt;-</span> <span class="fu">lapply</span>(os_data_samples, <span class="cf">function</span>(df) {</span>
<span id="cb61-975"><a href="#cb61-975" aria-hidden="true" tabindex="-1"></a>    survfit_obj <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> df)</span>
<span id="cb61-976"><a href="#cb61-976" aria-hidden="true" tabindex="-1"></a>    times <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>time</span>
<span id="cb61-977"><a href="#cb61-977" aria-hidden="true" tabindex="-1"></a>    surv_probs <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>surv</span>
<span id="cb61-978"><a href="#cb61-978" aria-hidden="true" tabindex="-1"></a>    strata <span class="ot">&lt;-</span> survfit_obj<span class="sc">$</span>strata</span>
<span id="cb61-979"><a href="#cb61-979" aria-hidden="true" tabindex="-1"></a>    n_control <span class="ot">&lt;-</span> strata[<span class="dv">1</span>]</span>
<span id="cb61-980"><a href="#cb61-980" aria-hidden="true" tabindex="-1"></a>    n_treatment <span class="ot">&lt;-</span> strata[<span class="dv">2</span>]</span>
<span id="cb61-981"><a href="#cb61-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-982"><a href="#cb61-982" aria-hidden="true" tabindex="-1"></a>    control_fun <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(</span>
<span id="cb61-983"><a href="#cb61-983" aria-hidden="true" tabindex="-1"></a>        times[<span class="dv">1</span><span class="sc">:</span>n_control],</span>
<span id="cb61-984"><a href="#cb61-984" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">1</span>, surv_probs[<span class="dv">1</span><span class="sc">:</span>n_control]),</span>
<span id="cb61-985"><a href="#cb61-985" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> <span class="cn">TRUE</span></span>
<span id="cb61-986"><a href="#cb61-986" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-987"><a href="#cb61-987" aria-hidden="true" tabindex="-1"></a>    treatment_fun <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(</span>
<span id="cb61-988"><a href="#cb61-988" aria-hidden="true" tabindex="-1"></a>        times[(n_control <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(times)],</span>
<span id="cb61-989"><a href="#cb61-989" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">1</span>, surv_probs[(n_control <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(surv_probs)]),</span>
<span id="cb61-990"><a href="#cb61-990" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> <span class="cn">TRUE</span></span>
<span id="cb61-991"><a href="#cb61-991" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-992"><a href="#cb61-992" aria-hidden="true" tabindex="-1"></a>    control_vals <span class="ot">&lt;-</span> <span class="fu">control_fun</span>(time_grid)</span>
<span id="cb61-993"><a href="#cb61-993" aria-hidden="true" tabindex="-1"></a>    treatment_vals <span class="ot">&lt;-</span> <span class="fu">treatment_fun</span>(time_grid)</span>
<span id="cb61-994"><a href="#cb61-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-995"><a href="#cb61-995" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">control =</span> control_vals, <span class="at">treatment =</span> treatment_vals)</span>
<span id="cb61-996"><a href="#cb61-996" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-997"><a href="#cb61-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-998"><a href="#cb61-998" aria-hidden="true" tabindex="-1"></a>km_control_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(km_curves, <span class="cf">function</span>(x) x<span class="sc">$</span>control)</span>
<span id="cb61-999"><a href="#cb61-999" aria-hidden="true" tabindex="-1"></a>km_treatment_samples <span class="ot">&lt;-</span> <span class="fu">sapply</span>(km_curves, <span class="cf">function</span>(x) x<span class="sc">$</span>treatment)</span>
<span id="cb61-1000"><a href="#cb61-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1001"><a href="#cb61-1001" aria-hidden="true" tabindex="-1"></a>survfit_ia <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(os_time, os_event) <span class="sc">~</span> arm, <span class="at">data =</span> os_data_augmented)</span>
<span id="cb61-1002"><a href="#cb61-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1003"><a href="#cb61-1003" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(survfit_ia, <span class="at">col =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(time_grid)))</span>
<span id="cb61-1004"><a href="#cb61-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1005"><a href="#cb61-1005" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the mean KM curves for each arm.</span></span>
<span id="cb61-1006"><a href="#cb61-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(time_grid, <span class="fu">rowMeans</span>(km_control_samples), <span class="at">col =</span> <span class="dv">1</span>)</span>
<span id="cb61-1007"><a href="#cb61-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(time_grid, <span class="fu">rowMeans</span>(km_treatment_samples), <span class="at">col =</span> <span class="dv">2</span>)</span>
<span id="cb61-1008"><a href="#cb61-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1009"><a href="#cb61-1009" aria-hidden="true" tabindex="-1"></a><span class="co"># Add pointwise confidence intervals as shaded areas.</span></span>
<span id="cb61-1010"><a href="#cb61-1010" aria-hidden="true" tabindex="-1"></a>km_control_ci <span class="ot">&lt;-</span> <span class="fu">apply</span>(km_control_samples, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb61-1011"><a href="#cb61-1011" aria-hidden="true" tabindex="-1"></a>km_treatment_ci <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb61-1012"><a href="#cb61-1012" aria-hidden="true" tabindex="-1"></a>    km_treatment_samples,</span>
<span id="cb61-1013"><a href="#cb61-1013" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb61-1014"><a href="#cb61-1014" aria-hidden="true" tabindex="-1"></a>    quantile,</span>
<span id="cb61-1015"><a href="#cb61-1015" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb61-1016"><a href="#cb61-1016" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-1017"><a href="#cb61-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1018"><a href="#cb61-1018" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(</span>
<span id="cb61-1019"><a href="#cb61-1019" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(time_grid, <span class="fu">rev</span>(time_grid)),</span>
<span id="cb61-1020"><a href="#cb61-1020" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(km_control_ci[<span class="dv">1</span>, ], <span class="fu">rev</span>(km_control_ci[<span class="dv">2</span>, ])),</span>
<span id="cb61-1021"><a href="#cb61-1021" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="dv">1</span>, <span class="at">alpha.f =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-1022"><a href="#cb61-1022" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb61-1023"><a href="#cb61-1023" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-1024"><a href="#cb61-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(</span>
<span id="cb61-1025"><a href="#cb61-1025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(time_grid, <span class="fu">rev</span>(time_grid)),</span>
<span id="cb61-1026"><a href="#cb61-1026" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(km_treatment_ci[<span class="dv">1</span>, ], <span class="fu">rev</span>(km_treatment_ci[<span class="dv">2</span>, ])),</span>
<span id="cb61-1027"><a href="#cb61-1027" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="dv">2</span>, <span class="at">alpha.f =</span> <span class="fl">0.2</span>),</span>
<span id="cb61-1028"><a href="#cb61-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">border =</span> <span class="cn">NA</span></span>
<span id="cb61-1029"><a href="#cb61-1029" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-1030"><a href="#cb61-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1031"><a href="#cb61-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1032"><a href="#cb61-1032" aria-hidden="true" tabindex="-1"></a>We can see that we assume a very long follow up of the data here.</span>
<span id="cb61-1033"><a href="#cb61-1033" aria-hidden="true" tabindex="-1"></a>Obviously we could cut the data sets at a certain number of events or a specific time point easily.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RCONIS/tgi-os-training/edit/main/session-pts/1_pts-jmpost.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/RCONIS/tgi-os-training/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>